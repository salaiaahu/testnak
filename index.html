<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCC Indy</title>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Three.js for 3D elements -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf_viewer.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf_viewer.min.css" />
	
<!-- Firebase App (Core SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<!-- Firebase Firestore -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

    <style>
        /* Custom Styles & Themes */
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --sidebar-bg: #1f2937;
            --sidebar-hover: #374151;
            --header-bg: #3b82f6; /* Blue header for default theme */
            --header-text: #ffffff;
            --text-color: #1f2937;
            --text-muted: #6b7280;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --input-bg: #ffffff;
            --input-text: #111827;
            --notification-bg: #ef4444;
        }

        .theme-dark {
            --primary-color: #818cf8;
            --primary-hover: #6366f1;
            --sidebar-bg: #111827;
            --sidebar-hover: #1f2937;
            --header-bg: #1f2937;
            --header-text: #f9fafb;
            --text-color: #f9fafb;
            --text-muted: #9ca3af;
            --bg-color: #111827;
            --card-bg: #1f2937;
            --input-bg: #374151;
            --input-text: #f9fafb;
        }
        
        .theme-ocean {
             --primary-color: #0d9488;
             --primary-hover: #0f766e;
             --sidebar-bg: #042f2e;
             --sidebar-hover: #064e4a;
             --header-bg: #115e59;
             --header-text: #ffffff;
             --text-color: #042f2e;
             --text-muted: #115e59;
             --bg-color: #ccfbf1;
             --card-bg: #f0fdfa;
             --input-bg: #ffffff;
             --input-text: #042f2e;
        }

        .theme-sunset {
            --primary-color: #f97316;
            --primary-hover: #ea580c;
            --sidebar-bg: #422006;
            --sidebar-hover: #7c2d12;
            --header-bg: #c2410c;
            --header-text: #ffffff;
            --text-color: #422006;
            --text-muted: #7c2d12;
            --bg-color: #fef3c7;
            --card-bg: #fff7ed;
             --input-bg: #ffffff;
             --input-text: #422006;
        }

        .theme-forest {
            --primary-color: #16a34a;
            --primary-hover: #15803d;
            --sidebar-bg: #14532d;
            --sidebar-hover: #166534;
            --header-bg: #166534;
            --header-text: #ffffff;
            --text-color: #14532d;
            --text-muted: #166534;
            --bg-color: #dcfce7;
            --card-bg: #f0fdf4;
             --input-bg: #ffffff;
             --input-text: #14532d;
        }


        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        #login-screen {
            background-color: rgba(229, 231, 235, 0.8);
            backdrop-filter: blur(8px);
        }

		#main-content > .page { /* Target only direct children of main-content with class 'page' */
			display: none;
			animation: fadeIn 0.5s ease-in-out;
		}

		#main-content > .page.active {
			display: block;
		}

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #sidebar {
            transition: transform 0.3s ease-in-out;
            background-color: var(--sidebar-bg);
        }
         #sidebar nav.flex-grow {
            overflow-y: auto;
        }
        
        #sidebar-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        
        .sidebar-nav-link {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            color: #d1d5db;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
            position: relative; /* Add this line */
        }

        .sidebar-nav-link:hover {
            background-color: var(--sidebar-hover);
            color: white;
        }

        .sidebar-nav-link.active {
            background-color: var(--primary-color) !important;
            color: white !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .sidebar-nav-link .link-content {
             display: flex;
             align-items: center;
             font-size: 0.875rem;
             position: relative; /* Add this line */
        }

        .sidebar-nav-link i {
            width: 1.5rem;
            margin-right: 0.75rem;
            text-align: center;
            font-size: 1rem; /* Consistent icon size */
        }
/* Hide default scrollbar for WebKit browsers (Chrome, Safari) */
#sidebar nav.flex-grow::-webkit-scrollbar {
    width: 0;
    height: 0;
    background: transparent; /* make scrollbar transparent */
}

/* For Firefox */
#sidebar nav.flex-grow {
    scrollbar-width: none; /* "none" to hide scrollbar */
}

/* For Edge and IE */
#sidebar nav.flex-grow {
    -ms-overflow-style: none;
}

/* Adjust collapsible-content for smoother and more reliable toggle */
.collapsible-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}

.collapsible-content.expanded {
    /* A large fixed value bigger than any content will be.
       This is crucial for smooth 'max-height' transitions.
       If content exceeds this, it will just get a default scrollbar. */
    max-height: 500px; /* Adjust this value if your groups can be taller */
}		
        .icon-favorites { color: #facc15; }
        .icon-groups { color: #60a5fa; }
        .icon-register { color: #4ade80; }
        .icon-reports { color: #fb923c; }
        .icon-update { color: #e879f9; }
        .icon-settings { color: #9ca3af; }
        .icon-theme { color: #f472b6; }
        .icon-home { color: #f87171; } /* New Home icon color */
        .icon-ministers { color: #a78bfa; } /* New Ministers icon color */
        .icon-give { color: #ffd700; } /* Gold color for Give */
        .icon-prayer { color: #87ceeb; } /* Sky blue for Prayer */
		.icon-events { color: #34d399; } /* Green color for Events */
		.icon-users-cog { color: #facc15; } /* Yellow for User Management */
		.icon-user-edit { color: #87ceeb; } /* Light blue for Edit My Profile */
		
        /* Specific spacing for Groups icon and text */
        .collapsible-header .link-content i.icon-groups {
            margin-right: 1.5rem; /* 1.5rem width */
        }

        .member-checkbox, .favorite-btn {
            transform: scale(1.1);
            accent-color: var(--primary-color);
        }
        
        .favorite-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #ccc;
            padding: 0;
        }
        .favorite-btn.favorited {
            color: #fbbf24; /* amber-400 */
        }


        .import-icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #38bdf8;
            color: white;
            font-size: 20px;
            line-height: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.3s, transform 0.2s;
        }
        .import-icon-btn:hover {
            background-color: #0ea5e9;
            transform: scale(1.1);
        }

        .form-section {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            background-color: var(--card-bg);
        }
        .form-section-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .conditional-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.7s ease-in-out, opacity 0.5s ease-in;
            opacity: 0;
        }
        .conditional-section.visible {
            max-height: 5000px;
            opacity: 1;
        }
        .modal-body {
            max-height: 80vh;
            overflow-y: auto;
        }
.notification-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 1rem; /* Space below header */
    margin-bottom: 1rem; /* Margin before content starts */
    border-bottom: 1px solid #e5e7eb; /* Separator line */
    position: sticky; /* Make it sticky */
    top: 0; /* Stick to the top of its scrollable parent */
    background-color: var(--card-bg); /* Ensure background is visible when sticky */
    z-index: 10; /* Ensure it's above scrolling content */
    padding-top: 0.5rem; /* Small padding at the very top for visual comfort */
    padding-left: 1rem; /* Match modal padding */
    padding-right: 1rem; /* Match modal padding */
    margin-left: -1rem; /* Counteract parent padding to stretch full width */
    margin-right: -1rem; /* Counteract parent padding to stretch full width */
}

/* Adjust modal body to enable proper sticky behavior for the header */
#notification-modal .modal-body {
    max-height: 80vh; /* Adjust as needed, but ensure it's less than 100vh */
    overflow-y: auto; /* Enable scrolling within the modal body */
    display: flex; /* Use flex to control content within modal body */
    flex-direction: column; /* Stack content vertically */
}

/* Give the actual scrollable content a div to prevent sticky header from pushing it down */
.modal-body-scrollable {
    flex-grow: 1; /* Allow content to grow and fill space */
    padding-left: 1rem; /* Re-add padding that was removed from header */
    padding-right: 1rem;
}

/* Adjust padding for the main modal content to fit the new header */
#notification-modal .p-5 {
    padding-top: 0; /* Remove top padding from outer modal div as header now has it */
}

/* Style for the 'X' button */
#close-notification-modal-x {
    background: none;
    border: none;
    cursor: pointer;
    line-height: 1; /* Keep icon centered */
}
        #family-modal-content, #minister-detail-modal-content, #add-minister-modal .modal-body, #edit-about-directory-modal .modal-body, #give-modal .modal-body, #prayer-request-modal .modal-body {
            display: flex;
            flex-direction: column;
            max-height: 85vh;
        }
        #family-modal-list, #minister-detail-modal-body, #give-modal-body, #prayer-request-modal-body {
            overflow-y: auto;
        }
        .profile-pic-placeholder {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 24px;
            flex-shrink: 0;
            cursor: pointer;
        }
        .user-profile-pic {
            width: 50px;
            height: 50px;
        }
        .profile-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            cursor: pointer;
        }
        .info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
        }
        .info-item i {
            width: 16px;
            text-align: center;
        }
         .info-item .fa-phone { color: #22c55e; }
        .info-item .fa-envelope { color: #f97316; }
        .info-item .fa-venus-mars { color: #ec4899; }
        .info-item .fa-church { color: #8b5cf6; }
        .info-item .fa-map-marker-alt { color: #3b82f6; }

        .info-item a {
            color: var(--primary-color);
        }
        .info-item a:hover {
            color: var(--primary-hover);
        }
        body {
            background-color: var(--bg-color);
        }
        #header, header {
             background-color: var(--header-bg);
             color: var(--header-text);
        }
        #header h1, #header i {
            color: var(--header-text);
        }
        .bg-white, .rounded-xl, .rounded-2xl, .bg-gray-50 {
             background-color: var(--card-bg);
             color: var(--text-color);
        }
    input, select, textarea {
        background-color: var(--input-bg) !important;
        color: var(--input-text) !important; /* Ensure input text is correct */
        border: 1px solid #d1d5db; /* Keep borders consistent */
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }
        label {
            color: var(--text-color) !important;
        }
        #route-planner-bar {
             background-color: var(--primary-color);
        }
         #plan-route-btn {
            background-color: var(--card-bg);
            color: var(--primary-color);
        }
        #apply-age-filter, .btn-primary {
            background-color: var(--primary-color);
        }
        #group-breakdown-tbody th {
            position: sticky;
            left: 0;
            background-color: var(--card-bg);
            z-index: 1;
        }
        #group-breakdown-table thead th {
            background-color: var(--header-bg); /* Added background color for sticky header */
            color: var(--header-text); /* Ensure text is visible */
        }
        #group-breakdown-table thead {
            background: linear-gradient(to right, #60a5fa, #3b82f6);
            color: white;
        }
        #theme-dropdown {
            background-color: var(--card-bg);
        }
        #theme-dropdown a {
            color: var(--text-color)
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -8px;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background-color: var(--notification-bg);
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-nav-link .notification-badge {
            position: static; /* Overrides the 'absolute' position */
            margin-left: 8px;
            flex-shrink: 0;
        }
        .page > .p-6 {
            padding: 1rem;
        }
        @media (min-width: 640px) {
             .page > .p-6 {
                padding: 2rem;
            }

        }
		@media (max-width: 600px) {
			.p-4 {
				padding: 0.5rem !important;
			}
			.p-2 {
				padding: 0.5rem !important;
			}
			.gap-4 {
				gap: 0.5rem !important;
			}
			.text-xs {
				font-size: 0.75rem !important;
				line-height: 1.3rem !important;
			}
			.text-2xl {
				font-size: 1.15rem !important;
				line-height: 2rem !important;
				text-align: center !important;
			}
			.text-lg {
				font-size: 0.9rem !important;
				line-height: 0.75rem !important;
			}
			.text-sm {
				font-size: 0.75rem !important;
				line-height: 1.25rem !important;
			}
			.mb-4 {
				margin-bottom: 0.5rem !important;
			}
			.mb-2 {
				margin-bottom: 0.1rem !important;
			}
			.pt-4 {
				padding-top: 0rem !important;
			}
			.mt-6 {
				margin-top: 0.5rem !important;
			}
			.text-xl {
				font-size: 1.25rem !important;
				line-height: 0.75rem !important;
			}

			.mt-8 {
				margin-top: 0.5rem !Important;
			}
			.mt-2 {
				margin-top: 0 !Important;
			}
			.w-20 {
				width: 4rem !Important;
				height: 2rem !important;
			}
			.import-icon-btn {
				display: none !important;
			}
			.text-white {
				--tw-text-opacity: 1;
				color: rgb(255 255 255 / var(--tw-text-opacity, 1));
				font-size: 0.7rem !important;
			}
			.px-4 {
				padding-left: 0.5rem !important;
				padding-right: 0.5rem !important;
			}
			label {
				color: var(--text-color) !important;
				font-size: 0.9rem !important;
			}
			.text-base {
				font-size: 0.9rem !important;
				line-height: 1.5rem !important;
			}
			.text-gray-800 {
				--tw-text-opacity: 1;
				color: rgb(31 41 55 / var(--tw-text-opacity, 1));
				font-size: 0.8rem !important;
			}
			.py-2 {
				padding-top: 0.3rem !important;
				padding-bottom: 0.3rem !important;
			}
			element.style {
				color: var(--text-muted);
				font-size: 0.8rem !important;
			}
			button, input, optgroup, select, textarea {
				font-family: inherit;
				font-feature-settings: inherit;
				font-variation-settings: inherit;
				font-size: 85% !important;
				font-weight: inherit;
				line-height: inherit;
				letter-spacing: inherit;
				color: inherit;
				margin: 0;
				padding: 0;
			}
			.font-semibold {
				font-weight: 600;
				font-size: 0.9rem !important;
			}
			.font-medium {
				font-weight: 500;
				font-size: 0.7rem !important;
			}
			.info-item a {
				color: var(--primary-color);
				line-height: 1.25rem !important;
			}
			.pb-4 {
				padding-bottom: 0rem !important;
			}
            /* New padding for sidebar links to make them look more professional on mobile */
            .sidebar-nav-link, .collapsible-header {
                padding: 0.75rem 1rem; /* Increased vertical padding */
            }
            .collapsible-content .sidebar-nav-link {
                padding-left: 2.75rem; /* Maintain indent */
            }
	
		}
        /* New styles for collapsible groups */
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            color: #d1d5db;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
            cursor: pointer;
            font-size: 0.875rem; /* Consistent font size */
        }

        .collapsible-header:hover {
            background-color: var(--sidebar-hover);
            color: white;
        }

        .collapsible-header i.fa-chevron-down {
            transition: transform 0.3s ease-in-out;
            font-size: 1rem; /* Consistent icon size */
        }

        .collapsible-header.expanded i.fa-chevron-down {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .collapsible-content.expanded {
            max-height: 500px; /* Adjust as needed to fit content */
        }
        .collapsible-content .sidebar-nav-link {
            padding-left: 2.5rem; /* Indent sub-items */
        }

        /* Home Page Slideshow */
        .slideshow-container {
            position: relative;
            width: 100%;
            /* DEFAULT FOR ALL SCREENS (including mobile/small screens): */
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio by default */
            height: 0; /* Important for padding-bottom hack */

            max-width: 800px; /* Current max-width for smaller screens */
            margin: auto;
            overflow: hidden;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background-color: var(--card-bg);
        }


        .mySlides {
            position: absolute; /* Position for overlaying slides */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; /* Fill the container */
            object-fit: cover; /* Cover the area, cropping if necessary */
            display: none;
            transition: opacity 1s ease-in-out; /* Smooth transition */
            opacity: 0; /* Start hidden for transition */
        }
        .mySlides.active-slide {
            opacity: 1; /* Show active slide */
        }

        .prev, .next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            width: auto;
            padding: 16px; /* Default large padding */
            margin-top: -22px;
            color: white;
            font-weight: bold;
            font-size: 18px;
            transition: 0.6s ease;
            border-radius: 0 3px 3px 0;
            user-select: none;
            background-color: rgba(0,0,0,0.5);
            z-index: 20; /* Ensure buttons are above slides */
        }

        .next {
            right: 0;
            border-radius: 3px 0 0 3px;
        }

        .prev:hover, .next:hover {
            background-color: rgba(0,0,0,0.8);
        }

        /* NEW: Smaller buttons for mobile screens */
        @media (max-width: 600px) { /* Adjust breakpoint as needed, e.g., 640px for sm */
            .prev, .next {
                padding: 8px; /* Reduce padding */
                font-size: 14px; /* Reduce font size */
                margin-top: -14px; /* Adjust margin-top to keep it centered vertically */
            }
        }

.slideshow-controls-outside {
    display: flex;
    justify-content: center;
    gap: 1rem;
    padding: 0.75rem 0;
    margin-top: 0.5rem;
    /* NEW: Add these for proper collapsing */
    height: auto; /* Ensure height adapts */
    overflow: hidden; /* Hide any overflow if content changes */
}
.slideshow-controls-outside:has(> .editor-only-section.hidden) {
    display: none; /* Collapse the container itself */
}

        /* Ministers Page Canvas Styling */
        .minister-card-canvas-container {
            width: 100%;
            /* Maintain 1:1 aspect ratio by using padding-bottom hack */
            height: 0;
            padding-bottom: 100%; 
            position: relative;
            background-color: #f0f0f0; /* Light background for canvas */
            border-radius: 0.5rem;
            overflow: hidden; /* Ensure 3D doesn't spill */
        }

        .minister-card-canvas-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Minister Detail Modal sticky header */
        .minister-modal-profile-header {
            position: sticky;
            top: 0;
            background-color: var(--card-bg);
            z-index: 10;
            padding-bottom: 1rem; /* Space below header */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Subtle shadow */
        }
        
        .minister-modal-profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 0.75rem; /* Changed from 50% */
            object-fit: cover;
        }

        .sermon-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
            /* Ensure background color for smooth transition if needed */
            background-color: var(--card-bg);
        }
        .sermon-body-expanded {
            /* A large fixed value bigger than any content will be */
            max-height: 1000px; 
        }

        .minister-modal-profile-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 0.75rem; /* Changed from 50% */
            background-color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 40px;
        }

        #edit-mode-toggle-btn.active {
            background-color: var(--primary-color);
            color: var(--header-text);
        }
    .prose, /* Target elements with the prose class */
    #prayer-wall-container p, /* Specifically target paragraphs in the prayer wall */
    #prayer-request-form label, /* Ensure labels in forms are visible */
    #give-form label,
    #register-form label,
    #update-info-form label,
    #edit-my-profile-form label {
        color: var(--text-color); /* Apply the theme-aware text color */
    }

    /* Override any specific Tailwind prose default colors if they clash */
    .prose :where(p, li, blockquote, h1, h2, h3, h4, h5, h6) {
        color: var(--text-color) !important;
    }

    /* Ensure prayer card text also adheres to theme */
    #page-prayer-wall .p-4.rounded-xl.shadow-md p {
        color: var(--text-color);
    }

        /* Rich Text Editor */
        .rich-text-editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            background-color: var(--input-bg);
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .rich-text-editor-toolbar button {
            padding: 0.25rem 0.5rem;
            background-color: #e5e7eb;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .rich-text-editor-toolbar button:hover {
            background-color: #d1d5db;
        }
        .rich-text-editor-content {
            min-height: 150px;
            border: 1px solid #d1d5db;
            border-top: none;
            padding: 0.75rem;
            outline: none;
            background-color: var(--input-bg);
            color: var(--input-text);
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
        .slideshow-description-overlay {
            /* Basic styling for the description text */
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black background */
            color: white; /* White text for contrast */
            padding: 0.5rem;
            font-size: 0.875rem; /* text-sm */
            text-align: center;
            box-sizing: border-box; /* Include padding in width/height */
            display: flex; /* Use flexbox for alignment */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            transition: opacity 0.5s ease-in-out; /* Smooth fade in/out */
        }

        .slideshow-description-overlay button.edit-slideshow-description-btn {
            /* Styles for the edit button within the description overlay */
            font-size: 0.75rem; /* text-xs */
            margin-left: 0.5rem; /* ml-2 */
            padding: 0.25rem 0.5rem; /* py-1 px-2 */
            border-radius: 0.25rem; /* rounded-md */
            background-color: white;
            color: #1f2937; /* Dark text on white button */
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        .slideshow-description-overlay button.edit-slideshow-description-btn:hover {
            background-color: #e5e7eb; /* hover:bg-gray-200 */
        }
.about-us-card {
	background-color: var(--card-bg);
}
 
.theme-dark .posts-section-container {
    background-color: var(--card-bg); /* Use the theme's dark card background */
}
.theme-dark .about-us-card {
    background-color: #374151; /* A slightly lighter dark gray for contrast (gray-700 in Tailwind) */
    /* You could also use a different light color that fits your dark theme aesthetic, e.g., #4B5563 (gray-600) */
}
/* Ensure headings/text within this container are visible too */
.theme-dark .posts-section-container h3,
.theme-dark .posts-section-container p,
.theme-dark .posts-section-container span {
    color: var(--text-color); /* Ensure text color is light in dark mode */
}

/* Your previous rule for individual post-cards is still good if you want them slightly different */
.theme-dark .post-card {
    background-color: var(--card-bg); /* Or a slightly different shade if you prefer, e.g., #111827 */
    /* Ensure internal text is also covered by text-color variable */
}

/* Make sure text within post-cards is also set to theme's text color */
.theme-dark .post-card h3,
.theme-dark .post-card p,
.theme-dark .post-card span {
    color: var(--text-color);
}
/* For Slideshow and About Us Layout */
.slideshow-about-container {
    display: flex;
    flex-direction: column; /* Stack vertically on small screens */
    gap: 0.5rem; /* NEW: Reduced gap for smaller screens (adjust as needed, e.g., 0.5rem, 1rem) */
    align-items: center;
}

@media (min-width: 1024px) { /* For large screens (lg breakpoint) and up */
    .slideshow-about-container {
        flex-direction: row; /* Arrange horizontally */
        align-items: flex-start; /* Align to top */
        margin-top: 1.5rem; /* Add some top margin to align with page padding */
    }

    .slideshow-container {
        flex: 2; /* Slideshow takes 2 parts of the available space */
        max-width: none; /* Remove previous max-width to allow flex to control it */
        min-width: 0; /* Allow it to shrink */
        
        /* NEW: Set a fixed height for large screens and remove padding-bottom hack */
        height: 350px; /* Adjust this value (e.g., 300px, 400px) as desired */
        padding-bottom: 0; /* Crucial: Remove the aspect ratio hack for fixed height */
    }

    /* Ensure the image inside fills the new fixed height */
    .slideshow-container .mySlides {
        height: 100%; /* Make the image fill the container's new fixed height */
        object-fit: cover; /* Ensure the image covers the area, cropping if necessary */
    }

    .about-us-card { /* Target the About Us card */
        flex: 1; /* About Us takes 1 part of the available space */
        margin-top: 0 !important; /* Remove the default mt-8 on large screens */
		background-color: var(--card-bg);
    }
}
/* Adjust general slideshow container padding on smaller screens if it was too much */
        @media (max-width: 600px) {
            .slideshow-container {
                padding-bottom: 45%; /* Slightly shorter on very small screens to give more room */
                max-width: none; /* Allow it to take full width of its parent on very small screens */
            }
        }

/* For Prayer Wall Grid Layout */
.prayer-wall-grid-layout {
    display: flex; /* Default to flex column for small screens */
    flex-direction: column;
}

@media (min-width: 768px) { /* For medium screens (md breakpoint) and up */
    .prayer-wall-grid-layout {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* 300px minimum width, fills available space */
        gap: 1rem; /* Gap between grid items */
    }
}

/* For Sermons Grid Layout - adjust min width to allow more columns */
.sermons-grid-layout {
    display: flex; /* Default to flex column for small screens */
    flex-direction: column;
}

@media (min-width: 768px) { /* For medium screens (md breakpoint) and up */
    .sermons-grid-layout {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); /* Adjusted min width */
        gap: 1.5rem; /* Gap between grid items */
    }
}

/* Mobile filter buttons */
.mobile-filter-container {
    width: calc(50% - 8px); /* Half width minus gap */
}
@media (min-width: 768px) {
    .mobile-filter-container {
        width: auto; /* Revert to auto width on desktop */
    }
}

#plan-route-btn {
    background-color: var(--card-bg);
    color: var(--primary-color);
    /* Ensure text does not wrap */
    white-space: nowrap; /* NEW: Prevents text from wrapping to the next line */
    
    /* Existing styles from your HTML */
    font-bold py-1 px-3 sm:py-2 sm:px-4 rounded-lg shadow-md hover:opacity-80 text-xs sm:text-sm transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed
}

/* You might already have these, but confirm they are correctly applied. */
/* If the button is still wrapping on very small screens, you might need to reduce px- values in HTML directly, or target them with media queries in CSS. */
/* For example, you could add: */
@media (max-width: 600px) {
    #plan-route-btn, #clear-selection-btn {
        padding-left: 0.75rem; /* px-3 */
        padding-right: 0.75rem; /* px-3 */
    }
}


/* Ensure post cards are responsive within their grid */
#posts-list-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Adjust minmax as needed */
    gap: 1rem; /* Space between cards */
}
        /* Styles for Printing */
        @media print {
            /* --- General Print Reset --- */
            body * {
                visibility: hidden;
            }
            #main-content, #main-content * {
                visibility: visible;
            }
            #main-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100% !important;
                margin: 0 !important;
                padding: 0.5rem !important;
                box-sizing: border-box;
            }
            body {
                font-size: 12pt !important;
                background-color: #ffffff !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            /* --- Hide Unnecessary UI --- */
            /* **THIS IS THE FIX:** The last selector is now more specific */
            #sidebar, header, #financials-actions, #report-category-selector, #financials-report-section > .p-4:first-child {
                display: none !important;
            }
            
            /* --- Element Styling for Print --- */
            .shadow-lg, .rounded-xl {
                box-shadow: none !important;
                border: 1px solid #cccccc !important;
            }
            .bg-slate-100 {
                background-color: #ffffff !important;
            }
            h2, h3, h4 {
                color: #000000 !important;
                font-size: 14pt !important;
                margin-bottom: 0.5rem !important;
            }
            
            /* Compact Layout Rules */
            #financials-report-section .p-4, #financials-report-section .p-2 {
                 padding: 0.5rem !important;
            }
            #financial-summary-cards {
                gap: 0.5rem !important;
            }
            
            #church-treasurer-chart-grid {
                display: flex !important;
                flex-direction: row !important;
                gap: 0.5rem !important; /* Reduced gap */
                width: 100% !important;
                page-break-inside: avoid;
            }
            #church-treasurer-chart-grid > div {
                flex: 1; /* Make each chart container take up equal space */
                page-break-inside: avoid !important;
            }
            
            /* Ensure charts resize correctly */
            canvas {
                max-width: 100% !important;
                height: auto !important;
            }

            /* Table Styles */
            #financial-table-container th, 
            #financial-table-container td {
                padding: 4px 6px !important;
                font-size: 10pt !important;
                color: #000000 !important;
            }
        }
		.text-sm {
		border-radius: 0.375rem;
		}
		/* NEW: Styles for compact mobile filters in Meeting Reports */
		@media (max-width: 767px) {
			.meeting-filters-layout {
				display: flex;
				flex-direction: row;
				align-items: center;
				gap: 0.5rem; /* Small gap between items */
			}
			.meeting-filters-layout #meeting-dept-selector {
				flex: 1 1 40%; /* Grow and shrink, basis of 40% */
				min-width: 0;
			}
			.meeting-filters-layout #meeting-report-sort {
				flex: 1 1 40%; /* Grow and shrink, basis of 40% */
				min-width: 0;
			}
			/* Remove margins that are no longer needed */
			.meeting-filters-layout > select {
				margin-top: 0 !important;
			}

			/* Container for search icon and input */
			.search-container-mobile {
				position: relative;
				flex-shrink: 0; /* Don't let it shrink */
			}
			/* The search icon button */
			.search-icon-btn-mobile {
				display: flex; /* Initially visible */
				align-items: center;
				justify-content: center;
				width: 38px; /* Match height of select inputs */
				height: 38px;
				border: 1px solid #d1d5db;
				background-color: var(--input-bg);
				color: var(--text-muted);
				border-radius: 0.375rem; /* rounded-md */
				cursor: pointer;
			}
			/* The actual search input */
			.search-input-mobile {
				display: none; /* Initially hidden */
				position: absolute;
				top: 0;
				right: 0;
				width: 200px; /* Expand to this width when active */
				height: 38px;
				padding-left: 0.75rem;
				border: 1px solid var(--primary-color); /* Highlight when active */
				border-radius: 0.375rem;
				box-shadow: 0 2px 8px rgba(0,0,0,0.1);
				z-index: 10;
			}

			/* When the container is active, hide the icon and show the input */
			.search-container-mobile.search-active .search-icon-btn-mobile {
				display: none;
			}
			.search-container-mobile.search-active .search-input-mobile {
				display: block;
			}
		}

		/* Keep the desktop layout as it was */
		@media (min-width: 768px) {
			.meeting-filters-layout {
				display: flex;
				flex-direction: row;
				gap: 1rem;
				align-items: end;
			}
			.meeting-filters-layout #meeting-report-sort {
				margin-top: 1rem; /* Re-add margin for desktop stacking */
			}
			.meeting-filters-layout #search-container {
				margin-top: 1rem;
			}
			.search-container-mobile {
				width: 100%;
			}
			.search-icon-btn-mobile {
				display: none; /* Hide icon on desktop */
			}
			.search-input-mobile {
				display: block; /* Always show input on desktop */
				width: auto; /* Expand to this width when active */
				height: 38px;
				padding-left: 0.75rem;
				border: 1px solid var(--primary-color); /* Highlight when active */
				border-radius: 0.375rem;
				box-shadow: 0 2px 8px rgba(0,0,0,0.1);
				z-index: 10;
			}
		}
		
		/* START: New Styles for Meeting Reports & Ebook Reader */
		.bookshelf {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); /* Smaller minimum size */
			gap: 2.5rem 1rem;
			padding: 2rem 1rem;
		}

		.book {
			position: relative;
			width: 130px;  /* Smaller width */
			height: 190px; /* Smaller height to maintain aspect ratio */
			margin: 0 auto;
			cursor: pointer;
			transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
		}
		.book:hover {
			transform: rotateY(-25deg);
		}

		.book-cover {
			position: absolute;
			width: 100%;
			height: 100%;
			background-color: #4a5568; /* Default color */
			border-radius: 4px 6px 6px 4px;
			box-shadow: 5px 5px 15px rgba(0,0,0,0.3);
			transform-origin: left;
			transition: transform 0.5s ease;
			display: flex;
			flex-direction: column;
			justify-content: space-between;
			padding: 1rem;
			color: white;
			text-align: center;
		}
		.book:hover .book-cover {
			transform: rotateY(-140deg);
		}

		.book-title {
			font-weight: 700;
			font-size: 1rem;
			line-height: 1.2;
		}
		.book-date, .book-view-count {
			font-size: 0.75rem;
			opacity: 0.8;
		}
		.book-inner-page {
			position: absolute;
			width: 100%;
			height: 100%;
			background-color: #ffffff; /* White paper color */
			border-radius: 2px 5px 5px 2px;
			transform: rotateY(-25deg);
			transform-origin: left;
			z-index: -1; /* Place it behind the cover */
			/* Styles for the preview image */
			background-size: contain;
			background-repeat: no-repeat;
			background-position: center;
		}
		.book-spine {
			position: absolute;
			width: 30px;
			height: 100%;
			background-color: #2d3748; /* Darker spine color */
			transform: translateX(150px) rotateY(90deg);
			transform-origin: left;
		}

		.book-controls {
			position: absolute;
			top: 5px;
			right: 5px;
			display: flex;
			gap: 5px;
			z-index: 10;
		}
		.book:hover .book-controls {
			opacity: 1;
		}
		.book-controls button {
			background-color: white;
			color: #2d3748;
			border: 1px solid #ccc;
			border-radius: 50%;
			width: 28px;
			height: 28px;
			font-size: 0.7rem;
			display: flex;
			align-items: center;
			justify-content: center;
			box-shadow: 0 2px 5px rgba(0,0,0,0.2);
		}
		
		
		/* NEW: Media query for larger bookshelf on desktops */
		@media (min-width: 1024px) {
			.bookshelf {
				/* Increase the minimum book size and the gap between them */
				grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
				gap: 4rem 1.5rem;
				padding: 2rem;
			}
			.book {
				/* Increase the dimensions of the book itself */
				width: 170px;
				height: 250px;
			}
			.book-title {
				font-size: 1.125rem; /* Larger font for the title */
			}
			.book-date, .book-view-count {
				font-size: 0.875rem; /* Larger font for the footer info */
			}
		}

		/* NEW: Styles for compact mobile filters in Meeting Reports */
		@media (max-width: 767px) {
			/* Hide the filter toggle button entirely on mobile */
			#toggle-filters-btn {
				display: none;
			}
			/* And remove the top padding from its container */
			#meeting-filters-container {
				padding-top: 0 !important;
			}

			.meeting-filters-layout {
				display: flex;
				flex-direction: row;
				align-items: center;
				gap: 0.5rem; /* Small gap between items */
			}
			.meeting-filters-layout #meeting-dept-selector,
			.meeting-filters-layout #meeting-report-sort {
				flex: 1 1 40%; /* Grow and shrink, basis of 40% */
				min-width: 0;
				margin-top: 0 !important;
			}
			
			.search-container-mobile {
				position: relative;
				flex-shrink: 0; 
			}
			.search-icon-btn-mobile {
				display: flex; 
				align-items: center;
				justify-content: center;
				width: 38px; 
				height: 38px;
				border: 1px solid #d1d5db;
				background-color: var(--input-bg);
				color: var(--text-muted);
				border-radius: 0.375rem; 
				cursor: pointer;
			}
			.search-input-mobile {
				display: none; 
				position: absolute;
				top: 0;
				right: 0;
				width: 200px;
				height: 38px;
				padding-left: 0.75rem;
				border: 1px solid var(--primary-color);
				border-radius: 0.375rem;
				box-shadow: 0 2px 8px rgba(0,0,0,0.1);
				z-index: 10;
			}
			.search-container-mobile.search-active .search-icon-btn-mobile {
				display: none;
			}
			.search-container-mobile.search-active .search-input-mobile {
				display: block;
			}

			/* Correctly style the Add Report button on mobile */
			#add-meeting-report-btn {
				font-size: 0 !important; /* Hide the text */
				width: 38px !important;
				height: 38px !important;
				padding: 0 !important;
				flex-shrink: 0;
				display: flex;
				align-items: center;
				justify-content: center;
				border-radius: 0.375rem; /* Ensure consistent corner rounding */
			}
			#add-meeting-report-btn::before {
				content: '+';
				font-size: 1.5rem;
				font-weight: 500;
				line-height: 1;
				color: white; /* Ensure plus is visible */
			}
		}
/* Fullscreen PDF Viewer */
#pdf-viewer-modal {
    background-color: transparent !important; /* Make the modal itself transparent to reveal controls */
}
#pdf-viewer-modal.hidden {
    display: none !important;
}

#pdf-viewer-content-wrapper {
    background-color: var(--bg-color); /* Background when no PDF is loaded, or behind PDF.js */
}

/* Ensure PDF.js's canvas scales properly */
.pdfViewer canvas {
    max-width: 100% !important;
    height: auto !important; /* Important for scaling proportionally */
    display: block !important;
    margin: 0 auto !important;
    box-shadow: 0 0 10px rgba(0,0,0,0.5); /* Subtle shadow around the page */
}

/* Make sure the text layer also scales and positions correctly */
.pdfViewer .textLayer {
    transform-origin: 0% 0%; /* Important for text layer scaling with canvas */
}

/* Styles for overlay controls */
#pdf-top-controls.visible,
#pdf-bottom-controls.visible {
    opacity: 1;
}

/* Specific mobile adjustments for a cleaner fullscreen look */
@media (max-width: 767px) {
    #pdf-viewer-modal.hidden {
        display: none !important; /* Ensure hidden works consistently */
    }
    #pdf-viewer-modal {
        padding: 0 !important; /* Remove all padding from modal */
    }
    #pdf-modal-overlay-bg {
        display: none; /* Hide the background overlay when in fullscreen mode */
    }
    #pdf-viewer-content-wrapper {
        margin: 0 !important;
        border-radius: 0 !important; /* No rounded corners for fullscreen */
        box-shadow: none !important;
    }
    #pdf-top-controls,
    #pdf-bottom-controls {
        padding: 0.5rem !important; /* Smaller padding for control bars */
    }
    #pdf-report-title {
        font-size: 1rem !important; /* Even smaller title */
    }
    #pdf-close-btn, #pdf-download-top, #pdf-print-top {
        padding: 0.25rem !important; /* Smaller padding for top buttons */
    }
}
#pdf-viewer-modal #pdf-viewer-container {
    position: absolute !important;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100% !important;
    height: 100% !important;
	justify-items: center !important;
    margin: 0 !important;
    overflow: auto !important; /* Ensure overflow is always auto for scrolling */
    /* Add this to prevent content from going outside its bounds if not already there */
    box-sizing: border-box; /* Include padding/border in element's total width/height */
}
  /* horizontal flex + snap */
  #pdf-viewer-container {
    display: flex;
    flex-direction: row;
    width: 100vw;
    height: 100vh;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
  }

  /* each page is exactly one “slide” */
  #pdf-viewer-container .pdfViewer .page {
    flex: 0 0 100%;             /* take 100% of viewport-width */
    scroll-snap-align: center;  /* center each page in view */
    display: flex;
    justify-content: center;
    margin: 0;
  }

  /* canvas will scale to fit width exactly */
  #pdf-viewer-container .pdfViewer canvas {
    width: 100vw !important;    /* fill viewport width */
    height: auto !important;
    margin: 0;
  }
  
  /* Hide YouTube branding within iframes */
iframe[src*="youtube.com"] {
    position: relative; /* Needed for absolute positioning of children */
}
iframe[src*="youtube.com"].hide-yt-branding::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%; /* Cover the entire iframe */
    background-color: transparent; /* Make it invisible */
    z-index: 1; /* Place it above the YouTube player controls but below other elements */
    pointer-events: none; /* Allow clicks to pass through */
}
@media (max-width: 600px) {
    /* Adjust text-xl (for sm:text-2xl) if it's still too big.
       Your existing .text-2xl rule for mobile might already cover this.
       If not, add: */
    #page-sermon-detail h1 {
        font-size: 1.0rem !important; /* text-xl */
        line-height: 1.75rem !important; /* line-height-7 (like text-xl) */
    }
}

/* For Sermons Grid Layout - adjust min width to allow more columns */
.sermons-grid-layout {
    display: flex; /* Default to flex column for small screens */
    flex-direction: column;
    gap: 1rem; /* Smaller gap on mobile */
    padding: 0.5rem; /* Reduced padding on mobile */
}

@media (min-width: 768px) { /* For medium screens (md breakpoint) and up */
    .sermons-grid-layout {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Increased min-width for larger cards */
        gap: 1.5rem; /* Standard gap for larger screens */
        padding: 1rem; /* Standard padding for larger screens */
    }
}

@media (min-width: 1024px) { /* For large screens (lg breakpoint) and up */
    .sermons-grid-layout {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* Even larger min-width for wider screens */
        gap: 2rem; /* Larger gap for very large screens */
    }
}

/* Ensure the sermon card itself stretches correctly within the grid */
.sermon-card {
    width: 100%; /* Make sure card fills its grid column */
    box-sizing: border-box; /* Include padding in width */
}
#page-sermon-detail .max-w-4xl.mx-auto {
    width: 100%; /* Allow it to fill the column space */
    max-width: 100%; /* Override max-width so it can fill for mobile */
    padding-left: 0; /* Remove default padding here as it's applied to scroll-content */
    padding-right: 0;
}

@media (min-width: 768px) {
    #page-sermon-detail .max-w-4xl.mx-auto {
        max-width: 4xl; /* Re-apply max-width for larger screens */
        padding-left: 1rem; /* Re-apply appropriate padding for larger screens */
        padding-right: 1rem;
    }
}
/* For the video player on sermon detail page */
#page-sermon-detail .aspect-w-16.aspect-h-9 {
    width: 100%; /* Ensure the video container always takes full width of its parent */
	
}

/* Remove max-width from the main content wrapper on large screens, or specifically from the video's parent */
/* Option A: If the .max-w-4xl is affecting only the video, adjust it.
   If it affects the text too, we'll need to use a different approach. */
#page-sermon-detail .max-w-4xl.mx-auto {
    width: 100%;
    /* On mobile, allow the inner content (title, description) to have padding,
       but the video should still stretch */
    padding-left: 0.5rem; /* Small padding on mobile for entire content block */
    padding-right: 0.5rem; /* Small padding on mobile for entire content block */
}

@media (min-width: 768px) {
    #page-sermon-detail .max-w-4xl.mx-auto {
        /* The main content area (title, description, comments) should still be constrained for readability */
        max-width: 800px; /* Or max-w-4xl (approx 48rem/768px) for text, but not the video */
        margin-left: auto; /* Center it */
        margin-right: auto; /* Center it */
        padding-left: 1rem; /* Standard padding for larger screens */
        padding-right: 1rem;
    }
    
    /* NEW: Target the video player's direct parent if it's outside the text content constraint */
    /* This assumes the videoPlayerHTML is placed *before* the .max-w-4xl div in renderSermonDetailPage */
    #page-sermon-detail .video-player-fixed-top { /* Assuming this is the direct container for the iframe */
        max-width: 100%; /* Make sure it can expand */
        border-radius: 0; /* Optional: remove rounded corners for full width on top */
        box-shadow: none; /* Optional: remove shadow for full width */
    }

    /* If the video is truly outside the max-w-4xl container, you might need these */
    #page-sermon-detail > .aspect-w-16.aspect-h-9 { /* If the aspect-ratio div is a direct child of the page */
        width: 100%;
        max-width: 100%;
    }
}

/* Ensure the iframe itself always fills its container */
#page-sermon-detail iframe {
    width: 100%;
    height: 100%;
    display: block;
}
/* Container for the video player to ensure full width on all screen sizes */
#page-sermon-detail .sermon-video-wrapper {
    position: relative; /* Needed for padding-bottom trick */
    width: 100%;
    padding-bottom: 56.25%; /* 16:9 Aspect Ratio (9/16 = 0.5625) */
    height: 0; /* Ensures the padding-bottom trick works */
    overflow: hidden; /* Clips any overflow, important for rounded corners */
    /* Add some visual styling */
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    background-color: black; /* Background for black bars if video aspect is off, or during load */
    margin-bottom: 1rem; /* Space below the video */
}

/* Make the iframe fill its responsive parent */
#page-sermon-detail .sermon-video-wrapper iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 0; /* Remove iframe border */
}

/* Adjust the main content wrapper for sermons, ensuring it's centered and has padding */
#page-sermon-detail .sermon-content-wrapper {
    width: 100%;
    max-width: 900px; /* Max width for readability of text content, adjust as needed (e.g., 800px or 900px) */
    margin-left: auto;
    margin-right: auto;
    padding: 0 1rem; /* Horizontal padding for the text content on all screens */
    box-sizing: border-box; /* Include padding in width calculation */
}

/* Adjustments for Notification Modal */
#notification-modal .p-5 { /* This targets the direct child div of the modal overlay */
    /* Removed custom padding on this div. We will manage padding internally. */
    padding: 0 !important; /* Remove any padding that might be collapsing content */
    max-width: 900px !important; /* Make it wider, use !important to override */
    width: 95% !important; /* Take 95% width on all screens, adjusting max-width for desktop */
    box-sizing: border-box; /* Crucial: ensures padding is included in the element's total width/height */
}

/* Header for the modal */
#notification-modal .notification-modal-header {
    /* Previous styles are generally fine, ensure padding. */
    padding: 0.5rem; /* Consistent padding for the header */
    padding-top: 0.8rem; /* Small padding at the very top for visual comfort */
    border-bottom: 0.5px solid #e5e7eb;
    margin-bottom: 0.3; /* Space before content starts */
    background-color: var(--card-bg);
    position: sticky;
    top: 0;
    z-index: 10;
    /* Removed negative margins to avoid width issues */
    margin-left: 0;
    margin-right: 0;
}

/* Make the 'X' (close) button larger and ensure it's always visible */
#close-notification-modal-x {
    font-size: 2.0rem !important; /* Increased font size for bigger X icon */
    line-height: 1; /* Keep it vertically centered */
    padding: 0.25rem 0.5rem; /* Add a bit of padding for easier clicking */
    color: var(--text-muted); /* Ensure it's visible with theme */
    background: none;
    border: none;
    cursor: pointer;
}

/* Adjust the actual scrollable content area within the modal */
#notification-modal .modal-body-scrollable {
    padding: 0 1rem; /* Add horizontal padding here for the content */
    flex-grow: 1; /* Allow content to take up available height */
    overflow-y: auto; /* Ensure vertical scrolling */
}

/* Adjust text size within notification requests (red-marked area) */
#notification-modal .p-4.border.rounded-lg.mb-4 {
    padding: 0.75rem; /* Smaller padding around each request item for compactness */
    margin-bottom: 0.75rem; /* Smaller margin between items */
    background-color: var(--card-bg); /* Ensure card background for theme consistency */
}

#notification-modal .p-4.border.rounded-lg.mb-4 p {
    font-size: 0.75rem; /* text-sm: Base font size for paragraphs */
    line-height: 1.4; /* Adjust line-height for readability */
    color: var(--text-color); /* Ensure text is readable */
}

/* Specifically target the 'Name', 'Phone', 'Request' labels to be smaller */
#notification-modal .p-4.border.rounded-lg.mb-4 p strong {
    font-size: 0.8rem; /* Smaller font for the bold labels */
    color: var(--text-muted); /* Muted color for labels */
}

/* Adjust the actual values of Name, Phone, Request */
#notification-modal .p-4.border.rounded-lg.mb-4 p span {
    font-size: 0.875rem; /* text-sm: Standard text size for values */
    color: var(--text-color); /* Ensure text is readable */
}

/* Further adjust text within the bg-gray-100 sub-div for request details */
#notification-modal .p-4.border.rounded-lg.mb-4 .mt-2.p-2.bg-gray-100 p {
    font-size: 0.8rem; /* Even smaller font size for the detailed request text */
    line-height: 1.3;
    color: var(--text-color); /* Ensure text is readable */
}

/* Specific adjustment for the "No pending info update requests" text */
#notification-modal p.text-gray-500 { /* Or target by class if it has one */
    padding: 1rem; /* Add padding around this specific message */
    text-align: center;
    color: var(--text-muted) !important; /* Ensure it's muted in all themes */
}

/* Ensure the heading "Pending Prayer Requests" gets horizontal padding */
#notification-modal .text-lg.font-medium.mb-2 {
    padding: 0 1rem; /* Match scrollable content padding */
}


/* Hymn Detail Page - Title Size */
/* Ensure text sizes for hymn detail title are adjusted for mobile */
#page-hymn-detail h1 {
    font-size: 1.2rem; /* Default for larger screens */
    line-height: 2rem;
    margin-bottom: 0.5rem; /* Adjust margin */
}

@media (max-width: 600px) {
    #page-hymn-detail h1 {
        font-size: 1.0rem !important; /* Smaller on very small screens (text-xl equivalent) */
        line-height: 1.2rem !important;
    }
}

/* Hymn Detail Page - Back Button (icon only) */
#hymn-detail-back-btn {
    padding: 0.5rem !important; /* Make the button area bigger for touch */
    font-size: 2.0rem; /* Larger icon */
    line-height: 1; /* Center icon vertically */
}
/* Hide the text part of the back button if it exists as a separate span */
#hymn-detail-back-btn span {
    display: none;
}
/* Ensure the icon for the back button is visible */
#hymn-detail-back-btn i.fa-arrow-left {
    margin-right: 0 !important; /* Remove margin if no text */	
}

/* Hymns Library - Top Filter Bar Layout */
#page-hymns .flex-row.flex-wrap { /* Target the main filter bar container */
    flex-wrap: nowrap; /* CRITICAL: Prevent wrapping to keep on one line */
    justify-content: space-between; /* Space out items */
    gap: 0.5rem; /* Tighter gap on mobile */
    align-items: center; /* Vertically align items */
    
    /* Ensure it can scroll horizontally if needed on very small screens */
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 0.5rem; /* Add some padding if it scrolls */
}

@media (max-width: 600px) {
    #page-hymns .flex-row.flex-wrap {
        flex-wrap: nowrap; /* Prevent wrapping on very small screens to keep on one line */
        overflow-x: auto; /* Allow horizontal scrolling if items are too wide */
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        padding-bottom: 0.5rem; /* Add some padding if it scrolls */
        justify-content: flex-start; /* Start from left on small screens */
    }
    #page-hymns .flex-grow { /* Search box */
        flex: 1 1 auto; /* Allow search box to grow, but shrink too */
        min-width: 100px; /* Minimum width for search box */
    }
    #page-hymns .flex-shrink-0 { /* Filter dropdown and Favorites button */
        flex-shrink: 0; /* Prevent these from shrinking */
        width: auto; /* Width adapts to content */
    }
	#hymn-detail-back-btn {
		padding: 0.5rem !important; /* Make the button area bigger for touch */
		font-size: 1.5rem !important; /* Larger icon */
		line-height: 1; /* Center icon vertically */
	}
    /* Specific adjustments for filter dropdown and favorites button to be compact */
    #hymn-filter-by {
        padding-left: 0.3rem !important; /* Very reduced padding */
        padding-right: 0.3rem !important;
        font-size: 0.7rem !important; /* Smaller text size for dropdown */
    }
    #view-favorite-hymns-btn {
        padding: 0.3rem 0.5rem !important; /* Reduced padding to fit icon + count */
        font-size: 0.7rem !important; /* Smaller text for count */
        white-space: nowrap; /* Prevent text wrapping */
        min-width: unset !important; /* Remove min-width if any */
    }
    #view-favorite-hymns-btn .fa-star {
        margin-right: 0.25rem !important; /* Small margin between icon and count */
    }
    #hymn-favorites-count {
        display: none; /* Hide count text on very small screens if space is critical */
    }

}
/* Hide specific parts of the hymn list card preview */
#hymns-list-container .hymn-card-subtitle {
    display: none; /* Hide the "Doh is Ab." line */
}
/* Adjust the .hymn-card p to start from verse 1 */
#hymns-list-container .hymn-card-preview p {
    margin-top: 0.25rem; /* Reduce top margin if needed */
    line-height: 1.4; /* Adjust line height for readability */
}

/* Hymn Content Page - Body Font Size */
#hymn-detail-text p {
    font-size: 1em; /* Default font size for hymn text */
    line-height: 1.6;
    margin-bottom: 0.5rem; /* Default paragraph spacing */
}

/* Ensure the plus/minus buttons are styled */
#hymn-font-decrease-btn, #hymn-font-increase-btn {
    /* Existing styles are good for shape/border/color. Just make sure background is white. */
    background-color: var(--card-bg) !important; /* Force white background for buttons */
    border: 1px solid var(--text-muted); /* Light border */
    color: var(--text-color); /* Theme text color */
    box-shadow: 0 1px 2px rgba(0,0,0,0.05); /* Subtle shadow */
    transition: background-color 0.2s ease;
}
#hymn-font-decrease-btn:hover, #hymn-font-increase-btn:hover {
    background-color: var(--bg-color) !important; /* Force lighter background on hover */
}

/* Add !important to existing color code rules if they are being overridden */
#hymn-detail-text .doh-line {
    color: #4CAF50 !important; /* Green for "Doh is" */
    font-weight: bold;
    font-style: italic;
    font-size: 0.95rem; /* Slightly smaller than main text */
    margin-bottom: 0.75rem; /* More space below Doh line */
}

#hymn-detail-text .verse-number {
    color: #2196F3 !important; /* Blue for verse numbers */
    font-weight: bold;
    font-size: 1.1rem; /* Slightly larger for emphasis */
    margin-right: 0.25rem; /* Space between number and text */
}

#hymn-detail-text .chorus-label {
    color: #FFC107 !important; /* Amber/Yellow for "CHO:" */
    font-weight: bold;
    font-style: italic;
    font-size: 1.05rem; /* Slightly larger than main text */
    display: block; /* Ensure it takes its own line */
    margin-top: 1rem; /* Space above chorus */
    margin-bottom: 0.5rem; /* Space below chorus label */
}
/* Hymns List View - Title Text Size & Truncation */
#hymns-list-container h3 {
    overflow: hidden;    /* Hides overflowing content */
    /* Adjust font size for mobile directly here if needed, or rely on general mobile overrides */
    font-size: 1.125rem; /* text-lg is 1.125rem (18px) by default. Adjust to be smaller. */
}

@media (max-width: 600px) {
    #hymns-list-container h3 {
        font-size: 0.85rem !important; /* Smaller font size for mobile (16px) */
        line-height: 1.0rem !important; /* Adjust line height accordingly */
        /* Ensure truncation properties are active */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

}

/* Voting Page - Card Styling */
/* Voting Page - Card Styling */
.voting-card {
    border-radius: 0.75rem; /* Rounded corners */
    box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* Subtle shadow */
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    background-color: var(--card-bg); /* Theme-aware background */
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Ensures inner content respects border-radius */
    cursor: pointer; /* Indicates interactivity */
}

/* Add a border color based on status */
.voting-card.active-border { border-top: 4px solid #10B981; } /* Tailwind green-500 */
.voting-card.pending-border { border-top: 4px solid #F59E0B; } /* Tailwind yellow-500 */
.voting-card.ended-border { border-top: 4px solid #EF4444; }   /* Tailwind red-500 */

/* Header within the card */
.voting-card-header {
    padding: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--text-muted, #e5e7eb); /* Thin separator */
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
}

/* Status badge within the card header */
.voting-card-status-badge {
    font-size: 0.7rem; /* Smaller text for badge */
    padding: 0.25rem 0.6rem;
    border-radius: 9999px; /* Fully rounded */
    font-weight: 600;
    white-space: nowrap; /* Prevent text wrap */
}

/* Main content body of the card */
.voting-card-body {
    padding: 1rem;
    flex-grow: 1; /* Allows body to take remaining space */
}

/* Footer of the card (for countdown/main button) */
.voting-card-footer {
    padding: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--text-muted, #e5e7eb); /* Separator */
    display: flex;
    flex-direction: column; /* Stack elements in footer */
    gap: 0.75rem; /* Space between buttons/countdown */
    align-items: center; /* Center horizontally */
}

/* Editor control buttons within the card footer */
.voting-card-editor-controls {
    display: flex;
    justify-content: flex-end; /* Align buttons to the right */
    gap: 0.75rem; /* Space between buttons */
    width: 100%; /* Take full width of footer */
    padding-top: 0.75rem; /* Space above editor buttons */
    border-top: 1px solid var(--text-muted, #e5e7eb);
}

/* Specific styling for vote/report buttons */
.voting-card-footer button {
    font-size: 0.9rem;
    font-weight: 600;
    padding: 0.6rem 1.25rem;
    border-radius: 0.5rem;
    width: 100%; /* Make action buttons full width within footer */
}

/* Responsive adjustments for smaller screens (if needed) */
@media (max-width: 600px) {
    .voting-card-header, .voting-card-body, .voting-card-footer {
        padding: 0.75rem; /* Slightly less padding on very small screens */
    }
}

/* Voting Page - Overall Category Card Styling */
.voting-category-card {
    background-color: var(--card-bg); /* Use theme's card background */
    border-radius: 0.75rem; /* Match general card rounding */
    box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* Standard shadow */
    padding: 1.5rem; /* Padding inside the category card */
    display: flex;
    flex-direction: column;
    gap: 0.5rem; /* Space between header and grid */
}

.voting-category-header {
    display: flex;
    align-items: center;
    gap: 0.5rem; /* Space between icon/checkbox and title */
    padding-bottom: 0.5rem; /* Space below header text */
    border-bottom: 1px solid var(--text-muted, #e5e7eb); /* Separator line */
    margin-bottom: 0.5rem; /* Space below the line */
}

/* Ensure headings within category cards use theme colors */
.voting-category-header h2, .voting-category-header label {
    color: var(--text-color);
	font-size: 1.0rem !important;
}

/* Ensure the grid gap is applied within these new category cards */
.voting-category-card .grid {
    gap: 0.5rem; /* Adjust gap between individual session cards within the category */
}
/* Ensure table behaves well within its scrollable container */
#financial-logs-list-container table {
    table-layout: auto; /* Allow column widths to adjust to content */
    min-width: 600px; /* Set a minimum width for the table to ensure scrolling on small screens */
    /* Or, if you want columns to be strict and wrap content: */
    /* table-layout: fixed; */
    /* width: 100%; */
}
/* Ensure table cells don't overflow with long text */
#financial-logs-list-container td,
#financial-logs-list-container th {
    word-break: break-word; /* Break long words if necessary */
    /* white-space: nowrap; */ /* Only if you prefer all content on one line within a cell */
}

    </style>
</head>
<body class="antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-6 space-y-5">
            <div class="text-center">
                <h2 class="text-2xl font-bold text-gray-900">Welcome</h2>
                <p class="mt-2 text-sm text-gray-600">Please enter your name and passcode to continue.</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-name" class="block text-sm font-medium text-gray-700">Your Name</label>
                    <input type="text" id="login-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="login-passcode" class="block text-sm font-medium text-gray-700">Passcode</label>
                    <input type="password" id="login-passcode" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <p id="login-error" class="text-sm text-red-600 hidden">Invalid passcode. Please try again.</p>
                <div>
                    <button type="submit" id="login-submit-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Login
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App Wrapper -->
    <div id="app-wrapper" class="hidden">
        
        <!-- Sidebar -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden"></div>
        <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 text-white p-4 z-50 transform -translate-x-full lg:translate-x-0 flex flex-col">
            <!-- User Banner -->
            <div class="flex items-center p-4 border-b border-gray-700">
                <input type="file" id="user-profile-pic-input" class="hidden" accept="image/*">
                <button id="user-profile-pic-btn" class="flex-shrink-0">
                    <img id="user-profile-pic" src="" alt="User Profile" class="profile-pic user-profile-pic rounded-full object-cover border-2 border-gray-500">
                    <div id="user-profile-placeholder" class="profile-pic-placeholder user-profile-pic rounded-full border-2 border-gray-500 hidden">
                        <i class="fas fa-user"></i>
                    </div>
                </button>
                <div class="flex-grow flex items-center justify-between ml-3">
                    <h3 id="user-name-display" class="font-semibold text-base truncate"></h3>
                    <button id="edit-mode-toggle-btn" class="hidden text-xl p-2 rounded-full hover:bg-white/20" title="Toggle Edit Mode">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </div>
            </div>
            
            <!-- Navigation -->
            <nav id="nav-tabs" class="flex-grow mt-6 space-y-2 overflow-y-auto">
                <a href="#" data-page="home" class="sidebar-nav-link"><div class="link-content"><i class="fas fa-home icon-home"></i> Home</div></a>
				<a href="#" data-page="edit-my-profile" id="edit-my-profile-nav-btn" class="sidebar-nav-link hidden"><div class="link-content"><i class="fas fa-user-edit icon-user-edit"></i> Edit My Profile</div></a>
                <a href="#" data-page="ministers" class="sidebar-nav-link"><div class="link-content"><i class="fas fa-cross icon-ministers"></i> Ministers</div></a>
                <a href="#" data-page="events" class="sidebar-nav-link">
					<div class="link-content">
						<i class="fas fa-calendar-alt icon-events"></i> Events
						<span id="events-notification-badge" class="notification-badge hidden"></span> </div>
				</a>
                <a href="#" data-page="favorites" class="sidebar-nav-link"><div class="link-content"><i class="fas fa-star icon-favorites"></i> Favorites</div> <span id="count-favorites"></span></a>
                
                <!-- Collapsible Groups Section -->
                <div class="collapsible-header" data-page="groups">
                    <div class="link-content"><i class="fas fa-users icon-groups"></i> Groups</div>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div id="group-collapsible-content" class="collapsible-content">
                    <a href="#" data-page="groupA" class="sidebar-nav-link"><div class="link-content">Group A</div> <span id="count-groupA"></span></a>
                    <a href="#" data-page="groupB" class="sidebar-nav-link"><div class="link-content">Group B</div> <span id="count-groupB"></span></a>
                    <a href="#" data-page="groupC" class="sidebar-nav-link"><div class="link-content">Group C</div> <span id="count-groupC"></span></a>
                    <a href="#" data-page="groupD" class="sidebar-nav-link"><div class="link-content">Group D</div> <span id="count-groupD"></span></a>
                </div>
                <!-- End Collapsible Groups Section -->
                <a href="#" data-page="give" class="sidebar-nav-link"><div class="link-content"><i class="fas fa-hand-holding-usd icon-give"></i> Give</div></a>
                <a href="#" data-page="prayer-request" class="sidebar-nav-link"><div class="link-content"><i class="fas fa-hands-praying icon-prayer"></i> Prayer Request</div></a>
				<a href="#" data-page="prayer-wall" class="sidebar-nav-link">
					<div class="link-content">
						<i class="fas fa-praying-hands icon-prayer"></i> Prayer Wall
						<span id="prayer-wall-count" class="notification-badge hidden"></span>
					</div>
				</a>
				<a href="#" data-page="sermons" class="sidebar-nav-link">
					<div class="link-content">
						<i class="fas fa-book-bible icon-give"></i> Sermons
						<span id="sermon-notification-badge" class="notification-badge hidden"></span>
					</div>
				</a>
				<a href="#" data-page="hymns" class="sidebar-nav-link"><div class="link-content"><i class="fas fa-music icon-hymns"></i> Hymns</div></a>
				<a href="#" data-page="voting" id="voting-nav-btn" class="sidebar-nav-link">
					<div class="link-content">
						<i class="fas fa-vote-yea icon-favorites"></i> Voting
						<span id="voting-live-badge" class="notification-badge hidden" style="background-color: #16a34a; font-size: 0.7rem; padding: 0.1rem 0.4rem; margin-left: 8px;">Live</span>
					</div>
				</a>
                <a href="#" data-page="register" id="register-nav-btn" class="sidebar-nav-link hidden"><div class="link-content"><i class="fas fa-user-plus icon-register"></i> Register</div></a>
				<a href="#" data-page="user-management" id="user-management-nav-btn" class="sidebar-nav-link hidden"><div class="link-content"><i class="fas fa-users-cog icon-users-cog"></i> User Management</div></a>
                <a href="#" data-page="reports" id="reports-nav-btn" class="sidebar-nav-link"><div class="link-content"><i class="fas fa-chart-pie icon-reports"></i> Reports</div></a>
                 <a href="#" data-page="update-info" class="sidebar-nav-link"><div class="link-content"><i class="fas fa-edit icon-update"></i> Update Info</div></a>
                <a href="#" id="settings-btn" class="sidebar-nav-link"><div class="link-content"><i class="fas fa-cog icon-settings"></i> Settings</div></a>
                <a href="#" id="theme-switcher-btn" class="sidebar-nav-link"><div class="link-content"><i class="fas fa-palette icon-theme"></i> Themes</div></a>
            </nav>

            <!-- Logout Button -->
            <div class="mt-auto pt-4 border-t border-gray-700">
                <button id="logout-btn" class="w-full sidebar-nav-link text-left hover:bg-red-700">
                    <div class="link-content"><i class="fas fa-sign-out-alt"></i> Logout</div>
                </button>
            </div>
        </aside>


        <div id="main-container" class="lg:ml-64 transition-all duration-300">
             <!-- Header -->
            <header id="header" class="shadow-md p-4 sticky top-0 z-30">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <button id="hamburger-btn" class="lg:hidden text-2xl mr-4">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 id="header-title" class="text-xl sm:text-2xl font-bold">CCC Member Directory</h1>
                    </div>
                    <div class="flex items-center gap-6">
                         <div id="notification-bell-container" class="relative hidden">
                            <button id="notification-btn" class="text-2xl"><i class="fas fa-bell"></i></button>
                            <span id="notification-badge" class="notification-badge hidden"></span>
                        </div>
                    </div>
                </div>
            </header>

             <!-- Dynamic Route Planner Bar -->
            <div id="route-planner-bar" class="hidden fixed bottom-0 left-0 w-full z-40 rounded-t-lg shadow-lg p-3 mx-auto my-0 flex flex-row items-center justify-between gap-2">
                <div class="flex-grow flex items-center gap-2 w-full sm:w-auto">
                    <p class="font-semibold text-sm sm:text-base text-center sm:text-left text-white">
                        <span id="selected-count">0</span> member(s) selected
                    </p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="plan-route-btn" class="font-bold py-1 px-3 sm:py-2 sm:px-4 rounded-lg shadow-md hover:opacity-80 text-xs sm:text-sm transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed white-space-nowrap">
                        Plan Route
                    </button>
                    <button id="clear-selection-btn" class="bg-red-500 text-white font-bold py-1 px-3 sm:py-2 sm:px-4 rounded-lg shadow-md hover:bg-red-600 text-xs sm:text-sm transition-colors duration-300">
                        Clear
                    </button>
                </div>
            </div>

            <!-- Main Content Area -->
            <main id="main-content" class="p-2 sm:p-4">
                <!-- Home Page -->
				<div id="page-home" class="page">
					<div class="slideshow-about-container">
						<div class="slideshow-container bg-gray-200">
							<a class="prev" onclick="plusSlides(-1)">❮</a>
							<a class="next" onclick="plusSlides(1)">❯</a>
						</div>
						<div class="slideshow-controls-outside">
							<div class="editor-only-section hidden">
								<button id="manage-slideshow-btn" class="btn-primary text-sm px-4 py-2 rounded-md">Manage Slideshow</button>
							</div>
						</div>
						<div class="mt-8 p-4 sm:p-6 rounded-xl shadow-md bg-white about-us-card"> <div class="flex justify-between items-center mb-4">
								<h3 class="text-lg font-semibold">About Us</h3>
								<div class="editor-only-section hidden">
									<button id="edit-about-directory-btn" class="btn-primary text-sm px-4 py-2 rounded-md">Edit</button>
								</div>
							</div>
							<div id="about-directory-content" class="prose max-w-none" style="color: var(--text-color);">
								</div>
						</div>
					</div>

					<!--- Post Section --->
					<div class="mt-8 p-4 sm:p-6 rounded-xl shadow-md bg-white posts-section-container">
						<div class="mb-4 p-4 rounded-lg" style="background-color: var(--card-bg);">
							<div class="flex flex-row flex-wrap items-center justify-between gap-2 sm:gap-4">
								<div class="relative flex-grow min-w-0" style="flex-basis: 40%;"> <label for="post-search-box" class="sr-only">Search Posts</label>
									<input type="search" id="post-search-box" placeholder="Search posts..."
										   class="block w-full pl-10 pr-8 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-900 text-sm">
									<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
										<i class="fas fa-search text-gray-400"></i>
									</div>
									<button type="button" id="clear-post-search" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700 hidden">
										<i class="fas fa-times-circle"></i>
									</button>
								</div>

								<div class="flex-grow min-w-0" style="flex-basis: 25%;"> <label for="post-sort-box" class="sr-only">Sort Posts By</label>
									<select id="post-sort-box"
											class="block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-900 text-sm">
										<option value="date-desc">Newest</option> <option value="date-asc">Oldest</option> <option value="views-desc">Views</option> <option value="title-asc">Title</option> <option value="author-asc">Author</option> </select>
								</div>

								<div class="flex-grow-0 flex-shrink-0"> <button id="view-saved-posts-btn" class="btn-primary text-white text-sm px-3 py-2 rounded-md w-full whitespace-nowrap">
										<i class="fas fa-bookmark mr-1 sm:mr-2"></i>Saved Posts
									</button>
								</div>
							</div>
						</div>
						<div class="flex justify-between items-center mb-4">
							<h3 class="text-lg font-semibold">Latest Posts</h3>
							<div class="editor-only-section hidden">
								<button id="add-post-btn" class="btn-primary text-sm px-4 py-2 rounded-md">Add New Post</button>
							</div>
						</div>
						<div id="posts-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
							</div>
					</div>
				</div>

					<!-- Post Details -->
					<div id="page-post-detail" class="page p-4 sm:p-6">
                    </div>

				<!-- Prayer Wall -->
				<div id="page-prayer-wall" class="page">
					<div id="prayer-wall-container" class="space-y-4 prayer-wall-grid-layout">
						</div>
				</div>
				
				<!-- Sermon Details -->
				<div id="page-sermon-detail" class="page p-2 sm:p-4">
					<button id="sermon-detail-back-btn" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium mb-4">
						<i class="fas fa-arrow-left mr-2"></i>Back to Sermons
					</button>
					</div>
				
				<!-- Sermons -->
                <div id="page-sermons" class="page p-2 sm:p-4">
                    <div class="editor-only-section hidden flex justify-end mb-4">
                        <button id="add-sermon-btn" class="btn-primary text-sm px-4 py-2 rounded-md">Add New Sermon</button>
                    </div>
						<div class="flex flex-wrap gap-4 mb-6 p-4 rounded-lg items-end" style="background-color: var(--card-bg);">
							<div class="relative flex-grow">
								<label for="sermon-search-box" class="sr-only">Search Sermons</label>
								<input type="search" id="sermon-search-box" placeholder="Search sermons..."
									   class="block w-full pl-10 pr-8 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-900">
								<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
									<i class="fas fa-search text-gray-400"></i>
								</div>
								<button type="button" id="clear-sermon-search" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700 hidden">
									<i class="fas fa-times-circle"></i>
								</button>
							</div>

							<div class="flex-shrink-0 relative mobile-filter-container">
								<label for="sermon-speaker-filter" class="sr-only">Filter by Speaker</label>
								<select id="sermon-speaker-filter"
										class="hidden md:block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-900">
									<option value="">All Speakers</option>
									</select>
								<button id="sermon-speaker-filter-mobile-btn" class="md:hidden block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm bg-white text-gray-900 text-sm">
									<i class="fas fa-user-circle mr-2"></i>Speakers <i class="fas fa-chevron-down ml-2"></i>
								</button>
							</div>

							<div class="flex-shrink-0 relative mobile-filter-container">
								<label for="sermon-sort-box" class="sr-only">Sort By</label>
								<select id="sermon-sort-box"
										class="hidden md:block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-900">
									<option value="date-desc">Newest First</option>
									<option value="date-asc">Oldest First</option>
									<option value="views-desc">Most Viewed</option>
									<option value="title-asc">Title (A-Z)</option>
									<option value="speaker-asc">Speaker (A-Z)</option>
								</select>
								<button id="sermon-sort-box-mobile-btn" class="md:hidden block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm bg-white text-gray-900 text-sm">
									<i class="fas fa-sort mr-2"></i>Sort By <i class="fas fa-chevron-down ml-2"></i>
								</button>
							</div>
						</div>

						<div id="sermon-speaker-modal" class="hidden fixed inset-0 z-50 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
							<div class="bg-white p-5 rounded-lg shadow-xl w-full max-w-sm" style="background-color: var(--card-bg);">
								<h3 class="text-lg font-bold mb-4">Filter by Speaker</h3>
								<ul id="sermon-speaker-modal-list" class="space-y-2 max-h-60 overflow-y-auto">
									</ul>
								<button id="close-speaker-modal" class="mt-4 w-full btn-primary py-2 rounded-md">Close</button>
							</div>
						</div>

						<div id="sermon-sort-modal" class="hidden fixed inset-0 z-50 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
							<div class="bg-white p-5 rounded-lg shadow-xl w-full max-w-sm" style="background-color: var(--card-bg);">
								<h3 class="text-lg font-bold mb-4">Sort Sermons</h3>
								<ul id="sermon-sort-modal-list" class="space-y-2">
									</ul>
								<button id="close-sort-modal" class="mt-4 w-full btn-primary py-2 rounded-md">Close</button>
							</div>
						</div>
					<div id="sermons-list-container" class="sermons-grid-layout"></div>
				</div>

			<!-- Voting -->
					<div id="page-voting" class="page p-4">
						<div class="flex flex-col gap-6"> <div class="voting-category-card">
								<div class="voting-category-header">
									<i class="fas fa-vote-yea text-2xl text-green-500"></i>
									<h2 class="text-xl font-bold">Active Voting Sessions</h2>
								</div>
								<div id="active-voting-sessions" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
									</div>
							</div>

							<div class="voting-category-card">
								<div class="voting-category-header">
									<i class="fas fa-hourglass-half text-2xl text-yellow-500"></i>
									<h2 class="text-xl font-bold">Pending Voting Sessions</h2>
								</div>
								<div id="pending-voting-sessions" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
									</div>
							</div>

							<div class="voting-category-card">
								<div class="voting-category-header">
									<input type="checkbox" id="toggle-expired" class="h-5 w-5 accent-red-500" />
									<label for="toggle-expired" class="text-xl font-bold cursor-pointer">Show Expired Sessions</label>
								</div>
								<div id="expired-voting-sessions" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 hidden">
									</div>
							</div>

						</div>
						<div class="editor-only-section hidden fixed bottom-6 right-6">
							<button id="create-voting-session-btn" class="bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-all p-4">
								<i class="fas fa-plus text-2xl"></i>
							</button>
						</div>
					</div>

					<div id="create-edit-vote-modal" class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-50">
					  <div class="bg-white p-6 rounded shadow-md max-w-md mx-auto mt-32">
						<h2 class="text-xl font-semibold mb-4">Create Voting Session</h2>
						<input id="vote-title" placeholder="Title" class="w-full border p-2 mb-2" />
						<input id="vote-description" placeholder="Description" class="w-full border p-2 mb-2" />
						<input id="vote-nominees" placeholder="Nominees (comma-separated)" class="w-full border p-2 mb-2" />
						<input id="vote-num-to-vote-for" type="number" placeholder="Number of votes allowed" class="w-full border p-2 mb-2" />
						<input id="vote-duration-days" type="number" placeholder="Voting duration (days)" class="w-full border p-2 mb-2" />
						<input id="vote-autostart-minutes" type="number" placeholder="Auto-start in (minutes, optional)" class="w-full border p-2 mb-4" />
						<div class="flex justify-end gap-2">
						  <button id="submit-vote-btn" class="btn-primary">Submit</button>
						  <button id="cancel-vote-btn" class="btn-secondary">Cancel</button>
						</div>
					  </div>
					</div>

                <!-- Group Pages -->
                <div id="page-favorites" class="page">
                 <!--   <h2 class="text-xl sm:text-2xl font-bold mb-4">Favorite Members</h2> -->
                    <div id="member-list-favorites" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
                </div>
                <div id="page-groupA" class="page">
					<div class="sticky top-0 z-10 p-4 sm:p-4 rounded-b-lg shadow-md flex flex-col sm:flex-row justify-between items-center mb-4 gap-3" style="background-color: var(--bg-color);">
						<h2 class="text-xl sm:text-2xl font-bold">Group A Members <span id="member-count-groupA-header" class="text-sm sm:text-base font-medium text-gray-500"></span></h2>
						<div class="flex items-center gap-2 w-full sm:w-auto">
							<select data-group="A" class="display-mode-selector block w-auto px-3 py-1 text-xs sm:text-sm bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
								<option value="nameOnly" ${displayMode === 'nameOnly' ? 'selected' : ''}>Name Only</option>
								<option value="simpleList" ${displayMode === 'simpleList' ? 'selected' : ''}>Simple List</option>
								<option value="individualDetailList" ${displayMode === 'individualDetailList' ? 'selected' : ''}>Individual Detail</option>
								<option value="simpleFamily" ${displayMode === 'simpleFamily' ? 'selected' : ''}>Simple Family</option>
								<option value="familyDetails" ${displayMode === 'familyDetails' ? 'selected' : ''}>Family Details</option>
								<option value="familyWithPictures" ${displayMode === 'familyWithPictures' ? 'selected' : ''}>Family w/ Pics</option>
							</select>
							<input type="search" data-group="A" class="search-box block w-full px-3 py-1 text-xs sm:text-sm bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Search...">
							<div class="editor-only-section hidden"><input type="file" class="import-json-input hidden" accept=".json" data-group="A"><button type="button" class="import-icon-btn" title="Import from JSON">+</button></div>
						</div>
					</div>
                    <div id="member-list-groupA" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
                </div>
                <div id="page-groupB" class="page">
					<div class="sticky top-0 z-10 p-4 sm:p-4 rounded-b-lg shadow-md flex flex-col sm:flex-row justify-between items-center mb-4 gap-3" style="background-color: var(--bg-color);">
						<h2 class="text-xl sm:text-2xl font-bold">Group B Members <span id="member-count-groupB-header" class="text-sm sm:text-base font-medium text-gray-500"></span></h2>
						<div class="flex items-center gap-2 w-full sm:w-auto">
							<select data-group="B" class="display-mode-selector block w-auto px-3 py-1 text-xs sm:text-sm bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
								<option value="nameOnly" ${displayMode === 'nameOnly' ? 'selected' : ''}>Name Only</option>
								<option value="simpleList" ${displayMode === 'simpleList' ? 'selected' : ''}>Simple List</option>
								<option value="individualDetailList" ${displayMode === 'individualDetailList' ? 'selected' : ''}>Individual Detail</option>
								<option value="simpleFamily" ${displayMode === 'simpleFamily' ? 'selected' : ''}>Simple Family</option>
								<option value="familyDetails" ${displayMode === 'familyDetails' ? 'selected' : ''}>Family Details</option>
								<option value="familyWithPictures" ${displayMode === 'familyWithPictures' ? 'selected' : ''}>Family w/ Pics</option>
							</select>
							<input type="search" data-group="B" class="search-box block w-full px-3 py-1 text-xs sm:text-sm bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Search...">
							<div class="editor-only-section hidden"><input type="file" class="import-json-input hidden" accept=".json" data-group="B"><button type="button" class="import-icon-btn" title="Import from JSON">+</button></div>
						</div>
					</div>
                    <div id="member-list-groupB" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
                </div>
                <div id="page-groupC" class="page">
					<div class="sticky top-0 z-10 p-4 sm:p-4 rounded-b-lg shadow-md flex flex-col sm:flex-row justify-between items-center mb-4 gap-3" style="background-color: var(--bg-color);">
						<h2 class="text-xl sm:text-2xl font-bold">Group C Members <span id="member-count-groupC-header" class="text-sm sm:text-base font-medium text-gray-500"></span></h2>
						<div class="flex items-center gap-2 w-full sm:w-auto">
							<select data-group="C" class="display-mode-selector block w-auto px-3 py-1 text-xs sm:text-sm bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
								<option value="nameOnly" ${displayMode === 'nameOnly' ? 'selected' : ''}>Name Only</option>
								<option value="simpleList" ${displayMode === 'simpleList' ? 'selected' : ''}>Simple List</option>
								<option value="individualDetailList" ${displayMode === 'individualDetailList' ? 'selected' : ''}>Individual Detail</option>
								<option value="simpleFamily" ${displayMode === 'simpleFamily' ? 'selected' : ''}>Simple Family</option>
								<option value="familyDetails" ${displayMode === 'familyDetails' ? 'selected' : ''}>Family Details</option>
								<option value="familyWithPictures" ${displayMode === 'familyWithPictures' ? 'selected' : ''}>Family w/ Pics</option>
							</select>
							<input type="search" data-group="C" class="search-box block w-full px-3 py-1 text-xs sm:text-sm bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Search...">
							<div class="editor-only-section hidden"><input type="file" class="import-json-input hidden" accept=".json" data-group="C"><button type="button" class="import-icon-btn" title="Import from JSON">+</button></div>
						</div>
					</div>
                    <div id="member-list-groupC" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
                </div>
                <div id="page-groupD" class="page">
					<div class="sticky top-0 z-10 p-4 sm:p-4 rounded-b-lg shadow-md flex flex-col sm:flex-row justify-between items-center mb-4 gap-3" style="background-color: var(--bg-color);">
						<h2 class="text-xl sm:text-2xl font-bold">Group D Members <span id="member-count-groupD-header" class="text-sm sm:text-base font-medium text-gray-500"></span></h2>
						<div class="flex items-center gap-2 w-full sm:w-auto">
							<select data-group="D" class="display-mode-selector block w-auto px-3 py-1 text-xs sm:text-sm bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
								<option value="nameOnly" ${displayMode === 'nameOnly' ? 'selected' : ''}>Name Only</option>
								<option value="simpleList" ${displayMode === 'simpleList' ? 'selected' : ''}>Simple List</option>
								<option value="individualDetailList" ${displayMode === 'individualDetailList' ? 'selected' : ''}>Individual Detail</option>
								<option value="simpleFamily" ${displayMode === 'simpleFamily' ? 'selected' : ''}>Simple Family</option>
								<option value="familyDetails" ${displayMode === 'familyDetails' ? 'selected' : ''}>Family Details</option>
								<option value="familyWithPictures" ${displayMode === 'familyWithPictures' ? 'selected' : ''}>Family w/ Pics</option>
							</select>
							<input type="search" data-group="D" class="search-box block w-full px-3 py-1 text-xs sm:text-sm bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Search...">
							<div class="editor-only-section hidden"><input type="file" class="import-json-input hidden" accept=".json" data-group="D"><button type="button" class="import-icon-btn" title="Import from JSON">+</button></div>
						</div>
					</div>
                    <div id="member-list-groupD" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
                </div>
                
                <!-- Ministers Page -->
                <div id="page-ministers" class="page">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
                    <!--    <h2 class="text-xl sm:text-2xl font-bold">Our Ministers</h2>  -->
                        <div class="editor-only-section hidden">
                            <button id="add-minister-btn" class="btn-primary text-sm px-4 py-2 rounded-md">Add Minister</button>
                        </div>
                    </div>
                    <div id="ministers-list-container" class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        <!-- Minister 3D cards will be rendered here -->
                    </div>
                </div>
				
                <!-- Events Page -->
                <div id="page-events" class="page">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
                   <!--     <h2 class="text-xl sm:text-2xl font-bold">Upcoming Events</h2>  -->
                        <div class="editor-only-section hidden">
                            <button id="add-event-btn" class="btn-primary text-sm px-4 py-2 rounded-md">Add New Event</button>
                        </div>
                    </div>
                    <div id="events-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        <!-- Event cards will be rendered here -->
                    </div>
                </div>
				
                <!-- Give Page -->
                <div id="page-give" class="page">
               <!--     <h2 class="text-xl sm:text-2xl font-bold mb-4">Give to the Church</h2> -->
                    <div class="p-4 sm:p-6 rounded-xl shadow-md" style="background-color: var(--card-bg);">
                        <p class="text-sm text-gray-700 mb-4">Thawhlawm, Cheuhra Cheukhat, Mission ca, Building ca, CE ca le Mino ca ti bantuk in pek duh mi paoh cu a tanglei Zelle ah hin kuat khawh a si lai. Kuat tikah pek hnawh chan mi kha fiang tein note tial piak chih i zuam hna usih.</p><p class="text-sm text-gray-700 mb-4"> Petu dihlak Bawipa tu nih a let in thluachuah in pe ko hna seh.</p>
                        <form id="give-form" class="space-y-4">
  
                            <div class="form-section">
                                <h3 class="form-section-title">Zelle Information</h3>
                                <p class="text-sm text-gray-700 mb-2">Please send your Zelle payment to the recipient below via your banking app.</p>
                                <p id="zelle-recipient-display" class="text-base text-gray-800">
                                    Recipient: <span id="zelle-name">Loading...</span><br>
                                    Email/Phone: <span id="zelle-contact">Loading...</span>
                                </p>
                                <div class="editor-only-section hidden mt-4">
                                    <button type="button" id="edit-zelle-btn" class="btn-primary text-sm px-4 py-2 rounded-md">Edit Zelle Info</button>
                                </div>
                            </div>
                            <div class="mt-4 text-center">
                                <p class="text-sm text-gray-500">We do not process payments directly through this app.</p>
                            </div>
                            <div class="editor-only-section hidden mt-4">
                                <button type="button" id="edit-online-payment-link-btn" class="btn-primary text-sm px-4 py-2 rounded-md">Edit Online Payment Link</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Prayer Request Page -->
                <div id="page-prayer-request" class="page">
               <!--     <h2 class="text-xl sm:text-2xl font-bold mb-4">Submit a Prayer Request</h2> -->
                    <div class="p-4 sm:p-6 rounded-xl shadow-md" style="background-color: var(--card-bg);">
                        <form id="prayer-request-form" class="space-y-4">
                            <div>
                                <label for="prayer-name" class="block text-sm font-medium text-gray-700">Your Name (Optional)</label>
                                <input type="text" id="prayer-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="prayer-phone" class="block text-sm font-medium text-gray-700">Your Phone (Optional)</label>
                                <input type="tel" id="prayer-phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="prayer-request-text" class="block text-sm font-medium text-gray-700">Your Prayer Request</label>
                                <textarea id="prayer-request-text" rows="5" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Type your prayer request here..."></textarea>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="share-prayer-publicly" name="share-prayer-publicly" type="checkbox" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="share-prayer-publicly" class="font-medium text-gray-700">Share on the public Prayer Wall</label>
                                    <p class="text-gray-500">Mah ka hi na check ahcun thlacam na request mi kha member zapi sin ah a lang lai.</p>
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button type="submit" class="btn-primary text-white px-4 py-2 rounded-md">Submit Prayer Request</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Register Page -->
                <div id="page-register" class="page">
                <!--    <h2 class="text-2xl font-bold mb-4">Register New Household</h2> -->
                    <div class="p-4 sm:p-6 rounded-xl shadow-md"><form id="register-form" class="space-y-3"></form></div>
                </div>
				
                <div id="page-user-management" class="page p-4 space-y-6">
                    <div>
                        <h2 class="text-2xl font-bold">User Roles & Departments</h2>
                        <p class="text-sm text-gray-500">Assign users to roles within each department.</p>
                    </div>

                    <div id="department-cards-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        </div>
                </div>
				
				<!-- Edit My Profile Page -->
				<div id="page-edit-my-profile" class="page p-2 sm:p-4">
					<h2 class="text-xl sm:text-2xl font-bold mb-4">Edit My Profile</h2>
					<p class="text-sm text-gray-600 mb-4">Update your personal and household information here. Changes will apply to your entire household.</p>

					<div id="profile-verification-step1" class="p-4 sm:p-6 rounded-xl shadow-md" style="background-color: var(--card-bg);">
						<h3 class="text-lg font-semibold mb-3">Verify Your Identity</h3>
						<p class="text-sm text-gray-700 mb-4">Please enter your full name and phone number to receive a verification code.</p>
						<form id="verify-identity-form" class="space-y-4">
							<div>
								<label for="verify-full-name" class="block text-sm font-medium">Full Name</label>
								<input type="text" id="verify-full-name" required class="mt-1 block w-full px-3 py-2 border rounded-md">
							</div>
							<div>
								<label for="verify-phone-number" class="block text-sm font-medium">Phone Number</label>
								<input type="tel" id="verify-phone-number" required class="mt-1 block w-full px-3 py-2 border rounded-md" placeholder="e.g., +11234567890">
							</div>
							<p id="verify-identity-error" class="text-sm text-red-600 hidden"></p>
							<div id="recaptcha-container" class="mt-4"></div> <div class="flex justify-end mt-4">
								<button type="submit" id="send-code-btn" class="btn-primary text-white px-4 py-2 rounded-md">Send Verification Code</button>
							</div>
						</form>
					</div>

					<div id="profile-verification-step2" class="hidden p-4 sm:p-6 rounded-xl shadow-md mt-4" style="background-color: var(--card-bg);">
						<h3 class="text-lg font-semibold mb-3">Enter Verification Code</h3>
						<p class="text-sm text-gray-700 mb-4">A 6-digit code has been sent to your phone number.</p>
						<form id="confirm-code-form" class="space-y-4">
							<div>
								<label for="verification-code" class="block text-sm font-medium">Verification Code</label>
								<input type="text" id="verification-code" required maxlength="6" class="mt-1 block w-full px-3 py-2 border rounded-md text-center text-lg font-bold tracking-widest">
							</div>
							<p id="confirm-code-error" class="text-sm text-red-600 hidden"></p>
							<div class="flex justify-end mt-4">
								<button type="button" id="resend-code-btn" class="text-sm px-3 py-2 rounded-md text-indigo-600 hover:text-indigo-800">Resend Code</button>
								<button type="submit" id="confirm-code-btn" class="btn-primary text-white px-4 py-2 rounded-md ml-3">Confirm Identity</button>
							</div>
						</form>
					</div>

					<div id="edit-my-profile-section" class="hidden p-4 sm:p-6 rounded-xl shadow-md mt-4" style="background-color: var(--card-bg);">
						<form id="edit-my-profile-form" class="space-y-4">
							</form>
					</div>
				</div>
				
                <!-- Update Info Page -->
                <div id="page-update-info" class="page">
                <!--     <h2 class="text-2xl font-bold mb-4">Request Information Update</h2> -->
                     <form id="update-info-form" class="p-4 sm:p-6 rounded-xl shadow-md space-y-6"></form>
                </div>
				
                <!-- Reports Page -->
			<div id="page-reports" class="page p-2 sm:p-4 space-y-4">
				<!-- Report Category Selector and Filter Toggle -->
				<div id="report-controls-header" class="p-3 rounded-xl shadow-lg" style="background-color: var(--card-bg);">
					<div class="flex items-center justify-between">
						<div class="flex-grow">
							<label for="report-category-selector" class="block text-sm font-medium text-slate-700">Report Category</label>
							<select id="report-category-selector" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base">
								<option value="members">Members & Demographics</option>
								<option value="financials">Financial Reports</option>
								<option value="meetings">Meeting Reports</option>
								<option value="financial_logs">Financial Activity Log</option> 
								<option value="others" disabled>Others (Coming Soon)</option>
							</select>
						</div>
						<!-- This button will toggle the financial filters -->
						<button id="financial-filter-toggle-btn" class="hidden ml-4 p-2 text-slate-500">
							<i class="fas fa-chevron-down text-lg transition-transform"></i>
						</button>
					</div>

					<!-- Collapsible Filters Container -->
					<div id="financial-filters-container" class="hidden mt-3 pt-3 border-t border-gray-200">
						<div class="flex flex-wrap items-end gap-3">
							<!-- Department Selector -->
							<div class="flex-grow min-w-[150px]">
								<label for="department-selector" class="block text-xs font-medium text-slate-700">Department</label>
								<select id="department-selector" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm text-sm">
									<option value="church">Church Treasurer</option>
									<option value="nubu">Nubu Treasurer</option>
									<option value="mino">Mino Treasurer</option>
									<option value="ce">CE Treasurer</option>
									<option value="building">Building Treasurer</option>
									<option value="mission">Mission Treasurer</option>
									<option value="nunphung_zatlang">Nunphung le Zatlang</option>
								</select>
							</div>
							<!-- Timeframe Selector -->
							<div class="flex-grow min-w-[150px]">
								<label for="timeframe-selector" class="block text-xs font-medium text-slate-700">Timeframe</label>
								<select id="timeframe-selector" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm text-sm">
									<option value="this_week">This Week</option>
									<option value="last_week">Last Week</option>
									<option value="this_month" selected>This Month</option>
									<option value="last_month">Last Month</option>
									<option value="last_year">Last Year</option>
									<option value="custom_range">Custom Range...</option>
								</select>
							</div>
							<!-- Custom Date Range -->
							<div id="custom-range-div" class="hidden flex-grow contents">
								<div class="flex-grow min-w-[120px]">
									<label for="date-from" class="block text-xs font-medium text-slate-700">From</label>
									<input type="date" id="date-from" class="mt-1 block w-full p-2 border-gray-300 rounded-md text-sm">
								</div>
								<div class="flex-grow min-w-[120px]">
									<label for="date-to" class="block text-xs font-medium text-slate-700">To</label>
									<input type="date" id="date-to" class="mt-1 block w-full p-2 border-gray-300 rounded-md text-sm">
								</div>
							</div>
							<!-- Generate Button -->
							<div class="flex-shrink-0 w-full md:w-auto">
								<button id="generate-financial-report-btn" class="btn-primary w-full py-2 px-4 text-sm">Generate Report</button>
							</div>
						</div>
					</div>
				</div>

					<div id="members-report-section" class="space-y-6">
						<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
							<div class="p-4 rounded-xl shadow-lg text-center bg-slate-100"><p class="text-3xl font-bold text-slate-900" id="total-members-stat">0</p><p class="text-sm text-slate-600">Total Members</p></div>
							<div class="p-4 rounded-xl shadow-lg text-center bg-slate-100"><p class="text-3xl font-bold text-slate-900" id="total-households-stat">0</p><p class="text-sm text-slate-600">Total Households</p></div>
							<div class="p-4 rounded-xl shadow-lg text-center bg-slate-100"><p class="text-3xl font-bold text-slate-900" id="total-males-stat">0</p><p class="text-sm text-slate-600">Total Males</p></div>
							<div class="p-4 rounded-xl shadow-lg text-center bg-slate-100"><p class="text-3xl font-bold text-slate-900" id="total-females-stat">0</p><p class="text-sm text-slate-600">Total Females</p></div>
						</div>

						<div class="p-4 sm:p-6 rounded-xl shadow-lg bg-slate-100">
							<h3 class="text-lg font-semibold mb-4 text-slate-900">Group Breakdown</h3>
							<div class="overflow-x-auto">
								<table id="group-breakdown-table" class="w-full text-sm text-left">
									<thead class="bg-slate-200">
										<tr>
											<th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider sticky left-0 z-10 bg-slate-200">Group</th>
											<th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Households</th>
											<th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Members</th>
											<th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Males</th>
											<th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Females</th>
										</tr>
									</thead>
									<tbody id="group-breakdown-tbody" class="text-slate-800"></tbody>
								</table>
							</div>
						</div>

						<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
							<div class="p-4 sm:p-6 rounded-xl shadow-lg bg-slate-100">
								<h3 class="text-lg font-semibold mb-4 text-center text-slate-900">Members by Group</h3>
								<div class="relative h-64">
									<canvas id="group-chart"></canvas>
								</div>
							</div>
							<div class="p-4 sm:p-6 rounded-xl shadow-lg bg-slate-100">
								<h3 class="text-lg font-semibold mb-4 text-center text-slate-900">Members by Gender</h3>
								<div class="relative h-64">
									<canvas id="gender-chart"></canvas>
								</div>
							</div>
						</div>

						<div class="p-4 sm:p-6 rounded-xl shadow-lg bg-slate-100">
							<h3 class="text-lg font-semibold mb-4 text-slate-900">Age Breakdown</h3>
							<div class="flex flex-wrap items-center gap-4 mb-4">
								<label for="min-age-filter" class="text-slate-700">From:</label>
								<input type="number" id="min-age-filter" class="w-20 p-2 border rounded-md" min="0">
								<label for="max-age-filter" class="text-slate-700">To :</label>
								<input type="number" id="max-age-filter" class="w-20 p-2 border rounded-md" min="0">
								<button id="apply-age-filter" class="px-4 py-2 rounded-md text-white">Apply</button>
							</div>
							<div id="age-breakdown-results" class="text-slate-800"></div>
						</div>
					</div>

					<!-- Financials Report Section -->
					<div id="financials-report-section" class="hidden space-y-4">
						<div id="financials-actions" class="hidden flex flex-wrap items-center justify-end gap-2">
							</div>
						<h2 id="financial-report-title" class="text-xl font-bold text-center"></h2>
						<div id="financial-summary-cards" class="grid grid-cols-3 gap-2 text-center"></div>
						<div id="financial-charts-container" class="space-y-4"></div>
						<div id="financial-table-wrapper" class="p-3 rounded-xl shadow-lg" style="background-color: var(--card-bg);">
							<h3 class="text-base font-semibold mb-2">Transaction Details</h3>
							<div id="financial-table-container" class="max-h-[30rem] overflow-y-auto"></div>
						</div>
					</div>
					<!-- START: New Meeting Reports Section -->
					<div id="meeting-reports-section" class="hidden space-y-4">
						<div class="p-3 rounded-xl shadow-lg" style="background-color: var(--card-bg);">

						<div id="meeting-filters-container" class="p-3 rounded-xl shadow-lg" style="background-color: var(--card-bg);">
							<button id="toggle-filters-btn" class="md:hidden w-full text-left font-semibold p-2 rounded-md hover:bg-gray-100 flex justify-between items-center">
								<!-- The text has been removed -->
								<i class="fas fa-chevron-down transition-transform"></i>
							</button>
							<div id="meeting-filters-collapsible-content" class="meeting-filters-layout">
								<select id="meeting-dept-selector" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm">
									<option value="church_secretary">Church Secretary Reports</option>
									<option value="nubu_secretary">Nubu Secretary Reports</option>
									<option value="mino_secretary">Mino Secretary Reports</option>
									<option value="ce_secretary">CE Secretary Reports</option>
									<option value="building_secretary">Building Secretary Reports</option>
									<option value="mission_secretary">Mission Secretary Reports</option>
									<option value="nunphung_zatlang_secretary">Nunphung le Zatlang Reports</option>
								</select>
								
								<select id="meeting-report-sort" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm">
									<option value="date-desc">Date (Newest First)</option>
									<option value="date-asc">Date (Oldest First)</option>
									<option value="views-desc">Views (Most)</option>
								</select>
								
								<div id="search-container" class="search-container-mobile">
									<button id="search-icon-btn" class="search-icon-btn-mobile">
										<i class="fas fa-search"></i>
									</button>
									<input type="search" id="meeting-report-search" placeholder="Search..." class="search-input-mobile">
								</div>

								<div class="editor-only-section hidden">
									<button id="add-meeting-report-btn" class="btn-primary w-full py-2 px-4 text-sm whitespace-nowrap">Add Report</button>
								</div>
							</div>
						</div>
						<!-- Bookshelf Container -->
						<div id="bookshelf-container" class="bookshelf">
							<!-- Books will be rendered here by JavaScript -->
						</div>
						</div>
					</div>
					<!-- END: New Meeting Reports Section -->
					
					<!-- Financial Logs Section -->
					<div id="financial-logs-section" class="hidden space-y-4">
						<h2 class="text-xl sm:text-2xl font-bold mb-4">Financial Activity Log</h2>
						<div id="financial-logs-list-container" class="p-3 rounded-xl shadow-lg" style="background-color: var(--card-bg);">
							<div class="overflow-x-auto">
								<table class="w-full text-left text-sm">
									<thead class="text-xs uppercase text-slate-500">
										<tr>
											<th class="py-2 px-2">Date/Time</th>
											<th class="py-2 px-2">Action</th>
											<th class="py-2 px-2">Transaction ID</th>
											<th class="py-2 px-2">Dept</th>
											<th class="py-2 px-2 text-right">Amount</th>
											<th class="py-2 px-2">By</th>
										</tr>
									</thead>
									<tbody id="financial-logs-tbody" class="text-slate-800">
										<tr><td colspan="6" class="text-center py-4 text-gray-500">Loading logs...</td></tr>
									</tbody>
								</table>
							</div>
							</div>
					</div>	
                </div>
					<!-- Hymns Section -->
					<div id="page-hymns" class="page p-2 sm:p-4">
					<div class="mb-4 p-4 rounded-lg" style="background-color: var(--card-bg);">
						<div class="flex flex-row items-center gap-2 sm:gap-4 overflow-x-auto pb-1" style="flex-wrap: nowrap; -webkit-overflow-scrolling: touch;">

							<div class="relative flex-grow min-w-[120px] sm:min-w-[200px]"> <label for="hymn-search-box" class="sr-only">Search Hymns</label>
								<input type="search" id="hymn-search-box" placeholder="Search hymns..."
									   class="block w-full pl-10 pr-8 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-900 text-sm">
								<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
									<i class="fas fa-search text-gray-400"></i>
								</div>
								<button type="button" id="clear-hymn-search" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700 hidden">
									<i class="fas fa-times-circle"></i>
								</button>
							</div>

							<div class="flex-shrink-0">
								<label for="hymn-filter-by" class="sr-only">Filter By</label>
								<select id="hymn-filter-by" class="block w-auto py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-900 text-sm">
									<option value="title">Title</option>
									<option value="verse1">Verse 1</option>
									<option value="chorus">Chorus</option>
									<option value="all">All</option> </select>
							</div>

							<div class="flex-shrink-0">
								<button id="view-favorite-hymns-btn" class="btn-primary text-white text-sm px-3 py-2 rounded-md whitespace-nowrap">
									<i class="fas fa-star mr-1"></i><span id="hymn-favorites-count"></span> </button>
							</div>
						</div>
					</div>
						<div id="hymns-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
							</div>
					</div>

					<div id="page-hymn-detail" class="page p-2 sm:p-4">
						<div class="flex items-center justify-between mb-4">
							<button id="hymn-detail-back-btn" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
								<i class="fas fa-arrow-left mr-2"></i></button>
							<div class="flex items-center gap-2">
								<button id="hymn-font-decrease-btn" class="btn-secondary text-gray-800 px-2 py-1 rounded-md text-sm"><i class="fas fa-minus"></i> A</button>
								<button id="hymn-font-increase-btn" class="btn-secondary text-gray-800 px-2 py-1 rounded-md text-sm"><i class="fas fa-plus"></i> A</button>
							</div>
							<div class="flex items-center gap-2">
								<button id="hymn-prev-btn" class="btn-primary text-white px-3 py-1 rounded-md"><i class="fas fa-chevron-left"></i></button>
								<span id="hymn-number-display" class="font-bold text-lg text-gray-700"></span>
								<button id="hymn-next-btn" class="btn-primary text-white px-3 py-1 rounded-md"><i class="fas fa-chevron-right"></i></button>
							</div>
							<button id="hymn-detail-favorite-btn" class="text-yellow-500 text-2xl p-1" title="Add to Favorites">
								<i class="fas fa-star"></i>
							</button>
						</div>

						<div id="hymn-content-wrapper" class="p-4 sm:p-6 rounded-xl shadow-md" style="background-color: var(--card-bg);">
							<h1 id="hymn-detail-title" class="text-xl sm:text-2xl font-bold mb-3 text-center"></h1>
							<div id="hymn-detail-text" class="prose max-w-none mb-6" style="color: var(--text-color);">
								</div>
						</div>
					</div>
					<!-- End Hymns Section -->				
            </main>
        </div>
    </div>


    <!-- Modals -->
    <div id="notification-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center"></div>
    <div id="create-edit-voting-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center"></div>
    <div id="voting-results-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center"></div>
    <div id="settings-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center"></div>
    <div id="route-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"></div>
    <div id="edit-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center"></div>
    <div id="family-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center"></div>
    <div id="minister-detail-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center"></div>
    <div id="add-minister-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center"></div>
    <div id="edit-about-directory-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center"></div>
    <div id="edit-zelle-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center"></div>
    <div id="prayer-request-detail-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center"></div>
    <div id="add-edit-event-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center"></div>
    <div id="edit-user-role-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center"></div>
	
	<div id="manage-slideshow-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center">
		<div class="p-5 rounded-lg shadow-xl w-full max-w-3xl" style="background-color: var(--card-bg);">
			<div class="modal-body">
				<h3 class="text-lg text-center font-medium mb-4">Manage Slideshow Photos</h3>

				<div class="form-section mb-6">
					<h4 class="form-section-title">Upload New Photo</h4>
					<form id="upload-new-slideshow-form" class="space-y-4">
						<div>
							<label for="new-slideshow-image" class="block text-sm font-medium">Select Image</label>
							<input type="file" id="new-slideshow-image" accept="image/*" required class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
						</div>
						<div>
							<label for="new-slideshow-caption" class="block text-sm font-medium">Caption (Optional)</label>
							<textarea id="new-slideshow-caption" rows="2" class="mt-1 block w-full px-3 py-2 border rounded-md"></textarea>
						</div>
						<div class="flex justify-end">
							<button type="submit" class="btn-primary text-white px-4 py-2 rounded-md">Upload & Add Slide</button>
						</div>
					</form>
				</div>

				<div class="form-section">
					<h4 class="form-section-title">Existing Slides</h4>
					<ul id="existing-slideshow-list" class="space-y-4 max-h-60 overflow-y-auto">
						<li class="text-gray-500 text-center py-4">Loading slides...</li>
					</ul>
				</div>

				<div class="pt-4 flex justify-end gap-3">
					<button type="button" id="close-manage-slideshow-modal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md">Close</button>
				</div>
			</div>
		</div>
	</div>	
	
    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-5 right-5 sm:bottom-10 sm:right-10 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-xl transition-opacity duration-300">
        <p id="toast-message" class="text-sm"></p>
    </div>

<script type="module">

// --- NEW: Data fetched flags ---
let dataFetched = {
    members: false,
    ministers: false,
    events: false,
    prayerWall: false,
    financials: false,
    meetingReports: false,
    financialLogs: false,
    hymns: false, // Will be managed by its own cache/fetch
    chawnghlang: false, // Will be managed by its own cache/fetch
    userManagement: false // For allAppUsers
};

// --- NEW: Global UI element variables (Declare here, assign in initializeAppLogic) ---
// This is critical for avoiding ReferenceErrors when switchPage accesses them.
let manageSlideshowBtn = null;
let manageSlideshowModal = null;
let sermonSearchBox = null, clearSermonSearchBtn = null, sermonSpeakerFilter = null, sermonSortBox = null;
let postSearchBox = null, clearPostSearchBtn = null, postSortBox = null, viewSavedPostsBtn = null;
let hymnSearchBox = null, clearHymnSearchBtn = null, hymnFilterBy = null, viewFavoriteHymnsBtn = null;
let navToHymnsListBtn = null, navToChawngHlangListBtn = null, navToHymnsListBottomBtn = null, navToChawngHlangListBottomBtn = null;
let chawnghlangSearchBox = null, clearChawnghlangSearchBtn = null, viewFavoriteChawnghlangBtn = null;
let createVotingSessionBtn = null;
let toggleExpiredCheckbox = null;
let notificationBellContainer = null; // Declare here
let notificationBtn = null; // Declare here
let notificationBadge = null; // Declare here

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getStorage, ref, ref as storageRef, uploadBytes, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
	import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc, addDoc, deleteDoc, writeBatch, query, where, getDocs, updateDoc, arrayUnion, arrayRemove, serverTimestamp, orderBy, increment, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
	import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut, RecaptchaVerifier, signInWithPhoneNumber, PhoneAuthProvider, linkWithCredential } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
	import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js";
	
	pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js`;

    document.addEventListener('DOMContentLoaded', () => {
            

            // --- FIREBASE CONFIGURATION ---
			const firebaseConfig = {
			  apiKey: "AIzaSyC-iFUmZtERt8T7jB3rytM_N5cxj0vIvO4",
			  authDomain: "ccc-indy.firebaseapp.com",
			  projectId: "ccc-indy",
			  storageBucket: "ccc-indy.firebasestorage.app",
			  messagingSenderId: "889999699630",
			  appId: "1:889999699630:web:5813e3a92fc0843c40473f",
			  measurementId: "G-5VYKDERNDY"
			};
            
            // IMPORTANT: Replace with your actual Firebase Cloud Function URL.
            const verifyPasscodeUrl = "https://verifypasscode-um47szhvba-uc.a.run.app";
			const incrementReportViewUrl = "https://incrementreportview-um47szhvba-uc.a.run.app";
 	
            // --- Firebase Initialization ---
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
			const storage = getStorage(app);
			
            // --- UI Elements ---
            const loginScreen = document.getElementById('login-screen'),
				  meetingReportsSection = document.getElementById('meeting-reports-section'),
                  loginForm = document.getElementById('login-form'),
                  loginError = document.getElementById('login-error'),
                  appWrapper = document.getElementById('app-wrapper'),
                  logoutBtn = document.getElementById('logout-btn'),
                  settingsBtn = document.getElementById('settings-btn'),
                  navTabs = document.getElementById('nav-tabs'),
                  mainContent = document.getElementById('main-content'),
                  registerFormEl = document.getElementById('register-form'),
                  updateInfoFormEl = document.getElementById('update-info-form'),
                  routePlannerBar = document.getElementById('route-planner-bar'),
                  planRouteBtn = document.getElementById('plan-route-btn'),
                  clearSelectionBtn = document.getElementById('clear-selection-btn'),
                  selectedCountEl = document.getElementById('selected-count'),
                  editModal = document.getElementById('edit-modal'),
                  familyModal = document.getElementById('family-modal'),
                  settingsModal = document.getElementById('settings-modal'),
                  notificationModal = document.getElementById('notification-modal'),
                  registerNavBtn = document.getElementById('register-nav-btn'),
                  sidebar = document.getElementById('sidebar'),
                  sidebarOverlay = document.getElementById('sidebar-overlay'),
                  hamburgerBtn = document.getElementById('hamburger-btn'),
                  userNameDisplay = document.getElementById('user-name-display'),
                  userProfilePicBtn = document.getElementById('user-profile-pic-btn'),
                  userProfilePicInput = document.getElementById('user-profile-pic-input'),
                  userProfilePic = document.getElementById('user-profile-pic'),
                  userProfilePlaceholder = document.getElementById('user-profile-placeholder'),
                  themeSwitcherBtn = document.getElementById('theme-switcher-btn'),
                  notificationBellContainer = document.getElementById('notification-bell-container'),
                  notificationBtn = document.getElementById('notification-btn'),
                  notificationBadge = document.getElementById('notification-badge');
           // const createVotingSessionBtn = document.getElementById('create-voting-session-btn');
            const createEditVotingModal = document.getElementById('create-edit-voting-modal');
            const votingSessionsListContainer = document.getElementById('voting-sessions-list-container');
            const activeVotingSessionView = document.getElementById('active-voting-session-view');
            const votingResultsModal = document.getElementById('voting-results-modal');

			RegExp.escape = function(s) {
				return s.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|\(\)]/g, "\\$&");
			};

            // Home page slideshow elements
            const slideshowContainer = document.querySelector('.slideshow-container');
            const slideshowPicInput = document.getElementById('slideshow-pic-input');
            const uploadSlideshowPicBtn = document.getElementById('upload-slideshow-pic-btn');
            const removeSlideshowPicBtn = document.getElementById('remove-slideshow-pic-btn');
            let slideIndex = 0; // Changed to 0 for easier array indexing
            let slideshowInterval; // To control auto-advance

            // Home page "About Our Directory" elements
            const aboutDirectoryContent = document.getElementById('about-directory-content');
            const editAboutDirectoryBtn = document.getElementById('edit-about-directory-btn');
            const editAboutDirectoryModal = document.getElementById('edit-about-directory-modal');

            // Home page "Posts" elements
            const postsListContainer = document.getElementById('posts-list-container');
            const addPostBtn = document.getElementById('add-post-btn');
            let allPosts = []; // State for posts
			let currentPostView = 'all';

            // Ministers page elements
            const ministersListContainer = document.getElementById('ministers-list-container');
            const addMinisterBtn = document.getElementById('add-minister-btn');
            const addMinisterModal = document.getElementById('add-minister-modal');
            const ministerDetailModal = document.getElementById('minister-detail-modal');

            // Give page elements
            const giveForm = document.getElementById('give-form');
            const zelleNameDisplay = document.getElementById('zelle-name');
            const zelleContactDisplay = document.getElementById('zelle-contact');
            const editZelleBtn = document.getElementById('edit-zelle-btn');
            const editZelleModal = document.getElementById('edit-zelle-modal');



            // Prayer Request page elements
            const prayerRequestForm = document.getElementById('prayer-request-form');
            const prayerRequestDetailModal = document.getElementById('prayer-request-detail-modal');


            // --- State Management ---
            let currentPage = 'home',
				isEditModeActive = false,
				loggedInUserName = '',
                selectedMembers = [],
                allMembers = [],
				currentSermonId = null,
				currentPostId = null,
                userFavorites = [],
                allMinisters = [],
                slideshowPhotos = [],
                aboutDirectoryText = '',
                zelleRecipient = {name: 'N/A', contact: 'N/A'},
                onlinePaymentLink = '',
                currentUser = null,
                displayMode = 'familyDetails',
               // allPosts = [],
                allEvents = [];
            // ADD THESE NEW VARIABLES FOR VOTING
			let allMeetingReports = [];
			let speakerProfiles = {};
            let allVotingSessions = [];
            let userVotedSessionIds = [];
			let userVotes = {};
            let unsubscribeVotingSessions = null;
            let unsubscribeUserVotes = null;
            let unsubscribeRealtimeVotes = null;
            let voteCharts = {}; // To hold Chart.js instances
            let countdownIntervals = {}; // To hold countdown timers
			let liveResultsUnsubscribe = null;
			let currentReportTransactions = [];
			let financialLogs = [];
			let controlsTimeout;
			let isControlsVisible = false;
			let touchStartX = 0;
			let touchEndX = 0;
			const SWIPE_THRESHOLD = 50; // Pixels needed for a swipe
			let userSavedPosts = []; // To store IDs of posts saved by the current user
			let unsubscribeSavedPosts = null;
			let allPostComments = {}; // Cache for comments on detailed posts
			let manageSlideshowBtn = null;
			let manageSlideshowModal = null;
			let allHymns = [];
			let unsubscribeHymns = null;
			let currentHymnId = null;
			let filteredHymns = [];
			let hymnFavorites = [];
			let unsubscribeHymnFavorites = null;
			let currentHymnView = 'all';
			let currentHymnFontSize = parseInt(localStorage.getItem('hymnFontSize') || '16');
			let currentVerificationUserId = null;
			let currentVerificationPhoneNumber = null;
			let recaptchaVerifier = null;
			let confirmationResult = null;
		

            // Declare unsubscribe functions as global (script-scoped) variables, initialized to null
            let unsubscribeMembers = null,
                unsubscribeFavorites = null,
                unsubscribeUpdateRequests = null,
                unsubscribeMinisters = null,
                unsubscribeSlideshow = null,
                unsubscribeAboutContent = null,
                unsubscribeZelle = null,
                unsubscribeOnlinePaymentLink = null,
                unsubscribePrayerRequests = null,
                unsubscribePosts = null,
                unsubscribeEvents = null,
				unsubscribeMeetingReports = null;
            
            // Counters for notification badge, also global
            let allPreviousUpdateRequestsCount = 0;
            let allPreviousPrayerRequestsCount = 0;
            let allAppUsers = []; // NEW: State for all app users
            let unsubscribeAppUsers = null; // NEW: Unsubscribe for app users
			let unsubscribeFinancialLogs = null;

			// ===================================================================
			// == START: USER ROLE & DEPARTMENT MANAGEMENT
			// ===================================================================

			const departments = [
				{ id: 'church', name: 'Church' },
				{ id: 'nubu', name: 'Nubu' },
				{ id: 'mino', name: 'Mino' },
				{ id: 'ce', name: 'CE' },
				{ id: 'building', name: 'Building' },
				{ id: 'mission', name: 'Mission' },
				{ id: 'nunphung_zatlang', name: 'Nunphung le Zatlang' },
				{ id: 'auditor', name: 'Auditor' }, // Standalone Auditor Department/Role
				{ id: 'minister', name: 'Minister' } // Standalone Minister Department/Role
			];

			const assignableRoles = ['Treasurer', 'Secretary'];

            const saveSettings = () => {
                const settings = { displayMode, theme: document.body.className };
                localStorage.setItem('appSettings', JSON.stringify(settings));
            }
            
            const getUserProfile = async (userId) => {
                const userProfileRef = doc(db, "userProfiles", userId);
                const docSnap = await getDoc(userProfileRef);
                return docSnap.exists() ? docSnap.data() : { profilePic: null };
            }

            const saveUserProfile = async (userId, profileData) => {
                const userProfileRef = doc(db, "userProfiles", userId);
                await setDoc(userProfileRef, profileData, { merge: true });
            }

            // --- Utility Functions ---
			
			  async function uploadFileToStorage(file, path) {
				if (!file) return null; // No file provided, return null

				const storageRefInstance = storageRef(storage, path);
				await uploadBytes(storageRefInstance, file);
				return await getDownloadURL(storageRefInstance);
			}   
	 
            const showToast = (message, type = 'success') => {
                const toast = document.getElementById('toast'),
                      toastMessage = document.getElementById('toast-message');
                toastMessage.textContent = message;
                toast.className = `fixed bottom-5 right-5 sm:bottom-10 sm:right-10 text-white py-2 px-5 rounded-lg shadow-xl transition-opacity duration-300 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), 3000);
            };

            const showConfirmModal = (message, onConfirm) => {
                const confirmModal = document.createElement('div');
                confirmModal.className = 'fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center p-4';
                confirmModal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-auto">
                        <p class="text-lg" style="color: #1f2937;">${message}</p>
                        <div class="mt-6 flex justify-end gap-4">
                            <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                            <button id="confirm-ok-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmModal);

                const close = () => document.body.removeChild(confirmModal);

                document.getElementById('confirm-ok-btn').onclick = () => {
                    onConfirm();
                    close();
                };
                document.getElementById('confirm-cancel-btn').onclick = close;
            };

             const toBase64 = file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
            
			const updateUserInfo = async () => {
                 if(!currentUser) return;
                 userNameDisplay.textContent = currentUser.name;
                 const userProfile = await getUserProfile(currentUser.uid);
                 if(userProfile.profilePic){
                    userProfilePic.src = userProfile.profilePic;
                    userProfilePic.classList.remove('hidden');
                    userProfilePlaceholder.classList.add('hidden');
                 } else {
                    userProfilePic.classList.add('hidden');
                    userProfilePlaceholder.classList.remove('hidden');
                 }

                 // NEW: Try to link the current Firebase UID to a head of household profile if found.
                 // This assumes a user who logs in is primarily identified with one household head.
                 // If a member with this UID isn't found, no action is taken.
                 if (currentUser.uid) {
                     const memberRef = collection(db, "members");
                     const q = query(memberRef, where("uid", "==", currentUser.uid), where("isHead", "==", true));
                     const querySnapshot = await getDocs(q);
                     if (querySnapshot.empty) {
                         // If no matching head member found, try to find by name, or mark as new user
                         // For simplicity for now, we only link if a head member with this UID exists.
                         // Or, if `currentUser.name` maps directly to a member.
                         const namedMemberQuery = query(memberRef, where("name", "==", currentUser.name), where("isHead", "==", true));
                         const namedMemberSnap = await getDocs(namedMemberQuery);
                         if (!namedMemberSnap.empty) {
                             const memberDoc = namedMemberSnap.docs[0];
                             // If a head member matches the name but doesn't have a UID yet, assign it.
                             if (!memberDoc.data().uid) {
                                 await updateDoc(memberDoc.ref, { uid: currentUser.uid });
                                 console.log(`Assigned UID ${currentUser.uid} to member ${memberDoc.id}.`);
                             }
                         }
                     }
                 }
            };

            // --- Local Data Storage (for settings & session) ---
            function loadSettings() {
                const savedSettings = localStorage.getItem('appSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    displayMode = settings.displayMode || 'familyDetails'; // Ensure displayMode is updated
                    document.body.className = settings.theme || '';
                    return settings; // Return the loaded settings
                }
                return {}; // Return empty object if no settings found
            }
            // --- INITIAL SETTINGS LOAD ---
            loadSettings();

            const showApp = () => {
                loginScreen.classList.add('hidden');
                appWrapper.classList.remove('hidden');
                
                updateUserInfo();
				setupEventListeners();
                initializeAppLogic();
            };
			

            const showLogin = () => {
                loginScreen.classList.remove('hidden');
                appWrapper.classList.add('hidden');
                 if(unsubscribeMembers) unsubscribeMembers();
                 if(unsubscribeFavorites) unsubscribeFavorites();
                 if(unsubscribeUpdateRequests) unsubscribeUpdateRequests();
                 if(unsubscribeMinisters) unsubscribeMinisters();
                 if(unsubscribeSlideshow) unsubscribeSlideshow();
                 if(unsubscribeAboutContent) unsubscribeAboutContent();
                 if(unsubscribeZelle) unsubscribeZelle();
                 if(unsubscribeOnlinePaymentLink) unsubscribeOnlinePaymentLink();
                 if(unsubscribePrayerRequests) unsubscribePrayerRequests();
                 if(unsubscribePosts) unsubscribePosts();
				 if(window.unsubscribeEvents) window.unsubscribeEvents();
				 if(unsubscribeAppUsers) unsubscribeAppUsers();
				 if(unsubscribeMeetingReports) unsubscribeMeetingReports();
				 if(unsubscribeFinancialLogs) unsubscribeFinancialLogs();
				 if(unsubscribeHymns) unsubscribeHymns();
				 if(unsubscribeHymnFavorites) unsubscribeHymnFavorites();
				 
            };

            onAuthStateChanged(auth, async (user) => {
                if(user) {
                    const idTokenResult = await user.getIdTokenResult();
                    const claims = idTokenResult.claims;

                    // Get the user's profile document from Firestore to load their true roles.
                    const userProfileRef = doc(db, "userProfiles", user.uid);
                    const userProfileSnap = await getDoc(userProfileRef);
                    
                    let profileData = {};
                    if (userProfileSnap.exists()) {
                        profileData = userProfileSnap.data();
                    } else {
                        // If a profile doesn't exist, create one.
                        await setDoc(userProfileRef, { name: claims.name, role: claims.role, assignments: [] });
                    }

                    // Create a complete currentUser object by combining login data and database data.
                    currentUser = {
                        uid: user.uid,
                        name: profileData.name || claims.name,
                        role: profileData.role || claims.role,
                        assignments: profileData.assignments || []
                    };
                    
                    showApp();
                } else {
                    currentUser = null;
                    showLogin();
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('login-name').value.trim();
                const passcode = document.getElementById('login-passcode').value;
					loggedInUserName = name;

                try {
                    const response = await fetch(verifyPasscodeUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ passcode, name })
                    });
                    
                    if(response.ok) {
                        const { token } = await response.json();
                        await signInWithCustomToken(auth, token);
                        loginError.classList.add('hidden');
                        // onAuthStateChanged will handle showing the app
                    } else {
                        const { error } = await response.json();
                        loginError.textContent = error || "Invalid passcode.";
                        loginError.classList.remove('hidden');
                        console.error("Login Error:", error);
                    }
                } catch (error) {
                   loginError.textContent = "Login request failed. Check network or contact admin.";
                   loginError.classList.remove('hidden');
                   console.error("Login Error:", error);
                }
            });
            
            logoutBtn.addEventListener('click', () => {
				loggedInUserName = '';
                signOut(auth);
            });
            
			const toggleSidebar = (forceOpen = null) => {
                const isOpen = sidebar.classList.contains('translate-x-0');
                if (forceOpen === true || (forceOpen === null && !isOpen)) {
                    sidebar.classList.remove('-translate-x-full');
                    sidebar.classList.add('translate-x-0');
                    sidebarOverlay.classList.remove('hidden');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    sidebar.classList.remove('translate-x-0');
                    sidebarOverlay.classList.add('hidden');
                    
                }
            };

const handleCollapsibleGroupClick = () => {
    const groupHeader = document.querySelector('.collapsible-header[data-page="groups"]');
    const groupContent = document.getElementById('group-collapsible-content');

    if (!groupHeader || !groupContent) return; // Safety check

    console.log("DEBUG: Delegated collapsible header clicked."); // Diagnostic

    // Toggle the 'expanded' class on the header
    groupHeader.classList.toggle('expanded');

    // Now, determine the target maxHeight based on the 'expanded' state
    if (groupHeader.classList.contains('expanded')) {
        // If it's expanded (should open):
        // Set maxHeight to scrollHeight to enable smooth transition
        groupContent.style.maxHeight = groupContent.scrollHeight + "px";
    } else {
        // If it's not expanded (should close):
        // Crucially, force the browser to recognize its current scrollHeight
        // before animating it to 0. This makes the animation work correctly.
        groupContent.style.maxHeight = groupContent.scrollHeight + "px"; // Set to current height
        requestAnimationFrame(() => { // Use requestAnimationFrame for next repaint
            groupContent.style.maxHeight = "0px"; // Then immediately set to 0
        });
    }
};
            /**
             * Checks if the current user has a specific role in a specific department.
             * @param {string} department - The department ID (e.g., 'nubu').
             * @param {string} role - The role to check for (e.g., 'Treasurer').
             * @returns {boolean}
             */
			const hasPermission = (department, role) => {
			  if (!currentUser) return false;
			  // Editors only when in edit mode
			  if (currentUser.role === 'editor') return isEditModeActive;

			  const assignments = currentUser.assignments || {};  
			  // Strip off any "_secretary" suffix so "finance_secretary" → "finance"
			  const baseDept = department.endsWith('_secretary')
				? department.slice(0, -10)
				: department;

			  // Look up the user’s role for that department in the map:
			  return assignments[baseDept] === role;
			};

        // ===================================================================
        // == START: MEETING REPORTS SYSTEM (Corrected Section)
        // ===================================================================
        
        let allUnfilteredMeetingReports = []; // Store all reports before filtering/* START: New Professional PDF Viewer Styles */
		

        const setupMeetingReportsPage = () => {
            const deptSelector = document.getElementById('meeting-dept-selector');
            const searchInput = document.getElementById('meeting-report-search');
            const sortSelector = document.getElementById('meeting-report-sort');
            const addReportBtn = document.getElementById('add-meeting-report-btn');
			const addReportBtnContainer = addReportBtn ? addReportBtn.closest('.editor-only-section') : null;

			// Helper function to show/hide the button based on permissions and selected department
			const updateAddButtonVisibility = () => {
				const addReportBtnContainer = document.getElementById('add-meeting-report-btn')?.closest('.editor-only-section');
				if (!addReportBtnContainer || !currentUser) return;

				const selectedDept = document.getElementById('meeting-dept-selector').value;

				// Logic now ONLY checks for 'Secretary' role.
				const canUpload = hasPermission(selectedDept, 'Secretary');

				let showButton = false;
				if (currentUser.role === 'editor') {
					showButton = isEditModeActive;
				} else if (canUpload) {
					showButton = true;
				}

				addReportBtnContainer.classList.toggle('hidden', !showButton);
			};

			const searchContainer = document.getElementById('search-container');
			const searchIconBtn = document.getElementById('search-icon-btn');

			if (searchIconBtn && searchContainer && !searchIconBtn.dataset.listenerAttached) {
				searchIconBtn.addEventListener('click', (e) => {
					e.stopPropagation(); 
					searchContainer.classList.add('search-active');
					searchInput.focus(); 
				});
				document.addEventListener('click', (e) => {
					if (searchContainer.classList.contains('search-active') && !searchContainer.contains(e.target)) {
						searchContainer.classList.remove('search-active');
					}
				});
				searchIconBtn.dataset.listenerAttached = 'true';
			}

            const applyFiltersAndRender = () => {
                const selectedDept = deptSelector.value;
                const searchTerm = searchInput.value.toLowerCase();
                const sortBy = sortSelector.value;

                let filtered = allUnfilteredMeetingReports.filter(report => report.department === selectedDept);

                if (searchTerm) {
                    filtered = filtered.filter(report => report.title.toLowerCase().includes(searchTerm));
                }

                if (sortBy === 'date-asc') {
                    filtered.sort((a, b) => a.uploadDate.toDate() - b.uploadDate.toDate());
                } else if (sortBy === 'views-desc') {
                    filtered.sort((a, b) => (b.views || 0) - (a.views || 0));
                } else { // date-desc
                    filtered.sort((a, b) => b.uploadDate.toDate() - a.uploadDate.toDate());
                }
                
                allMeetingReports = filtered;
                renderBookshelf();
				updateAddButtonVisibility();
            };
            
            if (deptSelector && !deptSelector.dataset.listenerAttached) {
                deptSelector.addEventListener('change', applyFiltersAndRender);
                deptSelector.dataset.listenerAttached = 'true';
            }
             if (searchInput && !searchInput.dataset.listenerAttached) {
                searchInput.addEventListener('input', applyFiltersAndRender);
                searchInput.dataset.listenerAttached = 'true';
            }
             if (sortSelector && !sortSelector.dataset.listenerAttached) {
                sortSelector.addEventListener('change', applyFiltersAndRender);
                sortSelector.dataset.listenerAttached = 'true';
            }
             if (addReportBtn && !addReportBtn.dataset.listenerAttached) {
                addReportBtn.addEventListener('click', () => openAddEditReportModal());
                addReportBtn.dataset.listenerAttached = 'true';
            }
            
            applyFiltersAndRender();
        };

        const fetchMeetingReports = () => {
            if (unsubscribeMeetingReports) unsubscribeMeetingReports();
            const reportsRef = collection(db, "meetingReports");
            unsubscribeMeetingReports = onSnapshot(query(reportsRef, orderBy("uploadDate", "desc")), snapshot => {
                allUnfilteredMeetingReports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('page-reports').classList.contains('active') && document.getElementById('report-category-selector').value === 'meetings') {
                   setupMeetingReportsPage();
                }
            });
        };

		const renderBookshelf = async () => {
			const container = document.getElementById('bookshelf-container');
			container.innerHTML = '';
			
	if (allMeetingReports.length === 0) {
		container.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">No reports found for this department.</p>`;
		return;
	}

	const colors = ['#4A90E2', '#50E3C2', '#F5A623', '#D0021B', '#BD10E0', '#9013FE', '#417505', '#7ED321'];
	const stringToColor = (str) => {
		let hash = 0;
		if (!str || str.length === 0) return colors[0];
		for (let i = 0; i < str.length; i++) {
			hash = str.charCodeAt(i) + ((hash << 5) - hash);
			hash = hash & hash;
		}
		return colors[Math.abs(hash) % colors.length];
	};

	// Use Promise.all to handle all thumbnail generations concurrently
	await Promise.all(allMeetingReports.map(async (report) => {
		const bookEl = document.createElement('div');
		bookEl.className = 'book';
		bookEl.dataset.reportId = report.id;

		// Grab the department→role map (or empty object if undefined)
		const assignments = currentUser.assignments || {};

		// Now just look up by the exact department string:
		const isTreasurerForDept = assignments[report.department] === 'Treasurer';
		const isSecretaryForDept = assignments[report.department] === 'Secretary';
		// now hasPermission will only return true for sec/treas or (editor when edit‐mode)
		const canManage = (
		  isTreasurerForDept
		  || (currentUser.role === 'editor' && isEditModeActive)
		);

		const editorControls = canManage
		  ? `<div class="book-controls">
			   <button data-action="edit" …><i class="fas fa-pencil-alt"></i></button>
			   <button data-action="delete" …><i class="fas fa-trash"></i></button>
			 </div>`
		  : '';

		const reportDate = report.reportDate ? new Date(report.reportDate + 'T00:00:00').toLocaleDateString() : 'No Date';
		const coverColor = stringToColor(report.title);
		const darkerColor = `color-mix(in srgb, ${coverColor} 65%, black)`;

		bookEl.innerHTML = `
			${editorControls}
			<div class="book-cover" style="background: linear-gradient(45deg, ${coverColor}, ${darkerColor});">
				<div class="book-title">${report.title}</div>
				<div class="book-footer">
					<div class="book-date">${reportDate}</div>
					<div class="book-view-count"><i class="fas fa-eye"></i> ${report.views || 0}</div>
				</div>
			</div>
			<div class="book-inner-page"></div>
			<div class="book-spine" style="background: ${darkerColor};"></div>
		`;
		container.appendChild(bookEl);

		// Generate the first page preview for the hover effect
		const innerPageEl = bookEl.querySelector('.book-inner-page');
		if (innerPageEl) {
            // This logic remains from our previous successful implementation
            if (report.firstPageThumbnail) {
                innerPageEl.style.backgroundImage = `url('${report.firstPageThumbnail}')`;
            } else {
                try {
                    const thumbnailUrl = await generateFirstPageThumbnail(report);
                    if (thumbnailUrl) {
                        report.firstPageThumbnail = thumbnailUrl; // Cache for session
                        innerPageEl.style.backgroundImage = `url('${thumbnailUrl}')`;
                    }
                } catch (error) {
                    console.error("Thumbnail generation failed for:", report.title, error);
                }
            }
        }


		// ** THIS IS THE CORRECTED CLICK HANDLER **
		bookEl.addEventListener('click', (e) => {
			// If the click was on an editor button, do nothing.
			if (e.target.closest('button[data-action]')) {
				return;
			}

            // 1. Increment the view count in the background
			try {
				fetch(incrementReportViewUrl, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ reportId: report.id })
				});
			} catch (err) {
				console.error("Could not increment view count:", err);
			}

            // 2. Open the PDF file inside the app using the new modal.
			openProfessionalPdfViewer(report);
		});

		// Attach listeners for edit/delete buttons if they exist
		if (isEditModeActive && canManage) {
			bookEl.querySelector('button[data-action="edit"]')?.addEventListener('click', () => openAddEditReportModal(report));
			bookEl.querySelector('button[data-action="delete"]')?.addEventListener('click', () => deleteMeetingReport(report));
		}
	}));
};

const generateFirstPageThumbnail = async (report) => {
	// This helper function remains unchanged. It generates the preview for the book hover effect.
	try {
		const loadingTask = pdfjsLib.getDocument({ url: report.fileURL });
		const pdf = await loadingTask.promise;
		const page = await pdf.getPage(1);
		const viewport = page.getViewport({ scale: 1.0 });
		
		const canvas = document.createElement('canvas');
		const context = canvas.getContext('2d');
		canvas.height = viewport.height;
		canvas.width = viewport.width;

		await page.render({ canvasContext: context, viewport: viewport }).promise;
		pdf.destroy(); // Important to free up memory

		return canvas.toDataURL('image/jpeg', 0.8);
	} catch (error) {
		console.error(`Failed to generate thumbnail for "${report.title}":`, error);
		return null;
	}
};
		
		const openAddEditReportModal = (report = null) => {
            const isEditing = report !== null;
            const modalId = 'add-edit-meeting-report-modal';
            let existingModal = document.getElementById(modalId);
            if (existingModal) existingModal.remove();

            // 1. Determine if the dropdown should be locked for non-editors.
            const isLocked = currentUser.role !== 'editor';

            // 2. Determine which department should be pre-selected.
            const departmentToSelect = isEditing ? report.department : document.getElementById('meeting-dept-selector').value;

            // 3. Generate the HTML for the department options.
            const departmentOptionsHTML = Array.from(document.getElementById('meeting-dept-selector').options)
                .map(opt => `<option value="${opt.value}" ${opt.value === departmentToSelect ? 'selected' : ''}>${opt.text}</option>`)
                .join('');

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center';
            
            // 4. Build the modal HTML, adding the 'disabled' attribute if needed.
            modal.innerHTML = `
                <div class="p-5 rounded-lg shadow-xl w-full max-w-lg" style="background-color: var(--card-bg);">
                    <form id="add-edit-report-form" class="space-y-4">
                        <h3 class="text-lg font-medium">${isEditing ? 'Edit' : 'Add'} Meeting Report</h3>
                        <input type="hidden" id="report-id" value="${isEditing ? report.id : ''}">
                        <div>
                            <label for="report-title">Title</label>
                            <input type="text" id="report-title" value="${isEditing ? report.title : ''}" required class="mt-1 block w-full border rounded-md p-2">
                        </div>
						<div>
							<label for="report-date">Report Date</label>
							<input type="date" id="report-date" value="${isEditing ? report.reportDate : ''}" required class="mt-1 block w-full border rounded-md p-2">
						</div>						
                        <div>
                            <label for="report-department">Department</label>
                            <select id="report-department" class="mt-1 block w-full border rounded-md p-2 bg-gray-100" ${isLocked ? 'disabled' : ''}>
                                ${departmentOptionsHTML}
                            </select>
                        </div>
                        <div>
                            <label for="report-file">Report File (PDF only)</label>
                            <input type="file" id="report-file" accept=".pdf" ${isEditing ? '' : 'required'} class="mt-1 block w-full text-sm">
                            ${isEditing ? `<p class="text-xs text-gray-500">Uploading a new file will replace the old one.</p>`: ''}
                        </div>
                        <div class="pt-4 flex justify-end gap-3">
                            <button type="button" id="cancel-report-btn" class="bg-gray-200 px-4 py-2 rounded-md">Cancel</button>
                            <button type="submit" id="submit-report-btn" class="btn-primary px-4 py-2 rounded-md text-white">Save</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            modal.querySelector('#cancel-report-btn').addEventListener('click', () => modal.remove());
            modal.querySelector('#add-edit-report-form').addEventListener('submit', handleReportUpload);
        };
        
		const handleReportUpload = async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            if(submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            }

            const reportId = document.getElementById('report-id').value;
            const file = document.getElementById('report-file').files[0];
            const title = document.getElementById('report-title').value;
            const department = document.getElementById('report-department').value;
            const reportDate = document.getElementById('report-date').value;

            if (!file && !reportId) {
                showToast("A PDF file is required for new reports.", "error");
                if(submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Save'; }
                return;
            }

            try {
                let fileURL = reportId ? allMeetingReports.find(r => r.id === reportId)?.fileURL : '';
                let filePath = reportId ? allMeetingReports.find(r => r.id === reportId)?.filePath : '';

                if (file) {
                    if (reportId && filePath) {
                        try { await deleteObject(ref(storage, filePath)); } catch (e) { console.warn("Old file not found, continuing upload."); }
                    }
                    filePath = `meetingReports/${department}/${Date.now()}_${file.name}`;
					const storageRef = ref(storage, filePath);
					// 1) Upload the raw file
					await uploadBytes(storageRef, file);
					// 2) Retrieve its download URL
					fileURL = await getDownloadURL(storageRef);
                }

                const reportData = { title, department, reportDate, fileURL, filePath, updatedAt: serverTimestamp() };

                if (reportId) {
                    await setDoc(doc(db, "meetingReports", reportId), reportData, { merge: true });
                    showToast("Report updated successfully!", "success");
                } else {
                    reportData.views = 0;
                    reportData.uploadDate = serverTimestamp();
                    await addDoc(collection(db, "meetingReports"), reportData);
                    showToast("Report added successfully!", "success");
                }
                document.getElementById('add-edit-meeting-report-modal')?.remove();
            } catch (error) {
                console.error("Error uploading report:", error);
                showToast("Failed to save report.", "error");
                if(submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Save'; }
            }
        };

        const deleteMeetingReport = (report) => {
            showConfirmModal(`Delete "${report.title}"? This cannot be undone.`, async () => {
                try {
                    if (report.filePath) { await deleteObject(ref(storage, report.filePath)); }
                    await deleteDoc(doc(db, "meetingReports", report.id));
                    showToast("Report deleted successfully!", "success");
                } catch (error) {
                    console.error("Error deleting report:", error);
                    showToast("Failed to delete report. The file may have been already removed.", "error");
                    try { await deleteDoc(doc(db, "meetingReports", report.id)); } catch (e) {}
                }
            });
        };

		
		// ===================================================================
        // == START: PROFESSIONAL PDF VIEWER (Definitive Fix)
        // ===================================================================
        
let pdfViewer = { instance: null, pdfDoc: null, eventBus: null };

async function openProfessionalPdfViewer(report) {
    const modal = document.getElementById('pdf-viewer-modal');
    const viewerContainer = document.getElementById('pdf-viewer-container');
    const titleEl = document.getElementById('pdf-report-title');
    const pageNumEl = document.getElementById('pdf-page-num');
    const pageCountEl = document.getElementById('pdf-page-count');
    const topControls = document.getElementById('pdf-top-controls');
    const bottomControls = document.getElementById('pdf-bottom-controls');
    const modalOverlayBg = document.getElementById('pdf-modal-overlay-bg');

    // Initial UI state: show modal, loading spinner, and hide controls
    titleEl.textContent = report.title;
    viewerContainer.innerHTML = `
      <div class="w-full h-full flex items-center justify-center text-gray-600">
        <i class="fas fa-spinner fa-spin text-4xl"></i>
      </div>`;
    modal.classList.remove('hidden');
    topControls.classList.remove('visible');
    bottomControls.classList.remove('visible');
    isControlsVisible = false;

    // Clean up any old PDF.js instance
    if (pdfViewer.instance) {
        pdfViewer.instance.cleanup();
        pdfViewer = { instance: null, pdfDoc: null, eventBus: null };
    }

    // Prepare the viewer container for PDF.js rendering
    viewerContainer.innerHTML = '';
	viewerContainer.scrollTop = 0;
	viewerContainer.scrollLeft = 0;

    try {
        const eventBus = new pdfjsViewer.EventBus();
        const linkService = new pdfjsViewer.PDFLinkService({ eventBus });

        const pdfViewerElement = document.createElement('div');
        pdfViewerElement.className = 'pdfViewer';
        viewerContainer.appendChild(pdfViewerElement);

        const pdfInst = new pdfjsViewer.PDFViewer({
            container: viewerContainer,
            viewer: pdfViewerElement,
            eventBus,
            linkService,
            textLayerMode: 2,
            annotationMode: 2,
        });
        linkService.setViewer(pdfInst);

        // This patch is crucial for precise single-page view.
        // It ensures that when a page changes (via swipe, next/prev buttons, or direct input),
        // PDF.js scrolls exactly to the top of that page.
        pdfInst.scrollPageIntoView = (params) => {
            const pageNum = typeof params === 'object' ? params.pageNumber : params;
            if (!pageNum || pageNum < 1 || pageNum > pdfInst.pagesCount) {
                return; // Invalid page number
            }
            const pageDiv = pdfInst._pages[pageNum - 1]?.div; // Optional chaining here is good
            if (pageDiv) {
                pageDiv.scrollIntoView({ behavior: 'instant', block: 'start', inline: 'nearest' });
            } else {
                console.warn(`Attempted to scroll to page ${pageNum}, but its div element was not found.`);
                // This warning can help diagnose if pages are missing unexpectedly
            }
        };

        // --- CRITICAL CHANGE: Move initial page/scale setup into pagesinit ---
eventBus.on('pagesinit', () => {
    setTimeout(() => { // Wrap the logic in a timeout
        pdfInst.currentPageNumber = 1;
        pdfInst.currentScaleValue = 'page-width';
        pdfInst.update();
        pdfInst.scrollPageIntoView(1);
        pageNumEl.value = pdfInst.currentPageNumber;
        pageCountEl.textContent = pdfInst.pagesCount;
        showControls();
    }, 50); // Small delay, e.g., 50ms
});
        // Existing pagechanging listener
        eventBus.on('pagechanging', e => {
            pageNumEl.value = e.pageNumber;
            showControls(); // Re-show controls on page change
        });


        // Load the PDF document
        const CMAP_URL = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/cmaps/';
        const loadingTask = pdfjsLib.getDocument({
            url: report.fileURL,
            cMapUrl: CMAP_URL,
            cMapPacked: true,
        });

        const pdfDoc = await loadingTask.promise;

        // --- Set document. Do NOT set currentPageNumber or currentScaleValue here anymore. ---
        pdfInst.setDocument(pdfDoc);
        linkService.setDocument(pdfDoc, null);

        // Store refs immediately, but control visibility and page number via pagesinit
        pdfViewer = { instance: pdfInst, pdfDoc, eventBus };

    } catch (err) {
        console.error('PDF load error:', err);
        viewerContainer.innerHTML = `
            <div class="p-4 text-red-600 text-center w-full">
                <strong>Failed to load PDF:</strong><br>${err.message}<br>Please try again or download the report.
            </div>`;
        showControls(); // Show controls in case of error
    }
}


// --- New functions for controls visibility and swipe gestures ---

function showControls() {
    clearTimeout(controlsTimeout);
    document.getElementById('pdf-top-controls').classList.add('visible');
    document.getElementById('pdf-bottom-controls').classList.add('visible');
    isControlsVisible = true;
    controlsTimeout = setTimeout(hideControls, 3000); // Hide after 3 seconds
}

function hideControls() {
    document.getElementById('pdf-top-controls').classList.remove('visible');
    document.getElementById('pdf-bottom-controls').classList.remove('visible');
    isControlsVisible = false;
}

// Add these event listeners within your `DOMContentLoaded` or `initializeAppLogic`
// or wherever your other PDF viewer button listeners are:

// Single tap/click on viewer content to toggle controls
document.getElementById('pdf-viewer-content-wrapper').addEventListener('click', (e) => {
    // Prevent hiding if a control button was clicked
    if (e.target.closest('#pdf-top-controls') || e.target.closest('#pdf-bottom-controls')) {
        return;
    }
    if (isControlsVisible) {
        hideControls();
    } else {
        showControls();
    }
});

// Touch event listeners for swipe navigation
document.getElementById('pdf-viewer-container').addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
    // Hide controls immediately on touch start to prevent accidental taps
    hideControls();
});

document.getElementById('pdf-viewer-container').addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
});

function handleSwipe() {
    if (!pdfViewer.instance) return;

    // Detect if it was a significant swipe or just a tap
    if (Math.abs(touchEndX - touchStartX) > SWIPE_THRESHOLD) {
        if (touchEndX < touchStartX) { // Swiped left (go to next page)
            if (pdfViewer.instance.currentPageNumber < pdfViewer.instance.pagesCount) {
                pdfViewer.instance.currentPageNumber++;
            } else {
                showToast("You're on the last page.", "info");
            }
        } else { // Swiped right (go to previous page)
            if (pdfViewer.instance.currentPageNumber > 1) {
                pdfViewer.instance.currentPageNumber--;
            } else {
                showToast("You're on the first page.", "info");
            }
        }
    }
    // If it was a short touch (tap), controls will be toggled by the 'click' listener on content-wrapper
    touchStartX = 0; // Reset for next swipe
    touchEndX = 0;
}
        // ===================================================================
        // == END: PROFESSIONAL PDF VIEWER
        // ===================================================================
		
		
			// ===================================================================
            // == START: FINANCIAL REPORTS SYSTEM (Complete Section)
            // ===================================================================

            /**
             * Converts a HEX color string to an RGBA string for chart backgrounds.
             */
            const hexToRgba = (hex, alpha = 0.5) => {
                if (!/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)) return `rgba(54, 162, 235, ${alpha})`;
                let c = hex.substring(1).split('');
                if (c.length === 3) { c = [c[0], c[0], c[1], c[1], c[2], c[2]]; }
                c = '0x' + c.join('');
                return `rgba(${[(c>>16)&255, (c>>8)&255, c&255].join(',')},${alpha})`;
            };
            
            /**
             * Draws a chart on a given canvas, with theme-aware colors.
             */
            const drawChart = (chartId, context, dataObject, type = 'bar', isHorizontal = false) => {
                 if (voteCharts[chartId]) voteCharts[chartId].destroy();

                 const style = getComputedStyle(document.documentElement);
                 const primaryColor = style.getPropertyValue('--primary-color').trim();
                 const mutedTextColor = style.getPropertyValue('--text-muted').trim();
                 const gridColor = hexToRgba(mutedTextColor, 0.1);
                 const chartBackgroundColor = 'transparent';

                 const chartPalette = [ '#4A90E2', '#50E3C2', '#F5A623', '#D0021B', '#BD10E0', '#9013FE', '#417505', '#7ED321' ];
                 const barColors = (Object.keys(dataObject).includes('Income')) ? ['rgba(22, 163, 74, 0.7)', 'rgba(239, 68, 68, 0.7)'] : chartPalette;

                 // --- MODIFIED: Conditional Legend Display ---
                 const showLegend = (type === 'pie' || type === 'doughnut'); // Show legend for pie/doughnut charts

                 voteCharts[chartId] = new Chart(context, {
                    type: type,
                    data: { labels: Object.keys(dataObject), datasets: [{ label: 'Votes', data: Object.values(dataObject), backgroundColor: barColors, borderColor: '#FFFFFF', borderWidth: 0 }] },
                    options: { 
                        indexAxis: isHorizontal ? 'y' : 'x',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: showLegend, // Use the conditional variable here
                                labels: {
                                    color: mutedTextColor // Ensure legend labels are theme-aware
                                }
                            },
                            customCanvasBackgroundColor: { color: chartBackgroundColor }
                        },
                        scales: { 
                            y: { display: true, beginAtZero: true, ticks: { color: mutedTextColor, precision: 0 }, grid: { color: gridColor } }, 
                            x: { display: true, ticks: { color: mutedTextColor, precision: 0 }, grid: { display: isHorizontal ? true : false, color: gridColor } } 
                        }
                    },
                    plugins: [{ id: 'customCanvasBackgroundColor', beforeDraw: (chart, args, options) => { const {ctx} = chart; ctx.save(); ctx.globalCompositeOperation = 'destination-over'; ctx.fillStyle = options.color || '#FFFFFF'; ctx.fillRect(0, 0, chart.width, chart.height); ctx.restore(); } }]
                });
            };

            /**
             * Exports the currently viewed transactions to a CSV file.
             */
            const exportTransactionsToCSV = () => {
                if (currentReportTransactions.length === 0) {
                    showToast("No data to export.", "info");
                    return;
                }
                const headers = ['Date', 'Type', 'Category', 'Description', 'Amount'];
                const rows = currentReportTransactions.map(t => [
                    t.date.toDate().toLocaleDateString(),
                    t.type,
                    t.category,
                    `"${(t.description || '').replace(/"/g, '""')}"`,
                    t.amount
                ].join(','));

                const csvContent = [headers.join(','), ...rows].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `financial-report-${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            /**
             * Attaches event listeners to the Print and Export buttons.
             */
            const setupFinancialsPageActions = () => {
                 const printBtn = document.getElementById('print-report-btn');
                 const exportBtn = document.getElementById('export-csv-btn');

                 if (printBtn && !printBtn.dataset.listenerAttached) {
                     printBtn.addEventListener('click', () => window.print());
                     printBtn.dataset.listenerAttached = 'true';
                 }
                 if (exportBtn && !exportBtn.dataset.listenerAttached) {
                     exportBtn.addEventListener('click', exportTransactionsToCSV);
                     exportBtn.dataset.listenerAttached = 'true';
                 }
            };
            
			/**
			 * Handles the submission of the transaction form, saving data to Firestore.
			 * MODIFIED: Adds logging for add/edit operations.
			 */
			const handleTransactionSubmit = async (e) => {
				e.preventDefault();
				const transactionId = e.target.dataset.id;
				const amount = parseFloat(document.getElementById('transaction-amount').value);
				if (isNaN(amount) || amount <= 0) {
					showToast("Please enter a valid amount.", "error");
					return;
				}

				const transactionData = {
					department: document.getElementById('transaction-department').value,
					type: document.querySelector('input[name="transaction-type"]:checked').value,
					amount: amount,
					date: new Date(document.getElementById('transaction-date').value),
					description: document.getElementById('transaction-description').value,
					category: 'general', // Default category
					recordedBy: currentUser.name,
				};

				if (transactionData.department === 'church' && transactionData.type === 'income') {
					const categoryValue = document.getElementById('transaction-category').value;
					if (categoryValue === 'manual_entry') {
						const manualValue = document.getElementById('manual-source-input').value.trim();
						transactionData.category = manualValue || 'Manual Entry';
					} else {
						transactionData.category = categoryValue;
					}
				}

				try {
					let logAction = '';
					let oldTransactionData = null;

					if (transactionId) {
						// Fetch old data for logging comparison
						const oldSnap = await getDoc(doc(db, "financials", transactionId));
						oldTransactionData = oldSnap.exists() ? oldSnap.data() : null;

						transactionData.updatedAt = serverTimestamp();
						await updateDoc(doc(db, "financials", transactionId), transactionData);
						logAction = 'updated';
						showToast("Transaction updated successfully!", "success");
					} else {
						transactionData.createdAt = serverTimestamp();
						await addDoc(collection(db, "financials"), transactionData);
						logAction = 'added';
						showToast("Transaction saved successfully!", "success");
					}

					// --- NEW: Log the financial transaction action ---
					await addDoc(collection(db, "financialLogs"), {
						action: logAction,
						transactionId: transactionId || "new", // Use "new" for added transactions
						department: transactionData.department,
						amount: transactionData.amount,
						type: transactionData.type,
						timestamp: serverTimestamp(),
						loggedBy: currentUser.name,
						loggedById: currentUser.uid,
						oldData: oldTransactionData, // Log old data if updated
						newData: transactionData // Log new data
					});
					// --- END NEW LOGGING ---

					document.getElementById('create-edit-vote-modal').classList.add('hidden');
					generateFinancialsReport(); // Re-generate report to reflect changes
				} catch (error) {
					console.error("Error saving transaction:", error);
					showToast("Failed to save transaction.", "error");
				} finally {
					const submitBtn = e.target.querySelector('button[type="submit"]');
					if(submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Save'; }
				}
			};
            
            /**
             * Opens a modal to add or edit a transaction.
             */
            const openAddTransactionModal = (transaction = null) => {
                const isEditing = transaction !== null;
                const modal = document.getElementById('create-edit-vote-modal');

                // 1. Determine if the dropdown should be locked for non-editors.
                const isLocked = currentUser.role !== 'editor';

                // 2. Determine which department to pre-select.
                // If editing, use the transaction's department. If adding, use the one from the report filter.
                const departmentToSelect = isEditing ? transaction.department : document.getElementById('department-selector').value;

                // 3. Generate the list of <option> elements, marking the correct one as 'selected'.
                const departmentOptionsHTML = [
                    { value: "church", text: "Church Treasurer" },
                    { value: "nubu", text: "Nubu Treasurer" },
                    { value: "mino", text: "Mino Treasurer" },
                    { value: "ce", text: "CE Treasurer" },
                    { value: "building", text: "Building Treasurer" },
                    { value: "mission", text: "Mission Treasurer" },
                    { value: "nunphung_zatlang", text: "Nunphung le Zatlang" }
                ].map(opt => `<option value="${opt.value}" ${opt.value === departmentToSelect ? 'selected' : ''}>${opt.text}</option>`).join('');
                
                // 4. Build the final modal HTML, adding the 'disabled' attribute if isLocked is true.
                modal.innerHTML = `
                    <div class="p-6 rounded-lg shadow-xl max-w-lg w-full mx-auto my-8" style="background-color: var(--card-bg);">
                        <form id="transaction-form" data-id="${isEditing ? transaction.id : ''}">
                            <h2 class="text-xl font-semibold mb-4">${isEditing ? 'Edit' : 'Add New'} Transaction</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="transaction-department" class="block text-sm font-medium">Department</label>
                                    <select id="transaction-department" class="mt-1 block w-full p-2 border-gray-300 rounded-md bg-gray-100" ${isLocked ? 'disabled' : ''}>
                                        ${departmentOptionsHTML}
                                    </select>
                                </div>
                                <div class="flex gap-4">
                                    <label class="flex-1"><input type="radio" name="transaction-type" value="income" ${isEditing && transaction.type === 'income' ? 'checked' : !isEditing ? 'checked' : ''}> Income</label>
                                    <label class="flex-1"><input type="radio" name="transaction-type" value="expense" ${isEditing && transaction.type === 'expense' ? 'checked' : ''}> Expense</label>
                                </div>
                                <div id="source-of-income-div" class="hidden">
                                    <label for="transaction-category" class="block text-sm font-medium">Source of Income</label>
                                    <select id="transaction-category" class="mt-1 block w-full p-2 border-gray-300 rounded-md">
                                        <option value="tithes">Tithes</option>
                                        <option value="offerings">Offerings</option>
                                        <option value="donations">Donations</option>
                                        <option value="manual_entry">Manual Entry</option>
                                    </select>
                                </div>
                                <div id="manual-source-div" class="hidden">
                                     <label for="manual-source-input" class="block text-sm font-medium">Manual Source Name</label>
                                     <input type="text" id="manual-source-input" class="mt-1 block w-full p-2 border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="transaction-amount" class="block text-sm font-medium">Amount</label>
                                    <input type="number" id="transaction-amount" value="${isEditing ? transaction.amount : ''}" step="0.01" min="0" required class="mt-1 block w-full p-2 border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="transaction-date" class="block text-sm font-medium">Date</label>
                                    <input type="date" id="transaction-date" required class="mt-1 block w-full p-2 border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="transaction-description" class="block text-sm font-medium">Description</label>
                                    <textarea id="transaction-description" rows="3" class="mt-1 block w-full p-2 border-gray-300 rounded-md">${isEditing ? transaction.description : ''}</textarea>
                                </div>
                            </div>
                            <div class="flex justify-end gap-2 mt-6">
                               <button type="button" id="cancel-transaction-btn" class="bg-gray-300 px-4 py-2 rounded-md text-gray-800">Cancel</button>
                               <button type="submit" class="btn-primary px-4 py-2 rounded-md text-white">Save Transaction</button>
                            </div>
                        </form>
                    </div>`;
                
                modal.classList.remove("hidden");
                
                const departmentSelect=modal.querySelector('#transaction-department'),typeRadios=modal.querySelectorAll('input[name="transaction-type"]'),categorySelect=modal.querySelector('#transaction-category'),sourceOfIncomeDiv=modal.querySelector('#source-of-income-div'),manualSourceDiv=modal.querySelector('#manual-source-div');
                if(isEditing){departmentSelect.value=transaction.department;modal.querySelector('#transaction-date').valueAsDate=transaction.date.toDate();if(transaction.department==='church_treasurer'&&transaction.type==='income'){const e=['tithes','offerings','donations','manual_entry'];if(e.includes(transaction.category))categorySelect.value=transaction.category;else{categorySelect.value='manual_entry';modal.querySelector('#manual-source-input').value=transaction.category}}}else modal.querySelector('#transaction-date').valueAsDate=new Date();
                const updateFormVisibility=()=>{const e=departmentSelect.value==='church',t=modal.querySelector('input[name="transaction-type"]:checked').value==='income',o=categorySelect.value==='manual_entry';sourceOfIncomeDiv.classList.toggle('hidden',!(e&&t));manualSourceDiv.classList.toggle('hidden',!(e&&t&&o))};
                departmentSelect.addEventListener('change',updateFormVisibility);typeRadios.forEach(e=>e.addEventListener('change',updateFormVisibility));categorySelect.addEventListener('change',updateFormVisibility);updateFormVisibility();
                modal.querySelector('#cancel-transaction-btn').addEventListener('click',()=>modal.classList.add('hidden'));modal.querySelector('#transaction-form').addEventListener('submit',handleTransactionSubmit);
            };

			const deleteTransaction = (transactionId) => {
				showConfirmModal("Are you sure you want to delete this transaction? This cannot be undone.", async () => {
					const transactionRef = doc(db, "financials", transactionId);
					try {
						// Fetch data before deleting for logging
						const transactionSnap = await getDoc(transactionRef);
						const deletedData = transactionSnap.exists() ? transactionSnap.data() : null;

						await deleteDoc(transactionRef);
						showToast("Transaction deleted.", "success");
						generateFinancialsReport();

						// --- NEW: Log the financial transaction deletion ---
						if (deletedData) {
							await addDoc(collection(db, "financialLogs"), {
								action: 'deleted',
								transactionId: transactionId,
								department: deletedData.department,
								amount: deletedData.amount,
								type: deletedData.type,
								timestamp: serverTimestamp(),
								loggedBy: currentUser.name,
								loggedById: currentUser.uid,
								deletedData: deletedData // Log the data that was deleted
							});
						}
						// --- END NEW LOGGING ---

					} catch (error) {
						showToast("Failed to delete transaction.", "error");
						console.error("Error deleting transaction: ", error);
					}
				});
			};
            
            /**
             * A helper function to get start and end dates based on a timeframe string.
             */
            const getTimeframeDates = (timeframe) => {
                const now=new Date();let startDate,endDate;const todayStart=new Date(now.getFullYear(),now.getMonth(),now.getDate());
                switch(timeframe){case'this_week':startDate=new Date(todayStart);startDate.setDate(startDate.getDate()-startDate.getDay());endDate=new Date(startDate);endDate.setDate(endDate.getDate()+6);break;case'last_week':endDate=new Date(todayStart);endDate.setDate(endDate.getDate()-endDate.getDay()-1);startDate=new Date(endDate);startDate.setDate(startDate.getDate()-6);break;case'last_month':startDate=new Date(now.getFullYear(),now.getMonth()-1,1);endDate=new Date(now.getFullYear(),now.getMonth(),0);break;case'last_year':startDate=new Date(now.getFullYear()-1,0,1);endDate=new Date(now.getFullYear()-1,11,31);break;case'custom_range':const t=document.getElementById('date-from').value,o=document.getElementById('date-to').value;if(t&&o){startDate=new Date(t);startDate.setHours(0,0,0,0);endDate=new Date(o)}else{startDate=todayStart;endDate=new Date(todayStart)}break;default:startDate=new Date(now.getFullYear(),now.getMonth(),1);endDate=new Date(now.getFullYear(),now.getMonth()+1,0)}
                endDate.setHours(23,59,59,999);return{startDate,endDate}
            };

            /**
             * Fetches and displays the financial report (DEBUGGING VERSION).
             */
async function generateFinancialsReport() {
  // 1) Grab controls + containers
  const department       = document.getElementById('department-selector').value;
  const timeframe        = document.getElementById('timeframe-selector').value;
  const summaryContainer = document.getElementById('financial-summary-cards');
  const tableContainer   = document.getElementById('financial-table-container');
  const chartsContainer  = document.getElementById('financial-charts-container');
  const reportTitle      = document.getElementById('financial-report-title');

  // 2) Show a loading state
  reportTitle.textContent = 'Generating Report…';
  summaryContainer.innerHTML = '';
  tableContainer.innerHTML   = `<p class="text-center py-4">Loading transactions…</p>`;
  chartsContainer.innerHTML  = '';

  // 3) Compute our date window
  const { startDate, endDate } = getTimeframeDates(timeframe);

  // **Extend endDate to 23:59:59.999** so entries stamped at any hour today are included
  endDate.setHours(23, 59, 59, 999);

  //console.log(`[DEBUG] Dept=${department} TF=${timeframe}`, startDate, endDate);

  // 4) Build the Firestore query (only 'date' has inequalities)
  const financialsRef = collection(db, "financials");
  const q = query(
    financialsRef,
    where("department", "==", department), // equality on department
    where("date",      ">=", startDate),   // start of range
    where("date",      "<=", endDate),     // end of range (end of day)
    orderBy("date",    "desc")             // must match the inequality field
  );

  // 5) Run it and debug‐log what we got
  const snap = await getDocs(q);
  //console.log(`[DEBUG] Returned ${snap.size} docs`, snap.docs.map(d => d.data()));

  const transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }));

  // 6) Aggregate totals + categories
  let totalIncome   = 0;
  let totalExpenses = 0;
  const incomeByCategory = {};

  transactions.forEach(t => {
    if (t.type === 'income') {
      totalIncome += t.amount;
      const cat = t.category || 'general';
      incomeByCategory[cat] = (incomeByCategory[cat] || 0) + t.amount;
    } else {
      totalExpenses += t.amount;
    }
  });
  const netResult = totalIncome - totalExpenses;

  // 7) Render the summary cards
  summaryContainer.innerHTML = `
    <div class="p-2 rounded-lg shadow border-l-4 border-green-500" style="background-color: var(--card-bg);">
      <p class="text-xs font-medium text-slate-500">Total Income</p>
      <p class="text-base font-bold text-green-600">$${totalIncome.toFixed(2)}</p>
    </div>
    <div class="p-2 rounded-lg shadow border-l-4 border-red-500" style="background-color: var(--card-bg);">
      <p class="text-xs font-medium text-slate-500">Total Expenses</p>
      <p class="text-base font-bold text-red-600">$${totalExpenses.toFixed(2)}</p>
    </div>
    <div class="p-2 rounded-lg shadow border-l-4 border-blue-500" style="background-color: var(--card-bg);">
      <p class="text-xs font-medium text-slate-500">Net Result</p>
      <p class="text-base font-bold text-blue-600">$${netResult.toFixed(2)}</p>
    </div>`;

  // 8) Render the transaction table
  if (transactions.length) {
const canEdit = hasPermission(department, 'Treasurer');
  
    const actionHdr = canEdit
      ? `<th class="py-2 px-2 text-right text-xs">Actions</th>`
      : '';
    const rows = transactions.map(t => {
      const btns = canEdit
        ? `<td class="py-1.5 px-2 text-right whitespace-nowrap">
             <button data-action="edit"   data-id="${t.id}" class="text-blue-600 hover:text-blue-800 p-1 text-sm">
               <i class="fas fa-pencil-alt"></i>
             </button>
             <button data-action="delete" data-id="${t.id}" class="text-red-600 hover:text-red-800 p-1 ml-1 text-sm">
               <i class="fas fa-trash"></i>
             </button>
           </td>`
        : '';
      return `
        <tr class="border-b border-slate-200">
          <td class="py-1.5 px-2 text-xs">${t.date.toDate().toLocaleDateString()}</td>
          <td class="py-1.5 px-2">
            <span class="px-2 py-0.5 text-xs rounded-full ${
              t.type==='income'
                ? 'bg-green-100 text-green-800'
                : 'bg-red-100 text-red-800'
            }">${t.type}</span>
          </td>
          <td class="py-1.5 px-2 text-xs">${t.description||'-'}</td>
          <td class="py-1.5 px-2 text-xs text-right font-medium">$${t.amount.toFixed(2)}</td>
          ${btns}
        </tr>`;
    }).join('');
    tableContainer.innerHTML = `
      <table class="w-full text-left">
        <thead class="text-xs uppercase text-slate-500">
          <tr>
            <th class="py-2 px-2 text-xs">Date</th>
            <th class="py-2 px-2 text-xs">Type</th>
            <th class="py-2 px-2 text-xs">Description</th>
            <th class="py-2 px-2 text-xs text-right">Amount</th>
            ${actionHdr}
          </tr>
        </thead>
        <tbody class="text-slate-800">${rows}</tbody>
      </table>`;
  } else {
    tableContainer.innerHTML = `
      <p class="text-center text-gray-500 py-4">
        No transactions found for this period.
      </p>`;
  }

  // Re‐attach edit/delete handlers
  tableContainer.querySelectorAll('button[data-action="edit"]')
    .forEach(b => b.addEventListener('click', () =>
      openAddTransactionModal(transactions.find(t => t.id === b.dataset.id))
    ));
  tableContainer.querySelectorAll('button[data-action="delete"]')
    .forEach(b => b.addEventListener('click', () =>
      deleteTransaction(b.dataset.id)
    ));

  // 9) Render both charts side by side
  chartsContainer.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="p-3 rounded-xl shadow-lg" style="background-color: var(--card-bg);">
        <h3 class="text-base font-semibold text-slate-900 mb-2 text-center">Income by Category</h3>
        <div class="relative h-64"><canvas id="category-chart"></canvas></div>
      </div>
      <div class="p-3 rounded-xl shadow-lg" style="background-color: var(--card-bg);">
        <h3 class="text-base font-semibold text-slate-900 mb-2 text-center">Income vs. Expenses</h3>
        <div class="relative h-64"><canvas id="comparison-chart"></canvas></div>
      </div>
    </div>`;
  
  const categoryData = Object.keys(incomeByCategory).length
    ? incomeByCategory
    : { Income: totalIncome, Expenses: totalExpenses };

  drawChart('category-chart',
    document.getElementById('category-chart').getContext('2d'),
    categoryData, 'pie'
  );
  drawChart('comparison-chart',
    document.getElementById('comparison-chart').getContext('2d'),
    { Income: totalIncome, Expenses: totalExpenses },
    'bar'
  );

  // 10) Set the final title & wire up chart toggles
  reportTitle.textContent = department === 'church'
    ? 'Church Treasurer Summary'
    : `Summary for ${department.charAt(0).toUpperCase() + department.slice(1)}`;
  setupFinancialsPageActions();
}

const fetchFinancialLogs = () => {
    console.log("DEBUG: fetchFinancialLogs called.");
    if (unsubscribeFinancialLogs) unsubscribeFinancialLogs();

    const logsRef = collection(db, "financialLogs");
    unsubscribeFinancialLogs = onSnapshot(query(logsRef, orderBy("timestamp", "desc")), (snapshot) => {
        financialLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        console.log("DEBUG: Financial logs fetched:", financialLogs.length, "items.");
        renderFinancialLogs();
    }, (error) => {
        console.error("ERROR: Error fetching financial logs:", error); // Log the actual error
        showToast("Failed to load financial logs.", "error");
        // Ensure "Loading logs..." is replaced by an error message if fetch fails
        document.getElementById('financial-logs-tbody').innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Error loading logs: ${error.message}. Check permissions.</td></tr>`;
    });
};

const renderFinancialLogs = () => {
    const tbody = document.getElementById('financial-logs-tbody');
    if (!tbody) {
        console.error("ERROR: financial-logs-tbody not found in DOM.");
        return;
    }

    tbody.innerHTML = ''; // Clear previous content

    console.log("DEBUG: renderFinancialLogs called. Logs to render:", financialLogs.length);

    if (financialLogs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No financial activity logged.</td></tr>`;
        return;
    }

    financialLogs.forEach(log => {
        const logDate = log.timestamp ? new Date(log.timestamp.toDate()).toLocaleString() : 'N/A';
        const amountDisplay = log.amount !== undefined ? `$${log.amount.toFixed(2)}` : 'N/A';
        const transactionIdDisplay = log.transactionId === 'new' ? 'NEW' : log.transactionId.substring(0, 6) + '...';

        tbody.innerHTML += `
            <tr class="border-b border-gray-200" style="background-color: var(--card-bg);">
                <td class="py-2 px-2 text-xs">${logDate}</td>
                <td class="py-2 px-2"><span class="px-2 py-0.5 text-xs rounded-full ${
                    log.action === 'added' ? 'bg-green-100 text-green-800' :
                    log.action === 'updated' ? 'bg-blue-100 text-blue-800' :
                    'bg-red-100 text-red-800'
                }">${log.action}</span></td>
                <td class="py-2 px-2 text-xs">${transactionIdDisplay}</td>
                <td class="py-2 px-2 text-xs">${log.department || 'N/A'}</td>
                <td class="py-2 px-2 text-xs text-right font-medium">${amountDisplay}</td>
                <td class="py-2 px-2 text-xs">${log.loggedBy || 'Unknown'}</td>
            </tr>
        `;
    });
};

        /**
         * Sets up the event listeners and initial state for the entire Reports page.
         */
		const setupReportsPage = () => {
			// --- UI Elements for Reports Page (ASSIGNED HERE EACH TIME setupReportsPage runs) ---
			// Get references inside the function, and ensure null checks before using them
			const categorySelector = document.getElementById('report-category-selector');
			const membersSection = document.getElementById('members-report-section');
			const financialsSection = document.getElementById('financials-report-section');
			const meetingReportsSection = document.getElementById('meeting-reports-section');
			const financialLogsSection = document.getElementById('financial-logs-section'); // This is the new section
			const addTransactionBtn = document.getElementById('add-transaction-btn');

			// --- Filter Elements ---
			const filterToggleButton = document.getElementById('financial-filter-toggle-btn');
			const filtersContainer = document.getElementById('financial-filters-container');
			const departmentSelector = document.getElementById('department-selector');
			const timeframeSelector  = document.getElementById('timeframe-selector');

            // Add null checks for safety before attaching listeners
			if (departmentSelector && !departmentSelector.dataset.listenerAttached) {
			    departmentSelector.addEventListener('change', generateFinancialsReport);
			    departmentSelector.dataset.listenerAttached = 'true';
			}
			if (timeframeSelector && !timeframeSelector.dataset.listenerAttached) {
			    timeframeSelector.addEventListener('change', generateFinancialsReport);
			    timeframeSelector.dataset.listenerAttached = 'true';
			}

			const switchReportView = (isInitialLoad = false) => {
				// Default to 'members' if categorySelector is not found yet
				const selectedValue = categorySelector ? categorySelector.value : 'members';

				// Determine visibility for all sections
				const showMembers = selectedValue === 'members';
				const showFinancials = selectedValue === 'financials';
				const showMeetings = selectedValue === 'meetings';
				const showFinancialLogs = selectedValue === 'financial_logs';

				// --- CRITICAL FIX: Add null checks before accessing classList ---
				if (membersSection) membersSection.classList.toggle('hidden', !showMembers);
				if (financialsSection) financialsSection.classList.toggle('hidden', !showFinancials);
				if (meetingReportsSection) meetingReportsSection.classList.toggle('hidden', !showMeetings);
				if (financialLogsSection) financialLogsSection.classList.toggle('hidden', !showFinancialLogs); // Correctly toggles financial logs section

				// Show/hide the financial-specific filters toggle button
				if (filterToggleButton) filterToggleButton.classList.toggle('hidden', !showFinancials);

				// Ensure filters are hidden when switching away from financials
				if (!showFinancials) {
					if (filtersContainer) filtersContainer.classList.add('hidden');
					if (filterToggleButton) filterToggleButton.querySelector('i').classList.remove('rotate-180');
				}

				// Auto-generate report on first load of the financials tab
				if (showFinancials && isInitialLoad) {
				  if (financialsSection && !financialsSection.dataset.generated) {
					let defaultDept = 'church';
					if (currentUser && currentUser.assignments) {
					  const entries = Object.entries(currentUser.assignments);
					  const treasurerEntry = entries.find(([dept, role]) => role === 'Treasurer');
					  if (treasurerEntry) {
						defaultDept = treasurerEntry[0];
					  }
					}
					if (departmentSelector) departmentSelector.value = defaultDept;
					if (timeframeSelector) timeframeSelector.value  = 'this_month';
					generateFinancialsReport();
					updateFinancialActionsVisibility()
					financialsSection.dataset.generated = 'true';
				  }
				}

				// Auto-load meeting reports if that tab is selected
                if (showMeetings) {
                    setupMeetingReportsPage(); // Call recursively if needed, or just apply filters
                }

                // IMPORTANT: Call fetchFinancialLogs when the Financial Logs tab is selected
        if (showFinancialLogs) {
            if (!currentUser) {
                console.warn("WARN: Cannot fetch financial logs - currentUser is null. Please log in.");
                document.getElementById('financial-logs-tbody').innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Please log in to view financial logs.</td></tr>`;
                return; // Stop execution if no user
            }

            console.log("DEBUG: User attempting to fetch financial logs.");
            console.log("DEBUG: currentUser.uid (from app JS):", currentUser.uid);
            console.log("DEBUG: currentUser.role (from app JS):", currentUser.role); // Log the role the app has

            // Client-side check based on the role the app has.
            // This does NOT use Firebase Security Rules directly, but reflects what the app expects.
            if (currentUser.role !== 'editor' && currentUser.role !== 'Auditor') {
                console.warn("WARN: Client-side: Current user role is not Editor or Auditor. Displaying permission message.");
                document.getElementById('financial-logs-tbody').innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">You do not have permission to view financial logs. Your role: ${currentUser.role}</td></tr>`;
                return; // Stop execution if role doesn't match client-side expectation
            }
            fetchFinancialLogs(); // Proceed if checks pass
        }
			};

			// Event Listeners (ensure they are attached only once)
			// Attach event listener for categorySelector outside the switchReportView to avoid re-attaching
			if (categorySelector && !categorySelector.dataset.listenerAttached) {
				categorySelector.addEventListener('change', () => switchReportView(true));
				categorySelector.dataset.listenerAttached = 'true';
			}

			if (filterToggleButton && !filterToggleButton.dataset.listenerAttached) {
				filterToggleButton.addEventListener('click', () => {
					if (filtersContainer) filtersContainer.classList.toggle('hidden');
					if (filterToggleButton) filterToggleButton.querySelector('i').classList.toggle('rotate-180');
				});
				filterToggleButton.dataset.listenerAttached = 'true';
			}

			if (addTransactionBtn && !addTransactionBtn.dataset.listenerAttached) {
				addTransactionBtn.addEventListener('click', () => openAddTransactionModal());
				addTransactionBtn.dataset.listenerAttached = 'true';
			}
			const generateBtn = document.getElementById('generate-financial-report-btn');
			if (generateBtn && !generateBtn.dataset.listenerAttached) {
			   generateBtn.addEventListener('click', generateFinancialsReport);
			   generateBtn.dataset.listenerAttached = 'true';
			}

			// Initial setup on page load - always call to ensure correct view
			switchReportView(true);
		};

            // ===================================================================
            // == END: FINANCIAL REPORTS SYSTEM
            // ===================================================================

				// --- Reports Setup -------
				const setupReportsPageNavigation = () => {
					const categorySelector = document.getElementById('report-category-selector');
					const membersSection = document.getElementById('members-report-section');
					const financialsSection = document.getElementById('financials-report-section');

					categorySelector.addEventListener('change', (e) => {
						const selectedValue = e.target.value;
						// Hide all sections first
						membersSection.classList.add('hidden');
						financialsSection.classList.add('hidden');

						// Show the selected one
						if (selectedValue === 'members') {
							membersSection.classList.remove('hidden');
						} else if (selectedValue === 'financials') {
							financialsSection.classList.remove('hidden');
						}
					});

					// Add listener for the button that generates the financial report
					document.getElementById('generate-financial-report-btn').addEventListener('click', generateFinancialsReport);
				};


			const switchPage = (pageId) => {
                const headerTitle = document.getElementById('header-title');
                let newTitle = 'CCC Indy'; // Default title
				const sermonDetailBackBtn = document.getElementById('sermon-detail-back-btn');
				
				// Reset/adjust UI elements for Hymns page
				const hymnSearchBox = document.getElementById('hymn-search-box');
				const hymnFilterBy = document.getElementById('hymn-filter-by');
				const viewFavoriteHymnsBtn = document.getElementById('view-favorite-hymns-btn');				
				
				// Hide back button by default
				if (sermonDetailBackBtn) {
					sermonDetailBackBtn.classList.add('hidden');
				}
                switch (pageId) {
                    case 'home': newTitle = 'Welcome to CCC!'; break;
                    case 'edit-my-profile': newTitle = 'Edit My Profile'; break;
                    case 'ministers': newTitle = 'Our Ministers'; break;
                    case 'events': newTitle = 'Upcoming Events'; break;
                    case 'favorites': newTitle = 'My Favorites'; break;
                    case 'give': newTitle = 'Give to the Church'; break;
                    case 'prayer-request': newTitle = 'Prayer Request'; break;
                    case 'prayer-wall': newTitle = 'Community Prayer Wall'; break;
                    case 'register': newTitle = 'Register New Household'; break;
                    case 'user-management': newTitle = 'User Management'; break;
                  	case 'voting': newTitle = 'Community Voting'; break;
                    case 'update-info': newTitle = 'Request Information Update'; break;
                    case 'sermons': 
                        newTitle = 'Sermons & Media Library'; 
                        // --- NEW: Hide sermon notification badge on page visit ---
                        document.getElementById('sermon-notification-badge').classList.add('hidden');
                        break;
                    case 'sermon-detail':
                        newTitle = 'Sermon'; // Title will be updated again by the render function
						if (sermonDetailBackBtn) {
							sermonDetailBackBtn.classList.remove('hidden');
						}						
                        break;					
                    case 'post-detail': newTitle = 'Post Details'; break;
                    case 'groupA': case 'groupB': case 'groupC': case 'groupD':
                        newTitle = 'Group Members';
                        break;
					case 'saved-posts':
						newTitle = 'My Saved Posts';
						renderSavedPostsPage(); // Call the specific render function for this page
						break;						
					case 'reports':
						newTitle = 'Reports & Analytics';
						// Ensure the main reports page div is active first
						const reportsPageDiv = document.getElementById('page-reports');
						if (reportsPageDiv) {
							// Now, call setupReportsPage, which will get its elements
							// and handle the sub-section visibility
							setupReportsPage();
						} else {
							console.error("ERROR: #page-reports div not found!");
						}
						break;
					case 'hymns':
						newTitle = 'Hymns Library';
						updateHymnsDisplay(); // Initial display of hymns list
						break;
					case 'hymn-detail':
						newTitle = 'Hymn Content'; // Will be updated by renderHymnDetailPage
						break;
                }
                headerTitle.textContent = newTitle;

                currentPage = pageId;
                
                navTabs.querySelectorAll('.sidebar-nav-link').forEach(link => {
                    link.classList.toggle('active', link.dataset.page === pageId);
                });

                mainContent.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });

                const targetPage = document.getElementById(`page-${pageId}`);
                if (targetPage) {
                    targetPage.classList.add('active');
                }

                // --- RENDER LOGIC FOR ALL PAGES ---
                if (pageId === 'sermons') {
                    updateSermonDisplay();
				} else if (pageId === 'sermon-detail') {
                    renderSermonDetailPage();
                } else if (pageId === 'post-detail') {
                    renderPostDetailPage();
                } else if (pageId === 'reports') {
                    generateReports();
				setupReportsPage();
					setupMeetingReportsPage();
                } else if (pageId === 'prayer-wall') {
                    renderPrayerWall(); 
                } else if (pageId === 'favorites') {
                    renderFavoritesPage();
                } else if (pageId === 'ministers') {
                    renderMinistersPage();
                } else if (pageId === 'events') {
                    renderEventsPage();
                } else if (pageId === 'user-management') {
                    renderUserManagementPage();
                } else if (pageId === 'edit-my-profile') {
                    renderEditMyProfilePage();
                } else if (pageId === 'give') {
                    fetchZelleRecipient();
                    fetchOnlinePaymentLink();
                } else if (pageId === 'hymns') {
					if (hymnSearchBox) hymnSearchBox.value = ''; // Clear search on page entry
					if (hymnFilterBy) hymnFilterBy.value = 'title'; // Reset filter on page entry
					currentHymnView = 'all'; // Reset to all hymns view
				} else if (pageId === 'hymn-detail') {
					renderHymnDetailPage(); // Render the detail page
				}
				

                if (window.innerWidth < 1024) {
                    toggleSidebar(false);
                }
				if (pageId !== 'voting') {
					// Stop listening to voting data when leaving the page to save resources
					if (unsubscribeVotingSessions) unsubscribeVotingSessions();
					if (unsubscribeRealtimeVotes) unsubscribeRealtimeVotes();
					if (unsubscribeUserVotes) unsubscribeUserVotes();
				} else {
					// When navigating TO the voting page, ensure data is fresh
					fetchVotingSessions();
				}
            };
			
        manageSlideshowBtn = document.getElementById('manage-slideshow-btn');
        manageSlideshowModal = document.getElementById('manage-slideshow-modal'); // Assuming this is also within the 'home' page's structure or globally available after 'home' renders.

        if (manageSlideshowBtn) {
            manageSlideshowBtn.removeEventListener('click', openManageSlideshowModal); // Prevent duplicates
            manageSlideshowBtn.addEventListener('click', openManageSlideshowModal);
            console.log("DEBUG: manageSlideshowBtn listener attached in switchPage('home').");
            // Also ensure its visibility based on role after it's attached
            if (currentUser && currentUser.role === 'editor') {
                manageSlideshowBtn.classList.remove('hidden');
            } else {
                manageSlideshowBtn.classList.add('hidden');
            }
        } else {
            console.error("ERROR: 'manage-slideshow-btn' element not found during switchPage('home').");
        }
			

            const fetchAllMembers = () => {
                if (unsubscribeMembers) unsubscribeMembers(); // Unsubscribe from previous listener
                
                const membersRef = collection(db, "members");
                unsubscribeMembers = onSnapshot(membersRef, (snapshot) => {
                    allMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateGroupCounts();
                    renderAllMemberLists();
                    if (currentPage === 'favorites') {
                        renderFavoritesPage();
                    }
                    if(currentPage === 'reports') {
                        generateReports();
                    }
                });
            };

            const updateGroupCounts = () => {
                const counts = { A: 0, B: 0, C: 0, D: 0 };
                allMembers.forEach(m => {
                    if (counts.hasOwnProperty(m.group)) {
                        counts[m.group]++;
                    }
                });
                for (const group in counts) {
                    document.getElementById(`count-group${group}`).textContent = `(${counts[group]})`;
                }
            };
            
            const filterAndRenderGroupList = (group, searchTerm = '') => { // Removed sortBy parameter
                const memberListContainer = document.getElementById(`member-list-group${group}`);
                const memberCountSpan = document.getElementById(`member-count-group${group}-header`);

                if (!memberListContainer || !memberCountSpan) return;

                const lowerCaseSearchTerm = searchTerm.toLowerCase();

                let membersToShow;
                // Use the global displayMode directly
                if (displayMode === 'simpleList' || displayMode === 'individualDetailList' || displayMode === 'nameOnly') {
                    membersToShow = allMembers.filter(m => m.group === group);
                } else {
                    membersToShow = allMembers.filter(m => m.group === group && m.isHead);
                }

                const filteredMembers = membersToShow.filter(member => {
                        return !searchTerm ||
                               (member.name && member.name.toLowerCase().includes(lowerCaseSearchTerm)) ||
                               (member.phone && member.phone.toLowerCase().includes(lowerCaseSearchTerm)) ||
                               (member.address && member.address.toLowerCase().includes(lowerCaseSearchTerm));
                    });

                // AUTO-SORT A-Z by name
                filteredMembers.sort((a, b) => a.name.localeCompare(b.name));

                memberCountSpan.textContent = `(${filteredMembers.length})`;
                memberListContainer.innerHTML = '';

                if (filteredMembers.length === 0) {
                    memberListContainer.innerHTML = `<p class="col-span-full" style="color: var(--text-muted)">No members found.</p>`;
                    return;
                }

                filteredMembers.forEach(member => {
                    const card = createMemberCard(member);
                    memberListContainer.appendChild(card);
                });

                if (isEditModeActive) {
                    memberListContainer.querySelectorAll('.editor-only-section').forEach(el => el.classList.remove('hidden'));
                } else {
                    memberListContainer.querySelectorAll('.editor-only-section').forEach(el => el.classList.add('hidden'));
                }
            };

            const createMemberCard = (member) => {
                const card = document.createElement('div');
                card.className = "p-4 rounded-xl shadow-md flex flex-col gap-3";
                const isSelected = selectedMembers.some(sm => sm.id === member.id);
                const isFavorited = userFavorites.some(favId => favId === member.id);

                let editorControls = '';
                 // Only generate controls for editors, wrapping them in a class that can be toggled
                 if (currentUser && currentUser.role === 'editor') {
                    // --- FIX: Add the 'hidden' class by default ---
                    editorControls = `
                        <div class="editor-only-section hidden mt-2 pt-3 border-t border-gray-200 flex items-center justify-end gap-2">
                            <button data-household-id="${member.householdId}" class="edit-btn text-xs font-medium text-indigo-600 hover:text-indigo-800">Edit</button>
                            <button data-id="${member.id}" class="delete-btn text-xs font-medium text-red-600 hover:text-red-800">Delete</button>
                        </div>
                    `;
                }

                let cardHTML = '';
                let cardMainContent = '';
                if (displayMode === 'nameOnly') {
                    cardMainContent = `<h3 class="text-base sm:text-lg font-bold leading-tight">${member.name}</h3>`;
                    // REMOVE OR MODIFY THIS LINE:
                    // card.classList.add('cursor-pointer');
                    // card.onclick = () => showMemberInfoModal(member.id);
                } else {
                    switch(displayMode) {
                        case 'simpleList':
                            cardMainContent = `
                                <h3 class="text-base sm:text-lg font-bold leading-tight">${member.name}</h3>
                                <p class="mt-1 text-xs sm:text-sm break-words info-item"><i class="fas fa-phone"></i><a href="tel:${member.phone}">${member.phone || 'N/A'}</a></p>
                                <p class="mt-1 text-xs sm:text-sm break-words info-item"><i class="fas fa-map-marker-alt"></i><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(member.address)}" target="_blank" rel="noopener noreferrer">${member.address || 'N/A'}</a></p>
                            `;
                            break;
                        case 'individualDetailList':
                            cardMainContent = `
                                <h3 class="text-base sm:text-lg font-bold leading-tight">${member.name}</h3>
                                <p class="mt-1 text-xs sm:text-sm info-item"><i class="fas fa-phone"></i><a href="tel:${member.phone}">${member.phone || 'N/A'}</a></p>
                                <p class="mt-1 text-xs sm:text-sm info-item"><i class="fas fa-map-marker-alt"></i><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(member.address)}" target="_blank" rel="noopener noreferrer">${member.address || 'N/A'}</a></p>
                                <p class="mt-1 text-xs sm:text-sm info-item"><i class="fas fa-envelope"></i>${member.email || 'N/A'}</p>
                                <p class="mt-1 text-xs sm:text-sm info-item"><i class="fas fa-venus-mars"></i>${member.gender || 'N/A'}</p>
                                <p class="mt-1 text-xs sm:text-sm info-item"><i class="fas fa-church"></i>${member.baptized ? 'Baptized' : 'Not Baptized'}</p>
                            `;
                            break;
                        case 'simpleFamily':
                            const simpleFamilyMembers = allMembers.filter(m => m.householdId === member.householdId);
                            cardMainContent = `
                                <ul class="space-y-1">
                                    ${simpleFamilyMembers.map(m => `<li>${m.name} ${m.isHead ? '(Head)' : ''}</li>`).join('')}
                                </ul>
                                <p class="mt-2 text-xs sm:text-sm info-item"><i class="fas fa-map-marker-alt"></i><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(member.address)}" target="_blank" rel="noopener noreferrer">${member.address || 'N/A'}</a></p>
                            `;
                            break;
                        case 'familyWithPictures':
                            cardMainContent = `
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center gap-3">
                                        ${ member.profilePic ? `<img src="${member.profilePic}" alt="${member.name}" class="profile-pic !w-10 !h-10">` : `<div class="profile-pic-placeholder !w-10 !h-10"><i class="fas fa-${member.gender === 'Male' ? 'male' : (member.gender === 'Female' ? 'female' : 'genderless')}"></i></div>` }
                                        <h3 class="text-base sm:text-lg font-bold leading-tight">${member.name}</h3>
                                    </div>
                                    <button data-household-id="${member.householdId}" class="show-family-btn text-xs font-medium text-green-600 hover:text-green-800 ml-auto">Show Family</button>
                                </div>
                                <p class="mt-2 text-xs sm:text-sm info-item"><i class="fas fa-map-marker-alt"></i><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(member.address)}" target="_blank" rel="noopener noreferrer">${member.address || 'N/A'}</a></p>
                            `;
                            break;
                        case 'familyDetails':
                        default:
                            const familyMembers = allMembers.filter(m => m.householdId === member.householdId);
                            const familyButton = familyMembers.length > 1 ? `<button data-household-id="${member.householdId}" class="show-family-btn text-xs font-medium text-green-600 hover:text-green-800 ml-auto">Show Family (${familyMembers.length})</button>` : '';
                            cardMainContent = `
                                <div class="flex justify-between items-start">
                                    <h3 class="text-base sm:text-lg font-bold leading-tight">${member.name}</h3>
                                    ${familyButton}
                                </div>
                                <p class="mt-1 text-xs sm:text-sm break-words info-item"><i class="fas fa-phone"></i><a href="tel:${member.phone}">${member.phone || 'N/A'}</a></p>
                                <p class="mt-1 text-xs sm:text-sm break-words info-item"><i class="fas fa-map-marker-alt"></i><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(member.address)}" target="_blank" rel="noopener noreferrer">${member.address || 'N/A'}</a></p>
                            `;
                            break;
                    }
                }

				let controlsHtml = '';
                if (displayMode === 'nameOnly') {
                    controlsHtml = `<input type="checkbox" data-id="${member.id}" ${isSelected ? 'checked' : ''} class="member-checkbox">`;
                } else {
                    controlsHtml = `
                        <input type="checkbox" data-id="${member.id}" ${isSelected ? 'checked' : ''} class="member-checkbox">
                        <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" data-id="${member.id}"><i class="fas fa-star"></i></button>
                    `;
                }

                card.innerHTML = `
                    <div class="flex items-start gap-3 flex-grow">
                        <div class="flex-shrink-0 pt-1 flex flex-col items-center gap-2">
                           ${controlsHtml}
                        </div>
                        <div class="flex-grow">${cardMainContent}</div>
                    </div>
                    ${editorControls}
                `;

                const memberCheckbox = card.querySelector('.member-checkbox');
                if (memberCheckbox) {
                    memberCheckbox.addEventListener('change', (e) => handleCheckboxChange(e.target.checked, member));
                }

                const favoriteButton = card.querySelector('.favorite-btn');
                if (favoriteButton) {
                    favoriteButton.addEventListener('click', (e) => toggleFavorite(e.currentTarget.dataset.id));
                }

                if (currentUser && currentUser.role === 'editor') {
                    card.querySelector('.edit-btn')?.addEventListener('click', (e) => openHouseholdEditModal(e.target.dataset.householdId));
                    card.querySelector('.delete-btn')?.addEventListener('click', () => deleteMember(member.id, member.name));
                }
                if (card.querySelector('.show-family-btn')) {
                     card.querySelector('.show-family-btn').addEventListener('click', (e) => showFamilyModal(e.target.dataset.householdId));
                }

                // Add this click listener ONLY for the name text in "nameOnly" view
                if (displayMode === 'nameOnly') {
                    const nameElement = card.querySelector('h3'); // Assuming h3 contains the name
                    if (nameElement) {
                        nameElement.classList.add('cursor-pointer'); // Add cursor for visual cue
                        nameElement.addEventListener('click', () => showMemberInfoModal(member.id));
                    }
                }

                return card;
            };

            const renderAllMemberLists = () => {
                ['A', 'B', 'C', 'D'].forEach(group => {
                    const searchBox = document.querySelector(`.search-box[data-group="${group}"]`);
                    // The sortBox is now the displayModeSelector
                    const displayModeSelector = document.querySelector(`.display-mode-selector[data-group="${group}"]`);


                    // Ensure listeners are attached only once per group for search
                    if (searchBox && !searchBox.dataset.listenerAttached) {
                        searchBox.addEventListener('input', () => {
                            filterAndRenderGroupList(group, searchBox.value); // No sortBy
                        });
                        searchBox.dataset.listenerAttached = true;
                    }

                    // Attach listener for the new display mode selector
                    if (displayModeSelector && !displayModeSelector.dataset.listenerAttached) {
                        displayModeSelector.addEventListener('change', (e) => {
                            displayMode = e.target.value; // Update the global displayMode
                            saveSettings(); // Save the new setting
                            // Re-render all group lists to apply the new display mode
                            renderAllMemberLists();
                        });
                        displayModeSelector.dataset.listenerAttached = true;
                    }

                    // Initial render/filter for the group, using the global displayMode
                    filterAndRenderGroupList(group, searchBox ? searchBox.value : ''); // No sortBy
                });
            };

            const handleCheckboxChange = (isChecked, member) => {
                if (isChecked) {
                    if (!selectedMembers.some(sm => sm.id === member.id)) {
                        // NEW: Enforce selection limit
                        if (selectedMembers.length >= 10) { // Limit to 10 waypoints + origin + destination = 12 total
                            showToast("You can select a maximum of 10 destinations.", "info");
                            e.target.checked = false; // Uncheck the box if limit is reached
                            return;
                        }
                        selectedMembers.push({ id: member.id, name: member.name, address: member.address });
                    }
                } else {
                    selectedMembers = selectedMembers.filter(sm => sm.id !== member.id);
                }
                updatePlannerBar();
            };

            const updateFinancialActionsVisibility = () => {
                const actionsContainer = document.getElementById('financials-actions');
                const addTransactionBtn = document.getElementById('add-transaction-btn');
                const selectedDept = document.getElementById('department-selector').value;

                const isTreasurerForDept = hasPermission(selectedDept, 'Treasurer');
                const isEditor = currentUser.role === 'editor';

                let showContainer = false;
                let showAddButton = false;

                // Determine visibility based on role and mode
                if (isEditor) {
                    showContainer = true; // Editors can always see Print/Export
                    showAddButton = isEditModeActive; // But only add/edit in Edit Mode
                } else if (isTreasurerForDept) {
                    showContainer = true; // Treasurers see all actions for their department
                    showAddButton = true;
                }

                // Apply the visibility rules
                actionsContainer.classList.toggle('hidden', !showContainer);
                if (addTransactionBtn) {
                   addTransactionBtn.classList.toggle('hidden', !showAddButton);
                }
            };
			
		    function toggleEditMode() {
                isEditModeActive = !isEditModeActive;
                const toggleBtn = document.getElementById('edit-mode-toggle-btn');
                toggleBtn.classList.toggle('active', isEditModeActive);

                document.querySelectorAll('.editor-only-section').forEach(el => {
                    el.classList.toggle('hidden', !isEditModeActive);
                });

                if (isEditModeActive) { showToast("Edit Mode Enabled.", "success"); }
                else { showToast("Edit Mode Disabled.", "info"); }

                const financialsReportSection = document.getElementById('financials-report-section');
                if (financialsReportSection && !financialsReportSection.classList.contains('hidden')) {
                    updateFinancialActionsVisibility();
                    generateFinancialsReport();
                }

                if (window.innerWidth < 1024) {
                    toggleSidebar(false);
                }
            };
			
            clearSelectionBtn.addEventListener('click', () => {
                document.querySelectorAll('.member-checkbox:checked').forEach(cb => cb.checked = false);
                selectedMembers = [];
                // No longer need to clear finalDestinationInput here as it's not permanently on the bar
                updatePlannerBar(); // This will now correctly hide the bar if selectedMembers is empty
            });

            const updatePlannerBar = () => {
                const count = selectedMembers.length;
                selectedCountEl.textContent = count;
                
                planRouteBtn.disabled = count === 0 || count > 11; // Allow up to 11 selected members (1 origin + 10 waypoints + 1 destination)


                // Show/hide the route planner bar based on selection
                routePlannerBar.classList.toggle('hidden', count === 0);
            };
            
            planRouteBtn.addEventListener('click', async () => {
                // Re-check conditions as state might have changed since button was enabled
                if (selectedMembers.length === 0 || selectedMembers.length > 11) {
                    showToast("Please select between 1 and 11 members for the route.", "error");
                    return;
                }
                
                let originAddress = '';
                let waypointsArray = [];
                let finalDestinationAddress = '';

                // Step 1: Get Origin (Current Location or First Selected Member)
                showToast("Attempting to get current location...", "info");
                try {
                    if (navigator.geolocation) {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0
                            });
                        });
                        originAddress = `${position.coords.latitude},${position.coords.longitude}`;
                        showToast("Using current location as start point!", "success");
                        waypointsArray = selectedMembers.map(m => m.address); // All selected members are waypoints
                    } else {
                        throw new Error("Geolocation not supported or denied."); // Force fallback
                    }
                } catch (error) {
                    console.error("Error getting current location, falling back:", error);
                    showToast("Could not get current location. Using first selected member as origin.", "error");
                    
                    // Fallback to first selected member as origin, rest as waypoints
                    originAddress = selectedMembers[0].address;
                    waypointsArray = selectedMembers.slice(1).map(m => m.address);
                }

                // If at this point originAddress is still empty (e.g., no geolocation AND no members selected, though the initial check should prevent this)
                if (!originAddress) {
                    showToast("Could not determine a starting point for the route.", "error");
                    return;
                }

                // Step 2: Determine Final Destination (via popup if needed)
                // If only one member is selected and geolocation is the origin, we need a separate final destination.
                // If more than one member is selected, the LAST selected member becomes the default destination,
                // and the popup allows override.
                
                let defaultFinalDestination = '';
                let membersAsWaypointsForPopup = [...waypointsArray]; // Copy for manipulation

                if (membersAsWaypointsForPopup.length > 0) {
                    defaultFinalDestination = membersAsWaypointsForPopup.pop(); // Last waypoint becomes default final destination
                }

                // Prompt for final destination if:
                // 1. Only 1 member selected AND geolocation was successful (need a final stop besides that member)
                // 2. Or, more than 1 member selected (default final destination is the last, but user can override)
                if (selectedMembers.length === 1 && originAddress.includes(',')) { // Case 1: Geolocation origin, 1 selected member
                     // Here, the single selected member is a waypoint, we need a true final destination.
                     finalDestinationAddress = await showPromptModal("Enter your final destination address (e.g., home, church):", defaultFinalDestination);
                     if (!finalDestinationAddress) {
                        showToast("Final destination is required.", "error");
                        return;
                    }
                } else if (selectedMembers.length > 1) { // Case 2: Multiple selected members (or first selected is origin)
                    finalDestinationAddress = await showPromptModal("Enter your final destination address (optional, defaults to last selected member):", defaultFinalDestination);
                    if (!finalDestinationAddress) {
                        finalDestinationAddress = defaultFinalDestination; // Use the default (last selected member)
                    }
                } else { // Case: Only current location, no members selected
                    finalDestinationAddress = await showPromptModal("Enter your final destination address (e.g., home, church):", "Your Home Address");
                     if (!finalDestinationAddress) {
                        showToast("Final destination is required.", "error");
                        return;
                    }
                }
				



				


                // Construct Google Maps URL
                let mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(originAddress)}&destination=${encodeURIComponent(finalDestinationAddress)}`;
                
                // Add waypoints if they exist and are within limit
                if (waypointsArray.length > 0) { // Check length *before* slicing to account for destination removal
                    // The waypointsArray already contains only the elements that should be waypoints.
                    // Now, we need to ensure the actual *count* of waypoints after considering the explicit destination.
                    const finalWaypoints = waypointsArray.filter(addr => addr !== finalDestinationAddress); // Ensure destination isn't also a waypoint

                    if (finalWaypoints.length > 0 && finalWaypoints.length <= 10) { // Google Maps allows max 10 waypoints
                        mapsUrl += `&waypoints=${finalWaypoints.map(addr => encodeURIComponent(addr)).join('|')}`;
                    } else if (finalWaypoints.length > 10) {
                        showToast(`Warning: Google Maps supports a maximum of 10 waypoints. Only the first 10 will be used.`, "warn");
                        mapsUrl += `&waypoints=${finalWaypoints.slice(0, 10).map(addr => encodeURIComponent(addr)).join('|')}`;
                    }
                }

                window.open(mapsUrl, '_blank');
            });


            const toggleFavorite = async (memberId) => {
                if(!currentUser) return;
                const favRef = doc(db, 'userFavorites', currentUser.uid);
                
                if(userFavorites.includes(memberId)) {
                    await updateDoc(favRef, { favoriteMemberIds: arrayRemove(memberId) });
                } else {
                    await setDoc(favRef, { favoriteMemberIds: arrayUnion(memberId) }, { merge: true });
                }
            };
            
            const renderFavoritesPage = () => {
                const favoritesListContainer = document.getElementById('member-list-favorites');
                favoritesListContainer.innerHTML = '';
                const favoriteMembers = allMembers.filter(m => userFavorites.includes(m.id));
                document.getElementById('count-favorites').textContent = `(${favoriteMembers.length})`;

                if (favoriteMembers.length === 0) {
                    favoritesListContainer.innerHTML = `<p class="col-span-full" style="color: var(--text-muted)">You haven't added any favorites yet.</p>`;
                    return;
                }
                
                favoriteMembers.forEach(member => {
                    const card = createMemberCard(member);
                    favoritesListContainer.appendChild(card);
                });
            };


			// --- Sermon Management Functions ---

			const openAddEditSermonModal = (sermon = null) => {
				const isEditing = sermon !== null;
				const modalId = 'add-edit-sermon-modal';

				let existingModal = document.getElementById(modalId);
				if (existingModal) existingModal.remove();

				const modal = document.createElement('div');
				modal.id = modalId;
				modal.className = 'hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center';

				modal.innerHTML = `
					<div class="p-5 rounded-lg shadow-xl w-full max-w-2xl" style="background-color: var(--card-bg);">
						<div class="modal-body">
							<h3 class="text-lg text-center font-medium mb-4">${isEditing ? 'Edit Sermon' : 'Add New Sermon'}</h3>
							<form id="add-edit-sermon-form" class="space-y-4">
								<input type="hidden" id="sermon-id" value="${sermon ? sermon.id : ''}">
								<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
									<div>
										<label for="sermon-title" class="block text-sm font-medium">Title</label>
										<input type="text" id="sermon-title" value="${sermon ? sermon.title : ''}" required class="mt-1 block w-full px-3 py-2 border rounded-md">
									</div>
									<div>
										<label for="sermon-speaker" class="block text-sm font-medium">Speaker</label>
										<input type="text" id="sermon-speaker" value="${sermon ? sermon.speaker : ''}" required class="mt-1 block w-full px-3 py-2 border rounded-md">
									</div>
								</div>
								<div>
									<label for="sermon-date" class="block text-sm font-medium">Date</label>
									<input type="date" id="sermon-date" value="${sermon ? sermon.sermonDate : ''}" required class="mt-1 block w-full px-3 py-2 border rounded-md">
								</div>

								<div>
									<label for="sermon-image" class="block text-sm font-medium">Custom Cover Image (Optional)</label>
									<input type="file" id="sermon-image" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
									<p class="text-xs text-gray-500 mt-1">If no image is uploaded, a thumbnail from the YouTube link will be used as a fallback.</p>
								</div>

								<div>
									<label for="speaker-profile-pic" class="block text-sm font-medium">Speaker Profile Picture (Optional)</label>
									<input type="file" id="speaker-profile-pic" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
									${isEditing && speakerProfiles[sermon.speaker] ? `<img src="${speakerProfiles[sermon.speaker]}" class="mt-2 w-20 h-20 object-cover rounded-full" alt="Current Speaker Pic">` : ''}
									<p class="text-xs text-gray-500 mt-1">Upload to save for this speaker's future sermons. Will override existing if same name.</p>
								</div>

								<div>
									<label for="sermon-video-url" class="block text-sm font-medium">YouTube Video URL (Optional)</label>
									<input type="url" id="sermon-video-url" value="${sermon ? sermon.videoUrl : ''}" class="mt-1 block w-full px-3 py-2 border rounded-md" placeholder="e.g., https://www.youtube.com/watch?v=...">
								</div>
								<div>
									<label for="sermon-audio-url" class="block text-sm font-medium">Audio URL (Optional)</label>
									<input type="url" id="sermon-audio-url" value="${sermon ? sermon.audioUrl : ''}" class="mt-1 block w-full px-3 py-2 border rounded-md" placeholder="e.g., https://.../sermon.mp3">
								</div>
								<div>
									<label for="sermon-description" class="block text-sm font-medium">Description / Notes (Optional)</label>
									<textarea id="sermon-description" rows="3" class="mt-1 block w-full px-3 py-2 border rounded-md">${sermon ? sermon.description : ''}</textarea>
								</div>
								<div class="pt-4 flex justify-end gap-3">
									<button type="button" id="cancel-sermon-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md">Cancel</button>
									<button type="submit" class="px-4 py-2 text-white rounded-md btn-primary">Save Sermon</button>
								</div>
							</form>
						</div>
					</div>
				`;
				document.body.appendChild(modal);
				modal.classList.remove('hidden');

				document.getElementById('cancel-sermon-btn').addEventListener('click', () => modal.remove());
				document.getElementById('add-edit-sermon-form').addEventListener('submit', handleAddEditSermon);
			};

			const handleAddEditSermon = async (e) => {
				e.preventDefault();
				const sermonId = document.getElementById('sermon-id').value;
				const imageFile = document.getElementById('sermon-image').files[0];
				const speakerProfilePicFile = document.getElementById('speaker-profile-pic').files[0];

				const sermonData = {
					title: document.getElementById('sermon-title').value,
					speaker: document.getElementById('sermon-speaker').value,
					sermonDate: document.getElementById('sermon-date').value,
					videoUrl: document.getElementById('sermon-video-url').value,
					audioUrl: document.getElementById('sermon-audio-url').value,
					description: document.getElementById('sermon-description').value,
					updatedAt: serverTimestamp()
				};

				// --- MODIFIED: Handle sermon image upload to Storage ---
				let sermonImageUrl = sermonId ? allSermons.find(s => s.id === sermonId)?.imageUrl : null; // Preserve existing URL
				if (imageFile) {
					const imagePath = `sermonImages/${Date.now()}_${imageFile.name}`;
					sermonImageUrl = await uploadFileToStorage(imageFile, imagePath);
				}
				sermonData.imageUrl = sermonImageUrl; // Assign the URL (new or existing)

				try {
					// Handle speaker profile picture upload (already correct, uses Storage)
					if (speakerProfilePicFile) {
						const speakerName = sermonData.speaker;
						const speakerPicPath = `speakerProfiles/${speakerName.replace(/\s+/g, '_')}_${Date.now()}_${speakerProfilePicFile.name}`;
						const downloadURL = await uploadFileToStorage(speakerProfilePicFile, speakerPicPath);

						await setDoc(doc(db, "speakerProfiles", speakerName), { profilePic: downloadURL, updatedAt: serverTimestamp() }, { merge: true });
					}

					if (sermonId) {
						await setDoc(doc(db, "sermons", sermonId), sermonData, { merge: true });
						showToast("Sermon updated successfully!", "success");
					} else {
						sermonData.createdAt = serverTimestamp();
						sermonData.views = 0;
						sermonData.authorId = currentUser.uid;
						await addDoc(collection(db, "sermons"), sermonData);
						showToast("Sermon added successfully!", "success");
					}
					document.getElementById('add-edit-sermon-modal').remove();
				} catch (error) {
					console.error("Error saving sermon:", error);
					showToast("Failed to save sermon.", "error");
				}
			};

			const populateSpeakerFilterModal = () => {
				const modalList = document.getElementById('sermon-speaker-modal-list');
				modalList.innerHTML = ''; // Clear previous options

				const allSpeakers = new Set(allSermons.map(sermon => sermon.speaker).filter(Boolean));
				const sortedSpeakers = Array.from(allSpeakers).sort();

				// Add 'All Speakers' option
				let li = document.createElement('li');
				li.className = 'py-2 px-3 hover:bg-gray-100 rounded-md cursor-pointer';
				li.textContent = 'All Speakers';
				li.dataset.value = '';
				modalList.appendChild(li);

				sortedSpeakers.forEach(speaker => {
					li = document.createElement('li');
					li.className = 'py-2 px-3 hover:bg-gray-100 rounded-md cursor-pointer';
					li.textContent = speaker;
					li.dataset.value = speaker;
					modalList.appendChild(li);
				});

				modalList.querySelectorAll('li').forEach(item => {
					item.addEventListener('click', () => {
						document.getElementById('sermon-speaker-filter').value = item.dataset.value;
						document.getElementById('sermon-speaker-filter-mobile-btn').textContent = `Speakers: ${item.textContent}`; // Update button text
						updateSermonDisplay();
						document.getElementById('sermon-speaker-modal').classList.add('hidden');
					});
				});
			};

			const populateSortFilterModal = () => {
				const modalList = document.getElementById('sermon-sort-modal-list');
				modalList.innerHTML = ''; // Clear previous options

				const sortOptions = [
					{ value: 'date-desc', text: 'Newest First' },
					{ value: 'date-asc', text: 'Oldest First' },
					{ value: 'views-desc', text: 'Most Viewed' },
					{ value: 'title-asc', text: 'Title (A-Z)' },
					{ value: 'speaker-asc', text: 'Speaker (A-Z)' }
				];

				sortOptions.forEach(option => {
					const li = document.createElement('li');
					li.className = 'py-2 px-3 hover:bg-gray-100 rounded-md cursor-pointer';
					li.textContent = option.text;
					li.dataset.value = option.value;
					modalList.appendChild(li);
				});

				modalList.querySelectorAll('li').forEach(item => {
					item.addEventListener('click', () => {
						document.getElementById('sermon-sort-box').value = item.dataset.value;
						document.getElementById('sermon-sort-box-mobile-btn').textContent = `Sort By: ${item.textContent}`; // Update button text
						updateSermonDisplay();
						document.getElementById('sermon-sort-modal').classList.add('hidden');
					});
				});
			};			

            // This is the main function to build the new page
			const renderSermonDetailPage = async () => {
				const container = document.getElementById('page-sermon-detail');
				const backButton = document.getElementById('sermon-detail-back-btn');

				container.innerHTML = `<div class="text-center p-10"><i class="fas fa-spinner fa-spin text-3xl"></i></div>`;

				if (!currentSermonId) return;

				const sermonRef = doc(db, "sermons", currentSermonId);
				const sermonSnap = await getDoc(sermonRef);
				if (!sermonSnap.exists()) {
					container.innerHTML = `<p class="text-red-500">Error: Sermon not found.</p>`;
					return;
				}
				let sermon = { id: sermonSnap.id, ...sermonSnap.data() }; 
				document.getElementById('header-title').textContent = sermon.title;

                if (currentUser) { 
                    const updatedFields = {};
                    updatedFields.views = increment(1);
                    if (!sermon.viewedBy || !sermon.viewedBy.includes(currentUser.uid)) {
                        updatedFields.viewedBy = arrayUnion(currentUser.uid);
                    }
                    if (Object.keys(updatedFields).length > 0) {
                        try {
                            await updateDoc(sermonRef, updatedFields);
                            sermon.views = (sermon.views || 0) + 1;
                            if (updatedFields.viewedBy) { 
                                sermon.viewedBy = [...(sermon.viewedBy || []), currentUser.uid];
                            }
                        } catch (error) {
                            console.error("Error updating sermon views/viewedBy in Firestore:", error);
                        }
                    }
                }

				let uploaderName = sermon.speaker; 
				let uploaderProfilePic = speakerProfiles[sermon.speaker] || 'https://placehold.co/48x48/cccccc/333333?text=?';

				if (sermon.authorId) {
					const userProfile = await getUserProfile(sermon.authorId);
					if (userProfile.profilePic) uploaderProfilePic = userProfile.profilePic;
					if (userProfile.name) uploaderName = userProfile.name;
				}

				const likesRef = collection(db, "sermons", currentSermonId, "likes");
				const likesSnap = await getDocs(likesRef);
				const likeCount = likesSnap.size;
				const userHasLiked = currentUser && likesSnap.docs.some(doc => doc.id === currentUser.uid);

				const commentsRef = query(collection(db, "sermons", currentSermonId, "comments"), orderBy("timestamp", "desc"));
				const commentsSnap = await getDocs(commentsRef);
				const comments = commentsSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));

				const videoIdMatch = sermon.videoUrl ? sermon.videoUrl.match(/(?:v=|\/embed\/|youtu\.be\/)([\w-]{11})/) : null;

                // --- MODIFIED: Use the new .sermon-video-wrapper class ---
				const videoPlayerHTML = videoIdMatch ? `
					<div class="sermon-video-wrapper mb-4">
						<iframe
							src="https://www.youtube.com/embed/${videoIdMatch[1]}?modestbranding=1&rel=0&showinfo=0&autohide=1&disablekb=1"
							frameborder="0"
							allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
							allowfullscreen
							title="YouTube video player for ${sermon.title}">
						</iframe>
					</div>` : '<p class="text-center p-4 bg-gray-100 rounded-md">No video available for this sermon.</p>';

                // --- MODIFIED: Use the new .sermon-content-wrapper class ---
				const sermonContentHTML = `
					<div class="sermon-content-wrapper">
						<h1 class="text-xl sm:text-2xl font-bold mt-2 mb-1 text-left">${sermon.title}</h1>

						<div class="flex items-center justify-between text-sm text-gray-500 py-1 border-b border-gray-200">
							<div class="flex items-center gap-2">
								<span>${sermon.views || 0} views</span>
								<span>${new Date(sermon.sermonDate).toLocaleDateString()}</span>
							</div>
							<button id="like-sermon-btn" class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold transition-colors ${userHasLiked ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}">
								<i class="fas fa-thumbs-up"></i>
								<span id="like-count">${likeCount}</span>
							</button>
						</div>

						<h2 class="text-lg font-bold mt-4 mb-2">Description</h2>
						<div class="text-sm text-gray-700 p-3 bg-gray-50 rounded-md">
							${sermon.description || '<p class="text-gray-500">No description provided.</p>'}
						</div>

						<div class="mt-6">
							<h2 class="text-xl font-bold mb-4">${comments.length} Comments</h2>
							<div class="flex items-start gap-3 mb-6">
								<img src="${(currentUser && (await getUserProfile(currentUser.uid)).profilePic) || 'https://placehold.co/40x40/cccccc/333333?text=?'}" class="w-10 h-10 rounded-full object-cover">
								<textarea id="new-comment-input" class="w-full p-2 border rounded-md" placeholder="Add a comment..."></textarea>
								<button id="submit-comment-btn" class="btn-primary text-white px-4 py-2 rounded-md">Comment</button>
							</div>
							<div id="comments-list" class="space-y-5">
								${comments.map(comment => `
									<div class="flex items-start gap-3">
										<img src="${comment.commenterPic || 'https://placehold.co/40x40/cccccc/333333?text=?'}" class="w-10 h-10 rounded-full object-cover">
										<div>
											<p class="font-semibold text-sm">${comment.commenterName} <span class="text-xs font-normal text-gray-500 ml-2">${new Date(comment.timestamp.toDate()).toLocaleString()}</span></p>
											<p class="mt-1">${comment.text}</p>
										</div>
									</div>
								`).join('')}
							</div>
						</div>
					</div>
				`;

				// Assemble the final HTML for the container
				// The video player is placed directly inside the main container,
				// and the rest of the content is in its own wrapper.
				container.innerHTML = (backButton ? backButton.outerHTML : '') + videoPlayerHTML + sermonContentHTML;

				// Re-attach event listeners after innerHTML update
				const reAttachedBackButton = document.getElementById('sermon-detail-back-btn');
				if (reAttachedBackButton) {
					reAttachedBackButton.removeEventListener('click', () => switchPage('sermons'));
					reAttachedBackButton.addEventListener('click', () => switchPage('sermons'));
					reAttachedBackButton.classList.remove('hidden');
				}

				document.getElementById('like-sermon-btn').addEventListener('click', () => handleLikeSermon(sermon.id, currentUser.uid));
				document.getElementById('submit-comment-btn').addEventListener('click', () => {
					const commentText = document.getElementById('new-comment-input').value;
					if (commentText.trim()) {
						handleAddSermonComment(sermon.id, commentText);
					}
				});
			};

			
			// ------- End Of Sermon Section -----------
			
			
			// ------- Render Posts Details -------
const renderPostDetailPage = async () => {
    const container = document.getElementById('page-post-detail');
    const backToPostsBtn = document.getElementById('back-to-home-btn'); // Renamed from back-to-home-btn for clarity

    container.innerHTML = `<p>Loading post...</p>`; // Loading state

    if (!currentPostId) {
        container.innerHTML = `<p class="text-red-500">Error: No post ID was selected. Please go back.</p>`;
        return;
    }

    try {
        const postRef = doc(db, "posts", currentPostId);
        const postSnap = await getDoc(postRef);

        if (!postSnap.exists()) {
            container.innerHTML = `<p class="text-red-500">Error: Post not found.</p>`;
            return;
        }

        let post = { id: postSnap.id, ...postSnap.data() };
        
        // Increment views only if it's the first time user views it in this session (optional, but good)
        // Or simply increment on every load for simplicity, as per previous logic.
        // For now, sticking with incrementing on every load as per your current snippet.
        await updateDoc(postRef, { views: increment(1) });
        post.views = (post.views || 0) + 1; // Update local object for display

        // Fetch comments for this post
        const commentsRef = collection(db, "posts", currentPostId, "comments");
        const commentsSnap = await getDocs(query(commentsRef, orderBy("timestamp", "asc"))); // Order by oldest first
        const comments = commentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Check like/save status for this individual post on detail page
        const likesSnap = await getDocs(collection(db, "posts", post.id, "likes"));
        post.likeCount = likesSnap.size;
        post.userHasLiked = currentUser && likesSnap.docs.some(doc => doc.id === currentUser.uid);
        post.isSaved = userSavedPosts.includes(post.id);


        const publishedDate = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : 'N/A';

        const likeButtonClass = post.userHasLiked ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300';
        const saveButtonClass = post.isSaved ? 'bg-yellow-500 text-white' : 'bg-gray-200 hover:bg-gray-300';

        container.innerHTML = `
            <div class="max-w-4xl mx-auto p-2 md:p-4">
                <button id="back-to-posts-btn" class="mb-4 text-sm font-medium text-indigo-600 hover:text-indigo-800">
                    <i class="fas fa-arrow-left"></i> Back to All Posts
                </button>

                <h1 class="text-3xl sm:text-4xl font-bold mb-2">${post.title}</h1>
                <div class="text-sm text-gray-500 mb-6 flex justify-between items-center">
                    <span class="font-semibold">By: ${post.authorName || 'Admin'}</span>
                    <div class="flex items-center gap-3">
                        <span>Published: ${publishedDate}</span>
                        <span><i class="fas fa-eye"></i> ${post.views} views</span>
                        <button id="detail-like-post-btn" class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold ${likeButtonClass}">
                            <i class="fas fa-thumbs-up"></i> ${post.likeCount || 0}
                        </button>
                        <button id="detail-save-post-btn" class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold ${saveButtonClass}">
                            <i class="fas fa-bookmark"></i>
                        </button>
                    </div>
                </div>

                <div class="prose max-w-none mb-8" style="color: var(--text-color);">
                    ${post.content || '<p>This post has no content.</p>'}
                </div>

                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h2 class="text-xl font-bold mb-4">${comments.length} Comments</h2>
                    <div class="flex items-start gap-3 mb-6">
                        <img src="${(currentUser && (await getUserProfile(currentUser.uid)).profilePic) || 'https://placehold.co/40x40/cccccc/333333?text=?'}" class="w-10 h-10 rounded-full object-cover">
                        <textarea id="new-comment-input" class="w-full p-2 border rounded-md" placeholder="Add a comment..."></textarea>
                        <button id="submit-comment-btn" class="btn-primary text-white px-4 py-2 rounded-md">Comment</button>
                    </div>
                    <div id="comments-list" class="space-y-5">
                        ${comments.map(comment => `
                            <div class="flex items-start gap-3">
                                <img src="${comment.commenterPic || 'https://placehold.co/40x40/cccccc/333333?text=?'}" class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <p class="font-semibold text-sm">${comment.commenterName} <span class="text-xs font-normal text-gray-500 ml-2">${new Date(comment.timestamp.toDate()).toLocaleString()}</span></p>
                                    <p class="mt-1">${comment.text}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        // Re-attach event listener for the back button
        const reAttachedBackButton = document.getElementById('back-to-posts-btn'); // Use the new ID
        if (reAttachedBackButton) {
            reAttachedBackButton.removeEventListener('click', () => switchPage('home')); // Remove old, potentially incorrect listener
            reAttachedBackButton.addEventListener('click', () => switchPage('home')); // Add correct listener
        }

        // Add event listeners for like and save buttons on the detail page
        document.getElementById('detail-like-post-btn')?.addEventListener('click', () => handleLikePost(post.id));
        document.getElementById('detail-save-post-btn')?.addEventListener('click', () => handleSavePost(post.id));

        // Add event listener for comment submission
        document.getElementById('submit-comment-btn')?.addEventListener('click', () => {
            const commentText = document.getElementById('new-comment-input').value;
            if (commentText.trim()) {
                handleAddPostComment(post.id, commentText);
            }
        });

    } catch (error) {
        container.innerHTML = `<p class="text-red-500">A critical error occurred while loading the post.</p>`;
        console.error("Error in renderPostDetailPage:", error);
    }
};

const createPostCard = (post) => {
    const card = document.createElement('div');
    card.className = "post-card p-4 rounded-xl shadow-md flex flex-col cursor-pointer";
    card.style.backgroundColor = 'var(--card-bg)';
    card.dataset.postId = post.id;

    let postImageHtml = '';
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = post.content || '';
    const firstImage = tempDiv.querySelector('img');
    if (firstImage) {
        postImageHtml = `<img src="${firstImage.src}" class="w-full h-32 object-cover rounded-md mb-3" onerror="this.onerror=null;this.src='https://placehold.co/300x150/cccccc/333333?text=No+Image';">`;
    }

    const textPreview = tempDiv.textContent.substring(0, 150) + (tempDiv.textContent.length > 150 ? '...' : '');
    const publishedDate = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : 'N/A';

    // NEW: Like and Save button HTML
    const likeButtonClass = post.userHasLiked ? 'text-blue-500' : 'text-gray-400';
    const saveButtonClass = post.isSaved ? 'text-yellow-500' : 'text-gray-400';

    card.innerHTML = `
        ${postImageHtml}
        <h3 class="text-lg font-bold mb-2">${post.title}</h3>
        <p class="text-sm text-gray-700 mb-3 flex-grow">${textPreview}</p>

        <div class="flex items-center justify-between text-xs text-gray-500 mt-auto pt-2 border-t border-gray-200">
            <span class="font-medium">By: ${post.authorName || 'Editor'}</span>
            <div class="flex items-center gap-3">
                <span class="text-xs">${publishedDate}</span>
                <button class="post-like-btn text-sm ${likeButtonClass}" data-id="${post.id}" title="Like Post">
                    <i class="fas fa-thumbs-up"></i> ${post.likeCount || 0}
                </button>
                <button class="post-save-btn text-sm ${saveButtonClass}" data-id="${post.id}" title="Save Post">
                    <i class="fas fa-bookmark"></i>
                </button>
            </div>
        </div>

        ${currentUser && currentUser.role === 'editor' ? `
            <div class="editor-only-section hidden mt-2 pt-2 border-t border-gray-200">
                <div class="flex items-center justify-end gap-2">
                    <button data-id="${post.id}" class="edit-post-btn text-xs font-medium text-indigo-600 hover:text-indigo-800">Edit</button>
                    <button data-id="${post.id}" class="delete-post-btn text-xs font-medium text-red-600 hover:text-red-800">Delete</button>
                </div>
            </div>
        ` : ''}
    `;

    // Attach the primary click listener for the post card itself
    card.addEventListener('click', (e) => {
        // Prevent action if edit/delete/like/save button or their icons are clicked
        if (e.target.closest('.edit-post-btn') || e.target.closest('.delete-post-btn') || e.target.closest('.post-like-btn') || e.target.closest('.post-save-btn')) {
            e.stopPropagation(); // Stop event from bubbling to the card
            return;
        }

        currentPostId = post.id;
        switchPage('post-detail');
    });

    // Attach listeners for Like and Save buttons
    card.querySelector('.post-like-btn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        handleLikePost(post.id);
    });
    card.querySelector('.post-save-btn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        handleSavePost(post.id);
    });

    if (currentUser && currentUser.role === 'editor') {
        card.querySelector('.edit-post-btn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            openEditPostModal(e.target.dataset.id);
        });
        card.querySelector('.delete-post-btn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            deletePost(e.target.dataset.id, post.title);
        });
    }

    return card;
};

async function handleAddPostComment(postId, commentText) {
    if (!currentUser) {
        showToast("Please log in to comment.", "error");
        return;
    }

    const userProfile = await getUserProfile(currentUser.uid); // Fetch user's profile for name/pic
    try {
        await addDoc(collection(db, "posts", postId, "comments"), {
            text: commentText,
            commenterId: currentUser.uid,
            commenterName: userProfile.name || currentUser.name,
            commenterPic: userProfile.profilePic || null,
            timestamp: serverTimestamp()
        });
        showToast("Comment added!", "success");
        // Re-render the post detail page to show the new comment
        renderPostDetailPage();
    } catch (error) {
        console.error("Error adding comment:", error);
        showToast("Failed to add comment.", "error");
    }
}
async function handleLikePost(postId) {
    if (!currentUser) {
        showToast("Please log in to like a post.", "error");
        return;
    }
    const likeRef = doc(db, "posts", postId, "likes", currentUser.uid);
    try {
        const likeSnap = await getDoc(likeRef);
        if (likeSnap.exists()) {
            await deleteDoc(likeRef); // Unlike
            showToast("Post unliked.", "info");
        } else {
            await setDoc(likeRef, { timestamp: serverTimestamp() }); // Like
            showToast("Post liked!", "success");
        }
        // After like/unlike, ensure UI updates
        if (currentPage === 'home') {
            fetchPosts(); // Re-fetch all posts to update counts/status
        } else if (currentPage === 'post-detail' && currentPostId === postId) {
            renderPostDetailPage(); // Re-render the detail page
        }
    } catch (error) {
        console.error("Error liking/unliking post:", error);
        showToast("Failed to update like status.", "error");
    }
}

async function handleSavePost(postId) {
    if (!currentUser) {
        showToast("Please log in to save a post.", "error");
        return;
    }
    const savedPostsRef = doc(db, 'userSavedPosts', currentUser.uid);
    try {
        if (userSavedPosts.includes(postId)) {
            // Remove from saved
            await updateDoc(savedPostsRef, { savedPostIds: arrayRemove(postId) });
            showToast("Post unsaved.", "info");
        } else {
            // Add to saved
            await setDoc(savedPostsRef, { savedPostIds: arrayUnion(postId) }, { merge: true });
            showToast("Post saved!", "success");
        }
        // The `listenForSavedPosts` should ideally trigger UI updates for both home and saved-posts pages
        // But let's explicitly trigger `fetchPosts` for 'home' to refresh `isSaved` status on cards
        if (currentPage === 'home') {
            fetchPosts();
        } else if (currentPage === 'post-detail' && currentPostId === postId) {
            renderPostDetailPage();
        }
        // `listenForSavedPosts` will handle `renderSavedPostsPage`
    } catch (error) {
        console.error("Error saving/unsaving post:", error);
        showToast("Failed to update save status.", "error");
    }
}

const renderSavedPostsPage = () => {
    const savedPostsListContainer = document.getElementById('saved-posts-list-container');
    if (!savedPostsListContainer) return;

    savedPostsListContainer.innerHTML = ''; // Clear previous content

    // Filter all available posts to show only the ones the user has saved
    const savedPostsData = allPosts.filter(post => userSavedPosts.includes(post.id));

    if (savedPostsData.length === 0) {
        savedPostsListContainer.innerHTML = `<p class="col-span-full text-center" style="color: var(--text-muted)">You haven't saved any posts yet.</p>`;
        return;
    }

    savedPostsData.forEach(post => {
        const card = createPostCard(post);
        savedPostsListContainer.appendChild(card);
    });

    if (isEditModeActive) {
        savedPostsListContainer.querySelectorAll('.editor-only-section').forEach(el => el.classList.remove('hidden'));
    } else {
        savedPostsListContainer.querySelectorAll('.editor-only-section').forEach(el => el.classList.add('hidden'));
    }
};

const listenForSavedPosts = () => {
    if (unsubscribeSavedPosts) unsubscribeSavedPosts();
    if (!currentUser) return;

    const savedPostsRef = doc(db, 'userSavedPosts', currentUser.uid);
    unsubscribeSavedPosts = onSnapshot(savedPostsRef, (docSnap) => {
        if (docSnap.exists()) {
            userSavedPosts = docSnap.data().savedPostIds || [];
        } else {
            userSavedPosts = [];
        }
        // --- REMOVE OR COMMENT OUT THESE LINES ---
        // const savedPostsCountSpan = document.getElementById('count-saved-posts');
        // if (savedPostsCountSpan) {
        //     savedPostsCountSpan.textContent = `(${userSavedPosts.length})`;
        // }

        if (currentPage === 'home') {
            fetchPosts();
        } else if (currentPage === 'post-detail' && currentPostId) {
            renderPostDetailPage();
        } else if (currentPage === 'saved-posts') {
            renderSavedPostsPage();
        }
    });
};

			// --- Sermon Display Functions ---
            let allSermons = [];
            let unsubscribeSermons = null;

			const fetchSermons = () => {
				if (unsubscribeSermons) unsubscribeSermons();
				const q = query(collection(db, "sermons"), orderBy("sermonDate", "desc"));

				unsubscribeSermons = onSnapshot(q, async (snapshot) => { // Made async to use await
					const fetchedSermons = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

					// --- NEW: Fetch likes and comments count for each sermon ---
					for (let sermon of fetchedSermons) {
						// Fetch Likes Count
						const likesSnap = await getDocs(collection(db, "sermons", sermon.id, "likes"));
						sermon.likeCount = likesSnap.size;

						// Fetch Comments Count
						const commentsSnap = await getDocs(collection(db, "sermons", sermon.id, "comments"));
						sermon.commentCount = commentsSnap.size;
					}
					// --- END NEW ---

					// Extract unique speaker names and update the filter dropdown
					const speakers = new Set(fetchedSermons.map(sermon => sermon.speaker).filter(Boolean));
					populateSpeakerFilter(Array.from(speakers).sort());

					// --- NEW: Notification Logic (as before) ---
					if (currentUser) {
						const unseenSermons = fetchedSermons.filter(sermon => !(sermon.viewedBy && sermon.viewedBy.includes(currentUser.uid))).length;
						const sermonBadge = document.getElementById('sermon-notification-badge');
						if (sermonBadge) {
							if (unseenSermons > 0) {
								sermonBadge.textContent = unseenSermons;
								sermonBadge.classList.remove('hidden');
							} else {
								sermonBadge.classList.add('hidden');
							}
						}
					}

					allSermons = fetchedSermons; // Update the global allSermons array
					updateSermonDisplay(); // Call new display function
				}, (error) => {
					console.error("Error fetching sermons:", error);
				});
			};

			const populateSpeakerFilter = (speakers) => {
				const speakerFilter = document.getElementById('sermon-speaker-filter');
				if (!speakerFilter) return;

				// Clear existing options, but keep "All Speakers"
				speakerFilter.innerHTML = '<option value="">All Speakers</option>';
				speakers.forEach(speaker => {
					const option = document.createElement('option');
					option.value = speaker;
					option.textContent = speaker;
					speakerFilter.appendChild(option);
				});
			};
			
			const fetchSpeakerProfiles = () => {
				const speakerProfilesRef = collection(db, "speakerProfiles");
				onSnapshot(speakerProfilesRef, (snapshot) => {
					speakerProfiles = {}; // Clear previous data
					snapshot.forEach(doc => {
						speakerProfiles[doc.id] = doc.data().profilePic; // Store speakerName -> profilePicUrl
					});
					// Re-render sermons to apply new profile pictures if the page is active
					if (currentPage === 'sermons') {
						updateSermonDisplay();
					} else if (currentPage === 'sermon-detail' && currentSermonId) {
						renderSermonDetailPage(); // Re-render detail page if active
					}
				}, (error) => {
					console.error("Error fetching speaker profiles:", error);
				});
			};
			
			const createSermonCard = (sermon) => {
                const card = document.createElement('div');
                const isViewed = currentUser && Array.isArray(sermon.viewedBy) && sermon.viewedBy.includes(currentUser.uid);
                card.className = `sermon-card flex flex-col p-4 rounded-xl shadow-md cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-opacity ${isViewed ? 'opacity-60' : ''}`;
                card.style.backgroundColor = 'var(--card-bg)';
                card.dataset.sermonId = sermon.id;

                let previewImageSrc = ''; 
                if (sermon.imageUrl) {
                    previewImageSrc = sermon.imageUrl;
                } 
                else if (sermon.videoUrl) {
                    const videoIdMatch = sermon.videoUrl.match(/(?:v=|\/embed\/|youtu\.be\/)([\w-]{11})/);
                    if (videoIdMatch && videoIdMatch[1]) {
                        previewImageSrc = `https://img.youtube.com/vi/${videoIdMatch[1]}/hqdefault.jpg`;
                    }
                }

                const previewImageHtml = previewImageSrc 
                    ? `<img src="${previewImageSrc}" alt="${sermon.title}" class="w-full h-40 object-cover mb-3 rounded-md">` 
                    : '<div class="w-full h-40 bg-gray-200 rounded-md mb-3 flex items-center justify-center"><i class="fas fa-photo-video text-gray-400 text-4xl"></i></div>';

                const editorControls = `
                    <div class="editor-only-section hidden flex gap-3 text-lg">
                        <button class="edit-sermon-btn text-indigo-600" title="Edit Sermon"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-sermon-btn text-red-600" title="Delete Sermon"><i class="fas fa-trash"></i></button>
                    </div>
                `;

                card.innerHTML = `
                    ${previewImageHtml}
                    <div class="flex-grow flex flex-col">
                        <div class="flex justify-between items-start mb-1">
                            <h3 class="text-lg font-bold">${sermon.title}</h3>
                            ${currentUser && (currentUser.role === 'editor' || currentUser.role === 'minister') ? editorControls : ''}
                        </div>
                        <div class="flex-grow text-sm text-gray-600">
                            <span>By ${sermon.speaker}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs text-gray-500 mt-2 pt-2 border-t border-gray-200">
                            <span>${new Date(sermon.sermonDate).toLocaleDateString()}</span>
                            <div class="flex items-center gap-3">
                                <span class="view-count"><i class="fas fa-eye"></i> ${sermon.views || 0}</span>
                                <span class="like-count"><i class="fas fa-thumbs-up"></i> ${sermon.likeCount || 0}</span>
                                <span class="comment-count"><i class="fas fa-comment"></i> ${sermon.commentCount || 0}</span>
                            </div>
                        </div>
                    </div>
                `;

                if (isEditModeActive) {
                    card.querySelectorAll('.editor-only-section').forEach(el => el.classList.remove('hidden'));
                }

                return card;
            };

			const showSermonDetailModal = async (sermonId) => {
                const sermon = allSermons.find(s => s.id === sermonId);
                const sermonModal = document.getElementById('sermon-detail-modal');


                if (!sermon) {
                    showToast("Sermon not found.", "error");
                    return;
                }

                const sermonRef = doc(db, "sermons", sermon.id);

                // --- NEW: Mark sermon as viewed by current user ---
                if (currentUser && (!sermon.viewedBy || !sermon.viewedBy.includes(currentUser.uid))) {
                    await updateDoc(sermonRef, {
                        viewedBy: arrayUnion(currentUser.uid)
                    });
                }

                // Increment view count (public counter)
                await updateDoc(sermonRef, { views: increment(1) });
                
                let mediaHtml = '';
                if (sermon.videoUrl) {
                    const videoIdMatch = sermon.videoUrl.match(/(?:v=|\/embed\/|youtu\.be\/)([\w-]{11})/);
                    if (videoIdMatch && videoIdMatch[1]) {
                        const videoId = videoIdMatch[1];
                        mediaHtml = `
                            <div class="aspect-w-16 aspect-h-9 mb-4 rounded-lg overflow-hidden">
                                <iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                            </div>`;
                    }
                }
                if (sermon.audioUrl) {
                    mediaHtml += `<audio controls class="w-full mt-4"><source src="${sermon.audioUrl}" type="audio/mpeg"></audio>`;
                }

                sermonModal.innerHTML = `
                    <div class="relative p-5 rounded-lg shadow-xl w-full max-w-2xl" style="background-color: var(--card-bg);">
                        <button class="sermon-modal-close-btn absolute top-2 right-4 text-2xl text-gray-500 hover:text-gray-800 z-20">×</button>
                        
                        <h3 class="text-2xl font-bold mb-1">${sermon.title}</h3>
                        <p class="text-base text-gray-600 mb-4">By ${sermon.speaker} on ${new Date(sermon.sermonDate).toLocaleDateString()}</p>
                        
                        ${mediaHtml || '<p class="text-gray-500">No media available for this sermon.</p>'}

                        <p class="text-sm text-gray-700 mt-4">${sermon.description || ''}</p>
                    </div>
                `;

                sermonModal.classList.remove('hidden');

                sermonModal.querySelector('.sermon-modal-close-btn').addEventListener('click', () => {
                    sermonModal.innerHTML = ''; // Clear content to stop video playback
                    sermonModal.classList.add('hidden');
                });
            };

			const renderSermonsPage = (sermonsToDisplay) => {
                const container = document.getElementById('sermons-list-container');
                container.innerHTML = '';
                if (sermonsToDisplay.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500">No sermons match your search.</p>`;
                    return;
                }
                sermonsToDisplay.forEach(sermon => {
                    const card = createSermonCard(sermon);
                    container.appendChild(card);
                });
                
                // --- FIX: After rendering, ensure controls visibility matches edit mode state ---
                if (isEditModeActive) {
                    container.querySelectorAll('.editor-only-section').forEach(el => el.classList.remove('hidden'));
                } else {
                    container.querySelectorAll('.editor-only-section').forEach(el => el.classList.add('hidden'));
                }
            };
// --- End Sermon section ---

// --- Start Hymns section ---
// Add constants for Local Storage keys and cache validity
const HYMNS_CACHE_KEY = 'allHymnsCache';
const HYMNS_CACHE_TIMESTAMP_KEY = 'allHymnsCacheTimestamp';
const HYMNS_CACHE_VALIDITY_MS = 24 * 60 * 60 * 1000; // 24 hours (1 day) - adjust as needed

const fetchHymns = async () => { // Make this function async
    console.log("DEBUG: fetchHymns called.");
    // IMPORTANT: Remove any unsubscribeHymns call here, as we won't be using onSnapshot anymore.
    // Ensure `unsubscribeHymns` is not being set anywhere else either for hymns.

    let hymnsToDisplay = [];
    let loadedFromLocalStorage = false;

    // 1. Try to load from Local Storage first
    const cachedHymns = localStorage.getItem(HYMNS_CACHE_KEY);
    const cachedTimestamp = localStorage.getItem(HYMNS_CACHE_TIMESTAMP_KEY);

    if (cachedHymns) {
        try {
            const parsedHymns = JSON.parse(cachedHymns);
            const cacheAge = new Date().getTime() - parseInt(cachedTimestamp || '0');
            
            if (cacheAge < HYMNS_CACHE_VALIDITY_MS) {
                // Cache is fresh, use it directly
                allHymns = parsedHymns;
                console.log("DEBUG: Hymns loaded from Local Storage cache (fresh):", allHymns.length, "items.");
                loadedFromLocalStorage = true;
                // Display immediately
                if (currentPage === 'hymns') {
                    updateHymnsDisplay();
                } else if (currentPage === 'hymn-detail' && currentHymnId) {
                    renderHymnDetailPage();
                }
                return; // IMPORTANT: Exit here if fresh data is found in Local Storage
            } else {
                // Cache is stale, log and proceed to fetch from Firestore
                console.log("DEBUG: Hymns cache found but stale (older than 24 hours).");
                // Optionally display stale cache while new data loads:
                allHymns = parsedHymns;
                if (currentPage === 'hymns') {
                    updateHymnsDisplay();
                } else if (currentPage === 'hymn-detail' && currentHymnId) {
                    renderHymnDetailPage();
                }
            }
        } catch (e) {
            console.error("ERROR: Failed to parse cached hymns, clearing cache.", e);
            localStorage.removeItem(HYMNS_CACHE_KEY);
            localStorage.removeItem(HYMNS_CACHE_TIMESTAMP_KEY);
            allHymns = [];
            loadedFromLocalStorage = false;
        }
    } else {
        console.log("DEBUG: No hymns cache found in Local Storage.");
        allHymns = [];
        loadedFromLocalStorage = false;
    }

    // 2. If not loaded from fresh cache, fetch once from Firestore (using getDocs)
    try {
        console.log("DEBUG: Fetching hymns from Firestore (using getDocs).");
        const snapshot = await getDocs(query(collection(db, "hymns"), orderBy("id", "asc")));
        const fetchedHymns = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        allHymns = fetchedHymns;
        console.log("DEBUG: Hymns fetched from Firestore:", allHymns.length, "items.");
        
        // Save fetched data and timestamp to Local Storage
        localStorage.setItem(HYMNS_CACHE_KEY, JSON.stringify(allHymns));
        localStorage.setItem(HYMNS_CACHE_TIMESTAMP_KEY, new Date().getTime().toString());
        console.log("DEBUG: Hymns cached to Local Storage after Firestore fetch.");

        // Re-render the display with the newly fetched data
        if (currentPage === 'hymns') {
            updateHymnsDisplay();
        } else if (currentPage === 'hymn-detail' && currentHymnId) {
            renderHymnDetailPage();
        }
        
    } catch (error) {
        console.error("ERROR: Error fetching hymns from Firestore:", error);
        showToast("Failed to load hymns from Firestore.", "error");
        // If Firestore fetch failed AND no cache was available, show error in UI
        if (!loadedFromLocalStorage) {
            document.getElementById('hymns-list-container').innerHTML = `<p class="col-span-full text-center text-red-500 py-10">Error loading hymns: ${error.message}. Please check your connection.</p>`;
        }
    }
};

// --- Updated Helper Function to Extract Specific Hymn Parts ---
function extractHymnPart(fullText, partType) {
    if (!fullText) return '';
    const rawText = fullText.trim(); 

    let match;
    let extractedContent = '';

    switch (partType) {
        case 'h4_title':
            match = rawText.match(/<h4[^>]*>(.*?)<\/h4>/is);
            return match ? match[1].trim() : '';
        case 'doh_line':
            match = rawText.match(/<p>Doh is (.*?)<\/p>/is);
            return match ? `Doh is ${match[1].trim()}` : '';
        case 'verse1':
            match = rawText.match(/<p>\s*<b[^>]*>1\.?\s*<\/b>\s*([\s\S]*?)<\/p>/is); 
            extractedContent = match ? match[1] : '';
            extractedContent = extractedContent.replace(/<[^>]*>/g, '').trim();

            const h4TitleForVerse1 = extractHymnPart(fullText, 'h4_title');
            if (h4TitleForVerse1 && extractedContent.toLowerCase().startsWith(h4TitleForVerse1.toLowerCase())) {
                const escapedTitle = RegExp.escape(h4TitleForVerse1);
                extractedContent = extractedContent.replace(new RegExp(`^${escapedTitle}\\s*`, 'i'), '').trim();
            }
            return extractedContent;

        case 'chorus':
            match = rawText.match(/<p>\s*<b[^>]*>(?:CHO|Chorus):\s*<\/b>\s*([\s\S]*?)<\/p>/is);
            extractedContent = match ? match[1] : '';
            extractedContent = extractedContent.replace(/<[^>]*>/g, '').trim();
            return extractedContent;

        case 'all_content_raw': // For rendering the full content without modifications
            return fullText.trim();
        case 'all_content_no_meta': // For general search, stripping H4 and Doh line, then all other HTML.
            let content = rawText.replace(/<h4[^>]*>.*?<\/h4>/is, '').replace(/<p>Doh is .*?<\/p>/is, '').trim();
            return content.replace(/<[^>]*>/g, '').trim();
        default:
            return '';
    }
}



function highlightTerm(text, term) {
  if (!term) return text;
  // escape regex
  const esc = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  return text.replace(
    new RegExp(`(${esc})`, 'gi'),
    '<mark>$1</mark>'
  );
}


const updateHymnsDisplay = (searchTerm = '') => {

    const hymnsListContainer = document.getElementById('hymns-list-container');
    const hymnSearchBox = document.getElementById('hymn-search-box');
    const hymnFilterBy = document.getElementById('hymn-filter-by');
    const viewFavoriteHymnsBtn = document.getElementById('view-favorite-hymns-btn');

    if (!hymnsListContainer) {
        console.error("ERROR: hymns-list-container not found in DOM.");
        return;
    }

    // Update favorite button text/style
    if (viewFavoriteHymnsBtn) {
        if (currentHymnView === 'favorites') {
            viewFavoriteHymnsBtn.innerHTML = `<i class="fas fa-star mr-1"></i>All (${hymnFavorites.length})`; // Text "All" with count
            viewFavoriteHymnsBtn.classList.remove('btn-primary');
            viewFavoriteHymnsBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
        } else {
            viewFavoriteHymnsBtn.innerHTML = `<i class="fas fa-star mr-1"></i>(${hymnFavorites.length})`; // Icon and count only
            viewFavoriteHymnsBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            viewFavoriteHymnsBtn.classList.add('btn-primary');
        }
    }

    const lowerCaseSearchTerm = searchTerm.toLowerCase();
    const filterBy = hymnFilterBy ? hymnFilterBy.value : 'title';

    if (!allHymns || allHymns.length === 0) {
        hymnsListContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">Loading hymns or no hymns found.</p>`;
        return;
    }

    let tempHymns = [...allHymns];

    if (currentHymnView === 'favorites') {
        tempHymns = tempHymns.filter(hymn => hymnFavorites.includes(hymn.id));
    }

    filteredHymns = tempHymns.filter(hymn => {
        if (!searchTerm) return true;

        switch (filterBy) {
            case 'title':
                return hymn.name.toLowerCase().includes(lowerCaseSearchTerm) || String(hymn.id).includes(lowerCaseSearchTerm);
            case 'verse1':
                const verse1Content = extractHymnPart(hymn.destext, 'verse1');
                const cleanVerse1ForSearch = verse1Content.toLowerCase();
                return cleanVerse1ForSearch.includes(lowerCaseSearchTerm);
            case 'chorus':
                const chorusContent = extractHymnPart(hymn.destext, 'chorus');
                const cleanChorusForSearch = chorusContent.toLowerCase();
                return cleanChorusForSearch.includes(lowerCaseSearchTerm);
            case 'all':
                const allSearchableContent = `${hymn.name} ${extractHymnPart(hymn.destext, 'all_content_no_meta')} ${hymn.id}`;
                return allSearchableContent.toLowerCase().includes(lowerCaseSearchTerm);
            default:
                return false;
        }
    });

    filteredHymns.sort((a, b) => parseInt(a.id) - parseInt(b.id));

    hymnsListContainer.innerHTML = '';

    if (filteredHymns.length === 0) {
        hymnsListContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">No hymns found matching your criteria.</p>`;
        return;
    }

    filteredHymns.forEach(hymn => {
        const card = document.createElement('div');
        const isFavorite = hymnFavorites.includes(hymn.id);
        card.className = `p-4 rounded-xl shadow-md cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors flex items-center justify-between gap-3 ${isFavorite ? 'border-yellow-500 border-2' : ''}`;
        card.style.backgroundColor = 'var(--card-bg)';
        card.dataset.hymnId = hymn.id;

        // --- new preview + highlight logic ---
        let rawPreview;
        if (filterBy === 'verse1') {
          rawPreview = extractHymnPart(hymn.destext, 'verse1');
        } else if (filterBy === 'chorus') {
          rawPreview = extractHymnPart(hymn.destext, 'chorus');
        } else {
          // default / fallback preview
          rawPreview = extractHymnPart(hymn.destext, 'all_content_no_meta');
        }

        // Highlight the user’s search term
        let highlighted = highlightTerm(rawPreview, lowerCaseSearchTerm);

        // Truncate around the first <mark> (so you show context)
        const idx = highlighted.indexOf('<mark>');
        if (idx > 50) {
          // show 50 chars before the match
          highlighted = '…' + highlighted.slice(idx - 50);
        }
        // finally, hard-limit to ~100 chars of rendered text
        if (highlighted.replace(/<[^>]+>/g, '').length > 100) {
          // cut at ~120 chars of HTML (rough)
          highlighted = highlighted.slice(0, 120) + '…';
        }
        const previewContent = highlighted;
 
         card.innerHTML = `
             <div class="flex-grow">
                 <h3 class="text-lg font-bold mb-1">${hymn.id}. ${hymn.name}</h3>
                <p class="text-sm text-gray-600 hymn-card-preview">${previewContent}</p>
              </div>
             <button class="hymn-favorite-list-btn text-yellow-500 text-xl p-1" …>
                 <i class="fas fa-star ${isFavorite ? '' : 'text-gray-400'}"></i>
             </button>
         `;

        card.querySelector('.flex-grow').addEventListener('click', (e) => {
            if (!e.target.closest('.hymn-favorite-list-btn')) {
                currentHymnId = hymn.id;
                switchPage('hymn-detail');
            }
        });

        card.querySelector('.hymn-favorite-list-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            toggleHymnFavorite(hymn.id);
        });

        hymnsListContainer.appendChild(card);
    });
};

const listenForHymnFavorites = () => {
    if (unsubscribeHymnFavorites) unsubscribeHymnFavorites();
    if (!currentUser) return;

    const favRef = doc(db, 'userHymnFavorites', currentUser.uid); // NEW COLLECTION for hymn favorites
    unsubscribeHymnFavorites = onSnapshot(favRef, (docSnap) => {
        if (docSnap.exists()) {
            hymnFavorites = docSnap.data().favoriteHymnIds || [];
        } else {
            hymnFavorites = [];
        }
        // Update the count on the button
        const countSpan = document.getElementById('hymn-favorites-count');
        if (countSpan) countSpan.textContent = `(${hymnFavorites.length})`;

        // Re-render relevant parts of the UI
        if (currentPage === 'hymns') {
            updateHymnsDisplay(document.getElementById('hymn-search-box')?.value || '');
        } else if (currentPage === 'hymn-detail' && currentHymnId) {
            renderHymnDetailPage(); // Update favorite icon on detail page
        }
    }, (error) => {
        console.error("Error fetching hymn favorites:", error);
        showToast("Failed to load hymn favorites.", "error");
    });
};

async function toggleHymnFavorite(hymnId) {
    if (!currentUser) {
        showToast("Please log in to add hymns to favorites.", "error");
        return;
    }
    const favRef = doc(db, 'userHymnFavorites', currentUser.uid);
    try {
        if (hymnFavorites.includes(hymnId)) {
            await updateDoc(favRef, { favoriteHymnIds: arrayRemove(hymnId) });
            showToast("Hymn removed from favorites.", "info");
        } else {
            await setDoc(favRef, { favoriteHymnIds: arrayUnion(hymnId) }, { merge: true });
            showToast("Hymn added to favorites!", "success");
        }
    } catch (error) {
        console.error("Error toggling hymn favorite:", error);
        showToast("Failed to update hymn favorite status.", "error");
    }
}	

// --- renderHymnDetailPage function (CRITICAL CHANGES HERE) ---
const renderHymnDetailPage = () => {
    const hymnDetailTitleEl = document.getElementById('hymn-detail-title');
    const hymnDetailTextEl = document.getElementById('hymn-detail-text');
    const hymnNumberDisplay = document.getElementById('hymn-number-display');
    const hymnPrevBtn = document.getElementById('hymn-prev-btn');
    const hymnNextBtn = document.getElementById('hymn-next-btn');
    const hymnDetailBackBtn = document.getElementById('hymn-detail-back-btn');
    const hymnDetailFavoriteBtn = document.getElementById('hymn-detail-favorite-btn');
    // REMOVE these const declarations if they are only used for listeners
    // const hymnFontDecreaseBtn = document.getElementById('hymn-font-decrease-btn');
    // const hymnFontIncreaseBtn = document.getElementById('hymn-font-increase-btn');

    if (!currentHymnId) {
        hymnDetailTextEl.innerHTML = `<p class="text-red-500">No hymn selected.</p>`;
        return;
    }

    const hymn = filteredHymns.find(h => h.id === currentHymnId) || allHymns.find(h => h.id === currentHymnId);
    if (!hymn) {
        hymnDetailTextEl.innerHTML = `<p class="text-red-500">Hymn not found.</p>`;
        return;
    }

    hymnDetailTitleEl.textContent = `${hymn.name}`;

    let contentToRender = hymn.destext || '';
    const dohLineText = extractHymnPart(contentToRender, 'doh_line');
    contentToRender = contentToRender.replace(/<h4[^>]*>.*?<\/h4>\s*/is, '').trim();
    contentToRender = contentToRender.replace(/<p>Doh is .*?<\/p>\s*/is, '').trim();

    if (dohLineText) {
        contentToRender = `<p class="doh-line">${dohLineText}</p>` + contentToRender;
    }

    contentToRender = contentToRender.replace(/<p>\s*<b[^>]*>(\d+\.?)\s*<\/b>/gi, `<p><b class="verse-number">$1</b>`);
    contentToRender = contentToRender.replace(/<p>\s*<b[^>]*>(CHO:)\s*<\/b>/gi, `<p><b class="chorus-label">$1</b>`);

    hymnDetailTextEl.innerHTML = contentToRender;
    
    // --- Apply current font size to the hymn text body ---
    hymnDetailTextEl.style.fontSize = `${currentHymnFontSize}px`;


    hymnNumberDisplay.textContent = hymn.id;

    // --- Navigation Buttons Logic (Keep existing, they are on direct elements) ---
    const currentIndex = filteredHymns.findIndex(h => h.id === currentHymnId);
    const prevHymn = filteredHymns[currentIndex - 1];
    const nextHymn = filteredHymns[currentIndex + 1];

    if (hymnPrevBtn) {
        hymnPrevBtn.disabled = !prevHymn;
        hymnPrevBtn.classList.toggle('opacity-50', !prevHymn);
        hymnPrevBtn.classList.toggle('cursor-not-allowed', !prevHymn);
        hymnPrevBtn.onclick = prevHymn ? () => { currentHymnId = prevHymn.id; renderHymnDetailPage(); } : null;
    }

    if (hymnNextBtn) {
        hymnNextBtn.disabled = !nextHymn;
        hymnNextBtn.classList.toggle('opacity-50', !nextHymn);
        hymnNextBtn.classList.toggle('cursor-not-allowed', !nextHymn);
        hymnNextBtn.onclick = nextHymn ? () => { currentHymnId = nextHymn.id; renderHymnDetailPage(); } : null;
    }
    
    // --- Back Button Listener (Keep existing) ---
    if (hymnDetailBackBtn) {
        hymnDetailBackBtn.removeEventListener('click', () => switchPage('hymns'));
        hymnDetailBackBtn.addEventListener('click', () => switchPage('hymns'));
    }

    // --- Favorite Icon on Detail Page Listener (Keep existing) ---
    const isFavorite = hymnFavorites.includes(hymn.id);
    if (hymnDetailFavoriteBtn) {
        hymnDetailFavoriteBtn.classList.toggle('text-yellow-500', isFavorite);
        hymnDetailFavoriteBtn.classList.toggle('text-gray-400', !isFavorite);
        hymnDetailFavoriteBtn.title = isFavorite ? 'Remove from Favorites' : 'Add to Favorites';
        hymnDetailFavoriteBtn.removeEventListener('click', () => toggleHymnFavorite(hymn.id));
        hymnDetailFavoriteBtn.addEventListener('click', () => toggleHymnFavorite(hymn.id));
    }

    // --- REMOVED: Individual font size button listener attachments from here. ---
    // They are now handled by delegation in initializeAppLogic.
};

// --- handleHymnFontSizeChange function (REFINEMENT FOR BUTTON STATES) ---
// Ensure this function is defined outside renderHymnDetailPage
function handleHymnFontSizeChange(direction) { // direction: -1 for decrease, 1 for increase
    const hymnTextElement = document.getElementById('hymn-detail-text');
    if (!hymnTextElement) {
        console.error("ERROR: #hymn-detail-text element not found for font change.");
        return;
    }

    let newSize = currentHymnFontSize + (direction * 2); // Change by 2px

    // Set limits for font size
    if (newSize < 12) newSize = 12; // Minimum font size
    if (newSize > 24) newSize = 24; // Maximum font size

    currentHymnFontSize = newSize;
    hymnTextElement.style.fontSize = `${currentHymnFontSize}px`;

    // Save font size to localStorage
    localStorage.setItem('hymnFontSize', currentHymnFontSize);

    // --- Update button states immediately after change ---
    // This part should be called after `currentHymnFontSize` is updated
    const hymnFontDecreaseBtn = document.getElementById('hymn-font-decrease-btn');
    const hymnFontIncreaseBtn = document.getElementById('hymn-font-increase-btn');
    if (hymnFontDecreaseBtn) {
        hymnFontDecreaseBtn.disabled = currentHymnFontSize <= 12;
        hymnFontDecreaseBtn.classList.toggle('opacity-50', currentHymnFontSize <= 12);
        hymnFontDecreaseBtn.classList.toggle('cursor-not-allowed', currentHymnFontSize <= 12);
    }
    if (hymnFontIncreaseBtn) {
        hymnFontIncreaseBtn.disabled = currentHymnFontSize >= 24;
        hymnFontIncreaseBtn.classList.toggle('opacity-50', currentHymnFontSize >= 24);
        hymnFontIncreaseBtn.classList.toggle('cursor-not-allowed', currentHymnFontSize >= 24);
    }
}

// --- handleHymnFontSizeChange function ---
// Ensure this function is defined outside renderHymnDetailPage
function handleHymnFontSizeChange(direction) { // direction: -1 for decrease, 1 for increase
    const hymnTextElement = document.getElementById('hymn-detail-text');
    if (!hymnTextElement) {
        console.error("ERROR: #hymn-detail-text element not found for font change.");
        return;
    }

    let newSize = currentHymnFontSize + (direction * 2); // Change by 2px

    // Set limits for font size
    if (newSize < 12) newSize = 12; // Minimum font size
    if (newSize > 24) newSize = 24; // Maximum font size

    currentHymnFontSize = newSize;
    hymnTextElement.style.fontSize = `${currentHymnFontSize}px`;

    // Save font size to localStorage
    localStorage.setItem('hymnFontSize', currentHymnFontSize);

    // Update button states immediately after change
    // This part should be called after `currentHymnFontSize` is updated
    const hymnFontDecreaseBtn = document.getElementById('hymn-font-decrease-btn');
    const hymnFontIncreaseBtn = document.getElementById('hymn-font-increase-btn');
    if (hymnFontDecreaseBtn) {
        hymnFontDecreaseBtn.disabled = currentHymnFontSize <= 12;
        hymnFontDecreaseBtn.classList.toggle('opacity-50', currentHymnFontSize <= 12);
        hymnFontDecreaseBtn.classList.toggle('cursor-not-allowed', currentHymnFontSize <= 12);
    }
    if (hymnFontIncreaseBtn) {
        hymnFontIncreaseBtn.disabled = currentHymnFontSize >= 24;
        hymnFontIncreaseBtn.classList.toggle('opacity-50', currentHymnFontSize >= 24);
        hymnFontIncreaseBtn.classList.toggle('cursor-not-allowed', currentHymnFontSize >= 24);
    }
}

// --- End Hymns Section ---

            // --- Edit and Delete Logic ---
            const openHouseholdEditModal = (householdId) => {
                const familyMembers = allMembers.filter(m => m.householdId === householdId);
                const headMember = familyMembers.find(m => m.isHead) || familyMembers[0];

                if (!headMember) {
                    showToast("Could not find household to edit.", "error");
                    return;
                }

                const createEditFormForMember = (member) => {
                    const maritalStatusField = member.isHead ? `
                        <div>
                            <label for="marital-status-${member.id}" class="block text-sm font-medium text-gray-700">Marital Status</label>
                            <select id="marital-status-${member.id}" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md">
                                <option value="Single" ${member.maritalStatus === 'Single' ? 'selected' : ''}>Single</option>
                                <option value="Married" ${member.maritalStatus === 'Married' ? 'selected' : ''}>Married</option>
                                <option value="Divorced" ${member.maritalStatus === 'Divorced' ? 'selected' : ''}>Divorced</option>
                                <option value="Widowed" ${member.maritalStatus === 'Widowed' ? 'selected' : ''}>Widowed</option>
                            </select>
                        </div>
                    ` : '';

                    return `
                        <div class="p-4 border border-gray-200 rounded-lg mt-4" data-member-id="${member.id}">
                             <div class="flex items-center gap-4">
                                 ${ member.profilePic ? `<img src="${member.profilePic}" alt="${member.name}" class="profile-pic">` : `<div class="profile-pic-placeholder"><i class="fas fa-${member.gender === 'Male' ? 'male' : (member.gender === 'Female' ? 'female' : 'genderless')}"></i></div>` }
                                 <h4 class="font-semibold text-lg">${member.name} (${getRelationship(member)})</h4>
                             </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mt-4">
                                <div>
                                    <label for="name-${member.id}" class="block text-sm font-medium text-gray-700">Full Name</label>
                                    <input type="text" id="name-${member.id}" value="${member.name}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="phone-${member.id}" class="block text-sm font-medium text-gray-700">Phone</label>
                                    <input type="tel" id="phone-${member.id}" value="${member.phone || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="email-${member.id}" class="block text-sm font-medium text-gray-700">Email</label>
                                    <input type="email" id="email-${member.id}" value="${member.email || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="dob-${member.id}" class="block text-sm font-medium text-gray-700">Birthday</label>
                                    <input type="date" id="dob-${member.id}" value="${member.dob || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="gender-${member.id}" class="block text-sm font-medium text-gray-700">Gender</label>
                                    <select id="gender-${member.id}" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md">
                                        <option value="" ${!member.gender ? 'selected' : ''}>Select...</option>
                                        <option value="Male" ${member.gender === 'Male' ? 'selected' : ''}>Male</option>
                                        <option value="Female" ${member.gender === 'Female' ? 'selected' : ''}>Female</option>
                                    </select>
                                </div>
                                ${maritalStatusField}
                                <div class="flex items-center pt-6">
                                    <input type="checkbox" id="baptized-${member.id}" ${member.baptized ? 'checked' : ''} class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                    <label for="baptized-${member.id}" class="ml-2 block text-sm font-medium text-gray-900">Baptized</label>
                                </div>
                                <div>
                                    <label for="profilePic-${member.id}" class="block text-sm font-medium text-gray-700">Profile Picture</label>
                                    <input type="file" id="profilePic-${member.id}" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                                </div>
                            </div>
                        </div>
                    `;
                };

                const membersFormsHTML = familyMembers.map(createEditFormForMember).join('');

                editModal.innerHTML = `
                <div class="p-5 rounded-lg shadow-xl w-full max-w-3xl" style="background-color: var(--card-bg);">
                    <div class="modal-body">
                        <h3 class="text-lg text-center font-medium mb-4">Edit Household</h3>
                        <form id="edit-household-form" class="space-y-4">
                            <input type="hidden" id="edit-household-id" value="${householdId}">
                            <!-- Household-wide fields -->
                            <div class="form-section">
                                <h3 class="form-section-title">Household Info</h3>
                                <div>
                                    <label for="edit-address" class="block text-sm font-medium">Address</label>
                                    <input type="text" id="edit-address" value="${headMember.address}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div class="mt-4">
                                    <label for="edit-group" class="block text-sm font-medium">Group</label>
                                    <select id="edit-group" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md">
                                        <option value="A" ${headMember.group === 'A' ? 'selected' : ''}>Group A</option>
                                        <option value="B" ${headMember.group === 'B' ? 'selected' : ''}>Group B</option>
                                        <option value="C" ${headMember.group === 'C' ? 'selected' : ''}>Group C</option>
                                        <option value="D" ${headMember.group === 'D' ? 'selected' : ''}>Group D</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Individual member forms -->
                            <div id="edit-members-container">${membersFormsHTML}</div>

                            <div class="pt-4 flex justify-end gap-3">
                                <button type="button" id="cancel-edit-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                                <button type="submit" class="px-4 py-2 text-white rounded-md" style="background-color: var(--primary-color);">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>`;
                editModal.classList.remove('hidden');

                document.getElementById('cancel-edit-btn').addEventListener('click', () => editModal.classList.add('hidden'));
                document.getElementById('edit-household-form').addEventListener('submit', handleHouseholdUpdate);
            };

			const handleHouseholdUpdate = async (e) => {
				e.preventDefault();
				const householdId = document.getElementById('edit-household-id').value;
				const newAddress = document.getElementById('edit-address').value;
				const newGroup = document.getElementById('edit-group').value;

				const batch = writeBatch(db);

				const memberForms = document.querySelectorAll('#edit-members-container [data-member-id]');
				for (const form of memberForms) {
					const memberId = form.dataset.memberId;
					const memberRef = doc(db, "members", memberId);

					// --- MODIFIED: Handle profilePic upload to Storage ---
					const picFile = document.getElementById(`profilePic-${memberId}`).files[0];
					let profilePicUrl = allMembers.find(m => m.id === memberId)?.profilePic || null; // Preserve existing URL
					if (picFile) {
						const picPath = `memberProfilePics/${memberId}/${Date.now()}_${picFile.name}`;
						profilePicUrl = await uploadFileToStorage(picFile, picPath);
					}

					const updatedData = {
						name: document.getElementById(`name-${memberId}`).value,
						phone: document.getElementById(`phone-${memberId}`).value,
						email: document.getElementById(`email-${memberId}`).value,
						dob: document.getElementById(`dob-${memberId}`).value,
						gender: document.getElementById(`gender-${memberId}`).value,
						baptized: document.getElementById(`baptized-${memberId}`).checked,
						address: newAddress,
						group: newGroup,
						profilePic: profilePicUrl // Assign the URL (new or existing)
					};

					if (document.getElementById(`marital-status-${memberId}`)) {
						updatedData.maritalStatus = document.getElementById(`marital-status-${memberId}`).value;
					}

					batch.update(memberRef, updatedData);
				}

				await batch.commit();
				showToast("Household updated successfully!", "success");
				editModal.classList.add('hidden');
			};


            const deleteMember = async (id, name) => {
                const memberToDelete = allMembers.find(m => m.id === id);
                const message = memberToDelete && memberToDelete.isHead ?
                    `Are you sure you want to delete ${name} and their entire household? This cannot be undone.` :
                    `Are you sure you want to delete ${name}? This action cannot be undone.`;

                showConfirmModal(message, async () => {
                    if (memberToDelete && memberToDelete.isHead) {
                        const q = query(collection(db, "members"), where("householdId", "==", memberToDelete.householdId));
                        const querySnapshot = await getDocs(q);
                        const batch = writeBatch(db);
                        querySnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                    } else {
                        await deleteDoc(doc(db, "members", id));
                    }
                    showToast("Member(s) deleted successfully.", "success");
                });
            };

            // --- NEW: Generic Prompt Modal ---
            const showPromptModal = (message, defaultValue = '') => {
                return new Promise(resolve => {
                    const promptModal = document.createElement('div');
                    promptModal.className = 'fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center p-4';
                    promptModal.innerHTML = `
                        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-auto" style="background-color: var(--card-bg);">
                            <p class="text-lg mb-4" style="color: var(--text-color);">${message}</p>
                            <input type="text" id="prompt-input" value="${defaultValue}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <div class="mt-6 flex justify-end gap-4">
                                <button id="prompt-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                                <button id="prompt-ok-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">OK</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(promptModal);

                    const cleanup = () => document.body.removeChild(promptModal);

                    document.getElementById('prompt-ok-btn').onclick = () => {
                        const value = document.getElementById('prompt-input').value;
                        cleanup();
                        resolve(value);
                    };
                    document.getElementById('prompt-cancel-btn').onclick = () => {
                        cleanup();
                        resolve(null); // Resolve with null if cancelled
                    };
                });
            };

            // New helper function to insert list HTML reliably
            const insertListHTML = (listType) => {
                let listHtml = '';
                // Use standard Tailwind CSS classes for proper list styling
                if (listType === 'UL') {
                    // 'list-disc' creates bullet points. 'pl-5' adds standard padding.
                    listHtml = `<ul class="list-disc pl-5"><li></li></ul>`;
                } else if (listType === 'OL') {
                    // 'list-decimal' creates incrementing numbers. 'pl-5' adds padding.
                    listHtml = `<ol class="list-decimal pl-5"><li></li></ol>`;
                }
                
                if (listHtml) {
                    document.execCommand('insertHTML', false, listHtml);
                }
            };

			// ------- Helper Function for RSVP -------
			const handleRsvpClick = async (eventId) => {
                if (!currentUser) {
                    showToast("Please log in to mark as Going.", "error");
                    return;
                }

                const eventRef = doc(db, "events", eventId);
                const eventSnap = await getDoc(eventRef);

                if (eventSnap.exists()) {
                    const eventData = eventSnap.data();
                    const attendees = eventData.attendees || [];

                    if (attendees.includes(currentUser.uid)) {
                        // User has already RSVP'd, so we remove them (un-RSVP)
                        await updateDoc(eventRef, {
                            attendees: arrayRemove(currentUser.uid)
                        });
                        showToast("You are no longer going.", "info");
                    } else {
                        // User has not RSVP'd, so we add them
                        await updateDoc(eventRef, {
                            attendees: arrayUnion(currentUser.uid)
                        });
                        showToast("Great! You're on the list.", "success");
                    }
                }
            };

            const handleAddToCalendar = (event) => {
                // Helper to format date/time for .ics file (YYYYMMDDTHHMMSSZ)
                const formatIcsDate = (date, time) => {
                    const d = new Date(`${date} ${time}`);
                    return d.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";
                };
                
                const startTime = formatIcsDate(event.date, event.time);
                // Create a default 1-hour duration for the event
                const endTime = formatIcsDate(event.date, (parseInt(event.time.split(":")[0]) + 1) + ":" + event.time.split(":")[1]);

                const icsContent = `BEGIN:VCALENDAR
				VERSION:2.0
				BEGIN:VEVENT
				UID:${event.id}@yourchurch.com
				DTSTAMP:${new Date().toISOString().replace(/[-:]/g, "").split(".")[0] + "Z"}
				DTSTART:${startTime}
				DTEND:${endTime}
				SUMMARY:${event.title}
				DESCRIPTION:${event.description.replace(/<[^>]*>?/gm, '')}
				LOCATION:${event.location}
				END:VEVENT
				END:VCALENDAR`;

                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `${event.title}.ics`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };


            // --- JSON Import Logic ---
            const setupImportButtons = () => {
                document.querySelectorAll('.import-icon-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => e.currentTarget.previousElementSibling.click());
                });
                document.querySelectorAll('.import-json-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const group = e.target.dataset.group;
                            handleFileUpload(file, group, e.target);
                        }
                    });
                });
            };

            const handleFileUpload = (file, group, inputElement) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    let membersToImport;
                    try {
                        const parsedData = JSON.parse(event.target.result);
                        if (!Array.isArray(parsedData)) throw new Error("JSON file must be an array.");
                        membersToImport = parsedData.map(item => {
                            const name = item.Min || item.name;
                            const phone = item.Phone || item.phone;
                            const address = item.Address || item.address;
                            if (!name || !address) {
                                console.warn("Skipping record due to missing name or address:", item);
                                return null;
                            }
                            const householdId = `hh-${Date.now()}-${Math.random()}`;
                            return { name, phone, address, group, householdId, isHead: true, gender: '', baptized: false, profilePic: null, maritalStatus: 'Single', isFavorite: false, relationship: 'Head' };
                        }).filter(Boolean); // Filter out null records
                    } catch (err) {
                        showToast(`Error parsing file: ${err.message}`, 'error');
                        inputElement.value = '';
                        return;
                    }

                    if (membersToImport.length > 0) {
                        const message = `Import ${membersToImport.length} new households into Group ${group}?`;
                        showConfirmModal(message, () => {
                           batchImportMembers(membersToImport);
                           inputElement.value = '';
                        });
                    } else {
                        showToast('No valid members to import found in the file.', 'error');
                        inputElement.value = '';
                    }
                };
                reader.readAsText(file);
            };

            const batchImportMembers = async (members) => {
                if (members.length === 0) { showToast("No valid members to import.", "info"); return; }
                const batch = writeBatch(db);
                members.forEach(memberData => {
                    const docRef = doc(collection(db, 'members')); // Automatically generate ID
                    batch.set(docRef, memberData);
                });
                await batch.commit();
                showToast(`Successfully imported ${members.length} households.`, 'success');
            };

			// --- Prayer Wall Logic ---
            let allPublicPrayers = [];
            let unsubscribePrayerWall = null;

				const fetchPublicPrayers = () => {
                if (unsubscribePrayerWall) unsubscribePrayerWall();

                const q = query(collection(db, "prayerRequests"), where("isPublic", "==", true), orderBy("submittedAt", "desc"));
                
                unsubscribePrayerWall = onSnapshot(q, (snapshot) => {
                    allPublicPrayers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // --- NEW LOGIC TO UPDATE THE COUNT ---
                    const prayerWallCounter = document.getElementById('prayer-wall-count');
                    // Filter for prayers that have a count of 0 or don't have the field yet
                    const unprayedForCount = allPublicPrayers.filter(p => !p.prayerCount || p.prayerCount === 0).length;

                    if (unprayedForCount > 0) {
                        prayerWallCounter.textContent = unprayedForCount;
                        prayerWallCounter.classList.remove('hidden');
                    } else {
                        prayerWallCounter.classList.add('hidden');
                    }
                    // --- END NEW LOGIC ---

                    // Only render the prayer wall if we are currently on that page
                    if(currentPage === 'prayer-wall') {
                        renderPrayerWall();
                    }
                }, (error) => {
                    console.error("Error fetching public prayers:", error);
                });
            };

            const renderPrayerWall = () => {
                const container = document.getElementById('prayer-wall-container');
                container.innerHTML = ''; // Clear existing content

                if (allPublicPrayers.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500">No public prayer requests at this time. Be the first to share!</p>`;
                    return;
                }
                
                allPublicPrayers.forEach(prayer => {
                    const card = createPrayerCard(prayer);
                    container.appendChild(card);
                });
            };

            const createPrayerCard = (prayer) => {
                const card = document.createElement('div');
                card.className = "p-4 rounded-xl shadow-md";
                card.style.backgroundColor = 'var(--card-bg)';

                const submittedDate = prayer.submittedAt ? new Date(prayer.submittedAt.toDate()).toLocaleDateString() : 'Just now';

                // --- NEW LOGIC to check if the current user has prayed ---
                const hasPrayed = currentUser && prayer.prayedByUids && prayer.prayedByUids.includes(currentUser.uid);
                
                // Conditionally set the button's style and text
                const buttonClass = hasPrayed ? 'bg-green-600' : 'btn-primary';
                const buttonText = hasPrayed ? '<i class="fas fa-check"></i> Prayed' : '<i class="fas fa-hands-praying"></i> I Prayed';
                const buttonDisabled = hasPrayed ? 'disabled' : '';

                card.innerHTML = `
                    <p class="text-base text-gray-800">${prayer.request}</p>
                    <div class="mt-3 pt-3 border-t border-gray-200 flex justify-between items-center">
                        <div>
                            <p class="text-sm font-semibold">${prayer.name}</p>
                            <p class="text-xs text-gray-500">Submitted on ${submittedDate}</p>
                        </div>
                        <div class="text-center">
                            <button data-id="${prayer.id}" class="pray-for-btn text-white font-bold py-2 px-4 rounded-full ${buttonClass}" ${buttonDisabled}>
                                ${buttonText}
                            </button>
                            <p class="text-xs text-gray-600 mt-1">${prayer.prayerCount || 0} prayers</p>
                        </div>
                    </div>
                `;

                // The listener no longer needs to change the button text, just call the update function.
                // It will only be clickable if the 'disabled' attribute is not present.
                card.querySelector('.pray-for-btn').addEventListener('click', (e) => {
                    handlePrayedForClick(prayer.id);
                });

                return card;
            };

            const handlePrayedForClick = async (requestId) => {
                if (!currentUser) { 
                    showToast("Please log in to pray.", "error");
                    return; 
                }

                const prayerRef = doc(db, "prayerRequests", requestId);
                
                // Atomically update the document in two ways:
                // 1. Increment the total prayer count.
                // 2. Add the current user's ID to a 'prayedByUids' array.
                // arrayUnion ensures the ID is only added once.
                await updateDoc(prayerRef, {
                    prayerCount: increment(1),
                    prayedByUids: arrayUnion(currentUser.uid)
                });
            };

            // --- Registration Form Logic ---
            const createMemberInputs = (idPrefix, isHead = false) => {
                 const maritalStatusField = isHead ? `
                    <div>
                        <label for="${idPrefix}-marital-status" class="block text-sm font-medium text-gray-700">Marital Status</label>
                        <select id="${idPrefix}-marital-status" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Single">Single</option>
                            <option value="Married">Married</option>
                            <option value="Divorced">Divorced</option>
                            <option value="Widowed">Widowed</option>
                        </select>
                    </div>
                ` : '';

                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <div>
                            <label for="${idPrefix}-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="${idPrefix}-name" name="${idPrefix}-name" ${isHead ? 'required' : ''} class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="${idPrefix}-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                            <input type="tel" id="${idPrefix}-phone" name="${idPrefix}-phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="${idPrefix}-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="${idPrefix}-email" name="${idPrefix}-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="${idPrefix}-dob" class="block text-sm font-medium text-gray-700">Birthday</label>
                            <input type="date" id="${idPrefix}-dob" name="${idPrefix}-dob" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="${idPrefix}-gender" class="block text-sm font-medium text-gray-700">Gender</label>
                            <select id="${idPrefix}-gender" name="${idPrefix}-gender" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Select...</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        ${maritalStatusField}
                         <div class="flex items-center pt-6">
                            <input id="${idPrefix}-baptized" name="${idPrefix}-baptized" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="${idPrefix}-baptized" class="ml-2 block text-sm font-medium text-gray-900">Baptized</label>
                        </div>
                         <div>
                            <label for="${idPrefix}-profilePic" class="block text-sm font-medium text-gray-700">Profile Picture</label>
                             <input type="file" id="${idPrefix}-profilePic" name="${idPrefix}-profilePic" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                        </div>
                    </div>
                `;
            };

			const setupRegistrationForm = () => {
                if (!registerFormEl) { // Added check
                    console.error("Register form element not found.");
                    return;
                }
                registerFormEl.innerHTML = `
                    <!-- Head of Household Section -->
                    <div class="form-section">
                        <h3 class="form-section-title">Head of Household</h3>
                        <div class="space-y-4">
                            ${createMemberInputs('head', true)}
                            <div>
                                <label for="head-address" class="block text-sm font-medium text-gray-700">Address</label>
                                <input type="text" id="head-address" name="head-address" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="123 Main St, City, State, Zip">
                            </div>
                            <div>
                                <label for="head-group" class="block text-sm font-medium text-gray-700">Group</label>
                                <select id="head-group" name="head-group" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="A">Group A</option>
                                    <option value="B">Group B</option>
                                    <option value="C">Group C</option>
                                    <option value="D">Group D</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Spouse Section (conditionally shown) -->
                    <div id="spouse-section" class="form-section conditional-section">
                         <h3 class="form-section-title">Spouse</h3>
                         ${createMemberInputs('spouse')}
                    </div>

                    <!-- Children & Relatives Toggle -->
                    <div class="form-section">
                         <div class="flex items-center">
                            <input id="add-other-dependents-toggle" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="add-other-dependents-toggle" class="ml-2 block text-sm font-medium text-gray-900">Add Children or Other Relatives?</label>
                        </div>
                    </div>

                    <!-- Conditional Section for Other Dependents -->
                    <div id="additional-dependents-section" class="conditional-section">
                        <!-- Children Section -->
                        <div class="form-section">
                            <h3 class="form-section-title">Children</h3>
                            <div id="children-container"></div>
                            <button type="button" id="add-child-btn" class="mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-800">+ Add Child</button>
                        </div>

                        <!-- Other Relatives Section -->
                        <div class="form-section">
                            <h3 class="form-section-title">Other Relatives in Household</h3>
                            <div id="relatives-container"></div>
                            <button type="button" id="add-relative-btn" class="mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-800">+ Add Relative</button>
                        </div>
                    </div>

                    <!-- Submission Button -->
                    <div class="mt-8 flex justify-end gap-4">
                        <button type="button" id="cancel-register-btn" class="w-full sm:w-auto flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-base font-medium">Cancel</button>
                        <button type="submit" class="w-full sm:w-auto flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white" style="background-color: var(--primary-color)">
                            Register
                        </button>
                    </div>
                `;
                
                // Attach event listeners *after* innerHTML is set
                const maritalStatusSelect = document.getElementById('head-marital-status');
                const spouseSection = document.getElementById('spouse-section');
                if (maritalStatusSelect && spouseSection) { // Added checks
                    maritalStatusSelect.addEventListener('change', () => {
                        spouseSection.classList.toggle('visible', maritalStatusSelect.value === 'Married');
                    });
                }

                const addDependentsToggle = document.getElementById('add-other-dependents-toggle');
                const additionalDependentsSection = document.getElementById('additional-dependents-section');
                if (addDependentsToggle && additionalDependentsSection) { // Added checks
                    addDependentsToggle.addEventListener('change', () => additionalDependentsSection.classList.toggle('visible', addDependentsToggle.checked));
                }
                
                const addChildBtn = document.getElementById('add-child-btn');
                const addRelativeBtn = document.getElementById('add-relative-btn');
                const childrenContainer = document.getElementById('children-container');
                const relativesContainer = document.getElementById('relatives-container');

                if (addChildBtn && childrenContainer) { // Added checks
                    let childCount = 0; // Reset local counter for dynamically added elements
                    addChildBtn.onclick = () => { // Use onclick for direct attachment
                        childCount++;
                        const childId = `child-${childCount}`;
                        const newChildDiv = document.createElement('div');
                        newChildDiv.className = 'p-4 border border-gray-200 rounded-lg mt-4 relative';
                        newChildDiv.innerHTML = `
                            <button type="button" class="absolute top-2 right-2 text-red-500 hover:text-red-700 font-bold" onclick="this.parentElement.remove()">X</button>
                            <h4 class="font-semibold mb-2">Child ${childCount}</h4>
                            ${createMemberInputs(childId)}
                        `;
                        childrenContainer.appendChild(newChildDiv);
                    };
                }

                if (addRelativeBtn && relativesContainer) { // Added checks
                    let relativeCount = 0; // Reset local counter
                    addRelativeBtn.onclick = () => { // Use onclick for direct attachment
                        relativeCount++;
                        const relativeId = `relative-${relativeCount}`;
                        const newRelativeDiv = document.createElement('div');
                        newRelativeDiv.className = 'p-4 border border-gray-200 rounded-lg mt-4 relative';
                        newRelativeDiv.innerHTML = `
                            <button type="button" class="absolute top-2 right-2 text-red-500 hover:text-red-700 font-bold" onclick="this.parentElement.remove()">X</button>
                            <h4 class="font-semibold mb-2">Relative ${relativeCount}</h4>
                            ${createMemberInputs(relativeId)}
                        `;
                        relativesContainer.appendChild(newRelativeDiv);
                    };
                }

                const cancelBtn = document.getElementById('cancel-register-btn');
                if (cancelBtn) { // Added check
                    cancelBtn.onclick = () => switchPage('home');
                }

                registerFormEl.removeEventListener('submit', handleRegisterSubmit); // Prevent duplicate listeners
                registerFormEl.addEventListener('submit', handleRegisterSubmit);
            };

			const handleRegisterSubmit = async (e) => {
				e.preventDefault();
				const householdId = doc(collection(db, "members")).id;
				const address = document.getElementById('head-address').value.trim();
				const group = document.getElementById('head-group').value;

				if (!address) {
					showToast("Address for the household is required.", "error");
					return;
				}

				const batch = writeBatch(db);

				const getMemberData = async (prefix, relationship) => {
					const nameInput = document.getElementById(`${prefix}-name`);
					const name = nameInput ? nameInput.value.trim() : '';
					if (!name) return null;

					// --- MODIFIED: Handle profilePic upload to Storage ---
					const picFile = document.getElementById(`${prefix}-profilePic`).files[0];
					const profilePicUrl = await uploadFileToStorage(picFile, `memberProfilePics/${Date.now()}_${picFile?.name || 'no-name'}`);

					const gender = document.getElementById(`${prefix}-gender`)?.value || '';

					let finalRelationship = relationship;
					if(relationship === 'Child') {
						finalRelationship = gender === 'Male' ? 'Son' : (gender === 'Female' ? 'Daughter' : 'Child');
					}

					const memberData = {
						householdId: householdId,
						name: name,
						phone: document.getElementById(`${prefix}-phone`)?.value.trim() || '',
						email: document.getElementById(`${prefix}-email`)?.value.trim() || '',
						dob: document.getElementById(`${prefix}-dob`)?.value || '',
						gender: gender,
						baptized: document.getElementById(`${prefix}-baptized`)?.checked || false,
						address: address,
						group: group,
						profilePic: profilePicUrl, // Assign the URL from Storage
						isFavorite: false,
						relationship: finalRelationship
					};

					const maritalStatusInput = document.getElementById(`${prefix}-marital-status`);
					if(maritalStatusInput) {
						memberData.maritalStatus = maritalStatusInput.value;
					}

					return memberData;
				};

                const headData = await getMemberData('head', 'Head');
                if (!headData) {
                    showToast("Head of Household name is required.", "error");
                    return;
                }
                headData.isHead = true;
                const headDocRef = doc(collection(db, "members"));
                batch.set(headDocRef, headData);


                if (document.getElementById('head-marital-status')?.value === 'Married') {
                    const spouseData = await getMemberData('spouse', 'Spouse');
                    if (spouseData) {
                        spouseData.isHead = false;
                        const spouseDocRef = doc(collection(db, "members"));
                        batch.set(spouseDocRef, spouseData);
                    }
                }
                
                if(document.getElementById('add-other-dependents-toggle').checked) {
                    const childDivs = document.querySelectorAll('#children-container > div');
                    for(const div of childDivs) {
                        const prefix = div.querySelector('input[id*="-name"]').id.replace('-name', '');
                        const childData = await getMemberData(prefix, 'Child');
                        if(childData) {
                            childData.isHead = false;
                            const childDocRef = doc(collection(db, "members"));
                            batch.set(childDocRef, childData);
                        }
                    }
                    
                    const relativeDivs = document.querySelectorAll('#relatives-container > div');
                     for(const div of relativeDivs) {
                        const prefix = div.querySelector('input[id*="-name"]').id.replace('-name', '');
                        const relativeData = await getMemberData(prefix, 'Relative');
                        if(relativeData){
                            relativeData.isHead = false;
                            const relativeDocRef = doc(collection(db, "members"));
                            batch.set(relativeDocRef, relativeData);
                        }
                    }
                }
                
                await batch.commit();
                
                showToast(`Successfully registered household.`, "success");
                registerFormEl.reset();
                document.getElementById('spouse-section').classList.remove('visible');
                document.getElementById('additional-dependents-section').classList.remove('visible');
                document.getElementById('children-container').innerHTML = '';
                document.getElementById('relatives-container').innerHTML = '';

                switchPage(`group${group}`);
            };

            // Handle standard page links, settings, and themes
            navTabs.querySelectorAll('.sidebar-nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    if (link.id === 'settings-btn') {
                        openSettingsModal();
                    } else if (link.id === 'theme-switcher-btn') {
                        openThemeModal();
                    } else if (link.dataset.page) {
                        switchPage(link.dataset.page);
                    }
                });
            });

  /*          // Handle collapsible group separately for reliability
            const groupHeader = document.querySelector('.collapsible-header[data-page="groups"]');
            const groupContent = document.getElementById('group-collapsible-content');
            if (groupHeader && groupContent) {
                groupHeader.addEventListener('click', () => {
                    // First, toggle the class on the header element
                    groupHeader.classList.toggle('expanded');
                    
                    // Now, check if the header has the 'expanded' class to determine the state
                    if (groupHeader.classList.contains('expanded')) {
                        // If it's expanded, set the height to its full scrollable height
                        groupContent.style.maxHeight = groupContent.scrollHeight + "px";
                    } else {
                        // Otherwise, collapse it by setting maxHeight to null
                        groupContent.style.maxHeight = null;
                    }
                });
            }
			*/

			const updateSermonDisplay = () => {
				const sortBy = document.getElementById('sermon-sort-box').value;
				const searchTerm = document.getElementById('sermon-search-box').value.toLowerCase();
				const speakerFilter = document.getElementById('sermon-speaker-filter').value; // Get selected speaker

				let displayedSermons = [...allSermons];

				// 1. Apply the search filter
				if (searchTerm) {
					displayedSermons = displayedSermons.filter(sermon =>
						sermon.title.toLowerCase().includes(searchTerm) ||
						sermon.speaker.toLowerCase().includes(searchTerm) ||
						new Date(sermon.sermonDate).toLocaleDateString().includes(searchTerm) ||
						(sermon.description && sermon.description.toLowerCase().includes(searchTerm)) // Search in description too
					);
				}

				// 2. Apply the speaker filter
				if (speakerFilter) {
					displayedSermons = displayedSermons.filter(sermon => sermon.speaker === speakerFilter);
				}

				// 3. Apply the selected sorting
				switch (sortBy) {
					case 'date-asc':
						displayedSermons.sort((a, b) => new Date(a.sermonDate) - new Date(b.sermonDate));
						break;
					case 'speaker-asc': // New sorting option
						displayedSermons.sort((a, b) => a.speaker.localeCompare(b.speaker));
						break;
					case 'views-desc': // New sorting option
						displayedSermons.sort((a, b) => (b.views || 0) - (a.views || 0));
						break;
					case 'title-asc': // New sorting option
						displayedSermons.sort((a, b) => a.title.localeCompare(b.title));
						break;
					case 'date-desc':
					default:
						displayedSermons.sort((a, b) => new Date(b.sermonDate) - new Date(a.sermonDate));
						break;
				}

				// 4. Render the final, filtered and sorted list
				renderSermonsPage(displayedSermons);
			};

            // --- Reports Logic ---
            let genderChartInstance, groupChartInstance;

            const generateReports = () => {
                const totalMembers = allMembers.length;
                const totalHouseholds = new Set(allMembers.map(m => m.householdId)).size;
                const totalMales = allMembers.filter(m => m.gender === 'Male').length;
                const totalFemales = allMembers.filter(m => m.gender === 'Female').length;

                document.getElementById('total-members-stat').textContent = totalMembers;
                document.getElementById('total-households-stat').textContent = totalHouseholds;
                document.getElementById('total-males-stat').textContent = totalMales;
                document.getElementById('total-females-stat').textContent = totalFemales;
                
                const groupData = ['A', 'B', 'C', 'D'].map(group => {
                    const membersInGroup = allMembers.filter(m => m.group === group);
                    return {
                        group,
                        households: new Set(membersInGroup.map(m => m.householdId)).size,
                        // --- THIS LINE IS CORRECTED ---
                        members: membersInGroup.length, // Was incorrectly 'membersIninGroup'
                        males: membersInGroup.filter(m => m.gender === 'Male').length,
                        females: membersInGroup.filter(m => m.gender === 'Female').length,
                    }
                });

                const groupTbody = document.getElementById('group-breakdown-tbody');
                groupTbody.innerHTML = groupData.map(d => `
                    <tr class="border-b" style="background-color: var(--card-bg)">
                        <th scope="row" class="px-6 py-4 font-medium whitespace-nowrap sticky left-0 z-10" style="background-color: var(--card-bg);">${d.group}</th>
                        <td class="px-6 py-4">${d.households}</td>
                        <td class="px-6 py-4">${d.members}</td>
                        <td class="px-6 py-4">${d.males}</td>
                        <td class="px-6 py-4">${d.females}</td>
                    </tr>
                `).join('');

                const existingGroupChart = Chart.getChart('group-chart');
                if (existingGroupChart) {
                    existingGroupChart.destroy();
                }
                new Chart(document.getElementById('group-chart'), {
                    type: 'pie',
                    data: {
                        labels: groupData.map(d => `Group ${d.group}`),
                        datasets: [{
                            label: 'Group Distribution',
                            data: groupData.map(d => d.members),
                            backgroundColor: ['#818cf8', '#fb923c', '#4ade80', '#22d3ee'],
                            hoverOffset: 4
                        }]
                    }
                });

                const existingGenderChart = Chart.getChart('gender-chart');
                if (existingGenderChart) {
                    existingGenderChart.destroy();
                }
                new Chart(document.getElementById('gender-chart'), {
                    type: 'bar',
                    data: {
                        labels: ['Male', 'Female'],
                        datasets: [{
                            data: [totalMales, totalFemales],
                            backgroundColor: ['#3b82f6', '#ec4899'],
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: 'var(--text-muted)' }
                            },
                            x: {
                                ticks: {
                                    color: 'var(--text-color)',
                                    font: { size: 12 },
                                    callback: function(value, index, ticks) {
                                        const label = this.getLabelForValue(value);
                                        const count = this.chart.data.datasets[0].data[index];
                                        return [label, `(${count})`];
                                    }
                                }
                            }
                        }
                    }
                });

                generateAgeReport();
            };

            const getAge = (dob) => {
                if (!dob) return null;
                const birthDate = new Date(dob);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            };

            const generateAgeReport = () => {
                const minAge = parseInt(document.getElementById('min-age-filter').value) || 0;
                const maxAge = parseInt(document.getElementById('max-age-filter').value) || 120;
                
                const filteredByAge = allMembers.filter(m => {
                    const age = getAge(m.dob);
                    return age !== null && age >= minAge && age <= maxAge;
                });

                const ageResultsDiv = document.getElementById('age-breakdown-results');
                if (filteredByAge.length === 0) {
                    ageResultsDiv.innerHTML = `<p style="color: var(--text-muted)">No members found in this age range.</p>`;
                    return;
                }

                const malesInAgeRange = filteredByAge.filter(m => m.gender === 'Male').length;
                const femalesInAgeRange = filteredByAge.filter(m => m.gender === 'Female').length;
                
                ageResultsDiv.innerHTML = `
                    <p><strong>Total Members in Range (${minAge}-${maxAge}):</strong> ${filteredByAge.length}</p>
                    <p><strong>Males:</strong> ${malesInAgeRange}</p>
                    <p><strong>Females:</strong> ${femalesInAgeRange}</p>
                `;
            };
            
            const getRelationship = (member) => {
                if(member.isHead) return 'Head';
                if(member.relationship === 'Child') {
                    return member.gender === 'Male' ? 'Son' : (member.gender === 'Female' ? 'Daughter' : 'Child');
                }
                return member.relationship || 'Member';
            }


            // --- Event Listeners Setup ---
            const setupEventListeners = () => {
                console.log("Setting up ALL event listeners..."); // Diagnostic

                // Attach listener to the nav-tabs container for delegation for all sidebar links
                const navTabsContainer = document.getElementById('nav-tabs');
                if (navTabsContainer) {
                    // Remove any old click handlers before adding new one to prevent duplicates
                    navTabsContainer.removeEventListener('click', handleSidebarNavClick);
                    navTabsContainer.addEventListener('click', handleSidebarNavClick);
                    console.log("Sidebar navigation delegation listener attached."); // Diagnostic
                } else {
                    console.error("Navigation tabs container not found, cannot attach delegation listener.");
                }

                // Handle sidebar toggle button (hamburger) - still direct onclick
                const finalHamburgerBtn = document.getElementById('hamburger-btn');
                if (finalHamburgerBtn) {
                    finalHamburgerBtn.onclick = () => {
                        console.log("Hamburger button clicked."); // Diagnostic
                        toggleSidebar();
                    };
                } else {
                    console.error("Hamburger button not found, cannot attach listener.");
                }

                // Handle sidebar overlay for closing - still direct onclick
                const finalSidebarOverlay = document.getElementById('sidebar-overlay');
                if (finalSidebarOverlay) {
                    finalSidebarOverlay.onclick = () => {
                        console.log("Sidebar overlay clicked."); // Diagnostic
                        toggleSidebar(false);
                    };
                } else {
                    console.warn("Sidebar overlay not found.");
                }
                
                // Add event listener for the logout button explicitly - still direct onclick
                const logoutButton = document.getElementById('logout-btn');
                if (logoutButton) {
                    logoutButton.onclick = () => {
                        console.log("Logout button clicked."); // Diagnostic
                        signOut(auth);
                    };
                } else {
                    console.warn("Logout button not found.");
                }

                // Attach other form/button specific listeners that are defined globally
                // Ensure they are correctly identified and attached.
                // These are event listeners usually added via addEventListener on specific IDs.
                // If any of these are not working, we'll need to check their specific attachment.

                // Example of direct listeners that were separate, ensure they are still correctly attached after DOM ready
                // (Assuming these are defined outside setupEventListeners, and thus fire when the script is parsed)
                // slideshowPicInput.addEventListener('change', handleSlideshowUpload);
                // uploadSlideshowPicBtn.addEventListener('click', () => slideshowPicInput.click());
                // removeSlideshowPicBtn.addEventListener('click', handleSlideshowRemove);
                // editAboutDirectoryBtn.addEventListener('click', openEditAboutDirectoryModal);
                // editZelleBtn.addEventListener('click', openEditZelleModal);
                // editOnlinePaymentLinkBtn.addEventListener('click', openEditOnlinePaymentLinkModal);
                // prayerRequestForm.addEventListener('submit', handlePrayerRequestSubmit);
                // addPostBtn.addEventListener('click', openAddPostModal);
                // addEventBtn.addEventListener('click', () => openAddEditEventModal());
                // notificationBtn.addEventListener('click', showCombinedNotificationModal);

                console.log("All core event listeners set up (delegated where possible)."); // Diagnostic
            };

            // Centralized handler for sidebar navigation clicks (Event Delegation)
            const handleSidebarNavClick = (e) => {
                const link = e.target.closest('.sidebar-nav-link');
                const collapsibleHeader = e.target.closest('.collapsible-header');

                if (link) {
                    e.preventDefault(); // Prevent default link behavior only for actual links
                    console.log("Delegated sidebar link clicked:", link.dataset.page || link.id); // Diagnostic
                    // Handle standard sidebar links
                    if (link.id === 'settings-btn') {
                        openSettingsModal();
                    } else if (link.id === 'theme-switcher-btn') {
                        openThemeModal();
                    } else if (link.dataset.page) { // Ensure data-page attribute exists
                        switchPage(link.dataset.page);
                    }
                } else if (collapsibleHeader) {
                    e.preventDefault(); // Prevent default behavior for the header click as well
                    console.log("Delegated collapsible header clicked."); // Diagnostic
                    // Handle collapsible headers (like "Groups")
                    const content = document.getElementById('group-collapsible-content');
                    collapsibleHeader.classList.toggle('expanded');
                    content.classList.toggle('expanded');
                }
            };
            
			navTabs.addEventListener('click', handleSidebarNavClick);

            const openThemeModal = () => {
                // Ensure only one theme modal exists at a time
                let themeModal = document.getElementById('theme-selection-modal');
                if (themeModal) {
                    themeModal.remove(); // Remove old instance if it exists
                }

                themeModal = document.createElement('div');
                themeModal.id = 'theme-selection-modal'; // Give it a unique ID for easier targeting and removal
                themeModal.className = 'fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center';
                themeModal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-xs" style="background-color: var(--card-bg);">
                        <h3 class="text-lg font-medium mb-4">Select Theme</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <a href="#" data-theme="default" class="block p-4 text-center border rounded-md hover:bg-gray-100">Default</a>
                            <a href="#" data-theme="dark" class="block p-4 text-center border rounded-md hover:bg-gray-100 bg-gray-800 text-white">Dark</a>
                            <a href="#" data-theme="ocean" class="block p-4 text-center border rounded-md hover:bg-gray-100 bg-teal-700 text-white">Ocean</a>
                            <a href="#" data-theme="sunset" class="block p-4 text-center border rounded-md hover:bg-gray-100 bg-orange-600 text-white">Sunset</a>
                            <a href="#" data-theme="forest" class="block p-4 text-center border rounded-md hover:bg-gray-100 bg-green-700 text-white">Forest</a>
                        </div>
                    </div>
                `;
                document.body.appendChild(themeModal);

                themeModal.addEventListener('click', (e) => {
                    // Check if clicked directly on the overlay or a theme link
                    if (e.target === themeModal || e.target.tagName === 'A') { 
                        if (e.target.dataset.theme) { // Only process if a theme link was clicked
                            document.body.className = `theme-${e.target.dataset.theme}`;
                            if (e.target.dataset.theme === 'default') document.body.className = '';
                            saveSettings();
                        }
                        themeModal.remove(); // Always remove the modal after interaction or clicking outside
                    }
                });
            };


            const openSettingsModal = () => {
                settingsModal.innerHTML = `
                    <div class="p-6 rounded-lg shadow-xl w-full max-w-md" style="background-color: var(--card-bg);">
                        <h3 class="text-lg font-medium mb-4">Settings</h3> <div class="space-y-4">
                            </div>
                         <div class="mt-6 flex justify-end gap-3">
                            <button type="button" id="cancel-settings-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Close</button>
                        </div>
                    </div>
                `;
                settingsModal.classList.remove('hidden');
                if (window.innerWidth < 1024) {
                    toggleSidebar(false);
                }

                document.getElementById('cancel-settings-btn').addEventListener('click', () => settingsModal.classList.add('hidden'));

                // REMOVE THIS EVENT LISTENER BLOCK as it's no longer needed for these radio buttons
                /*
                document.querySelectorAll('input[name="displayMode"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        displayMode = e.target.value;
                        saveSettings();
                        renderAllMemberLists();
                    });
                });
                */
            };

            const showFamilyModal = (householdId) => {
                const familyMembers = allMembers.filter(m => m.householdId === householdId)
                    .sort((a, b) => {
                        const order = { 'Head': 1, 'Spouse': 2, 'Son': 3, 'Daughter': 3, 'Child': 3, 'Relative': 4 };
                        return (order[a.relationship] || 5) - (order[b.relationship] || 5);
                    });

                const headMember = familyMembers.find(m => m.isHead);

                let listHTML = familyMembers.map(member => {
                    // Determine if the current user is an editor or minister
                    const canUploadProfilePic = currentUser && (currentUser.role === 'editor' || currentUser.role === 'minister'); //

                    // Conditionally render the label/input for profile picture upload
                    const profilePicUploadHtml = canUploadProfilePic ? `
                        <input type="file" class="hidden" id="modal-pic-upload-${member.id}" data-member-id="${member.id}" accept="image/*">
                        <label for="modal-pic-upload-${member.id}" class="flex-shrink-0 pt-1 cursor-pointer"> 
                            ${ member.profilePic ? `<img src="${member.profilePic}" alt="${member.name}" class="profile-pic">` : `<div class="profile-pic-placeholder"><i class="fas fa-${member.gender === 'Male' ? 'male' : (member.gender === 'Female' ? 'female' : 'genderless')}"></i></div>` }
                        </label>
                    ` : `
                        <div class="flex-shrink-0 pt-1">
                            ${ member.profilePic ? `<img src="${member.profilePic}" alt="${member.name}" class="profile-pic">` : `<div class="profile-pic-placeholder"><i class="fas fa-${member.gender === 'Male' ? 'male' : (member.gender === 'Female' ? 'female' : 'genderless')}"></i></div>` }
                        </div>
                    `; //


                    return `<li class="py-3 border-b border-gray-200 last:border-b-0 flex items-start gap-4">
                                ${profilePicUploadHtml}
                                <div class="flex-grow">
                                    <p class="font-semibold">${member.name} <span class="text-sm font-normal" style="color: var(--text-muted);">(${getRelationship(member)})</span></p>
                                    <p class="text-sm info-item"><i class="fas fa-phone"></i> ${member.phone || 'N/A'}</p>
                                    <p class="text-sm info-item"><i class="fas fa-envelope"></i> ${member.email || 'N/A'}</p>
                                    <p class="text-sm info-item"><i class="fas fa-venus-mars"></i> ${member.gender || 'N/A'}</p>
                                    <p class="text-sm info-item"><i class="fas fa-church"></i> ${member.baptized ? 'Baptized' : 'Not Baptized'}</p>
                                </div>
                            </li>`;
                }).join('');

                familyModal.innerHTML = `
                <div id="family-modal-content" class="relative p-5 rounded-lg shadow-xl w-full max-w-lg" style="background-color: var(--card-bg);">

                    <button id="close-family-modal-x" class="absolute top-2 right-4 text-2xl text-gray-500 hover:text-gray-800 z-20">×</button>

                    <div class="sticky top-0 pb-4" style="background-color: var(--card-bg);">
                        <h3 class="text-lg text-center font-semibold mb-2">Family of ${headMember ? headMember.name : 'Household'}</h3>
                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(headMember.address)}" target="_blank" rel="noopener noreferrer" class="text-sm text-center mb-4 info-item justify-center">${headMember.address || 'Address not available'}</a>
                    </div>
                    <ul id="family-modal-list" class="text-left">${listHTML}</ul>

                    </div>`;
                familyModal.classList.remove('hidden');

                // The event listener for file input change only needs to be attached
                // if the elements are actually rendered (i.e., if canUploadProfilePic is true).
                // However, attaching it to all 'input[type="file"]' that are *present*
                // is fine, as the 'hidden' class will prevent user interaction if the label isn't there.
                // This part of the code remains the same as it correctly targets the inputs if they exist.
				familyModal.querySelectorAll('input[type="file"]').forEach(input => {
				  input.addEventListener('change', async (e) => {
					const file     = e.target.files[0];
					const memberId = e.target.dataset.memberId;
					if (!file || !memberId) return;
					try {
					  showToast("Uploading picture...", "info");

					  // 1) Upload to Firebase Storage
					  const storage = getStorage();
					  const picRef  = storageRef(storage, `memberProfilePics/${memberId}/${Date.now()}_${file.name}`);
					  await uploadBytes(picRef, file);

					  // 2) Get the download URL
					  const downloadURL = await getDownloadURL(picRef);

					  // 3) Save the URL in Firestore
					  const memberRef = doc(db, "members", memberId);
					  await updateDoc(memberRef, { profilePic: downloadURL });

					  showToast("Profile picture updated!", "success");
					  familyModal.classList.add('hidden');
					} catch (err) {
					  console.error("Error uploading profile pic:", err);
					  showToast("Failed to update profile picture.", "error");
					} finally {
					  e.target.value = "";
					}
				  });
				});

                // Update the event listener to target the new 'X' button
                document.getElementById('close-family-modal-x').addEventListener('click', () => familyModal.classList.add('hidden'));
            };

			// --- Member Info Modal (for Name Only View) ---
			const showMemberInfoModal = (memberId) => {
                const member = allMembers.find(m => m.id === memberId);
                if (!member) {
                    showToast("Member not found.", "error");
                    return;
                }

                const familyMembers = allMembers.filter(m => m.householdId === member.householdId);
                const headMember = familyMembers.find(m => m.isHead);

                const showFamilyButtonHtml = (familyMembers.length > 1) ?
                    `<div class="mt-4 text-center"><button data-household-id="${member.householdId}" class="show-family-btn-modal px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Show Family (${familyMembers.length})</button></div>` :
                    '';

                const editButtonHtml = (currentUser && currentUser.role === 'editor') ?
                    `<button data-household-id="${member.householdId}" class="edit-member-info-modal-btn text-indigo-600 hover:text-indigo-900 text-lg" title="Edit Info"><i class="fas fa-pencil-alt"></i></button>` :
                    '';
				const memberInfoModalEl = document.getElementById('member-info-modal');
                memberInfoModalEl.innerHTML = `
                    <div class="relative p-5 rounded-lg shadow-xl w-full max-w-md" style="background-color: var(--card-bg);">
                        <button id="close-member-info-modal-x" class="absolute top-2 right-4 text-2xl text-gray-500 hover:text-gray-800 z-20">×</button>
                        <div class="member-modal-profile-header flex flex-col items-center pb-4 mb-4">
                            ${ member.profilePic ? `<img src="${member.profilePic}" alt="${member.name}" class="minister-modal-profile-pic">` : `<div class="minister-modal-profile-placeholder"><i class="fas fa-user"></i></div>` }
                            <div class="flex items-center gap-3 mt-2">
                                <h3 class="text-2xl font-bold">${member.name}</h3>
                                ${editButtonHtml}
                            </div>
                            ${member.isHead ? `<span class="text-base font-normal" style="color: var(--text-muted);">(${getRelationship(member)})</span>` : `
                                <span class="text-base font-normal" style="color: var(--text-muted);">(${getRelationship(member)}${headMember ? ` of ${headMember.name}` : ''})</span>
                            `}
                        </div>
                        <div class="modal-body flex-grow space-y-3">
                            <p class="text-base info-item"><i class="fas fa-phone"></i><a href="tel:${member.phone}">${member.phone || 'N/A'}</a></p>
                            <p class="text-base info-item"><i class="fas fa-envelope"></i> ${member.email || 'N/A'}</p>
                            <p class="text-base info-item"><i class="fas fa-venus-mars"></i> ${member.gender || 'N/A'}</p>
                            <p class="text-base info-item"><i class="fas fa-church"></i> ${member.baptized ? 'Baptized' : 'Not Baptized'}</p>
                            <p class="text-base info-item"><i class="fas fa-map-marker-alt"></i><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(member.address)}" target="_blank" rel="noopener noreferrer">${member.address || 'N/A'}</a></p>
                            <p class="text-base info-item"><strong>Group:</strong> ${member.group || 'N/A'}</p>
                            ${member.isHead ? `<p class="text-base info-item"><strong>Marital Status:</strong> ${member.maritalStatus || 'N/A'}</p>` : ''}
                        </div>
						${showFamilyButtonHtml}
                    </div>
                `;
                memberInfoModalEl.classList.remove('hidden');

                // --- CORRECTED EVENT LISTENER LOGIC ---
                document.getElementById('close-member-info-modal-x').addEventListener('click', () => memberInfoModalEl.classList.add('hidden'));

                const showFamilyBtn = document.querySelector('#member-info-modal .show-family-btn-modal');
                if (showFamilyBtn) {
                    showFamilyBtn.addEventListener('click', (e) => {
                        memberInfoModalEl.classList.add('hidden');
                        showFamilyModal(e.currentTarget.dataset.householdId);
                    });
                }
                
                const editBtn = document.querySelector('#member-info-modal .edit-member-info-modal-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', (e) => {
                        memberInfoModalEl.classList.add('hidden');
                        // Get the ID from the button itself (e.currentTarget)
                        const householdId = e.currentTarget.dataset.householdId;
                        openHouseholdEditModal(householdId);
                    });
                }
            };
            
            const listenForFavorites = () => {
                if(unsubscribeFavorites) unsubscribeFavorites();
                if(!currentUser) return;

                const favRef = doc(db, 'userFavorites', currentUser.uid);
                unsubscribeFavorites = onSnapshot(favRef, (docSnap) => {
                    if (docSnap.exists()) {
                        userFavorites = docSnap.data().favoriteMemberIds || [];
                    } else {
                        userFavorites = [];
                    }
                    document.getElementById('count-favorites').textContent = `(${userFavorites.length})`;
                    renderAllMemberLists(); // Re-render to update star icons
                    if(currentPage === 'favorites') {
                        renderFavoritesPage();
                    }
                });
            }
            
             const setupUpdateInfoForm = () => {
                updateInfoFormEl.innerHTML = `
                     <div class="form-section">
                        <h3 class="form-section-title">Your Information</h3>
                        <p class="text-sm mb-4" style="color: var(--text-muted)">Enter your full name so we can find your records, then fill out the fields you wish to update.</p>
                        <div class="space-y-4">
                            ${createMemberInputs('update', true)}
                             <div>
                                <label for="update-address" class="block text-sm font-medium text-gray-700">New Address</label>
                                <input type="text" id="update-address" name="update-address" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="123 Main St, City, State, Zip">
                            </div>
                            <div><label for="update-notes" class="block text-sm font-medium text-gray-700">Notes (Reason for update, etc.)</label><textarea id="update-notes" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Any additional notes about the update request..."></textarea></div>
                        </div>
                    </div>
                     <div class="mt-8 flex justify-end gap-4">
                         <button type="button" id="cancel-update-btn" class="w-full sm:w-auto flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-base font-medium">Cancel</button>
                        <button type="submit" class="w-full sm:w-auto flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white btn-primary">
                            Submit
                        </button>
                    </div>
                `;
                
                document.getElementById('cancel-update-btn').addEventListener('click', () => switchPage('home'));
                
                 updateInfoFormEl.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('update-name').value;
                    if(!name) {
                        showToast("Full name is required to submit a request.", "error");
                        return;
                    }
                    
                    const requestData = {
                        name: name,
                        phone: document.getElementById('update-phone').value,
                        email: document.getElementById('update-email').value,
                        address: document.getElementById('update-address')?.value || 'Not provided',
                        gender: document.getElementById('update-gender').value,
                        baptized: document.getElementById('update-baptized').checked,
                        maritalStatus: document.getElementById('update-marital-status').value,
                        notes: document.getElementById('update-notes').value,
                        submittedBy: currentUser.name,
                        submittedAt: serverTimestamp(),
                        status: 'pending'
                    };
                    
                    await addDoc(collection(db, 'updateRequests'), requestData);
                    showToast("Your update request has been submitted for review. Thank you!", "success");
                    updateInfoFormEl.reset();
                    switchPage('home');
                });
            };
            
           // let allPreviousUpdateRequestsCount = 0; // To track count for notification badge adjustment

            const listenForUpdateRequests = () => {
                if(unsubscribeUpdateRequests) unsubscribeUpdateRequests();
                // Only editors and ministers should listen for updates
                if (!(currentUser && (currentUser.role === 'editor' || currentUser.role === 'minister'))) {
                    // if not authorized, ensure related UI is hidden and do not setup listener
                    notificationBadge.classList.add('hidden');
                    // notificationBtn.onclick = null; // Don't nullify, handled by combined modal
                    return;
                }
                const q = query(collection(db, "updateRequests"), where("status", "==", "pending"));
                unsubscribeUpdateRequests = onSnapshot(q, (snapshot) => {
                    const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data()}));
                    let currentTotalNotifications = parseInt(notificationBadge.textContent || '0');
                    // Subtract previous update request count and add new one
                    currentTotalNotifications = currentTotalNotifications - allPreviousUpdateRequestsCount + requests.length;
                    allPreviousUpdateRequestsCount = requests.length; // Store current count for next update

                    if(currentTotalNotifications > 0) {
                        notificationBadge.textContent = currentTotalNotifications;
                        notificationBadge.classList.remove('hidden');
                    } else {
                        notificationBadge.classList.add('hidden');
                    }
                    // This will be handled by showCombinedNotificationModal when notificationBtn is clicked
                }, (error) => {
                     console.error("Error fetching update requests:", error);
                     showToast("Failed to load update requests.", "error");
                     notificationBadge.classList.add('hidden'); // Hide on error
                });
            };
            
            const showNotificationModal = (requests) => {
                let requestsHTML = requests.map(req => {
                    return `
                        <div class="p-4 border rounded-lg mb-4">
                            <p><strong>Request from:</strong> ${req.submittedBy}</p>
                            <p><strong>Member Name:</strong> ${req.name}</p>
                            <p><strong>Submitted:</strong> ${req.submittedAt ? new Date(req.submittedAt.toDate()).toLocaleString() : 'N/A'}</p>
                            <div class="mt-2 p-2 bg-gray-100 rounded">
                                ${req.phone ? `<p><strong>Phone:</strong> ${req.phone}</p>` : ''}
                                ${req.email ? `<p><strong>Email:</strong> ${req.email}</p>` : ''}
                                ${req.address !== 'Not provided' ? `<p><strong>Address:</strong> ${req.address}</p>` : ''}
                                ${req.gender ? `<p><strong>Gender:</strong> ${req.gender}</p>` : ''}
                                ${req.maritalStatus ? `<p><strong>Marital Status:</strong> ${req.maritalStatus}</p>` : ''}
                                <p><strong>Baptized:</strong> ${req.baptized ? 'Yes' : 'No'}</p>
                                ${req.notes ? `<p class="mt-2"><strong>Notes:</strong> ${req.notes}</p>` : ''}
                            </div>
                             <button data-id="${req.id}" class="mark-complete-btn mt-2 px-3 py-1 text-xs text-white btn-primary rounded-md">Mark as Complete</button>
                        </div>
                    `
                }).join('');

                if(requests.length === 0) {
                    requestsHTML = `<p style="color: var(--text-muted)">No pending update requests.</p>`;
                }

                 notificationModal.innerHTML = `
                    <div class="p-5 rounded-lg shadow-xl w-full max-w-2xl" style="background-color: var(--card-bg);">
                        <div class="modal-body">
                            <h3 class="text-lg font-medium mb-4">Update Requests</h3>
                            <div>${requestsHTML}</div>
                            <div class="mt-4 text-center"><button id="close-notification-modal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Close</button></div>
                        </div>
                    </div>`;
                notificationModal.classList.remove('hidden');
                
                notificationModal.querySelectorAll('.mark-complete-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const reqId = e.target.dataset.id;
                        const reqRef = doc(db, 'updateRequests', reqId);
                        await deleteDoc(reqRef); // Changed from update to delete
                        showToast("Request completed and removed.");
                        notificationModal.classList.add('hidden');
                    });
                });
                document.getElementById('close-notification-modal').addEventListener('click', () => notificationModal.classList.add('hidden'));

            };

            // --- Home Page Slideshow Logic ---
            function showSlides(n) {
                // Get all slides and description overlays as live NodeLists
                // The order in these NodeLists is crucial and must correspond by index.
                let slides = slideshowContainer.querySelectorAll('.mySlides');
                let descriptions = slideshowContainer.querySelectorAll('.slideshow-description-overlay');

                if (slides.length === 0) {
                    slideIndex = 0; // Reset index if no slides
                    return;
                }

                // Hide all slides and descriptions
                slides.forEach(slide => {
                    slide.classList.remove('active-slide');
                    slide.style.display = 'none'; // Ensure it's hidden
                });
                descriptions.forEach(desc => desc.classList.add('hidden')); // Ensure all captions are hidden

                // Calculate new slide index
                slideIndex = (n + slides.length) % slides.length;

                // Show the active slide
                slides[slideIndex].style.display = 'block';
                slides[slideIndex].offsetWidth; // Trigger reflow for transition
                slides[slideIndex].classList.add('active-slide');

                // Show the corresponding description overlay
                if (descriptions[slideIndex]) { // Ensure a description exists for this index
                    descriptions[slideIndex].classList.remove('hidden');
                }
            }


            window.plusSlides = function(n) {
                stopSlideshow(); // Stop auto-advance on manual navigation
                showSlides(slideIndex + n);
                startSlideshow(); // Restart auto-advance
            }

            const startSlideshow = () => {
                stopSlideshow(); // Clear any existing interval
                if (slideshowPhotos.length > 1) { // Only auto-advance if more than one picture
                    slideshowInterval = setInterval(() => {
                        showSlides(slideIndex + 1);
                    }, 5000); // Change image every 5 seconds
                }
            };

            const stopSlideshow = () => {
                clearInterval(slideshowInterval);
            };


            const fetchSlideshowPhotos = () => {
                if (unsubscribeSlideshow) unsubscribeSlideshow();
                const slideshowRef = collection(db, "slideshowPhotos");
                unsubscribeSlideshow = onSnapshot(slideshowRef, (snapshot) => {
                    slideshowPhotos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderSlideshow();
                }, (error) => {
                    console.error("Error fetching slideshow photos:", error);
                    showToast("Failed to load slideshow photos.", "error");
                });
            };

            const renderSlideshow = () => {
                // Clear all existing slides and description overlays before re-rendering
                slideshowContainer.querySelectorAll('.mySlides').forEach(slide => slide.remove());
                slideshowContainer.querySelectorAll('.slideshow-description-overlay').forEach(overlay => overlay.remove());

                if (slideshowPhotos.length === 0) {
                    const defaultImg = document.createElement('img');
                    defaultImg.className = 'mySlides active-slide';
                    defaultImg.src = "https://placehold.co/800x450/cccccc/333333?text=No+Images+Yet";
                    defaultImg.style.display = 'block';
                    slideshowContainer.prepend(defaultImg); // Use prepend to put at the start

                    const defaultDescOverlay = document.createElement('div');
                    defaultDescOverlay.className = 'slideshow-description-overlay absolute bottom-0 left-0 w-full bg-black bg-opacity-50 text-white p-2 text-sm text-center hidden';
                    defaultDescOverlay.innerHTML = `<span>No description available.</span>`;
                    slideshowContainer.appendChild(defaultDescOverlay); // Append after slides (order might matter for z-index)
                } else {
                    // Sort slideshowPhotos by uploadedAt to ensure consistent order
                    slideshowPhotos.sort((a, b) => (a.uploadedAt?.toDate() || 0) - (b.uploadedAt?.toDate() || 0));

                    // Create and prepend all slides and append all description overlays
                    // This creates two ordered lists (NodeLists) in the DOM that should correspond by index
                    slideshowPhotos.forEach((photo, index) => {
                        const img = document.createElement('img');
                        img.className = 'mySlides';
                        img.src = photo.url;
                        img.onerror = function() {
                            this.src = "https://placehold.co/800x450/ff0000/ffffff?text=Image+Load+Error";
                        };
                        slideshowContainer.prepend(img); // Prepend so new items are at the start of the NodeList

                        const descriptionOverlay = document.createElement('div');
                        descriptionOverlay.className = 'slideshow-description-overlay absolute bottom-0 left-0 w-full bg-black bg-opacity-50 text-white p-2 text-sm text-center hidden';
                        descriptionOverlay.innerHTML = `<span>${photo.description || ''}</span>`;
                        slideshowContainer.appendChild(descriptionOverlay); // Append after all images
                    });
                }

                // Show/hide the single "Manage Slideshow" button
                if (currentUser && currentUser.role === 'editor') {
                    manageSlideshowBtn.classList.remove('hidden');
                } else {
                    manageSlideshowBtn.classList.add('hidden');
                }

                slideIndex = 0; // Reset to the first slide
                showSlides(slideIndex); // Show the first slide and its caption
                startSlideshow(); // Start auto-advance
            };

			async function openManageSlideshowModal() {
				console.log("DEBUG: openManageSlideshowModal called.");
				if (!currentUser || currentUser.role !== 'editor') {
					showToast("You do not have permission to manage slideshows.", "error");
					return;
				}

				manageSlideshowModal.classList.remove('hidden');

				// Close button listener
				document.getElementById('close-manage-slideshow-modal').onclick = () => {
					manageSlideshowModal.classList.add('hidden');
				};

				// Upload Form Submission
				const uploadForm = document.getElementById('upload-new-slideshow-form');
				uploadForm.onsubmit = handleAddSlideshowPhoto; // Assign the new handler

				// Populate existing slides list
				await renderExistingSlideshowList();
			}
			
			async function handleAddSlideshowPhoto(e) {
				e.preventDefault();
				const fileInput = document.getElementById('new-slideshow-image');
				const captionInput = document.getElementById('new-slideshow-caption');
				const file = fileInput.files[0];
				const caption = captionInput.value;

				if (!file) {
					showToast("Please select an image to upload.", "error");
					return;
				}

				const submitBtn = e.target.querySelector('button[type="submit"]');
				submitBtn.disabled = true;
				submitBtn.textContent = 'Uploading...';

				try {
					const filePath = `slideshowPhotos/${Date.now()}_${file.name}`;
					const downloadURL = await uploadFileToStorage(file, filePath); // Re-using our helper

					await addDoc(collection(db, "slideshowPhotos"), {
						url: downloadURL,
						description: caption,
						uploadedAt: serverTimestamp()
					});

					showToast("Photo uploaded and added to slideshow!", "success");
					fileInput.value = ''; // Clear file input
					captionInput.value = ''; // Clear caption
					await renderExistingSlideshowList(); // Refresh the list of existing slides
				} catch (error) {
					console.error("Error adding slideshow photo:", error);
					showToast("Failed to upload photo.", "error");
				} finally {
					submitBtn.disabled = false;
					submitBtn.textContent = 'Upload & Add Slide';
				}
			}			
			
			async function renderExistingSlideshowList() {
				const listContainer = document.getElementById('existing-slideshow-list');
				listContainer.innerHTML = `<li class="text-gray-500 text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Loading existing slides...</li>`;

				// Ensure slideshowPhotos array is fresh (it should be due to its onSnapshot listener)
				// If you only want to work with the data that's already in `slideshowPhotos` (from the global listener),
				// then this step implicitly uses the latest.

				if (slideshowPhotos.length === 0) {
					listContainer.innerHTML = `<li class="text-gray-500 text-center py-4">No photos in the slideshow yet.</li>`;
					return;
				}

				listContainer.innerHTML = '';
				slideshowPhotos.forEach(photo => {
					const listItem = document.createElement('li');
					listItem.className = "flex items-center gap-4 p-3 border rounded-md";
					listItem.style.backgroundColor = 'var(--card-bg)'; // Use theme background

					listItem.innerHTML = `
						<img src="${photo.url}" alt="Slide" class="w-16 h-16 object-cover rounded-md flex-shrink-0">
						<div class="flex-grow">
							<p class="font-medium text-sm truncate">${photo.description || 'No caption'}</p>
							<p class="text-xs text-gray-500">Uploaded: ${photo.uploadedAt ? new Date(photo.uploadedAt.toDate()).toLocaleDateString() : 'N/A'}</p>
						</div>
						<div class="flex-shrink-0 flex gap-2">
							<button data-id="${photo.id}" data-action="edit-caption" class="text-indigo-600 hover:text-indigo-800 p-1" title="Edit Caption"><i class="fas fa-pencil-alt"></i></button>
							<button data-id="${photo.id}" data-action="delete-slide" class="text-red-600 hover:text-red-800 p-1" title="Delete Slide"><i class="fas fa-trash"></i></button>
						</div>
					`;
					listContainer.appendChild(listItem);
				});

				// Add event listeners for edit/delete buttons on each list item
				listContainer.querySelectorAll('button[data-action="edit-caption"]').forEach(btn => {
					btn.addEventListener('click', (e) => {
						const photoId = e.currentTarget.dataset.id;
						openEditSlideshowCaptionModal(photoId); // New function to edit caption
					});
				});

				listContainer.querySelectorAll('button[data-action="delete-slide"]').forEach(btn => {
					btn.addEventListener('click', (e) => {
						const photoId = e.currentTarget.dataset.id;
						handleDeleteSlideshowPhoto(photoId); // New function to delete photo
					});
				});
			}			
			
			async function openEditSlideshowCaptionModal(photoId) {
				const photo = slideshowPhotos.find(p => p.id === photoId);
				if (!photo) {
					showToast("Slide not found for editing.", "error");
					return;
				}

				// We'll reuse the manageSlideshowModal for simplicity or create a new tiny modal.
				// For simplicity, let's create a temporary sub-modal or prompt.
				const newCaption = await showPromptModal("Edit caption for this slide:", photo.description || '');

				if (newCaption !== null) { // User didn't cancel
					try {
						await updateDoc(doc(db, "slideshowPhotos", photoId), { description: newCaption, updatedAt: serverTimestamp() });
						showToast("Caption updated successfully!", "success");
						await renderExistingSlideshowList(); // Refresh the list in the main modal
					} catch (error) {
						console.error("Error updating slideshow caption:", error);
						showToast("Failed to update caption.", "error");
					}
				}
			}			
			
			async function handleDeleteSlideshowPhoto(photoId) {
				const photoToDelete = slideshowPhotos.find(p => p.id === photoId);
				if (!photoToDelete) {
					showToast("Photo not found for deletion.", "error");
					return;
				}

				showConfirmModal(`Are you sure you want to delete "${photoToDelete.description || 'this photo'}" from the slideshow? This cannot be undone.`, async () => {
					try {
						// Delete from Firebase Storage first (assuming 'url' contains a full GCS path)
						// If your 'url' in Firestore is just the path, you might need to construct the full ref.
						// Assuming photo.url is a direct downloadable URL.
						// You might need to store `filePath` in Firestore like you do for meetingReports
						// for reliable deletion from Storage. For now, assume a direct URL can be parsed.
						const storageUrl = photoToDelete.url;
						if (storageUrl && storageUrl.includes('firebasestorage.googleapis.com')) {
							// Extract path from download URL:
							const pathRegex = /%2F(.*?)\?alt/;
							const match = storageUrl.match(pathRegex);
							if (match && match[1]) {
								const decodedPath = decodeURIComponent(match[1]);
								const storagePath = `slideshowPhotos/${decodedPath.split('/').pop()}`; // Reconstruct path if needed, assuming base folder
								// OR, if your `photo` object stored `filePath` like `meetingReports`:
								// const storagePath = photoToDelete.filePath; // <--- RECOMMENDED: store filePath in Firestore

								const fileRef = storageRef(storage, storagePath);
								await deleteObject(fileRef).catch(err => console.warn("Could not delete Storage file (might already be gone or permission issue):", err));
							}
						}

						// Delete from Firestore
						await deleteDoc(doc(db, "slideshowPhotos", photoId));
						showToast("Slideshow photo deleted successfully!", "success");
						await renderExistingSlideshowList(); // Refresh the list in the modal
					} catch (error) {
						console.error("Error deleting slideshow photo:", error);
						showToast("Failed to delete slideshow photo.", "error");
					}
				});
			}
			// --- END OF SLIDESHOW SECTION ---
			
            // --- About Our Directory Content Logic ---
            const fetchAboutContent = () => {
                if (unsubscribeAboutContent) unsubscribeAboutContent();
                const aboutRef = doc(db, "appContent", "aboutDirectory");
                unsubscribeAboutContent = onSnapshot(aboutRef, (docSnap) => {
                    if (docSnap.exists()) {
                        aboutDirectoryText = docSnap.data().content || '<p style="color: var(--text-muted);">No information provided yet.</p>';
                    } else {
                        // Create a default entry if it doesn't exist
                        if (currentUser && currentUser.role === 'editor') {
                             setDoc(doc(db, "appContent", "aboutDirectory"), { content: '<p>Welcome! This is the About Our Directory section. Editors can customize this content.</p>', createdAt: serverTimestamp() }, { merge: true });
                        }
                        aboutDirectoryText = '<p style="color: var(--text-muted);">No information provided yet.</p>';
                    }
                    aboutDirectoryContent.innerHTML = aboutDirectoryText;
                }, (error) => {
                    console.error("Error fetching about content:", error);
                    showToast("Failed to load about section content.", "error");
                });
            };

            const openEditAboutDirectoryModal = () => {
                editAboutDirectoryModal.innerHTML = `
                    <div class="p-5 rounded-lg shadow-xl w-full max-w-2xl" style="background-color: var(--card-bg);">
                        <div class="modal-body">
                            <h3 class="text-lg text-center font-medium mb-4">Edit About Our Directory</h3>
                            <div class="rich-text-editor-toolbar">
                                <button type="button" data-command="bold"><i class="fas fa-bold"></i></button>
                                <button type="button" data-command="italic"><i class="fas fa-italic"></i></button>
                                <button type="button" data-command="underline"><i class="fas fa-underline"></i></button>
                                <button type="button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                                <button type="button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                                <button type="button" data-command="createLink" id="create-link-btn-about-edit"><i class="fas fa-link"></i></button>
                                <input type="file" id="image-upload-input-about-edit" accept="image/*" class="hidden">
                                <button type="button" id="insert-image-btn-about-edit"><i class="fas fa-image"></i></button>
                            </div>
                            <div id="edit-about-directory-text" contenteditable="true" class="rich-text-editor-content border rounded-md p-3 min-h-[150px] outline-none">${aboutDirectoryText}</div>
                            <div class="pt-4 flex justify-end gap-3">
                                <button type="button" id="cancel-about-edit-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                                <button type="button" id="save-about-edit-btn" class="px-4 py-2 text-white rounded-md" style="background-color: var(--primary-color);">Save Changes</button>
                            </div>
                        </div>
                    </div>
                `;
                editAboutDirectoryModal.classList.remove('hidden');

                document.getElementById('cancel-about-edit-btn').addEventListener('click', () => editAboutDirectoryModal.classList.add('hidden'));
                document.getElementById('save-about-edit-btn').addEventListener('click', handleSaveAboutDirectoryContent);

                // Rich text editor event listeners for about directory edit modal
                editAboutDirectoryModal.querySelectorAll('.rich-text-editor-toolbar button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const command = e.currentTarget.dataset.command;
                        if (command === 'createLink') {
                            const url = prompt('Enter the URL:');
                            if (url) document.execCommand(command, false, url);
                        } else {
                            document.execCommand(command, false, null);
                        }
                    });
                });
				document.getElementById('insert-image-btn-about-edit').addEventListener('click', () => document.getElementById('image-upload-input-about-edit').click());
				document.getElementById('image-upload-input-about-edit').addEventListener('change', (e) => {
					const file = e.target.files[0];
					if (file) {
						// --- MODIFIED: Use the helper function ---
						const imagePath = `editorImages/${Date.now()}_${file.name}`; // Store editor images in a general folder
						uploadFileToStorage(file, imagePath).then(downloadURL => {
							const img = `<img src="${downloadURL}" style="max-width:100%; height:auto;">`;
							document.execCommand('insertHTML', false, img);
						}).catch(error => showToast("Failed to insert image.", "error"));
					}
				});
            };

            const handleSaveAboutDirectoryContent = async () => {
                const content = document.getElementById('edit-about-directory-text').innerHTML;
                try {
                    await setDoc(doc(db, "appContent", "aboutDirectory"), { content: content, updatedAt: serverTimestamp() }, { merge: true });
                    showToast("About Our Directory content updated!", "success");
                    editAboutDirectoryModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error saving about content:", error);
                    showToast("Failed to save content.", "error");
                }
            };


            // --- Ministers Page Logic ---

            const ministerCanvasRenderers = {}; // Store Three.js renderers to dispose later

            const fetchMinisters = () => {
                if (unsubscribeMinisters) unsubscribeMinisters();
                const ministersRef = collection(db, "ministers");
                unsubscribeMinisters = onSnapshot(ministersRef, (snapshot) => {
                    allMinisters = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMinistersPage();
                }, (error) => {
                    console.error("Error fetching ministers:", error);
                    showToast("Failed to load ministers.", "error");
                });
            };

            const renderMinistersPage = () => {
                // Dispose of previous renderers and clear container
                for (const id in ministerCanvasRenderers) {
                    ministerCanvasRenderers[id].dispose();
                    delete ministerCanvasRenderers[id];
                }
                ministersListContainer.innerHTML = '';
                
                if (allMinisters.length === 0) {
                    ministersListContainer.innerHTML = `<p class="col-span-full" style="color: var(--text-muted)">No ministers added yet.</p>`;
                    return;
                }

                allMinisters.forEach(minister => {
                    const card = createMinisterCard(minister);
                    ministersListContainer.appendChild(card);
                });
            };

            const createMinisterCard = (minister) => {
                const card = document.createElement('div');
                card.className = "p-4 rounded-xl shadow-md flex flex-col items-center text-center cursor-pointer";
                card.style.backgroundColor = 'var(--card-bg)';
                card.dataset.ministerId = minister.id;

                const canvasContainer = document.createElement('div');
                canvasContainer.className = 'minister-card-canvas-container mb-3';
                canvasContainer.id = `minister-canvas-${minister.id}`;
                card.appendChild(canvasContainer);

                card.innerHTML += `
                    <h3 class="text-lg font-bold">${minister.name}</h3>
                    <p class="text-sm info-item"><i class="fas fa-phone"></i> ${minister.phone || 'N/A'}</p>
                    <p class="text-sm info-item"><i class="fas fa-envelope"></i> ${minister.email || 'N/A'}</p>
                `;

                // Add event listener to the whole card to open the detail modal
                card.addEventListener('click', () => showMinisterDetailModal(minister.id));

                // Initialize Three.js scene for this minister
                // Use setTimeout to ensure the element is in the DOM for proper sizing
                setTimeout(() => initMinisterCanvas(minister.id, minister.profilePic), 0);

                return card;
            };

            const initMinisterCanvas = (ministerId, imageUrl) => {
                const container = document.getElementById(`minister-canvas-${ministerId}`);
                if (!container) {
                    console.warn(`Container for minister ${ministerId} not found.`);
                    return;
                }

                // Clear previous canvas if any
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }

                const scene = new THREE.Scene();
                // Add lights for subtle 3D effect
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
                scene.add(ambientLight);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.4);
                directionalLight.position.set(0, 0, 1).normalize(); // Light from front
                scene.add(directionalLight);

                const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                renderer.setSize(container.clientWidth, container.clientHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                container.appendChild(renderer.domElement);

                ministerCanvasRenderers[ministerId] = renderer;

                // Position camera to view the plane head-on
                camera.position.z = 1.5;
                // No rotation for a flat, non-animated view, but maintain perspective
                // camera.rotation.x = 0;
                // camera.rotation.y = 0;

                const textureLoader = new THREE.TextureLoader();
                
                if (imageUrl) {
                    textureLoader.load(
                        imageUrl,
                        (loadedTexture) => {
                            const material = new THREE.MeshBasicMaterial({ map: loadedTexture });
				// Ensure container has valid dimensions before creating geometry
                let planeWidth = 2; // Default width
                let planeHeight = 2; // Default height

                if (container.clientWidth > 0 && container.clientHeight > 0) {
                    const aspectRatio = container.clientWidth / container.clientHeight;
                    // Adjust plane dimensions to fill the canvas, giving a slight overflow if needed
                    // This ensures the image covers the entire plane within the container
                    if (aspectRatio >= 1) { // Wider or square
                        planeWidth = 2.2; // Slightly larger than 2 to ensure full coverage
                        planeHeight = 2.2 / aspectRatio;
                    } else { // Taller
                        planeHeight = 2.2;
                        planeWidth = 2.2 * aspectRatio;
                    }
                }

                const geometry = new THREE.PlaneGeometry(planeWidth, planeHeight);
                            const mesh = new THREE.Mesh(geometry, material);
                            scene.add(mesh);
                            renderer.render(scene, camera); // Render after texture is loaded
                        },
                        undefined, // onProgress callback
                        (error) => {
                            console.error('Error loading texture for minister:', ministerId, error);
                            // Fallback to a plain color if image fails
                            const material = new THREE.MeshBasicMaterial({ color: 0x9ca3af });
                            const geometry = new THREE.PlaneGeometry(2, 2);
                            const mesh = new THREE.Mesh(geometry, material);
                            scene.add(mesh);
                            renderer.render(scene, camera); // Render fallback
                        }
                    );
                } else {
                    // No image provided, use a placeholder color
                    const material = new THREE.MeshBasicMaterial({ color: 0x9ca3af });
                    const geometry = new THREE.PlaneGeometry(2, 2);
                    const mesh = new THREE.Mesh(geometry, material);
                    scene.add(mesh);
                    renderer.render(scene, camera); // Initial render for placeholder
                }

                // Handle resize
                const onWindowResize = () => {
                    if (!container.parentElement) return; // If container is no longer in DOM
                    const newWidth = container.clientWidth;
                    const newHeight = container.clientHeight;
                    camera.aspect = newWidth / newHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(newWidth, newHeight);
                    renderer.render(scene, camera); // Re-render after resize
                };
                window.addEventListener('resize', onWindowResize);
            };


            // --- Add Minister Modal ---
            const setupAddMinisterModal = () => {
                addMinisterModal.innerHTML = `
                    <div class="p-5 rounded-lg shadow-xl w-full max-w-2xl" style="background-color: var(--card-bg);">
                        <div class="modal-body">
                            <h3 class="text-lg text-center font-medium mb-4">Add New Minister</h3>
                            <form id="add-minister-form" class="space-y-4">
                                <div class="form-section">
                                    <h4 class="form-section-title">Minister Details</h4>
                                    <div>
                                        <label for="add-minister-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                                        <input type="text" id="add-minister-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label for="add-minister-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                                        <input type="tel" id="add-minister-phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label for="add-minister-email" class="block text-sm font-medium text-gray-700">Email</label>
                                        <input type="email" id="add-minister-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label for="add-minister-profilePic" class="block text-sm font-medium text-gray-700">Profile Picture</label>
                                        <input type="file" id="add-minister-profilePic" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                                    </div>
                                </div>
                                <div class="form-section">
                                    <h4 class="form-section-title">About Me</h4>
                                    <div class="rich-text-editor-toolbar">
                                        <button type="button" data-command="bold"><i class="fas fa-bold"></i></button>
                                        <button type="button" data-command="italic"><i class="fas fa-italic"></i></button>
                                        <button type="button" data-command="underline"><i class="fas fa-underline"></i></button>
                                        <button type="button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                                        <button type="button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                                        <button type="button" data-command="createLink" id="create-link-btn"><i class="fas fa-link"></i></button>
                                        <input type="file" id="image-upload-input" accept="image/*" class="hidden">
                                        <button type="button" id="insert-image-btn"><i class="fas fa-image"></i></button>
                                    </div>
                                    <div id="add-minister-about" contenteditable="true" class="rich-text-editor-content border rounded-md p-3 min-h-[150px] outline-none"></div>
                                </div>
                                <div class="pt-4 flex justify-end gap-3">
                                    <button type="button" id="cancel-add-minister-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                                    <button type="submit" class="px-4 py-2 text-white rounded-md" style="background-color: var(--primary-color);">Save Minister</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                addMinisterModal.classList.remove('hidden');

                document.getElementById('cancel-add-minister-btn').addEventListener('click', () => addMinisterModal.classList.add('hidden'));
                document.getElementById('add-minister-form').addEventListener('submit', handleAddMinister);

                // Rich text editor event listeners
                addMinisterModal.querySelectorAll('.rich-text-editor-toolbar button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault(); // Prevent default button behavior
                        const command = e.currentTarget.dataset.command;
                        if (command === 'createLink') {
                            const url = prompt('Enter the URL:');
                            if (url) document.execCommand(command, false, url);
                        } else if (command === 'insertImage') {
                            // Handled by specific button
                        } else {
                            document.execCommand(command, false, null);
                        }
                    });
                });
				const uploadBtn = document.getElementById('insert-image-btn');
				const fileInput = document.getElementById('image-upload-input');

				uploadBtn.addEventListener('click', () => fileInput.click());
				fileInput.addEventListener('change', async (e) => {
					const file = e.target.files[0];
					if (!file) return;
					try {
						showToast("Uploading image...", "info");
						// --- MODIFIED: Use the helper function ---
						const imagePath = `editorImages/${Date.now()}_${file.name}`;
						const downloadURL = await uploadFileToStorage(file, imagePath);

						const imgHTML = `<img src="${downloadURL}" style="max-width:100%; height:auto;">`;
						document.execCommand('insertHTML', false, imgHTML);
					} catch (err) {
						console.error("Image upload/insert failed:", err);
						showToast("Failed to upload and insert image.", "error");
					} finally {
						e.target.value = '';
					}
				});
            };

            const handleAddMinister = async (e) => {
                e.preventDefault();
                const name = document.getElementById('add-minister-name').value;
                const phone = document.getElementById('add-minister-phone').value;
                const email = document.getElementById('add-minister-email').value;
                const about = document.getElementById('add-minister-about').innerHTML;
				const profilePicFile = document.getElementById('add-minister-profilePic').files[0];
				let profilePicUrl = null;
				if (profilePicFile) {
				  // 1) Upload to Firebase Storage
				  const storage = getStorage();
				  const picRef  = storageRef(storage, `ministerProfilePics/${Date.now()}_${profilePicFile.name}`);
			  
				  await uploadBytes(picRef, profilePicFile);

				  // 2) Get public URL
				  profilePicUrl = await getDownloadURL(picRef);
				}

                const ministerData = {
                    name,
                    phone,
                    email,
                    about,
                    profilePic: profilePicUrl,
                    createdAt: serverTimestamp()
                };

                try {
                    await addDoc(collection(db, "ministers"), ministerData);
                    showToast("Minister added successfully!", "success");
                    addMinisterModal.classList.add('hidden');
                    document.getElementById('add-minister-form').reset();
                    document.getElementById('add-minister-about').innerHTML = ''; // Clear rich text editor
                } catch (error) {
                    console.error("Error adding minister:", error);
                    showToast("Failed to add minister.", "error");
                }
            };

            // --- Minister Detail Popup Modal ---
			const showMinisterDetailModal = (ministerId) => {
                const minister = allMinisters.find(m => m.id === ministerId);
                if (!minister) {
                    showToast("Minister not found.", "error");
                    return;
                }

                const editorControls = `
                    <div class="editor-only-section mt-4 flex gap-2">
                        <button id="edit-minister-btn" data-id="${minister.id}" class="btn-primary text-sm px-4 py-2 rounded-md">Edit Minister</button>
                        <button id="delete-minister-btn" data-id="${minister.id}" class="bg-red-500 text-white text-sm px-4 py-2 rounded-md">Delete Minister</button>
                    </div>
                `;

                ministerDetailModal.innerHTML = `
                    <div id="minister-detail-modal-content" class="relative p-5 rounded-lg shadow-xl w-full max-w-xl" style="background-color: var(--card-bg);">
                        
                        <button id="close-minister-modal-x" class="absolute top-2 right-4 text-2xl text-gray-500 hover:text-gray-800 z-20">&times;</button>
                        
                        <div class="minister-modal-profile-header flex flex-col items-center pb-4 mb-4">
                            ${ minister.profilePic ? `<img src="${minister.profilePic}" alt="${minister.name}" class="minister-modal-profile-pic">` : `<div class="minister-modal-profile-placeholder"><i class="fas fa-user"></i></div>` }
                            <h3 class="text-2xl font-bold mt-2">${minister.name}</h3>
                            ${currentUser && currentUser.role === 'editor' ? editorControls : ''}
                        </div>
                        <div id="minister-detail-modal-body" class="flex-grow space-y-4">
                            <div>
                                <h4 class="font-semibold text-lg mb-2">About Me:</h4>
                                <div class="prose max-w-none" style="color: var(--text-color);">
                                    ${minister.about || '<p style="color: var(--text-muted);">No information provided.</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                ministerDetailModal.classList.remove('hidden');

                // This ensures the controls are hidden if edit mode is off when the modal is opened
                if (!isEditModeActive) {
                    ministerDetailModal.querySelectorAll('.editor-only-section').forEach(el => el.classList.add('hidden'));
                }


                document.getElementById('close-minister-modal-x').addEventListener('click', () => ministerDetailModal.classList.add('hidden'));

                if (currentUser && currentUser.role === 'editor') {
                    const editBtn = document.getElementById('edit-minister-btn');
                    const deleteBtn = document.getElementById('delete-minister-btn');
                    if (editBtn) editBtn.addEventListener('click', () => openEditMinisterModal(minister.id));
                    if (deleteBtn) deleteBtn.addEventListener('click', () => deleteMinister(minister.id, minister.name));
                }
            };

            const openEditMinisterModal = (ministerId) => {
                const minister = allMinisters.find(m => m.id === ministerId);
                if (!minister) {
                    showToast("Minister not found for editing.", "error");
                    return;
                }

                addMinisterModal.innerHTML = `
                    <div class="p-5 rounded-lg shadow-xl w-full max-w-2xl" style="background-color: var(--card-bg);">
                        <div class="modal-body">
                            <h3 class="text-lg text-center font-medium mb-4">Edit Minister</h3>
                            <form id="edit-minister-form" class="space-y-4">
                                <input type="hidden" id="edit-minister-id" value="${minister.id}">
                                <div class="form-section">
                                    <h4 class="form-section-title">Minister Details</h4>
                                    <div>
                                        <label for="edit-minister-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                                        <input type="text" id="edit-minister-name" value="${minister.name}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label for="edit-minister-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                                        <input type="tel" id="edit-minister-phone" value="${minister.phone || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label for="edit-minister-email" class="block text-sm font-medium text-gray-700">Email</label>
                                        <input type="email" id="edit-minister-email" value="${minister.email || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label for="edit-minister-profilePic" class="block text-sm font-medium text-gray-700">Profile Picture</label>
                                        <input type="file" id="edit-minister-profilePic" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                                        ${minister.profilePic ? `<img src="${minister.profilePic}" class="mt-2 w-20 h-20 object-cover rounded-full" alt="Current Profile Pic">` : ''}
                                    </div>
                                </div>
                                <div class="form-section">
                                    <h4 class="form-section-title">About Me</h4>
                                    <div class="rich-text-editor-toolbar">
                                        <button type="button" data-command="bold"><i class="fas fa-bold"></i></button>
                                        <button type="button" data-command="italic"><i class="fas fa-italic"></i></button>
                                        <button type="button" data-command="underline"><i class="fas fa-underline"></i></button>
                                        <button type="button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                                        <button type="button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                                        <button type="button" data-command="createLink" id="create-link-btn-edit"><i class="fas fa-link"></i></button>
                                        <input type="file" id="image-upload-input-edit" accept="image/*" class="hidden">
                                        <button type="button" id="insert-image-btn-edit"><i class="fas fa-image"></i></button>
                                    </div>
                                    <div id="edit-minister-about" contenteditable="true" class="rich-text-editor-content border rounded-md p-3 min-h-[150px] outline-none">${minister.about || ''}</div>
                                </div>
                                <div class="pt-4 flex justify-end gap-3">
                                    <button type="button" id="cancel-edit-minister-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                                    <button type="submit" class="px-4 py-2 text-white rounded-md" style="background-color: var(--primary-color);">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                addMinisterModal.classList.remove('hidden');
                ministerDetailModal.classList.add('hidden'); // Close detail modal if open

                document.getElementById('cancel-edit-minister-btn').addEventListener('click', () => addMinisterModal.classList.add('hidden'));
                document.getElementById('edit-minister-form').addEventListener('submit', handleEditMinister);

                // Rich text editor event listeners for edit modal
                addMinisterModal.querySelectorAll('.rich-text-editor-toolbar button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const command = e.currentTarget.dataset.command;
                        if (command === 'createLink') {
                            const url = prompt('Enter the URL:');
                            if (url) document.execCommand(command, false, url);
                        } else {
                            document.execCommand(command, false, null);
                        }
                    });
                });
				document.getElementById('insert-image-btn-edit').addEventListener('click', () => document.getElementById('image-upload-input-edit').click());
				document.getElementById('image-upload-input-edit').addEventListener('change', (e) => {
					const file = e.target.files[0];
					if (file) {
						// --- MODIFIED: Use the helper function ---
						const imagePath = `editorImages/${Date.now()}_${file.name}`;
						uploadFileToStorage(file, imagePath).then(downloadURL => {
							const img = `<img src="${downloadURL}" style="max-width:100%; height:auto;">`;
							document.execCommand('insertHTML', false, img);
						}).catch(error => showToast("Failed to insert image.", "error"));
					}
				});
            };

            const handleEditMinister = async (e) => {
                e.preventDefault();
                const ministerId = document.getElementById('edit-minister-id').value;
                const name = document.getElementById('edit-minister-name').value;
                const phone = document.getElementById('edit-minister-phone').value;
                const email = document.getElementById('edit-minister-email').value;
                const about = document.getElementById('edit-minister-about').innerHTML;
                const profilePicFile = document.getElementById('edit-minister-profilePic').files[0];

                if (!name) {
                    showToast("Minister name is required.", "error");
                    return;
                }

                let profilePicUrl = allMinisters.find(m => m.id === ministerId)?.profilePic || null; // Preserve existing URL

                // --- START DEBUGGING LOGS ---
                console.log("DEBUG: handleEditMinister triggered.");
                console.log("DEBUG: Current User UID (from app):", currentUser?.uid);
                console.log("DEBUG: Current User Role (from app):", currentUser?.role);

                try {
                    const debugProfileRef = doc(db, "userProfiles", currentUser.uid);
                    const debugProfileSnap = await getDoc(debugProfileRef);
                    if (debugProfileSnap.exists()) {
                        console.log("DEBUG: User Profile Document (from Firestore):", debugProfileSnap.data());
                        console.log("DEBUG: Role from Firestore User Profile:", debugProfileSnap.data().role);
                    } else {
                        console.log("DEBUG: User Profile Document NOT FOUND for UID:", currentUser?.uid);
                    }
                } catch (debugErr) {
                    console.error("DEBUG: Error fetching user profile during debug:", debugErr);
                }
                // --- END DEBUGGING LOGS ---

                if (profilePicFile) {
                    const picPath = `ministerProfilePics/${Date.now()}_${profilePicFile.name}`;
                    profilePicUrl = await uploadFileToStorage(profilePicFile, picPath);
                }

                const updatedData = {
                    name,
                    phone,
                    email,
                    about,
                    profilePic: profilePicUrl,
                    updatedAt: serverTimestamp()
                };

                try {
                    await updateDoc(doc(db, "ministers", ministerId), updatedData);
                    showToast("Minister updated successfully!", "success");
                    addMinisterModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error updating minister:", error);
                    showToast("Failed to update minister.", "error");
                }
            };

            const deleteMinister = (ministerId, ministerName) => {
                showConfirmModal(`Are you sure you want to delete ${ministerName}? This cannot be undone.`, async () => {
                    try {
                        await deleteDoc(doc(db, "ministers", ministerId));
                        showToast("Minister deleted successfully!", "success");
                        ministerDetailModal.classList.add('hidden');
                    } catch (error) {
                        console.error("Error deleting minister:", error);
                        showToast("Failed to delete minister.", "error");
                    }
                });
            };

			// --- Event Management Logic ---
            const addEventBtn = document.getElementById('add-event-btn'); // Get UI element
            const addEditEventModal = document.getElementById('add-edit-event-modal'); // Get UI element

            const fetchEvents = () => {
                if (unsubscribeEvents) unsubscribeEvents();
                const eventsRef = collection(db, "events");
                unsubscribeEvents = onSnapshot(query(eventsRef, orderBy("date", "asc")), (snapshot) => {
                    allEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // NEW: Calculate unseen events for notification badge
                    const eventsNotificationBadge = document.getElementById('events-notification-badge');
                    if (currentUser && eventsNotificationBadge) { // Ensure user is logged in and badge element exists
                        const notGoingCount = allEvents.filter(event => {
                            // An event is 'not going' if it has no attendees or if current user's UID is NOT in attendees
                            return !event.attendees || !event.attendees.includes(currentUser.uid);
                        }).length;

                        if (notGoingCount > 0) {
                            eventsNotificationBadge.textContent = notGoingCount;
                            eventsNotificationBadge.classList.remove('hidden');
                        } else {
                            eventsNotificationBadge.classList.add('hidden');
                        }
                    }

                    renderEventsPage();
                }, (error) => {
                    console.error("Error fetching events:", error);
                    showToast("Failed to load events.", "error");
                });
            };

            const renderEventsPage = () => {
                const eventsListContainer = document.getElementById('events-list-container');
                eventsListContainer.innerHTML = ''; // Clear existing events

                if (allEvents.length === 0) {
                    eventsListContainer.innerHTML = `<p class="col-span-full" style="color: var(--text-muted)">No upcoming events.</p>`;
                    return;
                }

                allEvents.forEach(event => {
                    const eventCard = createEventCard(event);
                    eventsListContainer.appendChild(eventCard);
                });
            };

            const createEventCard = (event) => {
                const card = document.createElement('div');
                card.className = "p-4 rounded-xl shadow-md flex flex-col";
                card.style.backgroundColor = 'var(--card-bg)';
                card.dataset.eventId = event.id;

                let eventImageHtml = '';
                if (event.imageUrl) {
                    eventImageHtml = `<img src="${event.imageUrl}" class="w-full h-32 object-cover rounded-md mb-3" onerror="this.onerror=null;this.src='https://placehold.co/300x150/cccccc/333333?text=Event';">`;
                }

                const eventDate = event.date ? new Date(event.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
                const eventTime = event.time || 'N/A';
                const eventLocation = event.location || 'N/A';

                const rsvpCount = event.attendees ? event.attendees.length : 0;
                const hasRsvpd = currentUser && event.attendees && event.attendees.includes(currentUser.uid);
                const rsvpButtonClass = hasRsvpd ? 'bg-green-600' : 'btn-primary';
                const rsvpButtonText = hasRsvpd ? '<i class="fas fa-check"></i> You\'re Going' : 'Going';

                // Determine if editor controls should be present at all based on user role
                const canSeeEditorControls = currentUser && (currentUser.role === 'editor' || currentUser.role === 'minister');

                // Determine initial visibility based on `isEditModeActive`
                const initialEditorControlsVisibilityClass = (canSeeEditorControls && isEditModeActive) ? '' : 'hidden'; // FIX HERE

                const editorControls = `
                    <div class="editor-only-section mt-2 pt-2 border-t border-gray-200 flex items-center justify-end gap-2 ${initialEditorControlsVisibilityClass}">
                        <button data-id="${event.id}" class="edit-event-btn text-xs font-medium text-indigo-600 hover:text-indigo-800">Edit</button>
                        <button data-id="${event.id}" class="delete-event-btn text-xs font-medium text-red-600 hover:text-red-800">Delete</button>
                    </div>
                `;

                card.innerHTML = `
                    ${eventImageHtml}
                    <h3 class="text-lg font-bold mb-1">${event.title}</h3>
                    <p class="text-sm text-gray-700 mb-2 flex-grow">${event.description || ''}</p>
                    <p class="text-xs text-gray-500 info-item"><i class="fas fa-calendar-alt"></i> ${eventDate} at ${eventTime}</p>
                    <p class="text-xs text-gray-500 info-item"><i class="fas fa-map-marker-alt"></i> ${eventLocation}</p>

                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-semibold text-gray-700">${rsvpCount} going</span>
                            <div class="flex gap-2">
                                <button data-id="${event.id}" class="add-to-calendar-btn text-xs font-medium text-gray-600 hover:text-indigo-800 p-2 rounded-md bg-gray-200"><i class="fas fa-calendar-plus"></i></button>
                                <button data-id="${event.id}" class="rsvp-btn text-xs font-medium text-white px-3 py-2 rounded-md ${rsvpButtonClass}">${rsvpButtonText}</button>
                            </div>
                        </div>
                    </div>

                    ${canSeeEditorControls ? editorControls : ''}
                `;

                // Add event listeners for new and existing buttons
                card.querySelector('.rsvp-btn')?.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent modal from opening
                    handleRsvpClick(event.id);
                });
                card.querySelector('.add-to-calendar-btn')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleAddToCalendar(event);
                });

                if (canSeeEditorControls) { // Only attach listeners if controls are potentially visible
                    card.querySelector('.edit-event-btn')?.addEventListener('click', () => openAddEditEventModal(event));
                    card.querySelector('.delete-event-btn')?.addEventListener('click', () => deleteEvent(event.id, event.title));
                }

                return card;
            };

            const openAddEditEventModal = (event = null) => {
                const isEditing = event !== null;
                addEditEventModal.innerHTML = `
                    <div class="p-5 rounded-lg shadow-xl w-full max-w-2xl" style="background-color: var(--card-bg);">
                        <div class="modal-body">
                            <h3 class="text-lg text-center font-medium mb-4">${isEditing ? 'Edit Event' : 'Add New Event'}</h3>
                            <form id="add-edit-event-form" class="space-y-4">
                                <input type="hidden" id="event-id" value="${event ? event.id : ''}">
                                <div class="form-section">
                                    <h4 class="form-section-title">Event Details</h4>
                                    <div>
                                        <label for="event-title" class="block text-sm font-medium text-gray-700">Title</label>
                                        <input type="text" id="event-title" value="${event ? event.title : ''}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                        <div>
                                            <label for="event-date" class="block text-sm font-medium text-gray-700">Date</label>
                                            <input type="date" id="event-date" value="${event ? event.date : ''}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div>
                                            <label for="event-time" class="block text-sm font-medium text-gray-700">Time</label>
                                            <input type="time" id="event-time" value="${event ? event.time : ''}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                    </div>
                                    <div>
                                        <label for="event-location" class="block text-sm font-medium text-gray-700">Location</label>
                                        <input type="text" id="event-location" value="${event ? event.location : ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="e.g., Church Auditorium, 123 Main St">
                                    </div>
                                    <div>
                                        <label for="event-image-url" class="block text-sm font-medium text-gray-700">Image URL (Optional)</label>
                                        <input type="url" id="event-image-url" value="${event ? event.imageUrl : ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Direct URL to an image">
                                    </div>
                                </div>
                                <div class="form-section">
                                    <h4 class="form-section-title">Description</h4>
                                    <div class="rich-text-editor-toolbar">
                                        <button type="button" data-command="bold"><i class="fas fa-bold"></i></button>
                                        <button type="button" data-command="italic"><i class="fas fa-italic"></i></button>
                                        <button type="button" data-command="underline"><i class="fas fa-underline"></i></button>
                                        <button type="button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                                        <button type="button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                                        <button type="button" data-command="createLink" id="create-link-btn-event"><i class="fas fa-link"></i></button>
                                        <input type="file" id="image-upload-input-event" accept="image/*" class="hidden">
                                        <button type="button" id="insert-image-btn-event"><i class="fas fa-image"></i></button>
                                    </div>
                                    <div id="event-description" contenteditable="true" class="rich-text-editor-content border rounded-md p-3 min-h-[150px] outline-none">${event ? event.description : ''}</div>
                                </div>
                                <div class="pt-4 flex justify-end gap-3">
                                    <button type="button" id="cancel-event-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                                    <button type="submit" class="px-4 py-2 text-white rounded-md" style="background-color: var(--primary-color);">Save Event</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                addEditEventModal.classList.remove('hidden');

                document.getElementById('cancel-event-btn').addEventListener('click', () => addEditEventModal.classList.add('hidden'));
                document.getElementById('add-edit-event-form').addEventListener('submit', handleAddEditEvent);

                // Rich text editor event listeners
                addEditEventModal.querySelectorAll('.rich-text-editor-toolbar button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const command = e.currentTarget.dataset.command;
                        if (command === 'createLink') {
                            const url = prompt('Enter the URL:');
                            if (url) document.execCommand(command, false, url);
                        } else {
                            document.execCommand(command, false, null);
                        }
                    });
                });
                document.getElementById('insert-image-btn-event').addEventListener('click', () => document.getElementById('image-upload-input-event').click());
                document.getElementById('image-upload-input-event').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        toBase64(file).then(base64 => {
                            const img = `<img src="${base64}" style="max-width:100%; height:auto;">`;
                            document.execCommand('insertHTML', false, img);
                        }).catch(error => showToast("Failed to insert image.", "error"));
                    }
                });
            };

            const handleAddEditEvent = async (e) => {
                e.preventDefault();
                const eventId = document.getElementById('event-id').value;
                const title = document.getElementById('event-title').value;
                const date = document.getElementById('event-date').value;
                const time = document.getElementById('event-time').value;
                const location = document.getElementById('event-location').value;
                const imageUrl = document.getElementById('event-image-url').value;
                const description = document.getElementById('event-description').innerHTML;

                if (!title.trim() || !date.trim() || !time.trim()) {
                    showToast("Event title, date, and time are required.", "error");
                    return;
                }

                const eventData = {
                    title,
                    date,
                    time,
                    location,
                    imageUrl,
                    description,
                };

                try {
                    if (eventId) {
                        // Editing existing event
                        await updateDoc(doc(db, "events", eventId), { ...eventData, updatedAt: serverTimestamp() });
                        showToast("Event updated successfully!", "success");
                    } else {
                        // Adding new event
                        await addDoc(collection(db, "events"), { ...eventData, createdAt: serverTimestamp(), createdBy: currentUser.name });
                        showToast("Event added successfully!", "success");
                    }
                    addEditEventModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error saving event:", error);
                    showToast("Failed to save event.", "error");
                }
            };

            const deleteEvent = (eventId, eventTitle) => {
                showConfirmModal(`Are you sure you want to delete the event "${eventTitle}"? This cannot be undone.`, async () => {
                    try {
                        await deleteDoc(doc(db, "events", eventId));
                        showToast("Event deleted successfully!", "success");
                    } catch (error) {
                        console.error("Error deleting event:", error);
                        showToast("Failed to delete event.", "error");
                    }
                });
            };

			// --- User Role Management Logic (Admin Panel) ---
            const userManagementNavBtn = document.getElementById('user-management-nav-btn'); // Get UI element
            const userListContainer = document.getElementById('user-list-container'); // Get UI element
            const editUserRoleModal = document.getElementById('edit-user-role-modal'); // Get UI element

            const fetchAppUsers = () => {
                if (unsubscribeAppUsers) unsubscribeAppUsers();
                const usersRef = collection(db, "userProfiles"); // Assuming user profiles are stored here
                unsubscribeAppUsers = onSnapshot(usersRef, (snapshot) => {
                    allAppUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUserManagementPage();
                }, (error) => {
                    console.error("Error fetching app users:", error);
                    showToast("Failed to load user list.", "error");
                });
            };

			/**
			 * Renders the User Management page with updated department cards and role assignments.
			 */
			const renderUserManagementPage = () => {
				const container = document.getElementById('department-cards-container');
				if (!container) return;

				if (!allAppUsers || allAppUsers.length === 0) {
					container.innerHTML = '<p class="col-span-full text-gray-500">Loading user data...</p>';
					return;
				}

				container.innerHTML = ''; // Clear previous content

				departments.forEach(dept => {
					const card = document.createElement('div');
					card.className = "p-4 rounded-xl shadow-lg bg-slate-100 flex flex-col space-y-4";

					let rolesHTML = '';

					// --- SPECIAL HANDLING for "Auditor" and "Minister" departments ---
					if (dept.id === 'auditor' || dept.id === 'minister') {
						const roleInProfile = (dept.id === 'auditor') ? 'Auditor' : 'Minister'; // The specific role string in user.role

						// Filter users whose PRIMARY role (user.role) matches this specific role
						const assignedUsers = allAppUsers.filter(user => user.role === roleInProfile);
						assignedUsers.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

						let userListHTML = '';
						if (assignedUsers.length > 0) {
							userListHTML = assignedUsers.map(user => `
								<div class="flex items-center justify-between mt-1 pt-2 border-t border-slate-200">
									<div class="flex items-center gap-2">
										<img src="${user.profilePic || 'https://placehold.co/40x40/cccccc/333333?text=?'}" class="w-8 h-8 rounded-full object-cover">
										<span class="text-sm font-medium text-slate-700">${user.name || 'Unnamed User'}</span>
									</div>
									<button data-action="unassign-primary" data-user-id="${user.id}" data-role="${roleInProfile}" class="text-xs text-red-500 hover:text-red-700">Remove</button>
								</div>
							`).join('');
						} else {
							userListHTML = `<p class="text-xs text-slate-400 mt-1 italic">No users assigned.</p>`;
						}

						// For Auditor/Minister, the card directly lists users assigned to that primary role
						rolesHTML = `
							<div class="p-2 bg-white rounded-lg">
								<div class="flex items-center justify-between">
									<p class="text-sm font-bold text-slate-800">${roleInProfile}s</p> <button data-action="assign-primary" data-role="${roleInProfile}" data-department="${dept.id}" class="btn-primary text-white text-xs py-1 px-3 rounded-md">Assign</button>
								</div>
								${userListHTML}
							</div>`;

					} else { // --- EXISTING HANDLING for other departments (Church, Nubu, Mino, etc.) ---
							 // These will still have Treasurer and Secretary sub-roles
						assignableRoles.forEach(role => {
							const assignedUsers = allAppUsers.filter(user => {
								const assignments = user.assignments || {};
								const baseDept = dept.id;
								return assignments[baseDept] === role;
							});

							assignedUsers.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

							let userListHTML = '';
							if (assignedUsers.length > 0) {
								userListHTML = assignedUsers.map(user => {
									return `
										<div class="flex items-center justify-between mt-1 pt-2 border-t border-slate-200">
											<div class="flex items-center gap-2">
												<img src="${user.profilePic || 'https://placehold.co/40x40/cccccc/333333?text=?'}" class="w-8 h-8 rounded-full object-cover">
												<span class="text-sm font-medium text-slate-700">${user.name || 'Unnamed User'}</span>
											</div>
											<button data-action="unassign" data-user-id="${user.id}" data-role="${role}" data-department="${dept.id}" class="text-xs text-red-500 hover:text-red-700">Remove</button>
										</div>
									`
								}).join('');
							} else {
								userListHTML = `<p class="text-xs text-slate-400 mt-1 italic">No users assigned.</p>`;
							}

							rolesHTML += `
								<div class="p-2 bg-white rounded-lg">
									<div class="flex items-center justify-between">
										<p class="text-sm font-bold text-slate-800">${role}</p>
										<button data-action="assign" data-role="${role}" data-department="${dept.id}" class="btn-primary text-white text-xs py-1 px-3 rounded-md">Assign</button>
									</div>
									${userListHTML}
								</div>`;
						});
					} // End else for other departments

					card.innerHTML = `
						<h3 class="text-lg font-bold text-slate-900 border-b border-slate-200 pb-2">${dept.name}</h3>
						<div class="space-y-3">${rolesHTML}</div>
					`;

					container.appendChild(card);
				});

				// Add event listeners to all the new buttons
				container.querySelectorAll('button[data-action="assign"]').forEach(btn => {
					btn.addEventListener('click', () => {
						const { role, department } = btn.dataset;
						showAssignUserModal(role, department);
					});
				});
				container.querySelectorAll('button[data-action="unassign"]').forEach(btn => {
					btn.addEventListener('click', () => {
						const { userId, role, department } = btn.dataset;
						handleUnassignUser(userId, role, department);
					});
				});

				// Event listeners for primary role assign/unassign buttons (Auditor, Minister)
				container.querySelectorAll('button[data-action="assign-primary"]').forEach(btn => {
					btn.addEventListener('click', () => {
						const { role, department } = btn.dataset;
						showAssignUserModal(role, department, true); // Pass true for primary role assignment
					});
				});
				container.querySelectorAll('button[data-action="unassign-primary"]').forEach(btn => {
					btn.addEventListener('click', () => {
						const { userId, role } = btn.dataset; // Removed department, as it's a primary role
						handleUnassignPrimaryRole(userId, role);
					});
				});
			};

			/**
			 * Opens a modal to select a user for a specific role and department.
			 * @param {string} role - The role to assign (e.g., 'Treasurer', 'Auditor', 'Minister').
			 * @param {string} departmentId - The department ID (e.g., 'church', 'auditor').
			 * @param {boolean} isPrimaryRoleAssignment - True if assigning a primary role (Auditor, Minister).
			 */
			const showAssignUserModal = (role, departmentId, isPrimaryRoleAssignment = false) => {
				const modal = document.getElementById('create-edit-vote-modal');
				const departmentName = departments.find(d => d.id === departmentId)?.name || departmentId;

				// Filter the list of users to exclude those already assigned
				const availableUsers = allAppUsers.filter(user => {
					if (isPrimaryRoleAssignment) {
						// If assigning a primary role, filter out users who already have this specific primary role
						return user.role !== role; 
					} else {
						// If assigning a departmental role, check assignments map
						const assignments = user.assignments || {};
						const baseDept = departmentId; // departmentId is already the base dept here
						return assignments[baseDept] !== role;
					}
				});

				if (availableUsers.length === 0) {
					showToast("No available users to assign to this role.", "info");
					return;
				}

				const userOptionsHTML = availableUsers
					.sort((a, b) => (a.name || '').localeCompare(b.name || ''))
					.map(user => `<option value="${user.id}">${user.name || 'Unnamed User'}</option>`).join('');

				modal.innerHTML = `
					<div class="p-6 rounded-lg shadow-xl max-w-lg w-full mx-auto my-8" style="background-color: var(--card-bg);">
						<form id="assign-user-form">
							<h2 class="text-xl font-semibold mb-2">Assign User</h2>
							<p class="text-sm mb-4" style="color: var(--text-muted);">Assigning a user to the role of <strong>${role}</strong> for the <strong>${departmentName}</strong> department.</p>

							<div>
								<label for="assign-user-select" class="block text-sm font-medium">Select User</label>
								<select id="assign-user-select" class="mt-1 block w-full p-2 border-gray-300 rounded-md">
									${userOptionsHTML}
								</select>
							</div>

							<div class="flex justify-end gap-2 mt-6">
							   <button type="button" id="cancel-assign-btn" class="bg-gray-300 px-4 py-2 rounded-md text-gray-800">Cancel</button>
							   <button type="submit" class="btn-primary px-4 py-2 rounded-md text-white">Confirm Assignment</button>
							</div>
						</form>
					</div>`;

				modal.classList.remove("hidden");

				modal.querySelector('#cancel-assign-btn').addEventListener('click', () => modal.classList.add('hidden'));
				modal.querySelector('#assign-user-form').addEventListener('submit', (e) => {
					e.preventDefault();
					const selectedUserId = document.getElementById('assign-user-select').value;
					if (isPrimaryRoleAssignment) {
						handleAssignPrimaryRole(selectedUserId, role);
					} else {
						handleAssignUser(selectedUserId, role, departmentId); // Pass departmentId
					}
					modal.classList.add('hidden');
				});
			};

			/**
			 * Assigns a user to a primary role (Auditor, Minister, Editor, etc.) by updating their 'role' field.
			 * @param {string} userId - The UID of the user to assign.
			 * @param {string} role - The primary role to assign ('Auditor', 'Minister', 'editor').
			 */
			const handleAssignPrimaryRole = async (userId, role) => {
				if (!userId) return;
				const userProfileRef = doc(db, "userProfiles", userId);

				try {
					await runTransaction(db, async (transaction) => {
						const userDoc = await transaction.get(userProfileRef);
						if (!userDoc.exists()) {
							throw "User profile not found!";
						}

						const profileData = userDoc.data();
						const currentRole = profileData.role;

						// Define role hierarchy: higher number = higher priority
						const rolePriority = { 'user': 0, 'Secretary': 1, 'Treasurer': 2, 'Auditor': 3, 'Minister': 4, 'editor': 5 };

						// Prevent demotion or assigning a lower/equal role if user already has a higher one
						if (rolePriority[role] < rolePriority[currentRole]) {
							showToast(`${profileData.name} already has a higher role (${currentRole}) than ${role}. Cannot demote.`, "error");
							throw new Error("Cannot demote user via this assignment.");
						}

						// If they already have the exact same role, no update needed
						if (rolePriority[role] === rolePriority[currentRole] && currentRole === role) {
							showToast(`${profileData.name} is already assigned as ${role}.`, "info");
							return; // Exit transaction if no change needed
						}


						// Update the primary role
						transaction.update(userProfileRef, { role: role });
					});

					showToast("User assigned successfully!", "success");
				} catch (error) {
					console.error("Error assigning primary role:", error);
					showToast(`Failed to assign primary role: ${error.message || error}`, "error");
				}
			};
			
			/**
			 * Unassigns a primary role from a user and recalculates their next highest role.
			 * This specifically handles roles that are stored in the top-level 'role' field (Auditor, Minister, Editor).
			 * @param {string} userId - The UID of the user to unassign.
			 * @param {string} roleToUnassign - The primary role to remove ('Auditor', 'Minister', 'editor').
			 */
			const handleUnassignPrimaryRole = (userId, roleToUnassign) => {
				const user = allAppUsers.find(u => u.id === userId);
				if (!user) return;

				showConfirmModal(
					`Remove ${user.name} from ${roleToUnassign}?`,
					async () => {
						const userProfileRef = doc(db, "userProfiles", userId);
						try {
							await runTransaction(db, async (transaction) => {
								const userDoc = await transaction.get(userProfileRef);
								if (!userDoc.exists()) throw "User profile not found!";

								const profileData = userDoc.data();

								// Check if the user actually has this role as their primary role
								if (profileData.role !== roleToUnassign) {
									 showToast(`${user.name} is not currently assigned as ${roleToUnassign}.`, "info");
									 return; // Exit transaction if not assigned this role
								}

								// Editor role cannot be unassigned this way, must be handled via 'Edit User Role' modal
								if (roleToUnassign === 'editor') {
									 showToast("Editor role cannot be unassigned this way. Please use 'Edit User Role'.", "error");
									 throw new Error("Cannot unassign editor via primary role button.");
								}

								// Determine the new primary role based on remaining departmental assignments
								// and implicit default 'user'
								let newPrimaryRole = "user"; // Default if no other roles apply

								const assignmentsMap = profileData.assignments || {};
								const rolePriority = { 'user': 0, 'Secretary': 1, 'Treasurer': 2, 'Auditor': 3, 'Minister': 4, 'editor': 5 }; // Define hierarchy

								// Find the highest priority role from remaining departmental assignments
								// and other primary roles if they somehow existed before this unassign
								const currentDepartmentalRoles = Object.values(assignmentsMap);

								let highestPriorityRemaining = 'user'; // Start with lowest priority
								for (const pRole of ['Secretary', 'Treasurer']) { // Check departmental roles
									if (currentDepartmentalRoles.includes(pRole)) {
										if (rolePriority[pRole] > rolePriority[highestPriorityRemaining]) {
											highestPriorityRemaining = pRole;
										}
									}
								}

								// After unassigning the primary role, their new top-level role
								// should be derived from the highest remaining role (departmental or default 'user')
								newPrimaryRole = highestPriorityRemaining;


								// Commit the updated primary role
								transaction.update(userProfileRef, {
									role: newPrimaryRole
								});
							});

							showToast("User unassigned successfully!", "success");
						} catch (error) {
							console.error("Error unassigning primary role:", error);
							showToast(`Failed to unassign primary role: ${error.message || error}`, "error");
						}
					}
				);
			};

			/**
			 * Assigns a user to a departmental role (Treasurer, Secretary).
			 * @param {string} userId - The UID of the user.
			 * @param {string} role - The departmental role ('Treasurer', 'Secretary').
			 * @param {string} departmentId - The department ID (e.g., 'church').
			 */
			const handleAssignUser = async (userId, role, departmentId) => {
				if (!userId) return;
				const userProfileRef = doc(db, "userProfiles", userId);

				try {
					await runTransaction(db, async (transaction) => {
						const userDoc = await transaction.get(userProfileRef);
						if (!userDoc.exists()) {
							throw "User profile not found!";
						}

						const profileData = userDoc.data();
						const assignmentsMap = profileData.assignments || {};

						// Use departmentId directly as the key in assignmentsMap
						if (assignmentsMap[departmentId] !== role) {
							assignmentsMap[departmentId] = role;
						}

						// Update just the assignments map
						transaction.update(userProfileRef, {
							assignments: assignmentsMap
						});
					});

					showToast("User assigned successfully!", "success");
				} catch (error) {
					console.error("Error assigning user:", error);
					showToast(`Failed to assign user: ${error.message || error}`, "error");
				}
			};

			/**
			 * Removes a departmental role assignment (Treasurer, Secretary) from a user's profile.
			 * @param {string} userId - The UID of the user.
			 * @param {string} role - The departmental role to remove.
			 * @param {string} departmentId - The department ID (e.g., 'church').
			 */
			const handleUnassignUser = (userId, role, departmentId) => {
				const user = allAppUsers.find(u => u.id === userId);
				if (!user) return;

				showConfirmModal(
					`Remove ${user.name} from ${role} in ${departmentId}?`,
					async () => {
						const userProfileRef = doc(db, "userProfiles", userId);
						try {
							await runTransaction(db, async (transaction) => {
								const userDoc = await transaction.get(userProfileRef);
								if (!userDoc.exists()) throw "User profile not found!";

								const profileData = userDoc.data();
								const assignmentsMap = profileData.assignments || {};

								// Use departmentId directly as the key
								delete assignmentsMap[departmentId];

								// Recalculate new primary role (as before, based on remaining departmental assignments)
								let newPrimaryRole = "user";
								if (profileData.role === "editor") {
									newPrimaryRole = "editor";
								} else {
									const priority = ["Auditor", "Minister", "Treasurer", "Secretary"]; // Ensure new roles are in priority
									const remainingDeptRoles = new Set(Object.values(assignmentsMap)); // Only departmental roles here

									// Check if user's current primary role is higher than any remaining departmental roles
									// If user was Auditor/Minister, keep that unless explicitly unassigned via primary unassign
									if (profileData.role === 'Auditor' || profileData.role === 'Minister') {
										newPrimaryRole = profileData.role; // Maintain current primary role
									} else {
										// Find highest remaining departmental role
										for (const p of priority) {
											if (remainingDeptRoles.has(p)) {
												newPrimaryRole = p;
												break;
											}
										}
									}
								}

								transaction.update(userProfileRef, {
									assignments: assignmentsMap,
									role: newPrimaryRole
								});
							});

							showToast("User unassigned successfully!", "success");
						} catch (error) {
							console.error("Error unassigning user: ", error);
							showToast("Failed to unassign user.", "error");
						}
					}
				);
			};
			
// ===================================================================
// == END: USER ROLE & DEPARTMENT MANAGEMENT
// ===================================================================


            const createUserCard = (user) => {
                const card = document.createElement('div');
                card.className = "p-4 rounded-xl shadow-md flex flex-col items-center text-center";
                card.style.backgroundColor = 'var(--card-bg)';
                card.dataset.userId = user.id;

                const profilePicHtml = user.profilePic ? 
                    `<img src="${user.profilePic}" alt="${user.name}" class="w-16 h-16 object-cover rounded-full mb-2">` :
                    `<div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center mb-2"><i class="fas fa-user text-3xl text-gray-400"></i></div>`;

                card.innerHTML = `
                    ${profilePicHtml}
                    <h3 class="text-lg font-bold">${user.name || 'Unknown User'}</h3>
                    <p class="text-sm text-gray-500">Role: ${user.role || 'user'}</p>
                    <p class="text-xs text-gray-400 break-all">UID: ${user.id}</p>
                    <div class="mt-4 flex gap-2">
                        <button data-id="${user.id}" class="edit-user-role-btn btn-primary text-sm px-3 py-1 rounded-md">Edit Role</button>
                    </div>
                `;

                // Add event listener to edit role button
                card.querySelector('.edit-user-role-btn')?.addEventListener('click', () => openEditUserRoleModal(user));

                return card;
            };

            const openEditUserRoleModal = (user) => {
                editUserRoleModal.innerHTML = `
                    <div class="p-5 rounded-lg shadow-xl w-full max-w-md" style="background-color: var(--card-bg);">
                        <div class="modal-body">
                            <h3 class="text-lg text-center font-medium mb-4">Edit Role for ${user.name || 'Unknown User'}</h3>
                            <form id="edit-user-role-form" class="space-y-4">
                                <input type="hidden" id="edit-user-id" value="${user.id}">
                                <div>
                                    <label for="user-role" class="block text-sm font-medium text-gray-700">Select Role</label>
                                    <select id="user-role" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md">
                                        <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                                        <option value="minister" ${user.role === 'minister' ? 'selected' : ''}>Minister</option>
                                        <option value="editor" ${user.role === 'editor' ? 'selected' : ''}>Editor</option>
                                    </select>
                                </div>
                                <div class="pt-4 flex justify-end gap-3">
                                    <button type="button" id="cancel-edit-user-role-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                                    <button type="submit" class="px-4 py-2 text-white rounded-md" style="background-color: var(--primary-color);">Save Role</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                editUserRoleModal.classList.remove('hidden');

                document.getElementById('cancel-edit-user-role-btn').addEventListener('click', () => editUserRoleModal.classList.add('hidden'));
                document.getElementById('edit-user-role-form').addEventListener('submit', handleSaveUserRole);
            };

            const handleSaveUserRole = async (e) => {
                e.preventDefault();
                const userId = document.getElementById('edit-user-id').value;
                const newRole = document.getElementById('user-role').value;

                try {
                    // Update the user's role in the userProfiles collection
                    await setDoc(doc(db, "userProfiles", userId), { role: newRole }, { merge: true });

                    // IMPORTANT: To update Firebase Authentication custom claims,
                    // you would typically need a Firebase Cloud Function.
                    // This client-side update only changes the role in Firestore.
                    // For full security, ensure your backend Cloud Function updates custom claims.
                    // E.g., await callFirebaseFunctionToSetCustomClaim({ uid: userId, role: newRole });
                    
                    showToast(`Role for ${userId} updated to ${newRole}.`, "success");
                    editUserRoleModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error updating user role:", error);
                    showToast("Failed to update user role.", "error");
                }
            };
			
			// --- Edit My Profile Logic (for authenticated users) ---
            const editMyProfileNavBtn = document.getElementById('edit-my-profile-nav-btn'); // Get UI element
            const editMyProfileFormEl = document.getElementById('edit-my-profile-form'); // Get UI element

const renderEditMyProfilePage = async () => {
    if (!currentUser) {
        showToast("Please log in to edit your profile.", "error");
        switchPage('home');
        return;
    }

    const verifyIdentityForm = document.getElementById('verify-identity-form');
    const confirmCodeForm = document.getElementById('confirm-code-form');
    const editMyProfileFormSection = document.getElementById('edit-my-profile-section');
    const verifyIdentityError = document.getElementById('verify-identity-error');
    const confirmCodeError = document.getElementById('confirm-code-error');
    const resendCodeBtn = document.getElementById('resend-code-btn');
    const recaptchaContainer = document.getElementById('recaptcha-container'); // Get reCAPTCHA container

    // Reset UI state
    verifyIdentityForm.closest('div').classList.remove('hidden'); // Show step 1
    confirmCodeForm.closest('div').classList.add('hidden'); // Hide step 2
    editMyProfileFormSection.classList.add('hidden'); // Hide edit form
    verifyIdentityError.textContent = '';
    confirmCodeError.textContent = '';

    // Initialize reCAPTCHA Verifier
    // Ensure reCAPTCHA container is visible before rendering it
    recaptchaContainer.innerHTML = ''; // Clear previous reCAPTCHA instance
    recaptchaVerifier = new RecaptchaVerifier(auth, recaptchaContainer, {
        'size': 'invisible', // Use 'invisible' reCAPTCHA
        'callback': (response) => {
            // reCAPTCHA solved, proceed with sending code (handleSendVerificationCode)
            // This callback is triggered when reCAPTCHA is ready/solved.
            // It means a human is likely interacting with the page.
            console.log("DEBUG: reCAPTCHA solved.");
        },
        'expired-callback': () => {
            console.warn("DEBUG: reCAPTCHA expired, please re-verify.");
            // Optionally inform user to retry
        }
    });
    recaptchaVerifier.render().catch(error => console.error("Error rendering reCAPTCHA:", error));

    // Attach event listeners for the verification forms
    verifyIdentityForm.removeEventListener('submit', handleSendVerificationCode);
    verifyIdentityForm.addEventListener('submit', handleSendVerificationCode);

    confirmCodeForm.removeEventListener('submit', handleConfirmVerificationCode);
    confirmCodeForm.addEventListener('submit', handleConfirmVerificationCode);

    resendCodeBtn.removeEventListener('click', handleResendVerificationCode);
    resendCodeBtn.addEventListener('click', handleResendVerificationCode);

    // Initial population of the main edit form (will be hidden until verified)
    // Check if the user is already linked to a member record. If so, skip verification.
    const memberQuery = query(collection(db, "members"), where("uid", "==", currentUser.uid), where("isHead", "==", true));
    const memberSnap = await getDocs(memberQuery);
    if (!memberSnap.empty) {
        // User is already linked, bypass verification and show edit form directly
        currentVerificationUserId = memberSnap.docs[0].id; // Store member ID
        document.getElementById('profile-verification-step1').classList.add('hidden');
        document.getElementById('profile-verification-step2').classList.add('hidden');
        editMyProfileFormSection.classList.remove('hidden');
        generateEditProfileForm({ id: memberSnap.docs[0].id, ...memberSnap.docs[0].data() });
        showToast("Profile loaded for editing.", "info");
    } else {
         // User not linked, proceed with verification steps
         verifyIdentityError.textContent = "Please verify your identity to link your profile.";
         verifyIdentityError.classList.remove('hidden');
    }
};


/**
 * Helper to generate the content for the actual edit profile form.
 * @param {Object} memberToEdit - The member data to pre-fill the form.
 */
const generateEditProfileForm = (memberToEdit) => {
    const editMyProfileFormEl = document.getElementById('edit-my-profile-form');
    editMyProfileFormEl.innerHTML = `
        <input type="hidden" id="edit-my-profile-member-id" value="${memberToEdit.id}">
        <div class="form-section">
            <h3 class="form-section-title">Personal Info</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <div>
                    <label for="my-profile-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="my-profile-name" value="${memberToEdit.name}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="my-profile-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                    <input type="tel" id="my-profile-phone" value="${memberToEdit.phone || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="my-profile-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="my-profile-email" value="${memberToEdit.email || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="my-profile-dob" class="block text-sm font-medium text-gray-700">Birthday</label>
                    <input type="date" id="my-profile-dob" value="${memberToEdit.dob || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="my-profile-gender" class="block text-sm font-medium text-gray-700">Gender</label>
                    <select id="my-profile-gender" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md">
                        <option value="" ${!memberToEdit.gender ? 'selected' : ''}>Select...</option>
                        <option value="Male" ${memberToEdit.gender === 'Male' ? 'selected' : ''}>Male</option>
                        <option value="Female" ${memberToEdit.gender === 'Female' ? 'selected' : ''}>Female</option>
                    </select>
                </div>
                <div>
                    <label for="my-profile-marital-status" class="block text-sm font-medium text-gray-700">Marital Status</label>
                    <select id="my-profile-marital-status" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md">
                        <option value="Single" ${memberToEdit.maritalStatus === 'Single' ? 'selected' : ''}>Single</option>
                        <option value="Married" ${memberToEdit.maritalStatus === 'Married' ? 'selected' : ''}>Married</option>
                        <option value="Divorced" ${memberToEdit.maritalStatus === 'Divorced' ? 'selected' : ''}>Divorced</option>
                        <option value="Widowed" ${memberToEdit.maritalStatus === 'Widowed' ? 'selected' : ''}>Widowed</option>
                    </select>
                </div>
                <div class="flex items-center pt-6">
                    <input type="checkbox" id="my-profile-baptized" ${memberToEdit.baptized ? 'checked' : ''} class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                    <label for="my-profile-baptized" class="ml-2 block text-sm font-medium text-gray-900">Baptized</label>
                </div>
                <div>
                    <label for="my-profile-profilePic" class="block text-sm font-medium text-gray-700">Profile Picture</label>
                    <input type="file" id="my-profile-profilePic" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                    ${memberToEdit.profilePic ? `<img src="${memberToEdit.profilePic}" class="mt-2 w-20 h-20 object-cover rounded-full" alt="Current Profile Pic">` : ''}
                </div>
                <div class="form-section col-span-full">
                    <h4 class="form-section-title">Change Passcode</h4>
                    <p class="text-sm text-gray-700 mb-2">Leave blank to keep current passcode.</p>
                    <div>
                        <label for="new-passcode" class="block text-sm font-medium">New Passcode</label>
                        <input type="password" id="new-passcode" class="mt-1 block w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label for="confirm-new-passcode" class="block text-sm font-medium">Confirm New Passcode</label>
                        <input type="password" id="confirm-new-passcode" class="mt-1 block w-full px-3 py-2 border rounded-md">
                    </div>
                    <p id="passcode-error" class="text-sm text-red-600 hidden"></p>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3 class="form-section-title">Household Address & Group</h3>
            <p class="text-sm mb-4" style="color: var(--text-muted);">This applies to your entire household.</p>
            <div>
                <label for="my-profile-address" class="block text-sm font-medium text-gray-700">Address</label>
                <input type="text" id="my-profile-address" value="${memberToEdit.address}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <div>
                <label for="my-profile-group" class="block text-sm font-medium text-gray-700">Group</label>
                <select id="my-profile-group" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md">
                    <option value="A" ${memberToEdit.group === 'A' ? 'selected' : ''}>Group A</option>
                    <option value="B" ${memberToEdit.group === 'B' ? 'selected' : ''}>Group B</option>
                    <option value="C" ${memberToEdit.group === 'C' ? 'selected' : ''}>Group C</option>
                    <option value="D" ${memberToEdit.group === 'D' ? 'selected' : ''}>Group D</option>
                </select>
            </div>
        </div>

        <div class="pt-4 flex justify-end gap-3">
            <button type="button" id="cancel-my-profile-edit-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
            <button type="submit" class="px-4 py-2 text-white rounded-md" style="background-color: var(--primary-color);">Save Changes</button>
        </div>
    `;
    // Attach submit listener to the form itself, not an outer div
    editMyProfileFormEl.removeEventListener('submit', handleSaveMyProfile); // Prevent duplicates
    editMyProfileFormEl.addEventListener('submit', handleSaveMyProfile);

    document.getElementById('cancel-my-profile-edit-btn').addEventListener('click', () => switchPage('home'));
    // Attach passcode validation listener
    const newPasscodeInput = document.getElementById('new-passcode');
    const confirmNewPasscodeInput = document.getElementById('confirm-new-passcode');
    const passcodeError = document.getElementById('passcode-error');

    const validatePasscode = () => {
        if (newPasscodeInput.value || confirmNewPasscodeInput.value) { // Only validate if either field has input
            if (newPasscodeInput.value.length < 8) {
                passcodeError.textContent = "Passcode must be at least 8 characters long.";
                passcodeError.classList.remove('hidden');
                return false;
            }
            if (newPasscodeInput.value !== confirmNewPasscodeInput.value) {
                passcodeError.textContent = "Passcodes do not match.";
                passcodeError.classList.remove('hidden');
                return false;
            }
        }
        passcodeError.classList.add('hidden'); // Hide error if valid
        return true;
    };

    newPasscodeInput.addEventListener('input', validatePasscode);
    confirmNewPasscodeInput.addEventListener('input', validatePasscode);
};

// --- NEW: handleSendVerificationCode (Step 1 submit) ---
async function handleSendVerificationCode(e) {
    e.preventDefault();
    const fullName = document.getElementById('verify-full-name').value.trim();
    const phoneNumber = document.getElementById('verify-phone-number').value.trim();
    const verifyIdentityError = document.getElementById('verify-identity-error');
    const sendCodeBtn = document.getElementById('send-code-btn');

    verifyIdentityError.classList.add('hidden');
    sendCodeBtn.disabled = true;
    sendCodeBtn.textContent = 'Sending...';

    if (!fullName || !phoneNumber) {
        verifyIdentityError.textContent = "Please enter both name and phone number.";
        verifyIdentityError.classList.remove('hidden');
        sendCodeBtn.disabled = false;
        sendCodeBtn.textContent = 'Send Verification Code';
        return;
    }
    // Normalize phone number (e.g., ensure +CountryCode)
    const formattedPhoneNumber = phoneNumber.startsWith('+') ? phoneNumber : `+1${phoneNumber.replace(/\D/g, '')}`; // Assuming +1 for US/Canada, remove non-digits

    currentVerificationPhoneNumber = formattedPhoneNumber; // Save for resend

    try {
        // 1. Look up member in Firestore by name and phone
        const membersRef = collection(db, 'members');
        const q = query(membersRef, where('name', '==', fullName), where('phone', '==', formattedPhoneNumber), where('isHead', '==', true)); // Assuming only Head of Household can verify
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            verifyIdentityError.textContent = 'Name or phone number not found as a Head of Household. Please check your details.';
            verifyIdentityError.classList.remove('hidden');
            return;
        }
        const memberDoc = snapshot.docs[0]; // Get the found member document
        currentVerificationUserId = memberDoc.id; // Store the found member's ID

        // 2. Use Firebase Phone Auth to send the verification code
        // This is handled by Firebase SDK directly, no custom Cloud Function for sending needed.
        confirmationResult = await signInWithPhoneNumber(auth, formattedPhoneNumber, recaptchaVerifier);

        showToast("Verification code sent to your phone!", "success");
        // Transition to Step 2
        document.getElementById('profile-verification-step1').classList.add('hidden');
        document.getElementById('profile-verification-step2').classList.remove('hidden');
        document.getElementById('verification-code').focus(); // Focus on code input

    } catch (error) {
        console.error("Error sending verification code (Firebase Auth):", error);
        let errorMessage = "Failed to send code. Please ensure the phone number is valid and try again.";
        if (error.code === 'auth/invalid-phone-number') {
            errorMessage = "Invalid phone number format. Please include country code (e.g., +11234567890).";
        } else if (error.code === 'auth/too-many-requests') {
            errorMessage = "Too many verification requests. Please try again later.";
        } else if (error.code === 'auth/captcha-check-failed') {
            errorMessage = "Security check failed. Please refresh and try again.";
        }
        verifyIdentityError.textContent = errorMessage;
        verifyIdentityError.classList.remove('hidden');
    } finally {
        sendCodeBtn.disabled = false;
        sendCodeBtn.textContent = 'Send Verification Code';
    }
}

// --- handleConfirmVerificationCode (Step 2 submit using Firebase Phone Auth) ---
async function handleConfirmVerificationCode(e) {
    e.preventDefault();
    const verificationCode = document.getElementById('verification-code').value.trim();
    const confirmCodeError = document.getElementById('confirm-code-error');
    const confirmCodeBtn = document.getElementById('confirm-code-btn');

    confirmCodeError.classList.add('hidden');
    confirmCodeBtn.disabled = true;
    confirmCodeBtn.textContent = 'Confirming...';

    if (!verificationCode || verificationCode.length !== 6) {
        confirmCodeError.textContent = "Please enter a valid 6-digit code.";
        confirmCodeError.classList.remove('hidden');
        confirmCodeBtn.disabled = false;
        confirmCodeBtn.textContent = 'Confirm Identity';
        return;
    }

    try {
        // Confirm the code using Firebase Auth
        if (!confirmationResult) {
            throw new Error("No verification code was sent. Please resend code.");
        }
        const credential = PhoneAuthProvider.credential(confirmationResult.verificationId, verificationCode);

        // Link the current authenticated user (from passcode login) with this phone number credential
        // This allows the user to have both their custom token and the phone number linked.
        await linkWithCredential(auth.currentUser, credential);

        // Once successfully linked, update the member document with the user's UID
        if (currentVerificationUserId && currentUser.uid) {
            await updateDoc(doc(db, "members", currentVerificationUserId), { uid: currentUser.uid });
        }

        showToast("Identity confirmed! Your profile is linked.", "success");
        // Hide verification steps, show edit form
        document.getElementById('profile-verification-step1').classList.add('hidden');
        document.getElementById('profile-verification-step2').classList.add('hidden');
        document.getElementById('edit-my-profile-section').classList.remove('hidden');

        // Re-render the edit form with the newly linked data
        const memberSnap = await getDocs(query(collection(db, "members"), where("uid", "==", currentUser.uid), where("isHead", "==", true)));
        if (!memberSnap.empty) {
            generateEditProfileForm({ id: memberSnap.docs[0].id, ...memberSnap.docs[0].data() });
        }

    } catch (error) {
        console.error("Error confirming verification code (Firebase Auth):", error);
        let errorMessage = "Invalid or expired code. Please try again.";
        if (error.code === 'auth/invalid-verification-code') {
            errorMessage = "The verification code is invalid.";
        } else if (error.code === 'auth/code-expired') {
            errorMessage = "The verification code has expired.";
        } else if (error.code === 'auth/credential-already-in-use') {
            errorMessage = "This phone number is already linked to another account.";
        }
        confirmCodeError.textContent = errorMessage;
        confirmCodeError.classList.remove('hidden');
    } finally {
        confirmCodeBtn.disabled = false;
        confirmCodeBtn.textContent = 'Confirm Identity';
    }
}

// --- handleResendVerificationCode ---
async function handleResendVerificationCode() {
    const resendCodeBtn = document.getElementById('resend-code-btn');
    const confirmCodeError = document.getElementById('confirm-code-error');

    resendCodeBtn.disabled = true;
    resendCodeBtn.textContent = 'Resending...';
    confirmCodeError.classList.add('hidden'); // Clear errors on resend

    if (!currentVerificationPhoneNumber) {
        showToast("No phone number to resend to. Please go back to step 1.", "error");
        resendCodeBtn.disabled = false;
        resendCodeBtn.textContent = 'Resend Code';
        return;
    }

    try {
        // Re-send the code using Firebase Phone Auth (no custom Cloud Function needed)
        confirmationResult = await signInWithPhoneNumber(auth, currentVerificationPhoneNumber, recaptchaVerifier);
        showToast("Verification code resent!", "info");
    } catch (error) {
        console.error("Error resending verification code (Firebase Auth):", error);
        let errorMessage = "Failed to resend code. Please try again later.";
        if (error.code === 'auth/invalid-phone-number') {
            errorMessage = "Invalid phone number format for resend.";
        } else if (error.code === 'auth/too-many-requests') {
            errorMessage = "Too many resend requests. Please wait.";
        }
        confirmCodeError.textContent = errorMessage;
        confirmCodeError.classList.remove('hidden');
    } finally {
        resendCodeBtn.disabled = false;
        resendCodeBtn.textContent = 'Resend Code';
    }
}

const handleSaveMyProfile = async (e) => {
    e.preventDefault();
    const memberId = document.getElementById('edit-my-profile-member-id').value;
    const memberRef = doc(db, "members", memberId);

    const newPasscodeInput = document.getElementById('new-passcode');
    const confirmNewPasscodeInput = document.getElementById('confirm-new-passcode');
    const passcodeError = document.getElementById('passcode-error');

    // Passcode validation (remains the same)
    if (newPasscodeInput.value || confirmNewPasscodeInput.value) {
        if (newPasscodeInput.value.length < 8) {
            passcodeError.textContent = "New passcode must be at least 8 characters long.";
            passcodeError.classList.remove('hidden');
            return;
        }
        if (newPasscodeInput.value !== confirmNewPasscodeInput.value) {
            passcodeError.textContent = "New passcodes do not match.";
            passcodeError.classList.remove('hidden');
            return;
        }
    }
    passcodeError.classList.add('hidden'); // Clear error if valid

    // ... (existing profilePicFile and profilePicUrl logic) ...

    const updatedData = {
        name: document.getElementById('my-profile-name').value,
        phone: document.getElementById('my-profile-phone').value,
        email: document.getElementById('my-profile-email').value,
        dob: document.getElementById('my-profile-dob').value,
        gender: document.getElementById('my-profile-gender').value,
        baptized: document.getElementById('my-profile-baptized').checked,
        maritalStatus: document.getElementById('my-profile-marital-status').value,
        address: document.getElementById('my-profile-address').value,
        group: document.getElementById('my-profile-group').value,
        profilePic: profilePicUrl,
        updatedAt: serverTimestamp(),
    };

    try {
        await updateDoc(memberRef, updatedData);

        // --- CRITICAL FIX: Call Cloud Function to update passcode using httpsCallable ---
        if (newPasscodeInput.value) {
            const updatePasscodeCallable = httpsCallable(functions, 'updatePasscode'); // Get the callable function
            const response = await updatePasscodeCallable({ // Call it with data
                uid: currentUser.uid, // The user whose passcode is being changed
                newPasscode: newPasscodeInput.value
            });

            if (response.data.success) { // onCall functions return data.success
                showToast("Passcode updated successfully!", "success");
                // Passcode updated, now force a token refresh if desired
                // (The function itself revokes tokens, which forces logout, so client will pick up new token on re-login)
                await auth.currentUser.getIdToken(true); // Force a client-side token refresh (less aggressive than revoke)
            } else {
                passcodeError.textContent = response.data.error || "Failed to update passcode.";
                passcodeError.classList.remove('hidden');
                console.error("Passcode update failed:", response.data.error);
                return; // Stop if passcode update fails
            }
        }
        // --- END CRITICAL FIX ---

        showToast("Profile updated successfully!", "success");
        switchPage('home');
    } catch (error) {
        console.error("Error updating my profile:", error);
        // Check for specific Firebase functions errors
        if (error.code === 'unauthenticated' || error.code === 'permission-denied' || error.code === 'invalid-argument' || error.code === 'failed-precondition' || error.code === 'internal') {
            passcodeError.textContent = error.message;
            passcodeError.classList.remove('hidden');
            console.error("Cloud Function Error:", error);
        } else {
            showToast("Failed to update profile.", "error");
        }
    }
};
			
            // --- Give Page Logic ---
            const fetchZelleRecipient = () => {
                if (unsubscribeZelle) unsubscribeZelle();
                const zelleRef = doc(db, "zelleRecipients", "default"); // Assuming one default recipient
                unsubscribeZelle = onSnapshot(zelleRef, (docSnap) => {
                    if (docSnap.exists()) {
                        zelleRecipient = docSnap.data();
                        zelleNameDisplay.textContent = zelleRecipient.name || 'N/A';
                        zelleContactDisplay.textContent = zelleRecipient.contact || 'N/A';
                    } else {
                        zelleRecipient = { name: 'N/A', contact: 'N/A' };
                        zelleNameDisplay.textContent = 'N/A';
                        zelleContactDisplay.textContent = 'N/A';
                        // If no default exists, and editor, create a placeholder
                        if (currentUser && currentUser.role === 'editor') {
                            setDoc(doc(db, "zelleRecipients", "default"), { name: "Church Treasurer", contact: "treasurer@example.com" }, { merge: true });
                        }
                    }
                }, (error) => {
                    console.error("Error fetching Zelle recipient:", error);
                    showToast("Failed to load Zelle information.", "error");
                });
            };

            const openEditZelleModal = () => {
                editZelleModal.innerHTML = `
                    <div class="p-5 rounded-lg shadow-xl w-full max-w-md" style="background-color: var(--card-bg);">
                        <div class="modal-body">
                            <h3 class="text-lg text-center font-medium mb-4">Edit Zelle Recipient</h3>
                            <form id="edit-zelle-form" class="space-y-4">
                                <div>
                                    <label for="edit-zelle-name" class="block text-sm font-medium text-gray-700">Recipient Name</label>
                                    <input type="text" id="edit-zelle-name" value="${zelleRecipient.name || ''}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="edit-zelle-contact" class="block text-sm font-medium text-gray-700">Zelle Email/Phone</label>
                                    <input type="text" id="edit-zelle-contact" value="${zelleRecipient.contact || ''}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div class="pt-4 flex justify-end gap-3">
                                    <button type="button" id="cancel-edit-zelle-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                                    <button type="submit" class="px-4 py-2 text-white rounded-md" style="background-color: var(--primary-color);">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                editZelleModal.classList.remove('hidden');
                document.getElementById('cancel-edit-zelle-btn').addEventListener('click', () => editZelleModal.classList.add('hidden'));
                document.getElementById('edit-zelle-form').addEventListener('submit', handleSaveZelleRecipient);
            };

            const handleSaveZelleRecipient = async (e) => {
                e.preventDefault();
                const name = document.getElementById('edit-zelle-name').value;
                const contact = document.getElementById('edit-zelle-contact').value;
                try {
                    await setDoc(doc(db, "zelleRecipients", "default"), { name, contact, updatedAt: serverTimestamp() }, { merge: true });
                    showToast("Zelle recipient updated!", "success");
                    editZelleModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error saving Zelle recipient:", error);
                    showToast("Failed to save Zelle recipient.", "error");
                }
            };
            
            // --- Online Payment Link Logic ---
            const fetchOnlinePaymentLink = () => {
                if (unsubscribeOnlinePaymentLink) unsubscribeOnlinePaymentLink();
                const paymentLinkRef = doc(db, "appContent", "onlinePaymentLink");
                unsubscribeOnlinePaymentLink = onSnapshot(paymentLinkRef, (docSnap) => {
                    if (docSnap.exists()) {
                        onlinePaymentLink = docSnap.data().url || '';
                    } else {
                        onlinePaymentLink = '';
                        if (currentUser && currentUser.role === 'editor') {
                            setDoc(doc(db, "appContent", "onlinePaymentLink"), { url: "https://example.com/donate", createdAt: serverTimestamp() }, { merge: true });
                        }
                    }
                     // Enable/disable button based on link presence
                    
                }, (error) => {
                    console.error("Error fetching online payment link:", error);
                    showToast("Failed to load online payment link.", "error");
                });
            };

            const openEditOnlinePaymentLinkModal = () => {
                const editOnlinePaymentLinkModal = document.createElement('div');
                editOnlinePaymentLinkModal.id = 'edit-online-payment-link-modal';
                editOnlinePaymentLinkModal.className = 'fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center';
                editOnlinePaymentLinkModal.innerHTML = `
                    <div class="p-5 rounded-lg shadow-xl w-full max-w-md" style="background-color: var(--card-bg);">
                        <div class="modal-body">
                            <h3 class="text-lg text-center font-medium mb-4">Edit Online Payment Link</h3>
                            <form id="edit-online-payment-link-form" class="space-y-4">
                                <div>
                                    <label for="online-payment-url" class="block text-sm font-medium text-gray-700">Payment URL</label>
                                    <input type="url" id="online-payment-url" value="${onlinePaymentLink}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div class="pt-4 flex justify-end gap-3">
                                    <button type="button" id="cancel-online-payment-link-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                                    <button type="submit" class="px-4 py-2 text-white rounded-md" style="background-color: var(--primary-color);">Save Link</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.appendChild(editOnlinePaymentLinkModal);
                editOnlinePaymentLinkModal.classList.remove('hidden');

                document.getElementById('cancel-online-payment-link-btn').addEventListener('click', () => document.body.removeChild(editOnlinePaymentLinkModal));
                document.getElementById('edit-online-payment-link-form').addEventListener('submit', handleSaveOnlinePaymentLink);
            };

            const handleSaveOnlinePaymentLink = async (e) => {
                e.preventDefault();
                const url = document.getElementById('online-payment-url').value;
                try {
                    await setDoc(doc(db, "appContent", "onlinePaymentLink"), { url: url, updatedAt: serverTimestamp() }, { merge: true });
                    showToast("Online payment link updated!", "success");
                    document.body.removeChild(document.getElementById('edit-online-payment-link-modal'));
                } catch (error) {
                    console.error("Error saving online payment link:", error);
                    showToast("Failed to save online payment link.", "error");
                }
            };
			
			// --- Profile Picture Upload Function ----
            const setupProfilePictureUpload = () => {
                const userProfilePicBtn = document.getElementById('user-profile-pic-btn');
                const userProfilePicInput = document.getElementById('user-profile-pic-input');

                if (!userProfilePicBtn || !userProfilePicInput) return;

                // When the user clicks their profile picture, programmatically click the hidden file input.
                userProfilePicBtn.addEventListener('click', () => {
                    userProfilePicInput.click();
                });

                // When the user selects a new file, process and upload it.
				userProfilePicInput.addEventListener('change', async (e) => {
				  const file = e.target.files[0];
				  if (!file || !currentUser) return;
				  showToast("Uploading picture...", "info");
				  try {
					// 1) Upload to Firebase Storage
					const storage = getStorage();
					const picRef = storageRef(storage, `profilePics/${currentUser.uid}/${Date.now()}_${file.name}`);
					await uploadBytes(picRef, file);

					// 2) Get its public URL
					const downloadURL = await getDownloadURL(picRef);

					// 3) Save URL in Firestore
					await saveUserProfile(currentUser.uid, { profilePic: downloadURL });

					// 4) (Optional) Update members collection if needed …

					// 5) Refresh UI
					await updateUserInfo();
					showToast("Profile picture updated successfully!", "success");
				  } catch (error) {
					console.error("Error updating profile picture:", error);
					showToast("Failed to update profile picture.", "error");
				  } finally {
					e.target.value = '';
				  }
				});
            };

            // --- Prayer Request Logic ---
            const handlePrayerRequestSubmit = async (e) => {
                e.preventDefault();
                const name = document.getElementById('prayer-name').value;
                const phone = document.getElementById('prayer-phone').value;
                const requestText = document.getElementById('prayer-request-text').value;
                const isPublic = document.getElementById('share-prayer-publicly').checked;

                if (!requestText.trim()) {
                    showToast("Prayer request cannot be empty.", "error");
                    return;
                }

                const prayerRequestData = {
                    name: name || 'Anonymous',
                    phone: phone || 'N/A',
                    request: requestText,
                    submittedAt: serverTimestamp(),
                    status: 'pending',
                    isPublic: isPublic,
                    prayerCount: 0
                };

                try {
                    await addDoc(collection(db, "prayerRequests"), prayerRequestData);
                    showToast("Your prayer request has been submitted!", "success");
                    prayerRequestForm.reset();
                    // NEW: Close the prayer request page and open the prayer wall
                    switchPage('prayer-wall'); // Added this line
                } catch (error) {
                    console.error("Error submitting prayer request:", error);
                    showToast("Failed to submit prayer request.", "error");
                }
            };

          //  let allPreviousPrayerRequestsCount = 0; // To track count for notification badge adjustment


            const listenForPrayerRequests = () => {
                if (unsubscribePrayerRequests) unsubscribePrayerRequests();
                // Only editors and ministers should listen for new pending requests
                if (!(currentUser && (currentUser.role === 'editor' || currentUser.role === 'minister'))) {
                    // if not authorized, ensure related UI is hidden and do not setup listener
                    // notificationBadge.classList.add('hidden'); // Combined logic handles this
                    // notificationBtn.onclick = null; // Don't nullify, handled by combined modal
                    return;
                }

                const q = query(collection(db, "prayerRequests"), where("status", "==", "pending"));
                unsubscribePrayerRequests = onSnapshot(q, (snapshot) => {
                    const pendingRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    let currentTotalNotifications = parseInt(notificationBadge.textContent || '0');
                    // Subtract previous prayer request count and add new one
                    currentTotalNotifications = currentTotalNotifications - allPreviousPrayerRequestsCount + pendingRequests.length;
                    allPreviousPrayerRequestsCount = pendingRequests.length; // Store current count for next update

                    if (currentTotalNotifications > 0) {
                        notificationBadge.textContent = currentTotalNotifications;
                        notificationBadge.classList.remove('hidden');
                    } else {
                        notificationBadge.classList.add('hidden');
                    }
                    // This will be handled by showCombinedNotificationModal when notificationBtn is clicked
                }, (error) => {
                    console.error("Error fetching prayer requests:", error);
                    showToast("Failed to load prayer requests.", "error");
                    notificationBadge.classList.add('hidden'); // Hide on error
                });
            };

            const showCombinedNotificationModal = () => {
                // Fetch latest update and prayer requests to show in the modal
                let updateRequests = [];
                let prayerRequests = [];

                // Re-fetch update requests (assuming listener might be stale if role changed)
                if (currentUser && currentUser.role === 'editor') {
                    getDocs(query(collection(db, "updateRequests"), where("status", "==", "pending")))
                        .then(snapshot => { updateRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderCombinedModal(updateRequests, prayerRequests); })
                        .catch(err => console.error("Error fetching update requests for modal:", err));
                }

                // Re-fetch prayer requests
                if (currentUser && (currentUser.role === 'editor' || currentUser.role === 'minister')) {
                    getDocs(query(collection(db, "prayerRequests"), where("status", "==", "pending")))
                        .then(snapshot => { prayerRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderCombinedModal(updateRequests, prayerRequests); })
                        .catch(err => console.error("Error fetching prayer requests for modal:", err));
                }

                const renderCombinedModal = (updateReqs, prayerReqs) => {
                    let combinedHtml = ``;

                    if (updateReqs.length > 0) {
                        combinedHtml += `<h3 class="text-lg font-medium mb-2">Pending Info Update Requests</h3>`;
                        combinedHtml += updateReqs.map(req => `
                            <div class="p-4 border rounded-lg mb-4">
                                <p><strong>Request from:</strong> ${req.submittedBy}</p>
                                <p><strong>Member Name:</strong> ${req.name}</p>
                                <p><strong>Submitted:</strong> ${req.submittedAt ? new Date(req.submittedAt.toDate()).toLocaleString() : 'N/A'}</p>
                                <div class="mt-2 p-2 bg-gray-100 rounded">
                                    ${req.phone ? `<p><strong>Phone:</strong> ${req.phone}</p>` : ''}
                                    ${req.email ? `<p><strong>Email:</strong> ${req.email}</p>` : ''}
                                    ${req.address !== 'Not provided' ? `<p><strong>Address:</strong> ${req.address}</p>` : ''}
                                    ${req.gender ? `<p><strong>Gender:</strong> ${req.gender}</p>` : ''}
                                    ${req.maritalStatus ? `<p><strong>Marital Status:</strong> ${req.maritalStatus}</p>` : ''}
                                    <p><strong>Baptized:</strong> ${req.baptized ? 'Yes' : 'No'}</p>
                                    ${req.notes ? `<p class="mt-2"><strong>Notes:</strong> ${req.notes}</p>` : ''}
                                </div>
                                <button data-id="${req.id}" data-type="update" class="mark-notification-complete-btn mt-2 px-3 py-1 text-xs text-white btn-primary rounded-md">Mark as Complete</button>
                            </div>
                        `).join('');
                    } else if (currentUser && currentUser.role === 'editor') {
                         combinedHtml += `<p style="color: var(--text-muted)">No pending info update requests.</p>`;
                    }

                    if (prayerReqs.length > 0) {
                        if (updateReqs.length > 0) combinedHtml += `<hr class="my-6 border-gray-200">`;
                        combinedHtml += `<h3 class="text-lg font-medium mb-2">Pending Prayer Requests</h3>`;
                        combinedHtml += prayerReqs.map(req => `
                            <div class="p-4 border rounded-lg mb-4">
                                <p><strong>Name:</strong> ${req.name}</p>
                                <p><strong>Phone:</strong> ${req.phone}</p>
                                <p><strong>Request:</strong> ${req.request}</p>
                                <p class="text-sm text-gray-500 mt-1">Submitted: ${req.submittedAt ? new Date(req.submittedAt.toDate()).toLocaleString() : 'N/A'}</p>
                                <button data-id="${req.id}" data-type="prayer" class="mark-notification-complete-btn mt-2 px-3 py-1 text-xs text-white btn-primary rounded-md">Mark as Complete</button>
                            </div>
                        `).join('');
                    } else if (currentUser && (currentUser.role === 'editor' || currentUser.role === 'minister')) {
                        if (updateReqs.length === 0) combinedHtml += `<p style="color: var(--text-muted)">No pending prayer requests.</p>`;
                    }


                    if (updateReqs.length === 0 && prayerReqs.length === 0) {
                        combinedHtml = `<p style="color: var(--text-muted)">No pending notifications.</p>`;
                    }

                    notificationModal.innerHTML = `
                        <div class="p-5 rounded-lg shadow-xl w-full max-w-2xl" style="background-color: var(--card-bg);">
                            <div class="notification-modal-header">
                                <h3 class="text-xl font-bold">Notifications</h3>
                                <button id="close-notification-modal-x" class="text-3xl text-gray-500 hover:text-gray-800">×</button>
                            </div>
                            <div class="modal-body-scrollable">
                                <div>${combinedHtml}</div>
                            </div>
                            </div>`;
                    notificationModal.classList.remove('hidden');

                    // Add listener for the new 'X' close button
                    document.getElementById('close-notification-modal-x').addEventListener('click', () => notificationModal.classList.add('hidden'));

                    notificationModal.querySelectorAll('.mark-notification-complete-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const reqId = e.target.dataset.id;
                            const reqType = e.target.dataset.type;
                            try {
                                if (reqType === 'update') {
                                    await deleteDoc(doc(db, 'updateRequests', reqId));
                                    showToast("Update request marked as complete.", "success");
                                } else if (reqType === 'prayer') {
                                    await updateDoc(doc(db, 'prayerRequests', reqId), { status: 'completed', completedAt: serverTimestamp() });
                                    showToast("Prayer request marked as complete.", "success");
                                }
                                showCombinedNotificationModal();
                            } catch (error) {
                                console.error(`Error marking ${reqType} request complete:`, error);
                                showToast(`Failed to mark ${reqType} request complete.`, "error");
                            }
                        });
                    });
                    // Removed old close button listener: document.getElementById('close-notification-modal').addEventListener('click', () => notificationModal.classList.add('hidden'));
                };
            };


            // --- Posts Logic ---
			const fetchPosts = () => {
				if (unsubscribePosts) unsubscribePosts();
				const postsRef = collection(db, "posts");
				// Order by createdAt to get latest posts by default
				unsubscribePosts = onSnapshot(query(postsRef, orderBy("createdAt", "desc")), async (snapshot) => {
					const fetchedPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

					// Fetch likes and saved status for each post
					for (let post of fetchedPosts) {
						// Get like count
						const likesSnap = await getDocs(collection(db, "posts", post.id, "likes"));
						post.likeCount = likesSnap.size;
						post.userHasLiked = currentUser && likesSnap.docs.some(doc => doc.id === currentUser.uid);

						// Check if post is saved by current user
						post.isSaved = userSavedPosts.includes(post.id);
					}

					allPosts = fetchedPosts; // Update the global allPosts array
					updatePostDisplay(); // Call new display function
				}, (error) => {
					console.error("Error fetching posts:", error);
					showToast("Failed to load posts.", "error");
				});
			};



const updatePostDisplay = () => {
    const postsListContainer = document.getElementById('posts-list-container');
    if (!postsListContainer) return;

    const searchTerm = document.getElementById('post-search-box').value.toLowerCase();
    const sortBy = document.getElementById('post-sort-box').value;
    const latestPostsHeading = document.querySelector('#page-home .posts-section-container h3'); // Get the heading element
    const viewSavedPostsBtn = document.getElementById('view-saved-posts-btn'); // The button in the filter bar


    let postsToDisplay = [...allPosts]; // Start with all fetched posts

    if (currentPostView === 'saved') {
        postsToDisplay = postsToDisplay.filter(post => userSavedPosts.includes(post.id));
        latestPostsHeading.textContent = 'My Saved Posts'; // Change heading
        if (viewSavedPostsBtn) {
            viewSavedPostsBtn.textContent = 'All Posts'; // Change button text to "All Posts"
            viewSavedPostsBtn.classList.remove('btn-primary');
            viewSavedPostsBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
        }
    } else { // currentPostView === 'all'
        latestPostsHeading.textContent = 'Latest Posts'; // Revert heading
        if (viewSavedPostsBtn) {
            viewSavedPostsBtn.textContent = 'Saved Posts'; // Change button text back
            viewSavedPostsBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            viewSavedPostsBtn.classList.add('btn-primary');
        }
    }

    // Apply search filter (applies to both 'all' and 'saved' views)
    if (searchTerm) {
        postsToDisplay = postsToDisplay.filter(post =>
            post.title.toLowerCase().includes(searchTerm) ||
            (post.content && post.content.toLowerCase().includes(searchTerm)) ||
            (post.authorName && post.authorName.toLowerCase().includes(searchTerm))
        );
    }

    // Apply sort order (applies to both 'all' and 'saved' views)
    switch (sortBy) {
        case 'date-asc':
            postsToDisplay.sort((a, b) => (a.createdAt?.toDate() || 0) - (b.createdAt?.toDate() || 0));
            break;
        case 'views-desc':
            postsToDisplay.sort((a, b) => (b.views || 0) - (a.views || 0));
            break;
        case 'title-asc':
            postsToDisplay.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            break;
        case 'author-asc':
            postsToDisplay.sort((a, b) => (a.authorName || '').localeCompare(b.authorName || ''));
            break;
        case 'date-desc':
        default:
            postsToDisplay.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
            break;
    }

    postsListContainer.innerHTML = '';
    if (postsToDisplay.length === 0) {
        const message = currentPostView === 'saved'
            ? `<p class="col-span-full text-center" style="color: var(--text-muted)">You haven't saved any posts yet, or none match your search.</p>`
            : `<p class="col-span-full text-center" style="color: var(--text-muted)">No posts found matching your criteria.</p>`;
        postsListContainer.innerHTML = message;
        return;
    }

    postsToDisplay.forEach(post => {
        const card = createPostCard(post);
        postsListContainer.appendChild(card);
    });

    if (isEditModeActive) {
        postsListContainer.querySelectorAll('.editor-only-section').forEach(el => el.classList.remove('hidden'));
    } else {
        postsListContainer.querySelectorAll('.editor-only-section').forEach(el => el.classList.add('hidden'));
    }
};
	
/*	
	const renderPosts = () => {
                postsListContainer.innerHTML = '';
                if (allPosts.length === 0) {
                    postsListContainer.innerHTML = `<p class="col-span-full" style="color: var(--text-muted)">No posts published yet.</p>`;
                    return;
                }

                allPosts.forEach(post => {
                    const card = document.createElement('div');
                    card.className = "post-card p-4 rounded-xl shadow-md flex flex-col cursor-pointer";
                    card.style.backgroundColor = 'var(--card-bg)';
                    card.dataset.postId = post.id; 

                    let postImageHtml = '';
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = post.content || '';
                    const firstImage = tempDiv.querySelector('img');
                    if (firstImage) {
                        postImageHtml = `<img src="${firstImage.src}" class="w-full h-32 object-cover rounded-md mb-3" onerror="this.onerror=null;this.src='https://placehold.co/300x150/cccccc/333333?text=No+Image';">`;
                    }
                    const textPreview = tempDiv.textContent.substring(0, 150) + (tempDiv.textContent.length > 150 ? '...' : '');

                    card.innerHTML = `
                        ${postImageHtml}
                        <h3 class="text-lg font-bold mb-2">${post.title}</h3>
                        <p class="text-sm text-gray-700 mb-3 flex-grow">${textPreview}</p>
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span class="font-medium">By: ${post.authorName || 'Editor'}</span>
                            <span>${post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : 'N/A'}</span>
                        </div>

                        <div class="editor-only-section hidden mt-2 pt-2 border-t border-gray-200">
                            <div class="flex items-center justify-end gap-2">
                                <button data-id="${post.id}" class="edit-post-btn text-xs font-medium text-indigo-600 hover:text-indigo-800">Edit</button>
                                <button data-id="${post.id}" class="delete-post-btn text-xs font-medium text-red-600 hover:text-red-800">Delete</button>
                            </div>
                        </div>
                    `;
                    
                    postsListContainer.appendChild(card);
                });
            };

*/






			// ------- Post in Popup View (currently not in use) --------
/*            const showPostDetailModal = async (postId) => {
                let post = allPosts.find(p => p.id === postId); // Use `let` to reassign
                if (!post) {
                    showToast("Post not found.", "error");
                    return;
                }

                // Increment view count directly on the fetched object and in Firestore
                const updatedViews = (post.views || 0) + 1;
                await updateDoc(doc(db, "posts", postId), { views: updatedViews });

                // Re-fetch the post to ensure we have the most up-to-date data after the update
                // This is important because the onSnapshot listener might not have updated 'allPosts' yet.
                const updatedPostSnap = await getDoc(doc(db, "posts", postId));
                if (updatedPostSnap.exists()) {
                    post = { id: updatedPostSnap.id, ...updatedPostSnap.data() };
                } else {
                    showToast("Failed to fetch updated post data.", "error");
                    return;
                }

                const postDetailModal = document.createElement('div');
                postDetailModal.id = 'post-detail-modal';
                postDetailModal.className = 'fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center';
                postDetailModal.innerHTML = `
                    <div class="p-5 rounded-lg shadow-xl w-full max-w-3xl" style="background-color: var(--card-bg);">
                        <div class="modal-body">
                            <h3 class="text-2xl font-bold mb-4">${post.title}</h3>
                            <div class="text-sm text-gray-500 mb-4 flex justify-between items-center">
                                <span><i class="fas fa-eye"></i> ${post.views} views</span> <!-- Now uses the updated post.views -->
                                <span>Published: ${post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : 'N/A'}</span>
                            </div>
                            <div class="prose max-w-none mb-6" style="color: var(--text-color);">
                                ${post.content || '<p style="color: var(--text-muted);">No content provided.</p>'}
                            </div>
                            <div class="mt-4 text-center">
                                <button id="close-post-modal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(postDetailModal);
                postDetailModal.classList.remove('hidden');
                document.getElementById('close-post-modal').addEventListener('click', () => document.body.removeChild(postDetailModal));
            };
*/

            const openAddPostModal = () => {
                const addPostModal = document.createElement('div');
                addPostModal.id = 'add-post-modal';
                addPostModal.className = 'fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center';
                addPostModal.innerHTML = `
                    <div class="p-5 rounded-lg shadow-xl w-full max-w-2xl" style="background-color: var(--card-bg);">
                        <div class="modal-body">
                            <h3 class="text-lg text-center font-medium mb-4">Add New Post</h3>
                            <form id="add-post-form" class="space-y-4">
                                <div class="form-section">
                                    <h4 class="form-section-title">Post Details</h4>
                                    <div>
                                        <label for="post-title" class="block text-sm font-medium text-gray-700">Title</label>
                                        <input type="text" id="post-title" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                </div>
                                <div class="form-section">
                                    <h4 class="form-section-title">Content</h4>
                                    <div class="rich-text-editor-toolbar">
                                        <button type="button" data-command="bold"><i class="fas fa-bold"></i></button>
                                        <button type="button" data-command="italic"><i class="fas fa-italic"></i></button>
                                        <button type="button" data-command="underline"><i class="fas fa-underline"></i></button>
                                        <button type="button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                                        <button type="button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                                        <button type="button" data-command="createLink" id="create-link-btn-post"><i class="fas fa-link"></i></button>
                                        <input type="file" id="image-upload-input-post" accept="image/*" class="hidden">
                                        <button type="button" id="insert-image-btn-post"><i class="fas fa-image"></i></button>
                                    </div>
                                    <div id="post-content" contenteditable="true" class="rich-text-editor-content border rounded-md p-3 min-h-[150px] outline-none"></div>
                                </div>
                                <div class="pt-4 flex justify-end gap-3">
                                    <button type="button" id="cancel-add-post-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                                    <button type="submit" class="px-4 py-2 text-white rounded-md" style="background-color: var(--primary-color);">Publish Post</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.appendChild(addPostModal);
                addPostModal.classList.remove('hidden');

                document.getElementById('cancel-add-post-btn').addEventListener('click', () => document.body.removeChild(addPostModal));
                document.getElementById('add-post-form').addEventListener('submit', handleAddPost);

                addPostModal.querySelectorAll('.rich-text-editor-toolbar button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const command = e.currentTarget.dataset.command;
                        
                        // --- NEW LOGIC FOR LISTS ---
                        if (command === 'insertUnorderedList') {
                            insertListHTML('UL');
                        } else if (command === 'insertOrderedList') {
                            insertListHTML('OL');
                        } else if (command === 'createLink') {
                            const url = prompt('Enter the URL:');
                            if (url) document.execCommand(command, false, url);
                        } else {
                            // Handle other commands like 'bold', 'italic'
                            document.execCommand(command, false, null);
                        }
                    });
                });

                document.getElementById('insert-image-btn-post').addEventListener('click', () => document.getElementById('image-upload-input-post').click());
                document.getElementById('image-upload-input-post').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        toBase64(file).then(base64 => {
                            const img = `<img src="${base64}" style="max-width:100%; height:auto;">`;
                            document.execCommand('insertHTML', false, img);
                        }).catch(error => showToast("Failed to insert image.", "error"));
                    }
                });
            };

            const handleAddPost = async (e) => {
                e.preventDefault();
                const title = document.getElementById('post-title').value;
                const content = document.getElementById('post-content').innerHTML;

                if (!title.trim() || !content.trim()) {
                    showToast("Post title and content cannot be empty.", "error");
                    return;
                }

                const postData = {
                    title,
                    content,
                    views: 0,
                    createdAt: serverTimestamp(),
                    authorName: loggedInUserName || currentUser.name || 'Editor', 
                    authorId: currentUser.uid
                };

                try {
                    await addDoc(collection(db, "posts"), postData);
                    showToast("Post published successfully!", "success");
                    document.body.removeChild(document.getElementById('add-post-modal'));
                } catch (error) {
                    console.error("Error publishing post:", error);
                    showToast("Failed to publish post.", "error");
                }
            };

            const openEditPostModal = (postId) => {
                const post = allPosts.find(p => p.id === postId);
                if (!post) {
                    showToast("Post not found for editing.", "error");
                    return;
                }

                const editPostModal = document.createElement('div');
                editPostModal.id = 'edit-post-modal';
                editPostModal.className = 'fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center';
                editPostModal.innerHTML = `
                    <div class="p-5 rounded-lg shadow-xl w-full max-w-2xl" style="background-color: var(--card-bg);">
                        <div class="modal-body">
                            <h3 class="text-lg text-center font-medium mb-4">Edit Post</h3>
                            <form id="edit-post-form" class="space-y-4">
                                <input type="hidden" id="edit-post-id" value="${post.id}">
                                <div class="form-section">
                                    <h4 class="form-section-title">Post Details</h4>
                                    <div>
                                        <label for="edit-post-title" class="block text-sm font-medium text-gray-700">Title</label>
                                        <input type="text" id="edit-post-title" value="${post.title}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>

                                    <div>
                                        <label for="edit-post-author" class="block text-sm font-medium text-gray-700">Author Name</label>
                                        <input type="text" id="edit-post-author" value="${post.authorName || ''}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    </div>
                                <div class="form-section">
                                    <h4 class="form-section-title">Content</h4>
                                    <div class="rich-text-editor-toolbar">
                                        <button type="button" data-command="bold"><i class="fas fa-bold"></i></button>
                                        <button type="button" data-command="italic"><i class="fas fa-italic"></i></button>
                                        <button type="button" data-command="underline"><i class="fas fa-underline"></i></button>
                                        <button type="button" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                                        <button type="button" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                                        <button type="button" data-command="createLink" id="create-link-btn-edit-post"><i class="fas fa-link"></i></button>
                                        <input type="file" id="image-upload-input-edit-post" accept="image/*" class="hidden">
                                        <button type="button" id="insert-image-btn-edit-post"><i class="fas fa-image"></i></button>
                                    </div>
                                    <div id="edit-post-content" contenteditable="true" class="rich-text-editor-content border rounded-md p-3 min-h-[150px] outline-none">${post.content || ''}</div>
                                </div>
                                <div class="pt-4 flex justify-end gap-3">
                                    <button type="button" id="cancel-edit-post-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                                    <button type="submit" class="px-4 py-2 text-white rounded-md" style="background-color: var(--primary-color);">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.appendChild(editPostModal);
                editPostModal.classList.remove('hidden');

                document.getElementById('cancel-edit-post-btn').addEventListener('click', () => document.body.removeChild(editPostModal));
                document.getElementById('edit-post-form').addEventListener('submit', handleEditPost);

                editPostModal.querySelectorAll('.rich-text-editor-toolbar button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const command = e.currentTarget.dataset.command;
                        if (command === 'insertUnorderedList') {
                            insertListHTML('UL');
                        } else if (command === 'insertOrderedList') {
                            insertListHTML('OL');
                        } else if (command === 'createLink') {
                            const url = prompt('Enter the URL:');
                            if (url) document.execCommand(command, false, url);
                        } else {
                            // Handle other commands like 'bold', 'italic'
                            document.execCommand(command, false, null);
                        }
                    });
                });

                document.getElementById('insert-image-btn-edit-post').addEventListener('click', () => document.getElementById('image-upload-input-edit-post').click());
                document.getElementById('image-upload-input-edit-post').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        toBase64(file).then(base64 => {
                            const img = `<img src="${base64}" style="max-width:100%; height:auto;">`;
                            document.execCommand('insertHTML', false, img);
                        }).catch(error => showToast("Failed to insert image.", "error"));
                    }
                });
            };

			const handleEditPost = async (e) => {
                e.preventDefault();
                const postId = document.getElementById('edit-post-id').value;
                const title = document.getElementById('edit-post-title').value;
                const content = document.getElementById('edit-post-content').innerHTML;
                const authorName = document.getElementById('edit-post-author').value; // <<< GET THE NEW VALUE

                if (!title.trim() || !content.trim()) {
                    showToast("Post title and content cannot be empty.", "error");
                    return;
                }

                const updatedData = {
                    title,
                    content,
                    authorName, // <<< ADD IT TO THE DATA TO BE SAVED
                    updatedAt: serverTimestamp()
                };

                try {
                    await updateDoc(doc(db, "posts", postId), updatedData);
                    showToast("Post updated successfully!", "success");
                    document.body.removeChild(document.getElementById('edit-post-modal'));
                } catch (error) {
                    console.error("Error updating post:", error);
                    showToast("Failed to update post.", "error");
                }
            };

            const deletePost = (postId, postTitle) => {
                showConfirmModal(`Are you sure you want to delete the post "${postTitle}"? This cannot be undone.`, async () => {
                    try {
                        await deleteDoc(doc(db, "posts", postId));
                        showToast("Post deleted successfully!", "success");
                    } catch (error) {
                        console.error("Error deleting post:", error);
                        showToast("Failed to delete post.", "error");
                    }
                });
            };

			// --- START OF FIREBASE VOTING SYSTEM ---
            /**
             * Fetches all voting sessions from Firestore in real-time.
             */
            const fetchVotingSessions = () => {
                if (unsubscribeVotingSessions) unsubscribeVotingSessions();
                const sessionsRef = collection(db, "votingSessions");
                const q = query(sessionsRef, orderBy("createdAt", "desc"));
                unsubscribeVotingSessions = onSnapshot(q, (snapshot) => {
                    const previousSessions = [...allVotingSessions];
                    allVotingSessions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    const justEndedSession = allVotingSessions.find(newS => {
                        const oldS = previousSessions.find(old => old.id === newS.id);
                        return newS.status === 'ended' && oldS && oldS.status === 'active';
                    });
                    if (justEndedSession) showVotingResultsModal(justEndedSession);

                    const votingLiveBadge = document.getElementById('voting-live-badge');
                    if (votingLiveBadge) {
                        const hasActiveSession = allVotingSessions.some(s => s.status === 'active');
                        votingLiveBadge.classList.toggle('hidden', !hasActiveSession);
                    }
                    const activeSession = allVotingSessions.find(s => s.status === 'active');
                    if (activeSession) fetchUserVoteForSession(activeSession.id);
                    if (currentPage === 'voting') renderVotingPage();
                });
            };

            const fetchUserVoteForSession = (sessionId) => {
                if (unsubscribeUserVotes) unsubscribeUserVotes();
                if (!currentUser || !sessionId) return;
                const userVoteRef = doc(db, "votingSessions", sessionId, "votes", currentUser.uid);
                unsubscribeUserVotes = onSnapshot(userVoteRef, (docSnap) => {
                    if (docSnap.exists()) userVotes[sessionId] = docSnap.data().votedChoices;
                    else delete userVotes[sessionId];
                    if (currentPage === 'voting') renderVotingPage();
                });
            };

            const renderVotingPage = () => {
                // --- CRITICAL FIX: Clear and re-populate each container based on session status ---
                const activeContainer = document.getElementById('active-voting-sessions');
                const pendingContainer = document.getElementById('pending-voting-sessions');
                const expiredContainer = document.getElementById('expired-voting-sessions');

                // Clear existing content in all containers
                if (activeContainer) activeContainer.innerHTML = '';
                if (pendingContainer) pendingContainer.innerHTML = '';
                if (expiredContainer) expiredContainer.innerHTML = '';

                let sessionCounts = { active: 0, pending: 0, expired: 0 };

                allVotingSessions.forEach(session => {
                    const card = createVotingSessionCard(session); // This correctly creates the card with the 'voting-card' class

                    if (session.status === 'active') {
                        if (activeContainer) activeContainer.appendChild(card);
                        sessionCounts.active++;
                    } else if (session.status === 'ended') {
                        if (expiredContainer) expiredContainer.appendChild(card);
                        sessionCounts.expired++;
                    } else { // pending
                        if (pendingContainer) pendingContainer.appendChild(card);
                        sessionCounts.pending++;
                    }
                });

                // Display "No sessions" message if a category is empty
                if (activeContainer && sessionCounts.active === 0) {
                    activeContainer.innerHTML = '<p class="col-span-full text-gray-500">No sessions in this category.</p>';
                }
                if (pendingContainer && sessionCounts.pending === 0) {
                    pendingContainer.innerHTML = '<p class="col-span-full text-gray-500">No sessions in this category.</p>';
                }
                // Expired sessions container visibility is handled by the checkbox, not direct `innerHTML`
                if (expiredContainer && sessionCounts.expired === 0) {
                    expiredContainer.innerHTML = '<p class="col-span-full text-gray-500">No sessions in this category.</p>';
                }
            };
            
            const updateCountdown = (sessionId, element, endTime) => {
                if (countdownIntervals[sessionId]) clearInterval(countdownIntervals[sessionId]);
                countdownIntervals[sessionId] = setInterval(() => {
                    const distance = endTime - new Date().getTime();
                    if (distance < 0) {
                        clearInterval(countdownIntervals[sessionId]);
                        const session = allVotingSessions.find(s => s.id === sessionId);
                        if (session && session.status === 'active') showReportVisibilityModal(session.id);
                        return;
                    }
                    const d = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((distance % (1000 * 60)) / 1000);
                    element.innerHTML = `This session ends in: <span class="font-bold">${d}d ${h}h ${m}m ${s}s</span>`;
                }, 1000);
            };

            const createVotingSessionCard = (session) => {
                const card = document.createElement('div');
                // Apply the new base card class
                // --- CRITICAL FIX: Ensure 'voting-card' class is always present ---
                // --- AND add status-specific border class ---
                let statusBorderClass = '';
                if (session.status === 'active') {
                    statusBorderClass = 'active-border';
                } else if (session.status === 'pending') {
                    statusBorderClass = 'pending-border';
                } else { // ended
                    statusBorderClass = 'ended-border';
                }

                card.className = `voting-card flex flex-col transition-all ${statusBorderClass}`; // Apply base class and status border
                card.style.backgroundColor = 'var(--card-bg)'; // Ensure theme color

                const isEditor = currentUser && currentUser.role === 'editor';
                const hasVoted = userVotes[session.id] !== undefined;

                let statusText, statusBadgeClass; // Removed cardBorderColor as it's handled by statusBorderClass

                // Determine card styles and status text/badge class
                if (session.status === 'active') {
                    statusText = 'Active'; statusBadgeClass = 'bg-green-100 text-green-800';
                } else if (session.status === 'ended') {
                    statusText = 'Ended'; statusBadgeClass = 'bg-red-100 text-red-800';
                } else { // pending
                    statusText = 'Pending'; statusBadgeClass = 'bg-gray-100 text-gray-800';
                }

                // Editor controls for Start/Stop/Edit/Delete
                let editorControlsHTML = '';
                if (isEditor) {
                    if (session.status === 'active') {
                        editorControlsHTML = `<button data-action="live-results" class="text-xs font-medium text-blue-600 hover:text-blue-800">View Live</button><button data-action="stop" class="text-xs font-medium text-yellow-600 hover:text-yellow-800">Stop</button>`;
                    } else if (session.status === 'ended') {
                        editorControlsHTML = `<button data-action="delete" class="text-xs font-medium text-red-600 hover:text-red-800">Delete</button>`;
                    } else { // pending
                        editorControlsHTML = `<button data-action="start" class="text-xs font-medium text-green-600 hover:text-green-800">Start</button><button data-action="edit" class="text-xs font-medium text-indigo-600 hover:text-indigo-800">Edit</button><button data-action="delete" class="text-xs font-medium text-red-600 hover:text-red-800">Delete</button>`;
                    }
                }

                // Main call-to-action button for voters/viewers
                let mainButtonHTML = '';
                if (session.status === 'active') {
                    mainButtonHTML = hasVoted
                        ? `<button class="w-full py-2 rounded-md bg-green-600 text-white font-semibold" disabled><i class="fas fa-check mr-2"></i>You have voted</button>`
                        : `<button data-action="vote" class="w-full py-2 rounded-md btn-primary text-white font-semibold">Vote Now</button>`;
                } else if (session.status === 'ended') {
                    mainButtonHTML = `<button data-action="report" class="w-full py-2 rounded-md bg-gray-600 text-white font-semibold hover:bg-gray-700">View Final Report</button>`;
                } else { // pending
                    mainButtonHTML = `<button class="w-full py-2 rounded-md bg-gray-400 text-white font-semibold cursor-not-allowed">Voting Has Not Started</button>`;
                }

                card.innerHTML = `
                    <div class="voting-card-header">
                        <h3 class="text-lg font-bold text-slate-900 pr-2">${session.title}</h3>
                        <span class="voting-card-status-badge ${statusBadgeClass}">${statusText}</span>
                    </div>
                    <div class="voting-card-body">
                        <p class="text-sm text-slate-500 mb-2">${session.description || 'No description provided.'}</p>
                        <p class="text-sm text-slate-600 mb-2">Vote for up to: <span class="font-bold">${session.numToVoteFor} nominee(s)</span></p>
                        <p id="countdown-${session.id}" class="text-xs text-gray-500"></p>
                    </div>
                    <div class="voting-card-footer">
                        ${mainButtonHTML}
                        ${editorControlsHTML ? `<div class="voting-card-editor-controls">${editorControlsHTML}</div>` : ''}
                    </div>
                `;

                // Add event listener to the whole card for default action (e.g., open detail)
                card.addEventListener('click', (e) => {
                    // Prevent card click from firing if a button inside the card was clicked.
                    if (e.target.closest('button[data-action]')) {
                        return;
                    }
                    console.log("Card clicked, but no specific action button.");
                    // You might want to define a default action here, e.g., open a read-only modal:
                    // showVotingSessionDetailsModal(session.id);
                });

                // Attach event listeners to all data-action buttons within this card
                card.querySelectorAll('button[data-action]').forEach(button => button.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent the main card click from triggering
                    const action = button.dataset.action;
                    if (action === 'start') startVotingSession(session.id);
                    else if (action === 'stop') showReportVisibilityModal(session.id);
                    else if (action === 'edit') openCreateEditVotingModal(session);
                    else if (action === 'delete') deleteVotingSession(session.id, session.title);
                    else if (action === 'report') showVotingResultsModal(session);
                    else if (action === 'live-results') showLiveResultsModal(session);
                    else if (action === 'vote') showVoteCastingModal(session);
                }));

                // Start countdown if session is active
                if (session.status === 'active' && session.endTime) {
                    updateCountdown(session.id, document.getElementById(`countdown-${session.id}`), session.endTime.toDate().getTime());
                } else if (session.status === 'pending' && session.startTime) {
                    // For pending sessions that have a defined startTime, show time until start
                    const startTime = session.startTime.toDate().getTime();
                    const now = new Date().getTime();
                    if (startTime > now) {
                        const countdownEl = document.getElementById(`countdown-${session.id}`);
                        if (countdownEl) {
                            updateCountdown(session.id, countdownEl, startTime); // Use start time for countdown
                            countdownEl.innerHTML = `Starts in: <span class="font-bold">...</span>`; // Initial text
                        }
                    } else {
                        // If pending session's start time has passed, re-evaluate status (might become active)
                        // This might require a small delay or a re-fetch, but for now, it'll just show "Pending".
                    }
                }

                return card;
            };

const handleVoteSubmission = async (sessionId, votedChoices) => {
    try {
        if (!currentUser || !currentUser.uid) { // Add safety checks
            throw new Error("User not authenticated.");
        }
        if (!sessionId) {
            throw new Error("Invalid voting session ID.");
        }

        await setDoc(doc(db, "votingSessions", sessionId, "votes", currentUser.uid), {
            votedChoices: votedChoices,
            timestamp: serverTimestamp(),
            voterName: currentUser.name || 'Anonymous User' // Ensure a string value
        });
        userVotes[sessionId] = votedChoices;
        renderVotingPage();
        showToast("Your vote has been submitted!", "success");
    } catch (error) {
        console.error("Failed to submit vote:", error);
        showToast("Failed to submit vote. " + (error.message || ""), "error"); // Show error message
        throw error; // IMPORTANT: Re-throw to propagate to the calling showConfirmModal
    }
};



            
            const showLiveResultsModal = (session) => {
                if (liveResultsUnsubscribe) liveResultsUnsubscribe();
                const modal = document.getElementById('voting-results-modal');
                const modalId = `live-results-${session.id}`;
                modal.innerHTML = `
                    <div class="p-5 rounded-lg shadow-xl w-full max-w-lg" style="background-color: var(--card-bg);">
                        <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Live Report: ${session.title}</h3><button id="close-live-results-modal" class="p-2 leading-none text-4xl" style="color: var(--text-muted);">&times;</button></div>
                        <div class="modal-body-scrollable max-h-[75vh] overflow-y-auto pr-2">
                            <p class="text-sm text-gray-500 mb-2">Results will update automatically.</p>
                            <canvas id="modal-chart-${modalId}" class="mt-2"></canvas>
                        </div>
                    </div>`;
                modal.classList.remove('hidden');

                const ctx = document.getElementById(`modal-chart-${modalId}`).getContext('2d');
                liveResultsUnsubscribe = onSnapshot(collection(db, "votingSessions", session.id, "votes"), (snapshot) => {
                    const voteCounts = session.nominees.reduce((acc, nominee) => ({...acc, [nominee]: 0}), {});
                    snapshot.forEach(doc => doc.data().votedChoices.forEach(choice => { if (voteCounts.hasOwnProperty(choice)) voteCounts[choice]++; }));
                    drawChart(modalId, ctx, voteCounts, 'bar');
                });
                document.getElementById('close-live-results-modal').addEventListener('click', () => {
                    if (liveResultsUnsubscribe) liveResultsUnsubscribe();
                    if (voteCharts[modalId]) voteCharts[modalId].destroy();
                    modal.classList.add('hidden');
                });
            };

            const showVotingResultsModal = async (session) => {
                const modal = document.getElementById('voting-results-modal');
                modal.innerHTML = `<div class="p-5 rounded-lg shadow-xl w-full max-w-lg bg-white flex justify-center items-center"><i class="fas fa-spinner fa-spin text-2xl"></i></div>`;
                modal.classList.remove('hidden');

                const votesSnapshot = await getDocs(collection(db, "votingSessions", session.id, "votes"));
                const voteCounts = session.nominees.reduce((acc, nominee) => ({...acc, [nominee]: 0}), {});
                let voters = [];
                votesSnapshot.forEach(doc => {
                    voters.push(doc.data().voterName || 'Anonymous');
                    doc.data().votedChoices.forEach(choice => { if (voteCounts.hasOwnProperty(choice)) voteCounts[choice]++; });
                });
                const sortedVotes = Object.entries(voteCounts).sort(([,a],[,b]) => b-a);
                const totalVotes = sortedVotes.reduce((sum, [, count]) => sum + count, 0);
                
                // --- FIX: Logic to switch chart type based on number of nominees ---
                const isHorizontal = sortedVotes.length > 7;

                const renderModalContent = (visibility) => {
                    let resultsToShow = sortedVotes;
                    if (visibility === 'show_top_count_only') {
                        resultsToShow = sortedVotes.slice(0, session.numToVoteFor);
                    }
                    
                    const tallyHTML = resultsToShow.map(([nom, cnt]) => {
                        const percentage = totalVotes > 0 ? ((cnt / totalVotes) * 100).toFixed(1) : 0;
                        return `<li class="space-y-1 py-2">
                                    <div class="flex justify-between font-medium text-sm"><span>${nom}</span><span>${cnt} votes</span></div>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${percentage}%"></div></div>
                                </li>`
                    }).join('');
                    
                    let participantsHTML = `<p class="text-sm text-gray-600">${voters.length} Members Voted</p>`;
                    if (visibility === 'show_all_full_list') {
                        participantsHTML = `<h4 class="text-base font-semibold mt-4">Participants (${voters.length})</h4><ul class="text-sm space-y-1 h-32 overflow-y-auto border p-2 rounded-md bg-gray-50">${voters.length > 0 ? voters.map(v => `<li>${v}</li>`).join('') : '<li>No votes cast.</li>'}</ul>`;
                    }
                    
                    const editorControlsHTML = currentUser?.role === 'editor' ? `
                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 mb-4">
                            <label for="editor-visibility-select" class="block text-sm font-medium mb-1">Editor: Change Report View</label>
                            <select id="editor-visibility-select" class="w-full p-2 border-gray-300 rounded-md text-sm" style="background-color: var(--input-bg); border-color: #d1d5db;">
                                <option value="show_all_full_list" ${visibility === 'show_all_full_list' ? 'selected' : ''}>Show everything</option>
                                <option value="show_all_count_only" ${visibility === 'show_all_count_only' ? 'selected' : ''}>Show all results (count only)</option>
                                <option value="show_top_count_only" ${visibility === 'show_top_count_only' ? 'selected' : ''}>Show top results (count only)</option>
                            </select>
                        </div>` : '';

                    // --- FIX: New two-column layout for the modal body ---
                    modal.innerHTML = `
                        <div class="p-5 rounded-lg shadow-xl w-full max-w-4xl" style="background-color: var(--card-bg);">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-bold">Final Report: ${session.title}</h3>
                                <button id="close-results-modal-x" class="p-2 -mr-2 leading-none text-4xl" style="color: var(--text-muted);">×</button>
                            </div>
                            <div class="modal-body-scrollable max-h-[80vh] overflow-y-auto pr-2">
                                ${editorControlsHTML}
                                <div class="flex flex-col md:flex-row gap-6">
                                    <div class="w-full md:w-1/2">
                                        <h4 class="text-lg font-semibold">Final Tally</h4>
                                        <ul class="space-y-1 mt-2 text-base">${tallyHTML}</ul>
                                        <div class="mt-4 pt-4 border-t">${participantsHTML}</div>
                                    </div>
                                    <div class="w-full md:w-1/2">
                                        <h4 class="text-lg font-semibold">Chart</h4>
                                        <div class="relative h-80 mt-2">
                                            <canvas id="modal-chart-${session.id}"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    
                    const modalId = `modal-chart-${session.id}`;
                    const ctx = document.getElementById(modalId).getContext('2d');
                    drawChart(modalId, ctx, Object.fromEntries(resultsToShow), isHorizontal ? 'bar' : 'bar', isHorizontal); // Pass chart type
                    
                    document.getElementById('close-results-modal-x').addEventListener('click', () => { if (voteCharts[modalId]) voteCharts[modalId].destroy(); modal.classList.add('hidden'); });
                    if(currentUser?.role === 'editor') {
                        document.getElementById('editor-visibility-select').addEventListener('change', (e) => renderModalContent(e.target.value));
                    }
                };
                renderModalContent(session.reportVisibility || 'show_all_full_list');
            };

            // This is a new helper function you'll need to add to handle the vote casting
            function showVoteCastingModal(session) {
                const modal = document.getElementById('create-edit-vote-modal');
                const nomineesHTML = session.nominees.map(nominee => `<div class="flex items-center p-3 rounded-md bg-slate-100 hover:bg-slate-200 transition-colors"><input type="checkbox" name="nominee" value="${nominee}" class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"><label class="ml-3 text-sm font-medium text-gray-800">${nominee}</label></div>`).join('');

                modal.innerHTML = `
                <div class="p-6 rounded-lg shadow-xl max-w-lg w-full mx-auto my-8" style="background-color: var(--card-bg);">
                    <h2 class="text-2xl font-bold text-center mb-1">${session.title}</h2>
                    <p class="text-center text-sm text-gray-500 mb-4">Please cast your vote. You may select up to ${session.numToVoteFor}.</p>
                    <form id="vote-form-${session.id}" class="space-y-3">${nomineesHTML}</form>
                    <div class="mt-6 flex flex-col sm:flex-row-reverse gap-3">
                        <button type="button" id="submit-vote-cast-btn" class="btn-primary text-white w-full py-2 rounded-md">Submit Vote</button>
                        <button type="button" id="cancel-vote-cast-btn" class="w-full py-2 rounded-md bg-gray-200 text-gray-800">Cancel</button>
                    </div>
                </div>`;
                modal.classList.remove("hidden");

                const voteForm = modal.querySelector(`#vote-form-${session.id}`);
                modal.querySelector('#cancel-vote-cast-btn').addEventListener('click', () => modal.classList.add('hidden'));
				modal.querySelector('#submit-vote-cast-btn').addEventListener('click', () => {
					 const selectedChoices = Array.from(voteForm.querySelectorAll('input[name="nominee"]:checked')).map(cb => cb.value);
					 if (selectedChoices.length === 0) {
						 showToast("Please select at least one nominee.", "error");
						 return;
					 }

					 // Disable button and show loading state while submitting
					 const submitButton = modal.querySelector('#submit-vote-cast-btn');
					 submitButton.disabled = true;
					 submitButton.textContent = 'Submitting...';

					 showConfirmModal("Submit your vote? This action is final.", async () => { // Make the confirm callback async
						 try {
							 await handleVoteSubmission(session.id, selectedChoices); // Await the submission
							 modal.classList.add('hidden'); // Only hide AFTER submission is successful
						 } catch (error) {
							 // Error already handled by handleVoteSubmission, just ensure button re-enables
							 console.error("Error from vote submission confirm modal:", error);
						 } finally {
							 submitButton.disabled = false;
							 submitButton.textContent = 'Submit Vote';
						 }
					 });
				});
                voteForm.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.addEventListener('change', () => {
                    if (voteForm.querySelectorAll('input[type="checkbox"]:checked').length > session.numToVoteFor) {
                        cb.checked = false;
                        showToast(`You can only select up to ${session.numToVoteFor} nominee(s).`, 'error');
                    }
                }));
            }
		
            const startVotingSession = async (sessionId) => {
                const sessionRef = doc(db, "votingSessions", sessionId);
                const sessionSnap = await getDoc(sessionRef);
                if (!sessionSnap.exists()) return;
                const durationMinutes = sessionSnap.data().durationMinutes || 60;
                const endTime = new Date(new Date().getTime() + durationMinutes * 60 * 1000);
                await updateDoc(sessionRef, { status: 'active', startTime: serverTimestamp(), endTime });
            };
            
            const showReportVisibilityModal = (sessionId) => {
                const modal = document.getElementById('create-edit-vote-modal');
                modal.innerHTML = `<div class="p-6 rounded-lg shadow-xl max-w-lg w-full mx-auto my-8" style="background-color: var(--card-bg);"><h2 class="text-xl font-semibold mb-2">Finalize Report</h2><p class="text-sm text-gray-500 mb-4">Choose how the final report will be displayed to members.</p><div class="space-y-3"><label class="block p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 dark:has-[:checked]:bg-blue-900/50"><input type="radio" name="reportVisibility" value="show_all_full_list" class="mr-2" checked>Show everything (All results & all participants)</label><label class="block p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 dark:has-[:checked]:bg-blue-900/50"><input type="radio" name="reportVisibility" value="show_all_count_only" class="mr-2">Show all results & voter count only</label><label class="block p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 dark:has-[:checked]:bg-blue-900/50"><input type="radio" name="reportVisibility" value="show_top_count_only" class="mr-2">Show top results & voter count only</label></div><div class="flex justify-end gap-2 mt-6"><button type="button" id="cancel-finalize-btn" class="bg-gray-300 px-4 py-2 rounded-md text-gray-800">Cancel</button><button type="button" id="confirm-finalize-btn" class="btn-primary px-4 py-2 rounded-md text-white">End Vote & Finalize</button></div></div>`;
                modal.classList.remove("hidden");
                modal.querySelector('#cancel-finalize-btn').addEventListener('click', () => modal.classList.add('hidden'));
                modal.querySelector('#confirm-finalize-btn').addEventListener('click', async () => {
                    const visibility = document.querySelector('input[name="reportVisibility"]:checked').value;
                    await updateDoc(doc(db, "votingSessions", sessionId), { status: 'ended', endTime: serverTimestamp(), reportVisibility: visibility });
                    modal.classList.add('hidden');
                    showToast("Voting session ended and report finalized!", "success");
                });
            };

            const deleteVotingSession = (sessionId, title) => {
                showConfirmModal(`Delete "${title}"?`, async () => {
                    if (voteCharts[sessionId] || voteCharts[`modal-chart-${sessionId}`]) {
                        if(voteCharts[sessionId]) voteCharts[sessionId].destroy();
                        if(voteCharts[`modal-chart-${sessionId}`]) voteCharts[`modal-chart-${sessionId}`].destroy();
                    }
                    if (countdownIntervals[sessionId]) clearInterval(countdownIntervals[sessionId]);
                    await deleteDoc(doc(db, "votingSessions", sessionId));
                    showToast("Voting session deleted!", "success");
                });
            };
            const openCreateEditVotingModal = (session = null) => {
                const isEditing = session !== null;
                const modal = document.getElementById('create-edit-vote-modal');
                modal.innerHTML = `<div class="p-6 rounded-lg shadow-xl max-w-lg w-full mx-auto my-8" style="background-color: var(--card-bg);"><h2 class="text-xl font-semibold mb-4">${isEditing ? 'Edit' : 'Create'} Session</h2><form id="save-vote-session-form" class="space-y-4"><input type="hidden" id="edit-vote-id" value="${isEditing ? session.id : ''}"><div><label for="vote-title">Title</label><input id="vote-title" class="w-full border p-2 rounded-md" value="${isEditing ? session.title : ''}" required></div><div><label for="vote-nominees">Nominees (one per line)</label><textarea id="vote-nominees" rows="5" class="w-full border p-2 rounded-md" required>${isEditing ? session.nominees.join('\n') : ''}</textarea></div><div><label for="vote-num-to-vote-for">Votes per person</label><input id="vote-num-to-vote-for" type="number" min="1" class="w-full border p-2 rounded-md" value="${isEditing ? session.numToVoteFor : '1'}" required></div><div><label for="vote-duration-minutes">Duration (minutes)</label><input id="vote-duration-minutes" type="number" min="1" class="w-full border p-2 rounded-md" value="${isEditing ? session.durationMinutes : '60'}" required></div><div class="flex justify-end gap-2 mt-4"><button type="button" id="cancel-vote-btn" class="bg-gray-300 px-4 py-2 rounded-md text-gray-800">Cancel</button><button type="submit" class="btn-primary px-4 py-2 rounded-md text-white">Save</button></div></form></div>`;
                modal.classList.remove("hidden");
                modal.querySelector('#cancel-vote-btn').addEventListener('click', () => modal.classList.add('hidden'));
                modal.querySelector('#save-vote-session-form').addEventListener('submit', handleSaveVotingSession);
            };
            const handleSaveVotingSession = async (e) => {
                e.preventDefault();
                const sessionId = document.getElementById('edit-vote-id').value;
                const sessionData = {
                    title: document.getElementById('vote-title').value,
                    nominees: document.getElementById('vote-nominees').value.split('\n').map(n => n.trim()).filter(n => n),
                    numToVoteFor: parseInt(document.getElementById('vote-num-to-vote-for').value),
                    durationMinutes: parseInt(document.getElementById('vote-duration-minutes').value),
                };
                if (!sessionData.title || sessionData.nominees.length === 0 || isNaN(sessionData.numToVoteFor) || isNaN(sessionData.durationMinutes)) {
                    return showToast("Please fill all fields correctly.", "error");
                }
                try {
                    if (sessionId) {
                        await updateDoc(doc(db, "votingSessions", sessionId), { ...sessionData, updatedAt: serverTimestamp() });
                        showToast("Session updated!", "success");
                    } else {
                        await addDoc(collection(db, "votingSessions"), { ...sessionData, description: '', status: 'pending', createdBy: currentUser.uid, createdAt: serverTimestamp() });
                        showToast("Session created!", "success");
                    }
                    document.getElementById('create-edit-vote-modal').classList.add('hidden');
                } catch (error) { showToast("Failed to save session.", "error"); }
            };

			// --- END OF FIREBASE VOTING SYSTEM ---


            // --- Initialization Logic ---
            const initializeAppLogic = async () => {
                if (!currentUser) { return; }

    manageSlideshowBtn = document.getElementById('manage-slideshow-btn');
    manageSlideshowModal = document.getElementById('manage-slideshow-modal');
    notificationBellContainer = document.getElementById('notification-bell-container');
    notificationBtn = document.getElementById('notification-btn');
    notificationBadge = document.getElementById('notification-badge');

    // Home Page specific elements
    postSearchBox = document.getElementById('post-search-box');
    clearPostSearchBtn = document.getElementById('clear-post-search');
    postSortBox = document.getElementById('post-sort-box');
    viewSavedPostsBtn = document.getElementById('view-saved-posts-btn');

    // Sermons Page specific elements
    sermonSearchBox = document.getElementById('sermon-search-box');
    clearSermonSearchBtn = document.getElementById('clear-sermon-search');
    sermonSpeakerFilter = document.getElementById('sermon-speaker-filter');
    sermonSortBox = document.getElementById('sermon-sort-box');

    // Voting Page specific elements
    createVotingSessionBtn = document.getElementById('create-voting-session-btn');
    toggleExpiredCheckbox = document.getElementById('toggle-expired');

    // Hymns Page specific elements
    hymnSearchBox = document.getElementById('hymn-search-box');
    clearHymnSearchBtn = document.getElementById('clear-hymn-search');
    hymnFilterBy = document.getElementById('hymn-filter-by');
    viewFavoriteHymnsBtn = document.getElementById('view-favorite-hymns-btn');

    // Bottom Navigation Buttons (Hymns/ChawngHlang list page)
    navToHymnsListBtn = document.getElementById('nav-to-hymns-list');
    navToChawngHlangListBtn = document.getElementById('nav-to-chawnghlang-list');
    navToHymnsListBottomBtn = document.getElementById('nav-to-hymns-list-bottom');
    navToChawngHlangListBottomBtn = document.getElementById('nav-to-chawnghlang-list-bottom');
    
    // ChawngHlang Page specific elements
    chawnghlangSearchBox = document.getElementById('chawnghlang-search-box');
    clearChawnghlangSearchBtn = document.getElementById('clear-chawnghlang-search');
    viewFavoriteChawnghlangBtn = document.getElementById('view-favorite-chawnghlang-btn');
    // --- END CRITICAL FIX: All DOM element assignments are done here ---
	
    // --- Setup initial forms (these render their HTML, so they can use elements) ---
    setupRegistrationForm(); // These functions typically populate a form innerHTML
    setupUpdateInfoForm();   // so they don't depend on other elements being active.
    setupProfilePictureUpload(); // Needs global currentUser, which is present.

    // --- Start only ESSENTIAL data fetches and listeners here (e.g., for home page, notifications) ---
    fetchSlideshowPhotos();     // For Home Page
    fetchAboutContent();        // For Home Page
    fetchPosts();               // For Home Page
    listenForSavedPosts();      // Related to Posts on Home Page
    listenForUpdateRequests();  // Global notifications
    listenForPrayerRequests();  // Global notifications
    // Note: Other fetches are moved into switchPage()

    // Setup listeners for global UI elements (after they are assigned)
    if (manageSlideshowBtn) {
        manageSlideshowBtn.removeEventListener('click', openManageSlideshowModal);
        manageSlideshowBtn.addEventListener('click', openManageSlideshowModal);
    }
    if (notificationBtn) {
        notificationBtn.removeEventListener('click', showCombinedNotificationModal);
        notificationBtn.addEventListener('click', showCombinedNotificationModal);
    }	
	

                // --- SETUP ALL EVENT LISTENERS ---
				setupEventListeners();
				
                switchPage('home'); 
            };	
                // --- "EDIT MODE" LOGIC (Corrected) ---
                const editModeToggleBtn = document.getElementById('edit-mode-toggle-btn');
                const canEnterEditMode = currentUser && (currentUser.role === 'editor' || currentUser.role === 'minister');

                if (canEnterEditMode) {
                    editModeToggleBtn.classList.remove('hidden');
                    // This is the fix. It connects the button to the correct 'toggleEditMode' function.
                    editModeToggleBtn.addEventListener('click', toggleEditMode);
                } else {
                    editModeToggleBtn.classList.add('hidden');
                    isEditModeActive = false;
                }

        // Ensure all editor sections start hidden
        document.querySelectorAll('.editor-only-section').forEach(el => {
            el.classList.add('hidden');
        });
    
	const createVotingSessionBtn = document.getElementById('create-voting-session-btn');
    if (createVotingSessionBtn) {
        createVotingSessionBtn.addEventListener('click', () => openCreateEditVotingModal());
    }

    const toggleExpiredCheckbox = document.getElementById('toggle-expired');
    if (toggleExpiredCheckbox) {
        toggleExpiredCheckbox.addEventListener('change', () => {
            document.getElementById('expired-voting-sessions').classList.toggle('hidden', !toggleExpiredCheckbox.checked);
        });
    }

    const hymnDetailPage = document.getElementById('page-hymn-detail');
    if (hymnDetailPage) {
        hymnDetailPage.addEventListener('click', (e) => {
            if (e.target.closest('#hymn-font-decrease-btn')) {
                handleHymnFontSizeChange(-1);
                
            } else if (e.target.closest('#hymn-font-increase-btn')) {
                handleHymnFontSizeChange(1);
               
            }
        });
        
    } else {
        
    }

	
	// In initializeAppLogic or a dedicated setup function for sermons page
			const sermonSearchBox = document.getElementById('sermon-search-box');
			const clearSermonSearchBtn = document.getElementById('clear-sermon-search');
			const sermonSpeakerFilter = document.getElementById('sermon-speaker-filter');
			const sermonSortBox = document.getElementById('sermon-sort-box');

			if (sermonSearchBox) {
				sermonSearchBox.addEventListener('input', () => {
					updateSermonDisplay();
					if (sermonSearchBox.value) {
						clearSermonSearchBtn.classList.remove('hidden');
					} else {
						clearSermonSearchBtn.classList.add('hidden');
					}
				});
			}
			if (clearSermonSearchBtn) {
				clearSermonSearchBtn.addEventListener('click', () => {
					sermonSearchBox.value = '';
					clearSermonSearchBtn.classList.add('hidden');
					updateSermonDisplay();
				});
			}
			if (sermonSpeakerFilter) {
				sermonSpeakerFilter.addEventListener('change', updateSermonDisplay);
			}
			if (sermonSortBox) {
				sermonSortBox.addEventListener('change', updateSermonDisplay);
			}	
			
			
                // --- MANAGE SPECIFIC NAV BUTTONS ---
                const isEditor = currentUser.role === 'editor';
                registerNavBtn.classList.toggle('hidden', !isEditor);
                userManagementNavBtn.classList.toggle('hidden', !isEditor);
                editMyProfileNavBtn.classList.toggle('hidden', !currentUser);
                notificationBellContainer.classList.toggle('hidden', !(isEditor || canEnterEditMode));
                const updateInfoNavBtn = document.getElementById('update-info-nav-btn');
                if (updateInfoNavBtn) {
                    updateInfoNavBtn.classList.toggle('hidden', !currentUser);
                }
                

				
			
				
				// NEW: Attach listener for create voting session button
                if (createVotingSessionBtn) {
                    createVotingSessionBtn.addEventListener('click', () => openCreateEditVotingModal());
                }

                // For Sermon page controls
                //const sermonSearchBox = document.getElementById('sermon-search-box');
                //const sermonSortBox = document.getElementById('sermon-sort-box');
                sermonSearchBox.addEventListener('input', updateSermonDisplay);
                sermonSortBox.addEventListener('change', updateSermonDisplay);

				// NEW: Post filtering/sorting/saving setup
				const postSearchBox = document.getElementById('post-search-box');
				const clearPostSearchBtn = document.getElementById('clear-post-search');
				const postSortBox = document.getElementById('post-sort-box');
				const viewSavedPostsBtn = document.getElementById('view-saved-posts-btn');

				if (postSearchBox) {
					postSearchBox.addEventListener('input', () => {
						updatePostDisplay();
						if (postSearchBox.value) {
							clearPostSearchBtn.classList.remove('hidden');
						} else {
							clearPostSearchBtn.classList.add('hidden');
						}
					});
				}
				if (clearPostSearchBtn) {
					clearPostSearchBtn.addEventListener('click', () => {
						postSearchBox.value = '';
						clearPostSearchBtn.classList.add('hidden');
						updatePostDisplay();
					});
				}
				if (postSortBox) {
					postSortBox.addEventListener('change', updatePostDisplay);
				}
				if (viewSavedPostsBtn) {
					viewSavedPostsBtn.addEventListener('click', () => {
						if (currentPostView === 'all') {
							currentPostView = 'saved';
						} else {
							currentPostView = 'all';
						}
						updatePostDisplay(); // Re-render with the new view
					});
				}
	
                // For Post card clicks (delegated)
                postsListContainer.addEventListener('click', (e) => {
                    const card = e.target.closest('.post-card');
                    const editBtn = e.target.closest('.edit-post-btn');
                    const deleteBtn = e.target.closest('.delete-post-btn');
                    if (!card) return;
                    const postId = card.dataset.postId;
                    if (editBtn) { e.stopPropagation(); openEditPostModal(postId); return; }
                    if (deleteBtn) { e.stopPropagation(); const post = allPosts.find(p => p.id === postId); if(post) deletePost(postId, post.title); return; }
                    currentPostId = postId;
                    switchPage('post-detail');
                });

                // For Sermon card clicks (delegated)
                const mainContentArea = document.getElementById('main-content');
                mainContentArea.addEventListener('click', (e) => {
                    const addSermonBtn = e.target.closest('#add-sermon-btn');
                    const editSermonBtn = e.target.closest('.edit-sermon-btn');
                    const deleteSermonBtn = e.target.closest('.delete-sermon-btn');
                    const sermonCard = e.target.closest('.sermon-card');

                    if (addSermonBtn) {
                        openAddEditSermonModal();
                        return;
                    }
                    if (editSermonBtn) {
                        const sermonId = e.target.closest('.sermon-card').dataset.sermonId;
                        const sermon = allSermons.find(s => s.id === sermonId);
                        openAddEditSermonModal(sermon);
                        return;
                    }
                    if (deleteSermonBtn) {
                        const sermonId = e.target.closest('.sermon-card').dataset.sermonId;
                        const sermon = allSermons.find(s => s.id === sermonId);
                        showConfirmModal(`Delete "${sermon.title}"?`, async () => {
                            await deleteDoc(doc(db, "sermons", sermonId));
                            showToast("Sermon deleted.", "success");
                        });
                        return;
                    }
                    if (sermonCard) {
                        const sermonId = sermonCard.dataset.sermonId;
                        currentSermonId = sermonId;
                        switchPage('sermon-detail');
                        return;
                    }
                });

            const groupHeader = document.querySelector('.collapsible-header[data-page="groups"]');
            const groupContent = document.getElementById('group-collapsible-content');
            if (groupHeader && groupContent) {
                // Ensure initial state is collapsed when app starts/user logs in
                groupHeader.classList.remove('expanded');
                groupContent.style.maxHeight = '0px'; // Explicitly set to 0px
                // IMPORTANT: Add this event listener ONCE.
                // You might want to use .removeEventListener before .addEventListener
                // if there's any chance this part of code runs multiple times.
                // However, if it's the *only* listener, just add it directly.
                groupHeader.removeEventListener('click', handleCollapsibleGroupClick); // Prevent duplicates
                groupHeader.addEventListener('click', handleCollapsibleGroupClick);
            }			

                // --- FETCH ALL DATA & SETUP FORMS ---

                fetchSlideshowPhotos(); 
                fetchAboutContent();     
                fetchMinisters();        
                fetchEvents();           
                fetchZelleRecipient();   
                fetchOnlinePaymentLink();
                fetchPosts();            
                fetchAllMembers();       
                listenForFavorites();    
                listenForUpdateRequests();
                listenForPrayerRequests();
                fetchSermons();
                fetchPublicPrayers();
				fetchVotingSessions();
				fetchMeetingReports();
				fetchSpeakerProfiles();
				listenForSavedPosts();
                renderSlideshow();
				fetchHymns();
				listenForHymnFavorites();
				fetchFinancialLogs();
                if (isEditor) { fetchAppUsers(); } 
                else { if (unsubscribeAppUsers) unsubscribeAppUsers(); }

                setupRegistrationForm(); 
                setupUpdateInfoForm();
				setupProfilePictureUpload();
                ['A', 'B', 'C', 'D'].forEach(group => {
                    const displayModeSelector = document.querySelector(`.display-mode-selector[data-group="${group}"]`);
                    if (displayModeSelector) {
                        displayModeSelector.value = displayMode; // Set the dropdown value to the loaded displayMode
                    }
                });


				// Hymns EventListener
				const hymnSearchBox = document.getElementById('hymn-search-box');
				const clearHymnSearchBtn = document.getElementById('clear-hymn-search');
				const hymnFilterBy = document.getElementById('hymn-filter-by');
				const viewFavoriteHymnsBtn = document.getElementById('view-favorite-hymns-btn');

				if (hymnSearchBox) {
					hymnSearchBox.addEventListener('input', () => {
						updateHymnsDisplay(hymnSearchBox.value);
						if (hymnSearchBox.value) {
							clearHymnSearchBtn.classList.remove('hidden');
						} else {
							clearHymnSearchBtn.classList.add('hidden');
						}
					});
				}
				if (clearHymnSearchBtn) {
					clearHymnSearchBtn.addEventListener('click', () => {
						hymnSearchBox.value = '';
						clearHymnSearchBtn.classList.add('hidden');
						updateHymnsDisplay('');
					});
				}
				// NEW: Listener for filter dropdown
				if (hymnFilterBy) {
					hymnFilterBy.addEventListener('change', () => updateHymnsDisplay(hymnSearchBox.value));
				}
				// NEW: Listener for favorite hymns button
				if (viewFavoriteHymnsBtn) {
					viewFavoriteHymnsBtn.addEventListener('click', () => {
						if (currentHymnView === 'all') {
							currentHymnView = 'favorites';
						} else {
							currentHymnView = 'all';
						}
						updateHymnsDisplay(hymnSearchBox.value); // Re-render with new view
					});
				}
				
                // THIS IS THE FIX for the sidebar navigation
                navTabs.addEventListener('click', (e) => {
                    const link = e.target.closest('.sidebar-nav-link');
                    const collapsibleHeader = e.target.closest('.collapsible-header');

                    if (link) {
                        e.preventDefault();
                        if (link.dataset.page) {
                            switchPage(link.dataset.page);
                        } else if (link.id === 'settings-btn') {
                            openSettingsModal();
                        } else if (link.id === 'theme-switcher-btn') {
                            openThemeModal();
                        }
                    } else if (collapsibleHeader) {
                        e.preventDefault();
                        const groupContent = document.getElementById('group-collapsible-content');
                        collapsibleHeader.classList.toggle('expanded');
                        if (collapsibleHeader.classList.contains('expanded')) {
                           groupContent.style.maxHeight = groupContent.scrollHeight + "px";
                        } else {
                           groupContent.style.maxHeight = null;
                        }
                    }
                });
				
			// New Event Listeners for Sermon Filter Popups
			const sermonSpeakerFilterMobileBtn = document.getElementById('sermon-speaker-filter-mobile-btn');
			const sermonSortBoxMobileBtn = document.getElementById('sermon-sort-box-mobile-btn');
			const sermonSpeakerModal = document.getElementById('sermon-speaker-modal');
			const sermonSortModal = document.getElementById('sermon-sort-modal');
			const closeSpeakerModalBtn = document.getElementById('close-speaker-modal');
			const closeSortModalBtn = document.getElementById('close-sort-modal');

			if (sermonSpeakerFilterMobileBtn) {
				sermonSpeakerFilterMobileBtn.addEventListener('click', () => {
					populateSpeakerFilterModal();
					sermonSpeakerModal.classList.remove('hidden');
				});
			}
			if (sermonSortBoxMobileBtn) {
				sermonSortBoxMobileBtn.addEventListener('click', () => {
					populateSortFilterModal();
					sermonSortModal.classList.remove('hidden');
				});
			}
			if (closeSpeakerModalBtn) {
				closeSpeakerModalBtn.addEventListener('click', () => {
					sermonSpeakerModal.classList.add('hidden');
				});
			}
			if (closeSortModalBtn) {
				closeSortModalBtn.addEventListener('click', () => {
					sermonSortModal.classList.add('hidden');
				});
			}

			// Event listener for the back button on sermon details page
			const sermonDetailBackBtn = document.getElementById('sermon-detail-back-btn');
			if (sermonDetailBackBtn) {
				sermonDetailBackBtn.addEventListener('click', () => switchPage('sermons'));
			}
							
			document.getElementById('pdf-download-top').addEventListener('click', async () => {
				if (pdfViewer.pdfDoc) {
					const data = await pdfViewer.pdfDoc.getData();
					const blob = new Blob([data], { type: 'application/pdf' });
					const url = URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = document.getElementById('pdf-report-title').textContent + '.pdf';
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
					URL.revokeObjectURL(url);
					showControls(); // Keep controls visible after action
				} else {
					showToast("No PDF loaded to download.", "info");
				}
			});

			// PDF Viewer EventListener
			document.getElementById('pdf-print-top').addEventListener('click', () => {
				showToast("Please download the PDF to print.", "info");
				showControls(); // Keep controls visible after action
			});

			// Update the existing page navigation buttons to also call showControls()
			// (These were previously attached to `pdf-prev-page`, `pdf-next-page`, etc.)
			document.getElementById('pdf-prev-page').addEventListener('click', () => {
				if (pdfViewer.instance && pdfViewer.instance.currentPageNumber > 1) {
					pdfViewer.instance.currentPageNumber--;
				}
				showControls();
			});

			document.getElementById('pdf-next-page').addEventListener('click', () => {
				if (pdfViewer.instance && pdfViewer.instance.currentPageNumber < pdfViewer.instance.pagesCount) {
					pdfViewer.instance.currentPageNumber++;
				}
				showControls();
			});

			document.getElementById('pdf-page-num').addEventListener('change', (e) => {
				const newPage = parseInt(e.target.value, 10);
				if (pdfViewer.instance && newPage > 0 && newPage <= pdfViewer.instance.pagesCount) {
					pdfViewer.instance.currentPageNumber = newPage;
				}
				showControls();
			});

			document.getElementById('pdf-zoom-in').addEventListener('click', () => {
				if (pdfViewer.instance) {
					let currentScale = pdfViewer.instance.currentScaleValue;

					if (typeof currentScale === 'string') {
						currentScale = pdfViewer.instance.currentScale;
					} else {
						currentScale = parseFloat(currentScale);
					}

					if (isNaN(currentScale)) {
						currentScale = 1.0;
					}

					// --- CHANGE THE INCREMENT VALUE HERE ---
					pdfViewer.instance.currentScaleValue = (currentScale + 0.1).toString(); // Changed from 0.25 to 0.1 for slower zoom
					showControls();
				}
			});

			document.getElementById('pdf-zoom-out').addEventListener('click', () => {
				if (pdfViewer.instance) {
					let currentScale = pdfViewer.instance.currentScaleValue;

					if (typeof currentScale === 'string') {
						currentScale = pdfViewer.instance.currentScale;
					} else {
						currentScale = parseFloat(currentScale);
					}

					if (isNaN(currentScale)) {
						currentScale = 1.0;
					}

					// --- CHANGE THE DECREMENT VALUE HERE ---
					// Ensure it doesn't go below a reasonable minimum, like 0.25 (25%)
					if (currentScale - 0.1 > 0.24) { // Changed from 0.25 to 0.1 for slower zoom
						pdfViewer.instance.currentScaleValue = (currentScale - 0.1).toString();
					} else {
						pdfViewer.instance.currentScaleValue = '0.25'; // Minimum zoom level
					}
					showControls();
				}
			});

			// For the close button, ensure it also clears the timeout
			document.getElementById('pdf-close-btn').addEventListener('click', () => {
				if (pdfViewer.pdfDoc) pdfViewer.pdfDoc.destroy();
				if (pdfViewer.instance) pdfViewer.instance.cleanup();
				document.getElementById('pdf-viewer-modal').classList.add('hidden');
				clearTimeout(controlsTimeout); // Clear any pending hide operation
			});

			// Click listener for the modal background to close the modal
			document.getElementById('pdf-modal-overlay-bg').addEventListener('click', () => {
				document.getElementById('pdf-viewer-modal').classList.add('hidden');
				clearTimeout(controlsTimeout);
			});

            // Event listeners for new buttons/forms
            addMinisterBtn.addEventListener('click', setupAddMinisterModal);
            editAboutDirectoryBtn.addEventListener('click', openEditAboutDirectoryModal);
            editZelleBtn.addEventListener('click', openEditZelleModal);
            prayerRequestForm.addEventListener('submit', handlePrayerRequestSubmit);
            addPostBtn.addEventListener('click', openAddPostModal); // New Post button listener
            addEventBtn.addEventListener('click', () => openAddEditEventModal());
			
			
            // Initial call for combined notification modal display
            // This is just the default handler. The listeners above will update counts and re-assign this handler
            // as needed to reflect the latest state from Firestore.
            notificationBtn.addEventListener('click', showCombinedNotificationModal);
		
            
        });


</script>
<div id="pdf-viewer-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-hidden h-full w-full flex flex-col">
    <div id="pdf-modal-overlay-bg" class="absolute inset-0 bg-gray-600 bg-opacity-50 z-10"></div>

    <div id="pdf-viewer-content-wrapper" class="relative flex-grow w-full h-full flex flex-col items-center justify-center z-20">

        <div id="pdf-viewer-container" class="relative w-full h-full flex justify-center items-start overflow-hidden">
            </div>

        <div id="pdf-top-controls" class="absolute top-0 left-0 right-0 p-2 bg-black bg-opacity-70 text-white flex justify-between items-center z-30 opacity-0 transition-opacity duration-300">
            <h3 id="pdf-report-title" class="text-base font-bold truncate mr-2">Meeting Report</h3>
            <div class="flex items-center gap-1">
                <button id="pdf-download-top" class="p-2 rounded-md bg-transparent hover:bg-gray-700"><i class="fas fa-download"></i></button>
                <button id="pdf-print-top" class="p-2 rounded-md bg-transparent hover:bg-gray-700"><i class="fas fa-print"></i></button>
                <button id="pdf-close-btn" class="p-2 rounded-md bg-transparent hover:bg-gray-700 text-2xl leading-none">&times;</button>
            </div>
        </div>

        <div id="pdf-bottom-controls" class="absolute bottom-0 left-0 right-0 p-2 bg-black bg-opacity-70 text-white flex justify-center items-center gap-2 z-30 opacity-0 transition-opacity duration-300">
            <button id="pdf-prev-page" class="px-3 py-1 rounded-md bg-gray-700 hover:bg-gray-600 text-sm"><i class="fas fa-chevron-left"></i> Prev</button>
            <span class="text-sm">Page <input type="number" id="pdf-page-num" value="1" min="1" class="w-10 text-center rounded-md p-1 bg-gray-800 text-white border-none"> of <span id="pdf-page-count"></span></span>
            <button id="pdf-next-page" class="px-3 py-1 rounded-md bg-gray-700 hover:bg-gray-600 text-sm">Next <i class="fas fa-chevron-right"></i></button>
            <button id="pdf-zoom-in" class="ml-4 px-3 py-1 rounded-md bg-gray-700 hover:bg-gray-600 text-sm"><i class="fas fa-search-plus"></i></button>
            <button id="pdf-zoom-out" class="px-3 py-1 rounded-md bg-gray-700 hover:bg-gray-600 text-sm"><i class="fas fa-search-minus"></i></button>
        </div>
    </div>
</div>
	  <!-- Member Info Modal (for Name Only view) -->
    <div id="member-info-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center"></div>
	<div id="sermon-detail-modal" class="hidden fixed z-50 inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full p-4 flex items-center justify-center"></div>

</body>
</html>
